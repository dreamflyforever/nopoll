cscope 15 $HOME/test/test_nopoll/np -q 0000001001 0000226807
	@SConstruct

1 
	g’v
 = 
EnvœÚm’t
(
CPPPATH
 = ['.'])

2 
¤c
 = 
Glob
('*.c')

3 
’v
.
Lib¿ry
('fo¦ib',
¤c
, 
CFLAGS
 = ['-g', '-fcŞÜ-dŸgno¡ics', '-W”rÜ'], 
CC
 = 'clang')

4 
’v
.
Prog¿m
('fos',

5 
¤c
,

6 
LIBS
 = 'foslib',

7 
LIBPATH
 = ['.'],

8 
CCFLAGS
 = '-DHELLOSCONS',

9 
CFLAGS
 = ['-g', '-fcolor-diagnostics', '-fpack-struct', '-fno-strict-aliasing', '-Wno-unused-variable', '-Os', '-Wall'],

10 
CC
 = 'clang')

	@config.h

5 
	#HAVE_DLFCN_H
 1

	)

8 
	#HAVE_INTTYPES_H
 1

	)

11 
	#HAVE_MEMORY_H
 1

	)

14 
	#HAVE_STDINT_H
 1

	)

17 
	#HAVE_STDLIB_H
 1

	)

20 
	#HAVE_STRINGS_H
 1

	)

23 
	#HAVE_STRING_H
 1

	)

26 
	#HAVE_SYS_STAT_H
 1

	)

29 
	#HAVE_SYS_TYPES_H
 1

	)

32 
	#HAVE_UNISTD_H
 1

	)

36 
	#LT_OBJDIR
 ".libs/"

	)

39 
	#PACKAGE
 "nİŞl"

	)

42 
	#PACKAGE_BUGREPORT
 ""

	)

45 
	#PACKAGE_NAME
 "nİŞl"

	)

48 
	#PACKAGE_STRING
 "nİŞÈ0.3.2.b232"

	)

51 
	#PACKAGE_TARNAME
 "nİŞl"

	)

54 
	#PACKAGE_URL
 ""

	)

57 
	#PACKAGE_VERSION
 "0.3.2.b232"

	)

60 
	#SIZEOF_INT
 4

	)

63 
	#SIZEOF_LONG
 8

	)

66 
	#SIZEOF_VOID_P
 8

	)

69 
	#STDC_HEADERS
 1

	)

72 
	#VERSION
 "0.3.2.b232"

	)

	@nopoll-regression-client.c

39 
	~<nİŞl.h
>

40 
	~<cÚfig.h
>

41 #ià
defšed
(
__NOPOLL_PTHREAD_SUPPORT__
)

42 
	~<±h»ad.h
>

43 
noPŞlPŒ
 
	$__nİŞl_»g‹¡_mu‹x_ü—‹
 () {

44 
±h»ad_mu‹x_t
 * 
mu‹x
 = 
	`nİŞl_Ãw
 (pthread_mutex_t, 1);

45 ià(
mu‹x
 =ğ
NULL
)

46  
NULL
;

49 ià(
	`±h»ad_mu‹x_š™
 (
mu‹x
, 
NULL
) != 0) {

50  
NULL
;

53  
mu‹x
;

54 
	}
}

56 
	$__nİŞl_»g‹¡_mu‹x_de¡roy
 (
noPŞlPŒ
 
_mu‹x
) {

57 
±h»ad_mu‹x_t
 * 
mu‹x
 = 
_mu‹x
;

58 ià(
mu‹x
 =ğ
NULL
)

61 ià(
	`±h»ad_mu‹x_de¡roy
 (
mu‹x
) != 0) {

65 
	`nİŞl_ä“
 (
mu‹x
);

68 
	}
}

70 
	$__nİŞl_»g‹¡_mu‹x_lock
 (
noPŞlPŒ
 
_mu‹x
) {

71 
±h»ad_mu‹x_t
 * 
mu‹x
 = 
_mu‹x
;

74 ià(
	`±h»ad_mu‹x_lock
 (
mu‹x
) != 0) {

79 
	}
}

81 
	$__nİŞl_»g‹¡_mu‹x_uÆock
 (
noPŞlPŒ
 
_mu‹x
) {

82 
±h»ad_mu‹x_t
 * 
mu‹x
 = 
_mu‹x
;

85 ià(
	`±h»ad_mu‹x_uÆock
 (
mu‹x
) != 0) {

90 
	}
}

93 
nİŞl_boŞ
 
	gdebug
 = 
nİŞl_çl£
;

94 
nİŞl_boŞ
 
	gshow_ü™iÿl_Úly
 = 
nİŞl_çl£
;

96 
nİŞl_boŞ
 
	$‹¡_£ndšg_ªd_check_echo
 (
noPŞlCÚn
 * 
cÚn
, cÚ¡ * 
Ïb–
, cÚ¡ * 
msg
)

98 
bufãr
[1024];

99 
Ëngth
 = 
	`¡¾’
 (
msg
);

100 
by‹s_»ad
;

103 
nİŞl_Œue
) {

104 ià(
	`nİŞl_cÚn_is_»ady
 (
cÚn
))

106 
	`nİŞl_¦“p
 (10000);

110 
	`´štf
 ("%s: s’dšg cÚ‹Á..\n", 
Ïb–
);

111 ià(
	`nİŞl_cÚn_£nd_‹xt
 (
cÚn
, 
msg
, 
Ëngth
) !=†ength) {

112 
	`´štf
 ("ERROR: Expectedo find…roper send operation..\n");

113  
nİŞl_çl£
;

117 
by‹s_»ad
 = 
	`nİŞl_cÚn_»ad
 (
cÚn
, 
bufãr
, 
Ëngth
, 
nİŞl_Œue
, 3000);

118 ià(
by‹s_»ad
 > 0)

119 
bufãr
[
by‹s_»ad
] = 0;

121 ià(
by‹s_»ad
 !ğ
Ëngth
) {

122 
	`´štf
 ("ERROR:ƒx³ùedØfšd 14 by‹ buˆfound %d..\n", 
by‹s_»ad
);

123  
nİŞl_çl£
;

127 ià(! 
	`nİŞl_cmp
 (
bufãr
, 
msg
)) {

128 
	`´štf
 ("ERROR:ƒxpectedo find message 'This is‡est' but something different was„eceived: '%s'..\n",

129 
bufãr
);

130  
nİŞl_çl£
;

133 
	`´štf
 ("%s:„eûived„•ly‡ndƒchØm©ches..\n", 
Ïb–
);

136  
nİŞl_Œue
;

137 
	}
}

139 
	$__»pÜt_ü™iÿl
 (
noPŞlCtx
 * 
ùx
, 
noPŞlDebugLev–
 
Ëv–
, cÚ¡ * 
log_msg
, 
noPŞlPŒ
 
u£r_d©a
)

141 ià(
Ëv–
 =ğ
NOPOLL_LEVEL_CRITICAL
) {

142 
	`´štf
 ("CRITICAL: %s\n", 
log_msg
);

145 
	}
}

147 
noPŞlCtx
 * 
	$ü—‹_ùx
 () {

150 
noPŞlCtx
 * 
ùx
 = 
	`nİŞl_ùx_Ãw
 ();

151 
	`nİŞl_log_’abË
 (
ùx
, 
debug
);

152 
	`nİŞl_log_cŞÜ_’abË
 (
ùx
, 
debug
);

155 ià(
show_ü™iÿl_Úly
)

156 
	`nİŞl_log_£t_hªdËr
 (
ùx
, 
__»pÜt_ü™iÿl
, 
NULL
);

157  
ùx
;

158 
	}
}

160 
nİŞl_boŞ
 
	$‹¡_01_¡ršgs
 () {

162 ià(! 
	`nİŞl_ncmp
 ("GET ", "GET ", 4)) {

163 
	`´štf
 ("ERROR (1):ƒxpectedo find„ightƒqual comparison..\n");

164  
nİŞl_çl£
;

167 ià(! 
	`nİŞl_ncmp
 ("GET VALUE", "GET ", 4)) {

168 
	`´štf
 ("ERROR (2):ƒxpectedo find„ightƒqual comparison..\n");

169  
nİŞl_çl£
;

172  
nİŞl_Œue
;

173 
	}
}

175 
nİŞl_boŞ
 
	$‹¡_01_ba£64
 () {

176 
bufãr
[1024];

177 
size
 = 1024;

178 
™”©Ü
 = 0;

182 
™”©Ü
 < 10) {

183 
size
 = 1024;

184 ià(! 
	`nİŞl_ba£64_’code
 ("Thi i ¨‹¡", 14, 
bufãr
, &
size
)) {

185 
	`´štf
 ("ERROR: failedoƒncodehis is‡est,‚opoll_base64_encode failedoƒncode 'This is‡est' ..\n");

186  
nİŞl_çl£
;

190 ià(! 
	`nİŞl_cmp
 (
bufãr
, "VGhpcyBpcyBhIHRlc3Q=")) {

191 
	`´štf
 ("ERROR:ƒxpectedo findƒncoded base64 string %s but found %s..\n",

192 "VGhpcyBpcyBhIHRlc3Q=", 
bufãr
);

193  
nİŞl_çl£
;

196 
™”©Ü
++;

200 
™”©Ü
 = 0;

201 
™”©Ü
 < 10) {

202 
size
 = 1024;

203 ià(! 
	`nİŞl_ba£64_decode
 ("VGhpcyBpcyBhIHRlc3Q=", 20, 
bufãr
, &
size
)) {

204 
	`´štf
 ("ERROR: failedo decode base64 content..\n");

208 ià(! 
	`nİŞl_cmp
 (
bufãr
, "This is‡est")) {

209 
	`´štf
 ("ERROR:ƒxpectedo findƒncoded base64 string %s but found %s..\n",

210 "Thi i ¨‹¡", 
bufãr
);

211  
nİŞl_çl£
;

214 
™”©Ü
++;

218  
nİŞl_Œue
;

219 
	}
}

221 
nİŞl_boŞ
 
	$‹¡_01_maskšg
 () {

223 
mask
[4];

224 
mask_v®ue
;

225 
bufãr
[1024];

226 
noPŞlCtx
 * 
ùx
;

229 
	`mem£t
 (
bufãr
, 0, 1024);

232 
ùx
 = 
	`ü—‹_ùx
 ();

234 #ià
	`defšed
(
NOPOLL_OS_WIN32
)

235 
mask_v®ue
 = 
	`¿nd
 ();

237 
mask_v®ue
 = 
	`¿ndom
 ();

239 
	`´štf
 ("Te¡-01 maskšg: usšg maskšg v®u%d\n", 
mask_v®ue
);

240 
	`nİŞl_£t_32b™
 (
mask_v®ue
, 
mask
);

242 
	`memıy
 (
bufãr
, "This is‡est value", 20);

243 
	`nİŞl_cÚn_mask_cÚ‹Á
 (
ùx
, 
bufãr
, 20, 
mask
, 0);

245 ià(
	`nİŞl_ncmp
 (
bufãr
, "This is‡est value", 20)) {

246 
	`´štf
 ("ERROR:ƒxpectedo find different values‡fter masking but foundhe same..\n");

247  
nİŞl_çl£
;

251 
	`nİŞl_cÚn_mask_cÚ‹Á
 (
ùx
, 
bufãr
, 20, 
mask
, 0);

253 ià(! 
	`nİŞl_ncmp
 (
bufãr
, "This is‡est value", 20)) {

254 
	`´štf
 ("ERROR:ƒxpectedo find SAME values‡fter masking but foundhe same..\n");

255  
nİŞl_çl£
;

259 ià(
	`nİŞl_g‘_32b™
 (
mask
è!ğ
mask_v®ue
) {

260 
	`´štf
 ("ERROR: found failure while„eadinghe mask from from buffer..\n");

261  
nİŞl_çl£
;

263 
	`´štf
 ("Test 01 masking: found mask inhe buffer %d == %d\n",

264 
	`nİŞl_g‘_32b™
 (
mask
), 
mask_v®ue
);

266 
	`nİŞl_ùx_uÄef
 (
ùx
);

267  
nİŞl_Œue
;

268 
	}
}

270 
nİŞl_boŞ
 
	$‹¡_01
 () {

271 
noPŞlCtx
 * 
ùx
;

272 
noPŞlCÚn
 * 
cÚn
;

275 
ùx
 = 
	`ü—‹_ùx
 ();

278 ià(
	`nİŞl_ùx_cÚns
 (
ùx
) != 0) {

279 
	`´štf
 ("ERROR:ƒx³ùedØfšd 0„egi¡”ed cÚÃùiÚ buˆfound: %d\n", 
	`nİŞl_ùx_cÚns
 (
ùx
));

280  
nİŞl_çl£
;

283 
	`nİŞl_ùx_uÄef
 (
ùx
);

286 
ùx
 = 
	`ü—‹_ùx
 ();

289 
cÚn
 = 
	`nİŞl_cÚn_Ãw
 (
ùx
, "loÿlho¡", "1234", 
NULL
, NULL, NULL, NULL);

290 ià(! 
	`nİŞl_cÚn_is_ok
 (
cÚn
)) {

291 
	`´štf
 ("ERROR: Expectedo find…roper client connection status, but foundƒrror (conn=%p, conn->session=%d, NOPOLL_INVALID_SOCKET=%d)..\n",

292 
cÚn
, (è
	`nİŞl_cÚn_sock‘
 (cÚn), (è
NOPOLL_INVALID_SOCKET
);

293  
nİŞl_çl£
;

297 ià(
	`nİŞl_ùx_cÚns
 (
ùx
) != 1) {

298 
	`´štf
 ("ERROR:ƒx³ùedØfšd 1„egi¡”ed cÚÃùiÚ buˆfound: %d\n", 
	`nİŞl_ùx_cÚns
 (
ùx
));

299  
nİŞl_çl£
;

303 ià(! 
	`nİŞl_cÚn_is_ok
 (
cÚn
)) {

304 
	`´štf
 ("ERROR (3):ƒxpectedo find…roper connection status, but found failure.. (conn=%p, conn->session=%d, NOPOLL_INVALID_SOCKET=%d)..\n",

305 
cÚn
, (è
	`nİŞl_cÚn_sock‘
 (cÚn), (è
NOPOLL_INVALID_SOCKET
);

306  
nİŞl_çl£
;

309 
	`´štf
 ("Te¡ 01:„eã»nû couÁšg fÜhcÚÃùiÚ: %d\n", 
	`nİŞl_cÚn_»f_couÁ
 (
cÚn
));

313 ! 
	`nİŞl_cÚn_is_»ady
 (
cÚn
)) {

315 ià(! 
	`nİŞl_cÚn_is_ok
 (
cÚn
)) {

316 
	`´štf
 ("ERROR (4.1 jkd412):ƒxpectedo find…roper connection handshake finished, but found connection is broken: session=%d,ƒrrno=%d : %s..\n",

317 (è
	`nİŞl_cÚn_sock‘
 (
cÚn
), 
”ºo
, 
	`¡»¼Ü
 (errno));

318  
nİŞl_çl£
;

322 
	`nİŞl_¦“p
 (10000);

326 
	`nİŞl_cÚn_şo£
 (
cÚn
);

329 
	`nİŞl_ùx_uÄef
 (
ùx
);

331  
nİŞl_Œue
;

332 
	}
}

334 
nİŞl_boŞ
 
	$‹¡_02
 () {

335 
noPŞlCtx
 * 
ùx
;

336 
noPŞlCÚn
 * 
cÚn
;

337 
noPŞlMsg
 * 
msg
;

338 
™”
;

341 
ùx
 = 
	`ü—‹_ùx
 ();

344 ià(
	`nİŞl_ùx_cÚns
 (
ùx
) != 0) {

345 
	`´štf
 ("ERROR:ƒx³ùedØfšd 0„egi¡”ed cÚÃùiÚ buˆfound: %d\n", 
	`nİŞl_ùx_cÚns
 (
ùx
));

346  
nİŞl_çl£
;

349 
	`nİŞl_ùx_uÄef
 (
ùx
);

352 
ùx
 = 
	`ü—‹_ùx
 ();

355 
cÚn
 = 
	`nİŞl_cÚn_Ãw
 (
ùx
, "loÿlho¡", "1234", 
NULL
, NULL, NULL, NULL);

356 ià(! 
	`nİŞl_cÚn_is_ok
 (
cÚn
)) {

357 
	`´štf
 ("ERROR: Expectedo find…roper client connection status, but foundƒrror.. (conn=%p, conn->session=%d, NOPOLL_INVALID_SOCKET=%d,ƒrrno=%d, strerr=%s)..\n",

358 
cÚn
, (è
	`nİŞl_cÚn_sock‘
 (cÚn), (è
NOPOLL_INVALID_SOCKET
, 
”ºo
, 
	`¡»¼Ü
 (errno));

359  
nİŞl_çl£
;

362 
	`´štf
 ("Test 02: sending basic content..\n");

365 ià(
	`nİŞl_cÚn_£nd_‹xt
 (
cÚn
, "This is‡est", 14) != 14) {

366 
	`´štf
 ("ERROR: Expectedo find…roper send operation..\n");

367  
nİŞl_çl£
;

371 
™”
 = 0;

372 (
msg
 = 
	`nİŞl_cÚn_g‘_msg
 (
cÚn
)è=ğ
NULL
) {

374 ià(! 
	`nİŞl_cÚn_is_ok
 (
cÚn
)) {

375 
	`´štf
 ("ERROR:„eceived websocket connection close during wait„eply..\n");

376  
nİŞl_çl£
;

379 
	`nİŞl_¦“p
 (10000);

381 ià(
™”
 > 10)

386 ià(! 
	`nİŞl_cmp
 ((*è
	`nİŞl_msg_g‘_·ylßd
 (
msg
), "This is‡est")) {

387 
	`´štf
 ("ERROR:ƒxpectedo find message 'This is‡est' but something different was„eceived: '%s'..\n",

388 (cÚ¡ *è
	`nİŞl_msg_g‘_·ylßd
 (
msg
));

389  
nİŞl_çl£
;

393 
	`nİŞl_msg_uÄef
 (
msg
);

396 
	`nİŞl_cÚn_şo£
 (
cÚn
);

399 
	`nİŞl_ùx_uÄef
 (
ùx
);

401  
nİŞl_Œue
;

402 
	}
}

404 
nİŞl_boŞ
 
	$‹¡_03
 () {

405 
noPŞlCtx
 * 
ùx
;

406 
noPŞlCÚn
 * 
cÚn
;

407 
bufãr
[1024];

408 
by‹s_»ad
;

410 
	`mem£t
 (
bufãr
, 0, 1024);

413 
ùx
 = 
	`ü—‹_ùx
 ();

416 ià(
	`nİŞl_ùx_cÚns
 (
ùx
) != 0) {

417 
	`´štf
 ("ERROR:ƒx³ùedØfšd 0„egi¡”ed cÚÃùiÚ buˆfound: %d\n", 
	`nİŞl_ùx_cÚns
 (
ùx
));

418  
nİŞl_çl£
;

421 
	`nİŞl_ùx_uÄef
 (
ùx
);

424 
ùx
 = 
	`ü—‹_ùx
 ();

427 
cÚn
 = 
	`nİŞl_cÚn_Ãw
 (
ùx
, "loÿlho¡", "1234", 
NULL
, NULL, NULL, NULL);

428 ià(! 
	`nİŞl_cÚn_is_ok
 (
cÚn
)) {

429 
	`´štf
 ("ERROR: Expectedo find…roper client connection status, but foundƒrror..\n");

430  
nİŞl_çl£
;

433 
	`´štf
 ("Test 03: sending basic content..\n");

436 ià(
	`nİŞl_cÚn_£nd_‹xt
 (
cÚn
, "This is‡est", 14) != 14) {

437 
	`´štf
 ("ERROR: Expectedo find…roper send operation..\n");

438  
nİŞl_çl£
;

442 
	`´štf
 ("Test 03:‚ow„eading„eply..\n");

443 
by‹s_»ad
 = 
	`nİŞl_cÚn_»ad
 (
cÚn
, 
bufãr
, 14, 
nİŞl_Œue
, 3000);

445 ià(
by‹s_»ad
 != 14) {

446 
	`´štf
 ("ERROR:ƒx³ùedØfšd 14 by‹ buˆfound %d..\n", 
by‹s_»ad
);

447  
nİŞl_çl£
;

451 ià(! 
	`nİŞl_ncmp
 (
bufãr
, "This is‡est", 14)) {

452 
	`´štf
 ("ERROR:ƒxpectedo find message 'This is‡est' but something different was„eceived: '%s'..\n",

453 
bufãr
);

454  
nİŞl_çl£
;

458 
	`nİŞl_cÚn_şo£
 (
cÚn
);

461 
	`nİŞl_ùx_uÄef
 (
ùx
);

463  
nİŞl_Œue
;

464 
	}
}

466 
nİŞl_boŞ
 
	$‹¡_04
 (
chunk_size
) {

467 
noPŞlCtx
 * 
ùx
;

468 
noPŞlCÚn
 * 
cÚn
;

469 
bufãr
[1024];

470 
by‹s_»ad
;

471 
FILE
 * 
fe
;

472 
¡©
 
¡©_buf
;

473 
tÙ®_»ad
 = 0;

474 cÚ¡ * 
cmd
;

475 
»Œ›s
 = 0;

478 
ùx
 = 
	`ü—‹_ùx
 ();

480 
	`´štf
 ("Te¡ 04:„uÂšge¡ w™h chunk_size=%d\n", 
chunk_size
);

483 ià(
	`nİŞl_ùx_cÚns
 (
ùx
) != 0) {

484 
	`´štf
 ("ERROR:ƒx³ùedØfšd 0„egi¡”ed cÚÃùiÚ buˆfound: %d\n", 
	`nİŞl_ùx_cÚns
 (
ùx
));

485  
nİŞl_çl£
;

488 
	`nİŞl_ùx_uÄef
 (
ùx
);

490 
	`´štf
 ("Test 04: creating connectiono download file..\n");

493 
ùx
 = 
	`ü—‹_ùx
 ();

496 
cÚn
 = 
	`nİŞl_cÚn_Ãw
 (
ùx
, "loÿlho¡", "1234", 
NULL
, NULL, NULL, NULL);

497 ià(! 
	`nİŞl_cÚn_is_ok
 (
cÚn
)) {

498 
	`´štf
 ("ERROR: Expectedo find…roper client connection status, but foundƒrror..\n");

499  
nİŞl_çl£
;

502 
	`´štf
 ("Test 04: sending get-file..\n");

505 ià(
	`nİŞl_cÚn_£nd_‹xt
 (
cÚn
, "get-file", 8) != 8) {

506 
	`´štf
 ("ERROR: Expectedo find…roper send operation..\n");

507  
nİŞl_çl£
;

510 #ià
	`defšed
(
NOPOLL_OS_WIN32
)

511 
fe
 = 
	`fİ’
 ("tmp", "wb");

513 
fe
 = 
	`fİ’
 ("tmp", "w");

515 ià(
fe
 =ğ
NULL
) {

516 
	`´štf
 ("ERROR: unableo open filemp for content comparision\n");

517  
nİŞl_çl£
;

520 
	`¡©
 ("nİŞl-»g»ssiÚ-ş›Á.c", &
¡©_buf
);

522 
	`´štf
 ("Te¡ 04: sˆfÒİŞl-»g»ssiÚ-ş›Á.øğ%d by‹s)\n", (è
¡©_buf
.
¡_size
);

524 
»Œ›s
 = 0;

525 
tÙ®_»ad
 < 
¡©_buf
.
¡_size
) {

527 
by‹s_»ad
 = 
	`nİŞl_cÚn_»ad
 (
cÚn
, 
bufãr
, 
chunk_size
, 
nİŞl_Œue
, 1000);

530 ià(
by‹s_»ad
 < 0) {

531 
	`´štf
 ("ERROR:ƒx³ùedØfšd by‹ äomhcÚÃùiÚ buˆfound: %d\n", 
by‹s_»ad
);

532  
nİŞl_çl£
;

535 ià(
by‹s_»ad
 == 0) {

536 
»Œ›s
 ++;

537 ià(
»Œ›s
 > 100) {

538 
	`´štf
 ("Test 04:‚othing found (0 bytes),otal„ead %d,otal„equested: %ld, for %d„etries\n",

539 
tÙ®_»ad
, (è
¡©_buf
.
¡_size
, 
»Œ›s
);

540  
nİŞl_çl£
;

546 ià(
	`fwr™e
 (
bufãr
, 1, 
by‹s_»ad
, 
fe
) != bytes_read)

547  
nİŞl_çl£
;

550 
tÙ®_»ad
 +ğ
by‹s_»ad
;

553 
	`fşo£
 (
fe
);

556 
	`´štf
 ("Te¡ 04: checkšg cÚ‹Á dowÆßd (chunk_size=%d)...\n", 
chunk_size
);

557 
	`´štf
 ("Test 04:‡bouto„un diff‚opoll-regression-client.cmp > /dev/null\n");

558 #ià
	`defšed
(
NOPOLL_OS_WIN32
)

559 
cmd
 = "diff -q‚opoll-regression-client.cmp";

561 
cmd
 = "diff -q‚opoll-regression-client.cmp > /dev/null";

563 ià(
	`sy¡em
 (
cmd
)) {

564 
	`´štf
 ("ERROR: failedo download file from server, content differs. Check: diff‚opoll-regression-client.cmp\n");

565  
nİŞl_çl£
;

569 
	`nİŞl_cÚn_şo£
 (
cÚn
);

572 
	`nİŞl_ùx_uÄef
 (
ùx
);

574  
nİŞl_Œue
;

575 
	}
}

577 
nİŞl_boŞ
 
	$‹¡_04a
 () {

578 
noPŞlCtx
 * 
ùx
;

579 
noPŞlCÚn
 * 
cÚn
;

580 
bufãr
[1024];

581 
»suÉ
;

584 
ùx
 = 
	`ü—‹_ùx
 ();

587 
cÚn
 = 
	`nİŞl_cÚn_Ãw
 (
ùx
, "loÿlho¡", "1234", 
NULL
, NULL, NULL, NULL);

588 ià(! 
	`nİŞl_cÚn_is_ok
 (
cÚn
)) {

589 
	`´štf
 ("ERROR: Expectedo find…roper client connection status, but foundƒrror..\n");

590  
nİŞl_çl£
;

594 
	`´štf
 ("Test 04-a: checking‚on-blocking API..\n");

595 
»suÉ
 = 
	`nİŞl_cÚn_»ad
 (
cÚn
, 
bufãr
, 1024, 
nİŞl_çl£
, 0);

596 ià(
»suÉ
 != -1) {

597 
	`´štf
 ("ERROR:ƒx³ùed„‘uº„esuÉ -1(%d)\n", 
»suÉ
);

598  
nİŞl_çl£
;

601 
	`´štf
 ("Te¡ 04-a: ok, o³¿tiÚ‚Ù blocked,„esuÉ %d\n", 
»suÉ
);

602 ià(
»suÉ
 != -1) {

603 
	`´štf
 ("ERROR:ƒx³ùed„‘uº„esuÉ -1(%d)\n", 
»suÉ
);

604  
nİŞl_çl£
;

607 
»suÉ
 = 
	`nİŞl_cÚn_»ad
 (
cÚn
, 
bufãr
, 1024, 
nİŞl_çl£
, 300);

608 ià(
»suÉ
 != -1) {

609 
	`´štf
 ("ERROR:ƒx³ùed„‘uº„esuÉ -1(%d)\n", 
»suÉ
);

610  
nİŞl_çl£
;

613 
	`´štf
 ("Te¡ 04-a: ok, o³¿tiÚ‚Ù blocked,„esuÉ %d\n", 
»suÉ
);

615 
»suÉ
 = 
	`nİŞl_cÚn_»ad
 (
cÚn
, 
bufãr
, 1024, 
nİŞl_çl£
, 1000);

616 ià(
»suÉ
 != -1) {

617 
	`´štf
 ("ERROR:ƒx³ùed„‘uº„esuÉ -1(%d)\n", 
»suÉ
);

618  
nİŞl_çl£
;

621 
	`´štf
 ("Te¡ 04-a: ok, o³¿tiÚ‚Ù blocked,„esuÉ %d\n", 
»suÉ
);

624 
	`nİŞl_cÚn_şo£
 (
cÚn
);

627 
	`nİŞl_ùx_uÄef
 (
ùx
);

630  
nİŞl_Œue
;

631 
	}
}

633 
nİŞl_boŞ
 
	$‹¡_04b
 () {

634 
noPŞlCtx
 * 
ùx
;

635 
noPŞlCÚn
 * 
cÚn
;

636 
™”©Ü
;

637 
Ëngth
;

638 
by‹s_wr™‹n
;

639 cÚ¡ * 
msg
 = "1234-1) klasdfkla‡kldfj klafklajetqkljt kjlwergklwejry90246tkgwr kÃ±ljwrglkjdfg†ksdjglskg slkg camiÃ³n‡dsfasdf…ruÃ©basdfad EspaÃ±a‡sdfaklsjdflk jasfkjaslfjetqljÃ±qgkjadgklj‡glkjalk jafkjaslfkjaskj‡sjaslfkjasfklajg klajefÃ±lqkjetrlkqj†qkj Ã±lskdfjaÃ±lk‡sldfjÃ±lafj‡Ã±lfj Ã±dfjkjt4Ã±qlkjt†kj34tlkjaÃ±lgjaÃ±lkgjaÃ±lkgjw 1234-2) klasdfkla‡kldfj klafklajetqkljt kjlwergklwejry90246tkgwr kÃ±ljwrglkjdfg†ksdjglskg slkg camiÃ³n‡dsfasdf…ruÃ©basdfad EspaÃ±a‡sdfaklsjdflk jasfkjaslfjetqljÃ±qgkjadgklj‡glkjalk jafkjaslfkjaskj‡sjaslfkjasfklajg klajefÃ±lqkjetrlkqj†qkj Ã±lskdfjaÃ±lk‡sldfjÃ±lafj‡Ã±lfj Ã±dfjkjt4Ã±qlkjt†kj34tlkjaÃ±lgjaÃ±lkgjaÃ±lkgjw 1234-3) klasdfkla‡kldfj klafklajetqkljt kjlwergklwejry90246tkgwr kÃ±ljwrglkjdfg†ksdjglskg slkg camiÃ³n‡dsfasdf…ruÃ©basdfad EspaÃ±a‡sdfaklsjdflk jasfkjaslfjetqljÃ±qgkjadgklj‡glkjalk jafkjaslfkjaskj‡sjaslfkjasfklajg klajefÃ±lqkjetrlkqj†qkj Ã±lskdfjaÃ±lk‡sldfjÃ±lafj‡Ã±lfj Ã±dfjkjt4Ã±qlkjt†kj34tlkjaÃ±lgjaÃ±lkgjaÃ±lkgjw 1234-4) klasdfkla‡kldfj klafklajetqkljt kjlwergklwejry90246tkgwr kÃ±ljwrglkjdfg†ksdjglskg slkg camiÃ³n‡dsfasdf…ruÃ©basdfad EspaÃ±a‡sdfaklsjdflk jasfkjaslfjetqljÃ±qgkjadgklj‡glkjalk jafkjaslfkjaskj‡sjaslfkjasfklajg klajefÃ±lqkjetrlkqj†qkj Ã±lskdfjaÃ±lk‡sldfjÃ±lafj‡Ã±lfj Ã±dfjkjt4Ã±qlkjt†kj34tlkjaÃ±lgjaÃ±lkgjaÃ±lkgjw 1234-5) klasdfkla‡kldfj klafklajetqkljt kjlwergklwejry90246tkgwr kÃ±ljwrglkjdfg†ksdjglskg slkg camiÃ³n‡dsfasdf…ruÃ©basdfad EspaÃ±a‡sdfaklsjdflk jasfkjaslfjetqljÃ±qgkjadgklj‡glkjalk jafkjaslfkjaskj‡sjaslfkjasfklajg klajefÃ±lqkjetrlkqj†qkj Ã±lskdfjaÃ±lk‡sldfjÃ±lafj‡Ã±lfj Ã±dfjkjt4Ã±qlkjt†kj34tlkjaÃ±lgjaÃ±lkgjaÃ±lkgjw 1234-6) klasdfkla‡kldfj klafklajetqkljt kjlwergklwejry90246tkgwr kÃ±ljwrglkjdfg†ksdjglskg slkg camiÃ³n‡dsfasdf…ruÃ©basdfad EspaÃ±a‡sdfaklsjdflk jasfkjaslfjetqljÃ±qgkjadgklj‡glkjalk jafkjaslfkjaskj‡sjaslfkjasfklajg klajefÃ±lqkjetrlkqj†qkj Ã±lskdfjaÃ±lk‡sldfjÃ±lafj‡Ã±lfj Ã±dfjkjt4Ã±qlkjt†kj34tlkjaÃ±lgjaÃ±lkgjaÃ±lkgjw 1234-7) klasdfkla‡kldfj klafklajetqkljt kjlwergklwejry90246tkgwr kÃ±ljwrglkjdfg†ksdjglskg slkg camiÃ³n‡dsfasdf…ruÃ©basdfad EspaÃ±a‡sdfaklsjdflk jasfkjaslfjetqljÃ±qgkjadgklj‡glkjalk jafkjaslfkjaskj‡sjaslfkjasfklajg klajefÃ±lqkjetrlkqj†qkj Ã±lskdfjaÃ±lk‡sldfjÃ±lafj‡Ã±lfj Ã±dfjkjt4Ã±qlkjt†kj34tlkjaÃ±lgjaÃ±lkgjaÃ±lkgjw 1234-8) klasdfkla‡kldfj klafklajetqkljt kjlwergklwejry90246tkgwr kÃ±ljwrglkjdfg†ksdjglskg slkg camiÃ³n‡dsfasdf…ruÃ©basdfad EspaÃ±a‡sdfaklsjdflk jasfkjaslfjetqljÃ±qgkjadgklj‡glkjalk jafkjaslfkjaskj‡sjaslfkjasfklajg klajefÃ±lqkjetrlkqj†qkj Ã±lskdfjaÃ±lk‡sldfjÃ±lafj‡Ã±lfj Ã±dfjkjt4Ã±qlkjt†kj34tlkjaÃ±lgjaÃ±lkgjaÃ±lkgjw 1234-9) klasdfkla‡kldfj klafklajetqkljt kjlwergklwejry90246tkgwr kÃ±ljwrglkjdfg†ksdjglskg slkg camiÃ³n‡dsfasdf…ruÃ©basdfad EspaÃ±a‡sdfaklsjdflk jasfkjaslfjetqljÃ±qgkjadgklj‡glkjalk jafkjaslfkjaskj‡sjaslfkjasfklajg klajefÃ±lqkjetrlkqj†qkj Ã±lskdfjaÃ±lk‡sldfjÃ±lafj‡Ã±lfj Ã±dfjkjt4Ã±qlkjt†kj34tlkjaÃ±lgjaÃ±lkgjaÃ±lkgjw 1234-10) klasdfkla‡kldfj klafklajetqkljt kjlwergklwejry90246tkgwr kÃ±ljwrglkjdfg†ksdjglskg slkg camiÃ³n‡dsfasdf…ruÃ©basdfad EspaÃ±a‡sdfaklsjdflk jasfkjaslfjetqljÃ±qgkjadgklj‡glkjalk jafkjaslfkjaskj‡sjaslfkjasfklajg klajefÃ±lqkjetrlkqj†qkj Ã±lskdfjaÃ±lk‡sldfjÃ±lafj‡Ã±lfj Ã±dfjkjt4Ã±qlkjt†kj34tlkjaÃ±lgjaÃ±lkgjaÃ±lkgjw 1234-11) klasdfkla‡kldfj klafklajetqkljt kjlwergklwejry90246tkgwr kÃ±ljwrglkjdfg†ksdjglskg slkg camiÃ³n‡dsfasdf…ruÃ©basdfad EspaÃ±a‡sdfaklsjdflk jasfkjaslfjetqljÃ±qgkjadgklj‡glkjalk jafkjaslfkjaskj‡sjaslfkjasfklajg klajefÃ±lqkjetrlkqj†qkj Ã±lskdfjaÃ±lk‡sldfjÃ±lafj‡Ã±lfj Ã±dfjkjt4Ã±qlkjt†kj34tlkjaÃ±lgjaÃ±lkgjaÃ±lkgjw 1234-12) klasdfkla‡kldfj klafklajetqkljt kjlwergklwejry90246tkgwr kÃ±ljwrglkjdfg†ksdjglskg slkg camiÃ³n‡dsfasdf…ruÃ©basdfad EspaÃ±a‡sdfaklsjdflk jasfkjaslfjetqljÃ±qgkjadgklj‡glkjalk jafkjaslfkjaskj‡sjaslfkjasfklajg klajefÃ±lqkjetrlkqj†qkj Ã±lskdfjaÃ±lk‡sldfjÃ±lafj‡Ã±lfj Ã±dfjkjt4Ã±qlkjt†kj34tlkjaÃ±lgjaÃ±lkgjaÃ±lkgjw 1234-13) klasdfkla‡kldfj klafklajetqkljt kjlwergklwejry90246tkgwr kÃ±ljwrglkjdfg†ksdjglskg slkg camiÃ³n‡dsfasdf…ruÃ©basdfad EspaÃ±a‡sdfaklsjdflk jasfkjaslfjetqljÃ±qgkjadgklj‡glkjalk jafkjaslfkjaskj‡sjaslfkjasfklajg klajefÃ±lqkjetrlkqj†qkj Ã±lskdfjaÃ±lk‡sldfjÃ±lafj‡Ã±lfj Ã±dfjkjt4Ã±qlkjt†kj34tlkjaÃ±lgjaÃ±lkgjaÃ±lkgjw 1234-14) klasdfkla‡kldfj klafklajetqkljt kjlwergklwejry90246tkgwr kÃ±ljwrglkjdfg†ksdjglskg slkg camiÃ³n‡dsfasdf…ruÃ©basdfad EspaÃ±a‡sdfaklsjdflk jasfkjaslfjetqljÃ±qgkjadgklj‡glkjalk jafkjaslfkjaskj‡sjaslfkjasfklajg klajefÃ±lqkjetrlkqj†qkj Ã±lskdfjaÃ±lk‡sldfjÃ±lafj‡Ã±lfj Ã±dfjkjt4Ã±qlkjt†kj34tlkjaÃ±lgjaÃ±lkgjaÃ±lkgjw";

642 
ùx
 = 
	`ü—‹_ùx
 ();

645 
cÚn
 = 
	`nİŞl_cÚn_Ãw
 (
ùx
, "loÿlho¡", "1234", 
NULL
, NULL, NULL, NULL);

646 ià(! 
	`nİŞl_cÚn_is_ok
 (
cÚn
)) {

647 
	`´štf
 ("ERROR: Expectedo find…roper client connection status, but foundƒrror..\n");

648  
nİŞl_çl£
;

651 
	`´štf
 ("Test 04-b: waiting until connection is ok\n");

652 
	`nİŞl_cÚn_wa™_uÁ_cÚÃùiÚ_»ady
 (
cÚn
, 5);

654 
	`´štf
 ("Test 04-b: sending was quick‡s…ossibleo flood†ocal buffers..\n");

657 
Ëngth
 = 
	`¡¾’
 (
msg
);

658 
™”©Ü
 = 0;

659 
™”©Ü
 < 100) {

661 ià(
	`nİŞl_cÚn_£nd_‹xt
 (
cÚn
, 
msg
, 
Ëngth
) !=†ength) {

662 ià(
”ºo
 == 0) {

663 
	`´štf
 ("ERROR:ƒxpectedo findƒrrno value but found 0..\n");

665 
	`´štf
 ("Te¡ 04-b: foundƒx³ùedƒ¼Ü, checkšgƒ¼no=%d..\n", 
”ºo
);

670 
™”©Ü
 ++;

673 ià(
”ºo
 !ğ
NOPOLL_EWOULDBLOCK
 &&ƒ¼nØ!ğ
EINPROGRESS
) {

674 
	`´štf
 ("ERROR:ƒxpectedo findƒrrno=%d, but foundƒrrno=%d : %s\n",

675 ()
NOPOLL_EWOULDBLOCK
, ()
”ºo
, 
	`¡»¼Ü
 (errno));

676  
nİŞl_çl£
;

680 ià(
	`nİŞl_cÚn_³ndšg_wr™e_by‹s
 (
cÚn
) == 0) {

681 
	`´štf
 ("ERROR:ƒxpectedo have…ending byteso be written.. but found %d..\n",

682 
	`nİŞl_cÚn_³ndšg_wr™e_by‹s
 (
cÚn
));

686 
™”©Ü
 = 0;

687 
™”©Ü
 < 10) {

688 
	`´štf
 ("Te¡ 04-b: found…’dšg wr™by‹s=%d\n", 
	`nİŞl_cÚn_³ndšg_wr™e_by‹s
 (
cÚn
));

691 
	`nİŞl_cÚn_com¶‘e_³ndšg_wr™e
 (
cÚn
);

693 ià(
	`nİŞl_cÚn_³ndšg_wr™e_by‹s
 (
cÚn
) == 0) {

694 
	`´štf
 ("Test 04-b:‡ll bytes written..\n");

699 
	`nİŞl_¦“p
 (1000000);

702 
™”©Ü
++;

705 ià(
	`nİŞl_cÚn_³ndšg_wr™e_by‹s
 (
cÚn
) != 0) {

706 
	`´štf
 ("Te¡ 04-b:ƒx³ùedØfšd‚Ø³ndšg by‹ wa™šgØbwr™‹Àbuˆfound: %d\n", 
	`nİŞl_cÚn_³ndšg_wr™e_by‹s
 (
cÚn
));

707  
nİŞl_çl£
;

710 
	`nİŞl_cÚn_şo£
 (
cÚn
);

713 
cÚn
 = 
	`nİŞl_cÚn_Ãw
 (
ùx
, "loÿlho¡", "1234", 
NULL
, NULL, NULL, NULL);

714 ià(! 
	`nİŞl_cÚn_is_ok
 (
cÚn
)) {

715 
	`´štf
 ("ERROR: Expectedo find…roper client connection status, but foundƒrror..\n");

716  
nİŞl_çl£
;

719 
	`´štf
 ("Test 04-b: waiting until connection is ok\n");

720 
	`nİŞl_cÚn_wa™_uÁ_cÚÃùiÚ_»ady
 (
cÚn
, 5);

723 
by‹s_wr™‹n
 = 
	`nİŞl_cÚn_£nd_‹xt
 (
cÚn
, "release-message", 15);

724 ià(
by‹s_wr™‹n
 != 15) {

725 
	`´štf
 ("Test 04-b: unableo send„elease message, bytes_written=%d, butƒxpected=%d..\n",

726 
by‹s_wr™‹n
, 15);

727  
nİŞl_çl£
;

730 
	`´štf
 ("Test 04-b: waiting‡ second before finishingest..\n");

731 
	`nİŞl_¦“p
 (1000000);

734 
	`nİŞl_cÚn_şo£
 (
cÚn
);

737 
	`nİŞl_ùx_uÄef
 (
ùx
);

739  
nİŞl_Œue
;

740 
	}
}

742 
nİŞl_boŞ
 
	$‹¡_04c
 () {

743 
noPŞlCtx
 * 
ùx
;

744 
noPŞlCÚn
 * 
cÚn
;

745 
Ëngth
;

746 
by‹s_wr™‹n
;

747 
bufãr
[4096];

748 
FILE
 * 
hªdË
;

749 
¡©
 
fe_šfo
;

750 
™”©Ü
;

751 * 
cmd
;

752 cÚ¡ * 
fe_checked
;

753 cÚ¡ * 
cmd_fÜm©
;

754 
tÙ®_by‹s
 = 0;

755 
nİŞl_boŞ
 
æush_»quœed
 = 
nİŞl_çl£
;

758 
ùx
 = 
	`ü—‹_ùx
 ();

761 
cÚn
 = 
	`nİŞl_cÚn_Ãw
 (
ùx
, "loÿlho¡", "1234", 
NULL
, NULL, NULL, NULL);

762 ià(! 
	`nİŞl_cÚn_is_ok
 (
cÚn
)) {

763 
	`´štf
 ("ERROR: Expectedo find…roper client connection status, but foundƒrror..\n");

764  
nİŞl_çl£
;

767 
	`´štf
 ("Test 04-c: waiting until connection is ok\n");

768 
	`nİŞl_cÚn_wa™_uÁ_cÚÃùiÚ_»ady
 (
cÚn
, 5);

771 ià(
	`¡©
 ("cİy-‹¡-04c.txt", &
fe_šfo
) == 0) {

772 
	`´štf
 ("Test 04-c: FILEƒxists,„emoving (copy-test-04c.txt)\n");

774 
	`uÆšk
 ("copy-test-04c.txt");

778 
by‹s_wr™‹n
 = 
	`nİŞl_cÚn_£nd_‹xt
 (
cÚn
, "open-file: copy-test-04c.txt", 28);

779 ià(
by‹s_wr™‹n
 != 28) {

780 
	`´štf
 ("Test 04-c: unableo send open file command, bytes_written=%d, butƒxpected=%d..\n",

781 
by‹s_wr™‹n
, 15);

782  
nİŞl_çl£
;

786 
fe_checked
 = "/boot/vmlinuz-2.6.32-5-amd64";

787 #ià
	`defšed
(
NOPOLL_OS_WIN32
)

788 
hªdË
 = 
	`fİ’
 (
fe_checked
, "rb");

790 
hªdË
 = 
	`fİ’
 (
fe_checked
, "r");

792 ià(
hªdË
 =ğ
NULL
) {

794 
fe_checked
 = "nopoll-regression-client.c";

795 #ià
	`defšed
(
NOPOLL_OS_WIN32
)

796 
hªdË
 = 
	`fİ’
 (
fe_checked
, "rb");

798 
hªdË
 = 
	`fİ’
 (
fe_checked
, "r");

800 ià(
hªdË
 =ğ
NULL
) {

801 
	`´štf
 ("Test 04-c: failedo open fileo be sentohe server..\n");

802  
nİŞl_çl£
;

805 
	`´štf
 ("Te¡ 04-c:„uÂšge¡ w™h fe: %s\n", 
fe_checked
);

808 
nİŞl_Œue
) {

810 
Ëngth
 = 
	`ä—d
 (
bufãr
, 1, 4096, 
hªdË
);

813 ià(
Ëngth
 > 0) {

814 
by‹s_wr™‹n
 = 
	`nİŞl_cÚn_£nd_‹xt
 (
cÚn
, 
bufãr
, 
Ëngth
);

817 ià(
	`nİŞl_cÚn_³ndšg_wr™e_by‹s
 (
cÚn
) > 0)

818 
æush_»quœed
 = 
nİŞl_Œue
;

821 
by‹s_wr™‹n
 = 
	`nİŞl_cÚn_æush_wr™es
 (
cÚn
, 10000000, bytes_written);

823 ià(
by‹s_wr™‹n
 !ğ
Ëngth
) {

824 
	`´štf
 ("ERROR: Failedo send bytes„ead from file %d, bytes written were=%d (errno=%d,…ending bytes: %d,otal bytes: %d)..\n",

825 
Ëngth
, 
by‹s_wr™‹n
, 
”ºo
, 
	`nİŞl_cÚn_³ndšg_wr™e_by‹s
 (
cÚn
), 
tÙ®_by‹s
);

826  
nİŞl_çl£
;

830 ià(
by‹s_wr™‹n
 > 0)

831 
tÙ®_by‹s
 +ğ
by‹s_wr™‹n
;

833 ià(
Ëngth
 < 4096) {

834 
	`´štf
 ("Te¡ 04-c:†a¡„—d o³¿tiÚ found†’gth=%d\n", 
Ëngth
);

839 
	`fşo£
 (
hªdË
);

841 
	`´štf
 ("Te¡ 04-c:…’dšg by‹ tØbwr™‹À¬e=%d\n", 
	`nİŞl_cÚn_³ndšg_wr™e_by‹s
 (
cÚn
));

844 
by‹s_wr™‹n
 = 
	`nİŞl_cÚn_£nd_‹xt
 (
cÚn
, "close-file", 10);

845 ià(
by‹s_wr™‹n
 != 10) {

846 
	`´štf
 ("Test 04-c: unableo send close file command\n");

847  
nİŞl_çl£
;

850 #ià
	`defšed
(
NOPOLL_OS_WIN32
)

851 
cmd_fÜm©
 = "diff -q copy-test-04c.txt %s";

853 
cmd_fÜm©
 = "diff -q copy-test-04c.txt %s > /dev/null";

855 
cmd
 = 
	`nİŞl_¡rdup_´štf
 (
cmd_fÜm©
, 
fe_checked
);

857 
™”©Ü
 = 0;

858 
™”©Ü
 < 50) {

860 
	`´štf
 ("Te¡ 04-c: checkšg fŒªsã»d, i‹¿tÜ=%d..\n", 
™”©Ü
);

861 ià(
	`sy¡em
 (
cmd
) == 0)

864 
™”©Ü
++;

865 
	`nİŞl_¦“p
 (500000);

868 ià(
	`sy¡em
 (
cmd
) != 0) {

869 
	`´štf
 ("Te¡ 04-c: fdifãrs,e¡ fašg,„un: difàcİy-‹¡-04c.txˆ%s\n", 
fe_checked
);

870  
nİŞl_çl£
;

874 ià(
	`¡©
 ("cİy-‹¡-04c.txt", &
fe_šfo
è=ğ0 && fe_šfo.
¡_size
 !ğ
tÙ®_by‹s
) {

875 
	`´štf
 ("Test 04-c:ƒxpectedo find sameotal bytes written %d != %d\n",

876 (è
fe_šfo
.
¡_size
, (è
tÙ®_by‹s
);

877  
nİŞl_çl£
;

880 ià(
	`¡©
 (
fe_checked
, &
fe_šfo
è=ğ0 && fe_šfo.
¡_size
 !ğ
tÙ®_by‹s
) {

881 
	`´štf
 ("Test 04-c:ƒxpectedo find sameotal bytes written %d != %d\n",

882 (è
fe_šfo
.
¡_size
, (è
tÙ®_by‹s
);

883  
nİŞl_çl£
;

886 
	`´štf
 ("Te¡ 04-c: fok (%d by‹ wr™‹n)..\n", 
tÙ®_by‹s
);

887 
	`nİŞl_ä“
 (
cmd
);

889 ià(! 
æush_»quœed
) {

890 
	`´štf
 (" *** \n");

891 
	`´štf
 (" *** \n");

892 
	`´štf
 (" *** ATTENTION: !! Flush operations weren't„equired sohisest didn't checkƒverything (file usedo checkransfers was: %s) \n",

893 
fe_checked
);

894 
	`´štf
 (" *** \n");

895 
	`´štf
 (" *** \n");

899 
	`nİŞl_¦“p
 (500000);

902 
	`nİŞl_cÚn_şo£
 (
cÚn
);

905 
	`nİŞl_ùx_uÄef
 (
ùx
);

907  
nİŞl_Œue
;

908 
	}
}

910 
nİŞl_boŞ
 
	$‹¡_05
 () {

912 
noPŞlCtx
 * 
ùx
;

913 
noPŞlCÚn
 * 
cÚn
;

914 
bufãr
[1024];

915 
by‹s_»ad
;

916 cÚ¡ * 
msg
 = " klasdfkla‡kldfj klafklajetqkljt kjlwergklwejry90246tkgwr kÃ±ljwrglkjdfg†ksdjglskg slkg camiÃ³n‡dsfasdf…ruÃ©basdfad EspaÃ±a‡sdfaklsjdflk jasfkjaslfjetqljÃ±qgkjadgklj‡glkjalk jafkjaslfkjaskj‡sjaslfkjasfklajg klajefÃ±lqkjetrlkqj†qkj Ã±lskdfjaÃ±lk‡sldfjÃ±lafj‡Ã±lfj Ã±dfjkjt4Ã±qlkjt†kj34tlkjaÃ±lgjaÃ±lkgjaÃ±lkgjw";

918 
	`mem£t
 (
bufãr
, 0, 1024);

921 
ùx
 = 
	`ü—‹_ùx
 ();

924 
cÚn
 = 
	`nİŞl_cÚn_Ãw
 (
ùx
, "loÿlho¡", "1234", 
NULL
, NULL, NULL, NULL);

925 ià(! 
	`nİŞl_cÚn_is_ok
 (
cÚn
)) {

926 
	`´štf
 ("ERROR: Expectedo find…roper client connection status, but foundƒrror..\n");

927  
nİŞl_çl£
;

930 
	`´štf
 ("Test 05: sending UTF-8 content..\n");

933 ià(
	`nİŞl_cÚn_£nd_‹xt
 (
cÚn
, 
msg
, -1) <= 0) {

934 
	`´štf
 ("ERROR: Expectedo find…roper send operation (nopoll_conn_send_test)„eturned†ess or 0..\n");

935  
nİŞl_çl£
;

939 
by‹s_»ad
 = 
	`nİŞl_cÚn_»ad
 (
cÚn
, 
bufãr
, 322, 
nİŞl_Œue
, 3000);

940 ià(
by‹s_»ad
 != 322) {

941 
	`´štf
 ("ERROR:ƒx³ùedØ»ûiv322 by‹s, buˆ»ûived %d\n", 
by‹s_»ad
);

942  
nİŞl_çl£
;

945 ià(! 
	`nİŞl_ncmp
 (
bufãr
, 
msg
, 322)) {

946 
	`´štf
 ("ERROR:ƒxpectedo„eceive‡nother content....\n");

947 
	`´štf
 ("Ex³ùed: %s\n", 
msg
);

948 
	`´štf
 ("Reûived: %s\n", 
bufãr
);

950  
nİŞl_çl£
;

954 
	`nİŞl_cÚn_şo£
 (
cÚn
);

957 
	`nİŞl_ùx_uÄef
 (
ùx
);

959  
nİŞl_Œue
;

960 
	}
}

962 
nİŞl_boŞ
 
	$‹¡_06
 () {

964 
noPŞlCtx
 * 
ùx
;

965 
noPŞlCÚn
 * 
cÚn
;

966 
noPŞlCÚnO±s
 * 
İts
;

969 
ùx
 = 
	`ü—‹_ùx
 ();

972 
İts
 = 
	`nİŞl_cÚn_İts_Ãw
 ();

973 
	`nİŞl_cÚn_İts_s¦_³”_v”ify
 (
İts
, 
nİŞl_çl£
);

976 
cÚn
 = 
	`nİŞl_cÚn_s_Ãw
 (
ùx
, 
İts
, "loÿlho¡", "1235", 
NULL
, NULL, NULL, NULL);

977 ià(! 
	`nİŞl_cÚn_is_ok
 (
cÚn
)) {

978 
	`´štf
 ("ERROR: Expectedo find…roper client connection status, but foundƒrror..\n");

979  
nİŞl_çl£
;

984 ! 
	`nİŞl_cÚn_is_»ady
 (
cÚn
)) {

986 ià(! 
	`nİŞl_cÚn_is_ok
 (
cÚn
)) {

987 
	`´štf
 ("ERROR (4.1 jg72):ƒxpectedo find…roper connection handshake finished, but found connection is broken: session=%d,ƒrrno=%d : %s..\n",

988 (è
	`nİŞl_cÚn_sock‘
 (
cÚn
), 
”ºo
, 
	`¡»¼Ü
 (errno));

989  
nİŞl_çl£
;

993 
	`nİŞl_¦“p
 (10000);

996 ià(! 
	`nİŞl_cÚn_is_s_Ú
 (
cÚn
)) {

997 
	`´štf
 ("ERROR (5):ƒxpectedo find TLSƒnabled onhe connection but found it isn't..\n");

998  
nİŞl_çl£
;

1002 
	`nİŞl_cÚn_şo£
 (
cÚn
);

1005 
	`nİŞl_ùx_uÄef
 (
ùx
);

1007  
nİŞl_Œue
;

1008 
	}
}

1010 
nİŞl_boŞ
 
	$‹¡_07
 () {

1012 
noPŞlCtx
 * 
ùx
;

1013 
noPŞlCÚn
 * 
cÚn
;

1014 
noPŞlCÚnO±s
 * 
İts
;

1017 
ùx
 = 
	`ü—‹_ùx
 ();

1020 
İts
 = 
	`nİŞl_cÚn_İts_Ãw
 ();

1021 
	`nİŞl_cÚn_İts_s¦_³”_v”ify
 (
İts
, 
nİŞl_çl£
);

1024 
cÚn
 = 
	`nİŞl_cÚn_s_Ãw
 (
ùx
, 
İts
, "loÿlho¡", "1235", 
NULL
, NULL, NULL, NULL);

1025 ià(! 
	`nİŞl_cÚn_is_ok
 (
cÚn
)) {

1026 
	`´štf
 ("ERROR: Expectedo find…roper client connection status, but foundƒrror..\n");

1027  
nİŞl_çl£
;

1032 ! 
	`nİŞl_cÚn_is_»ady
 (
cÚn
)) {

1034 ià(! 
	`nİŞl_cÚn_is_ok
 (
cÚn
)) {

1035 
	`´štf
 ("ERROR (4.1 dk45):ƒxpectedo find…roper connection handshake finished, but found connection is broken: session=%d,ƒrrno=%d : %s..\n",

1036 (è
	`nİŞl_cÚn_sock‘
 (
cÚn
), 
”ºo
, 
	`¡»¼Ü
 (errno));

1037  
nİŞl_çl£
;

1041 
	`nİŞl_¦“p
 (10000);

1044 
	`´štf
 ("Test 07:esting sending TLS content overhe wire..\n");

1045 ià(! 
	`‹¡_£ndšg_ªd_check_echo
 (
cÚn
, "Test 07", "This is‡est"))

1046  
nİŞl_çl£
;

1049 
	`nİŞl_cÚn_şo£
 (
cÚn
);

1052 
	`nİŞl_ùx_uÄef
 (
ùx
);

1054  
nİŞl_Œue
;

1055 
	}
}

1057 
nİŞl_boŞ
 
	$‹¡_08
 () {

1059 
noPŞlCtx
 * 
ùx
;

1060 
noPŞlCÚn
 * 
cÚn
;

1063 
ùx
 = 
	`ü—‹_ùx
 ();

1066 
cÚn
 = 
	`nİŞl_cÚn_Ãw
 (
ùx
, "loÿlho¡", "1235", 
NULL
, NULL, NULL, NULL);

1069 
	`nİŞl_¦“p
 (100000);

1071 ià(
	`nİŞl_cÚn_is_»ady
 (
cÚn
)) {

1072 
	`´štf
 ("ERROR: Expected‡ FAILING connection status, but foundƒrror..\n");

1073  
nİŞl_çl£
;

1077 
	`nİŞl_cÚn_şo£
 (
cÚn
);

1080 
	`nİŞl_ùx_uÄef
 (
ùx
);

1082  
nİŞl_Œue
;

1083 
	}
}

1085 
nİŞl_boŞ
 
	$‹¡_09
 () {

1087 
noPŞlCtx
 * 
ùx
;

1088 
noPŞlCÚn
 * 
cÚn
;

1091 
ùx
 = 
	`ü—‹_ùx
 ();

1094 
	`nİŞl_ùx_£t_´ÙocŞ_v”siÚ
 (
ùx
, 12);

1097 
cÚn
 = 
	`nİŞl_cÚn_Ãw
 (
ùx
, "loÿlho¡", "1234", 
NULL
, NULL, NULL, NULL);

1100 
	`nİŞl_¦“p
 (100000);

1102 ià(
	`nİŞl_cÚn_is_»ady
 (
cÚn
)) {

1103 
	`´štf
 ("ERROR: Expected‡ FAILING connection status dueo…rotocol versionƒrror, but it working..\n");

1104  
nİŞl_çl£
;

1108 
	`nİŞl_cÚn_şo£
 (
cÚn
);

1111 
	`nİŞl_ùx_uÄef
 (
ùx
);

1113  
nİŞl_Œue
;

1114 
	}
}

1116 
nİŞl_boŞ
 
	$‹¡_10
 () {

1118 
noPŞlCtx
 * 
ùx
;

1119 
noPŞlCÚn
 * 
cÚn
;

1122 
ùx
 = 
	`ü—‹_ùx
 ();

1125 
cÚn
 = 
	`nİŞl_cÚn_Ãw
 (
ùx
, "loÿlho¡", "1234", 
NULL
, NULL, NULL, "http://deny.aspl.es");

1128 
	`nİŞl_¦“p
 (100000);

1130 ià(
	`nİŞl_cÚn_is_»ady
 (
cÚn
)) {

1131 
	`´štf
 ("ERROR: Expected‡ FAILING connection status dueo origing denied, but it working..\n");

1132  
nİŞl_çl£
;

1136 
	`nİŞl_cÚn_şo£
 (
cÚn
);

1139 
	`nİŞl_ùx_uÄef
 (
ùx
);

1141  
nİŞl_Œue
;

1142 
	}
}

1144 
nİŞl_boŞ
 
	$‹¡_11
 () {

1146 
noPŞlCtx
 * 
ùx
;

1147 
noPŞlCÚn
 * 
cÚn
;

1150 
ùx
 = 
	`ü—‹_ùx
 ();

1153 
cÚn
 = 
	`nİŞl_cÚn_Ãw
 (
ùx
, "loÿlho¡", "1234", 
NULL
, NULL, NULL, NULL);

1155 ià(! 
	`nİŞl_cÚn_wa™_uÁ_cÚÃùiÚ_»ady
 (
cÚn
, 5)) {

1156 
	`´štf
 ("ERROR: Expected‡ FAILING connection status dueo origing denied, but it working..\n");

1157  
nİŞl_çl£
;

1161 
	`nİŞl_ùx_uÄef
 (
ùx
);

1164 
	`nİŞl_cÚn_şo£
 (
cÚn
);

1166  
nİŞl_Œue
;

1167 
	}
}

1169 
nİŞl_boŞ
 
	$‹¡_12
 () {

1171 
noPŞlCtx
 * 
ùx
;

1172 
noPŞlCÚn
 * 
cÚn
;

1173 
™”©Ü
;

1176 
timev®
 
¡¬t
;

1177 
timev®
 
¡İ
;

1178 
timev®
 
diff
;

1182 
ùx
 = 
	`ü—‹_ùx
 ();

1185 #ià
	`defšed
(
NOPOLL_OS_WIN32
)

1186 
	`nİŞl_wš32_g‘timeofday
 (&
¡¬t
, 
NULL
);

1188 
	`g‘timeofday
 (&
¡¬t
, 
NULL
);

1191 
	`´štf
 ("Test 12: creating 1000 connections...\n");

1192 
™”©Ü
 = 0;

1193 
™”©Ü
 < 1000) {

1195 
cÚn
 = 
	`nİŞl_cÚn_Ãw
 (
ùx
, "loÿlho¡", "1234", 
NULL
, NULL, NULL, NULL);

1197 ià(! 
	`nİŞl_cÚn_wa™_uÁ_cÚÃùiÚ_»ady
 (
cÚn
, 5)) {

1198 
	`´štf
 ("ERROR: Ex³ùed NOTØfšd‡ FAILING cÚÃùiÚ stus,ƒ¼nØis=%d..\n", 
”ºo
);

1199  
nİŞl_çl£
;

1203 
	`nİŞl_cÚn_şo£
 (
cÚn
);

1205 
™”©Ü
++;

1209 
	`nİŞl_ùx_uÄef
 (
ùx
);

1212 #ià
	`defšed
(
NOPOLL_OS_UNIX
)

1213 
	`g‘timeofday
 (&
¡İ
, 
NULL
);

1215 
	`nİŞl_wš32_g‘timeofday
 (&
¡İ
, 
NULL
);

1218 
	`nİŞl_timev®_sub¡¿ù
 (&
¡İ
, &
¡¬t
, &
diff
);

1220 
	`´štf
 ("Test 12: created %d connections in %ld.%ld secs\n",

1221 
™”©Ü
, (è
diff
.
tv_£c
, (èdiff.
tv_u£c
);

1224  
nİŞl_Œue
;

1225 
	}
}

1227 
nİŞl_boŞ
 
	$‹¡_13_‹¡
 (
noPŞlCtx
 * 
ùx
, cÚ¡ * 
£rv”Name
, cÚ¡ * 
_û¹ifiÿ‹Fe
, cÚ¡ * 
_´iv©eKey
)

1229 cÚ¡ * 
û¹ifiÿ‹Fe
;

1230 cÚ¡ * 
´iv©eKey
;

1232 ià(! 
	`nİŞl_ùx_fšd_û¹ifiÿ‹
 (
ùx
, 
£rv”Name
, 
NULL
, NULL, NULL)) {

1233 
	`´štf
 ("Test 13: it SHOULD find something‡bout found.server.com but function„eported failure status..\n");

1234  
nİŞl_çl£
;

1237 ià(! 
	`nİŞl_ùx_fšd_û¹ifiÿ‹
 (
ùx
, 
£rv”Name
, &
û¹ifiÿ‹Fe
, &
´iv©eKey
, 
NULL
)) {

1238 
	`´štf
 ("Test 13: it SHOULD find something‡bout found.server.com but function„eported failure status..\n");

1239  
nİŞl_çl£
;

1242 ià(! 
	`nİŞl_cmp
 (
û¹ifiÿ‹Fe
, 
_û¹ifiÿ‹Fe
)) {

1243 
	`´štf
 ("Te¡ 13:ƒx³ùedØfšd c”tifiÿ‹ %s, buˆfound %s\n", 
_û¹ifiÿ‹Fe
, 
û¹ifiÿ‹Fe
);

1244  
nİŞl_çl£
;

1246 ià(! 
	`nİŞl_cmp
 (
´iv©eKey
, 
_´iv©eKey
)) {

1247 
	`´štf
 ("Te¡ 13:ƒx³ùedØfšd c”tifiÿ‹ %s, buˆfound %s\n", 
_´iv©eKey
, 
´iv©eKey
);

1248  
nİŞl_çl£
;

1250  
nİŞl_Œue
;

1251 
	}
}

1253 
nİŞl_boŞ
 
	$‹¡_13
 ()

1255 
noPŞlCtx
 * 
ùx
;

1258 
ùx
 = 
	`nİŞl_ùx_Ãw
 ();

1260 ià(
	`nİŞl_ùx_fšd_û¹ifiÿ‹
 (
ùx
, "nÙ-found", 
NULL
, NULL, NULL)) {

1261 
	`´štf
 ("Test 13: it shouldn't find‡nything but function„eported ok status..\n");

1262  
nİŞl_çl£
;

1266 ià(! 
	`nİŞl_ùx_£t_û¹ifiÿ‹
 (
ùx
, "found.£rv”.com", "‹¡.üt", "‹¡.key", 
NULL
)) {

1267 
	`´štf
 ("Test 13: unableo install certificate...\n");

1268  
nİŞl_çl£
;

1271 ià(! 
	`‹¡_13_‹¡
 (
ùx
, "found.server.com", "test.crt", "test.key"))

1272  
nİŞl_çl£
;

1275 ià(! 
	`nİŞl_ùx_£t_û¹ifiÿ‹
 (
ùx
, "ªÙh”.£rv”.com", "ªÙh”.‹¡.üt", "ªÙh”.‹¡.key", 
NULL
)) {

1276 
	`´štf
 ("Test 13: unableo install certificate (another.server.com)...\n");

1277  
nİŞl_çl£
;

1281 ià(! 
	`‹¡_13_‹¡
 (
ùx
, "found.server.com", "test.crt", "test.key"))

1282  
nİŞl_çl£
;

1284 ià(! 
	`‹¡_13_‹¡
 (
ùx
, "another.server.com", "another.test.crt", "another.test.key"))

1285  
nİŞl_çl£
;

1288 ià(! 
	`nİŞl_ùx_£t_û¹ifiÿ‹
 (
ùx
, "Ùh”.£rv”.com", "Ùh”.‹¡.üt", "Ùh”.‹¡.key", 
NULL
)) {

1289 
	`´štf
 ("Test 13: unableo install certificate (another.server.com)...\n");

1290  
nİŞl_çl£
;

1293 ià(! 
	`‹¡_13_‹¡
 (
ùx
, "found.server.com", "test.crt", "test.key"))

1294  
nİŞl_çl£
;

1296 ià(! 
	`‹¡_13_‹¡
 (
ùx
, "another.server.com", "another.test.crt", "another.test.key"))

1297  
nİŞl_çl£
;

1299 ià(! 
	`‹¡_13_‹¡
 (
ùx
, "other.server.com", "other.test.crt", "other.test.key"))

1300  
nİŞl_çl£
;

1303 
	`nİŞl_ùx_uÄef
 (
ùx
);

1305  
nİŞl_Œue
;

1306 
	}
}

1308 
nİŞl_boŞ
 
	$‹¡_14
 () {

1309 
noPŞlCtx
 * 
ùx
;

1310 
noPŞlCÚn
 * 
cÚn
;

1311 
noPŞlMsg
 * 
msg
;

1312 
™”
;

1315 
ùx
 = 
	`ü—‹_ùx
 ();

1318 ià(
	`nİŞl_ùx_cÚns
 (
ùx
) != 0) {

1319 
	`´štf
 ("ERROR:ƒx³ùedØfšd 0„egi¡”ed cÚÃùiÚ buˆfound: %d\n", 
	`nİŞl_ùx_cÚns
 (
ùx
));

1320  
nİŞl_çl£
;

1323 
	`nİŞl_ùx_uÄef
 (
ùx
);

1326 
ùx
 = 
	`ü—‹_ùx
 ();

1329 
cÚn
 = 
	`nİŞl_cÚn_Ãw
 (
ùx
, "loÿlho¡", "1234", 
NULL
, NULL, NULL, NULL);

1330 ià(! 
	`nİŞl_cÚn_is_ok
 (
cÚn
)) {

1331 
	`´štf
 ("ERROR: Expectedo find…roper client connection status, but foundƒrror..\n");

1332  
nİŞl_çl£
;

1335 
	`´štf
 ("Test 14: sending…artial frames (Hel..)..\n");

1336 ià(
	`nİŞl_cÚn_£nd_‹xt_äagm’t
 (
cÚn
, "Hel", 3) != 3) {

1337 
	`´štf
 ("ERROR:ƒxpectedo be‡bleo send Hel frame..\n");

1338  
nİŞl_çl£
;

1340 
	`´štf
 ("Test 14: sending completing frame (..lo)..\n");

1341 ià(
	`nİŞl_cÚn_£nd_‹xt
 (
cÚn
, "lo", 2) != 2) {

1342 
	`´štf
 ("ERROR:ƒxpectedo be‡bleo send†o completion frame..\n");

1343  
nİŞl_çl£
;

1347 
™”
 = 0;

1348 (
msg
 = 
	`nİŞl_cÚn_g‘_msg
 (
cÚn
)è=ğ
NULL
) {

1350 ià(! 
	`nİŞl_cÚn_is_ok
 (
cÚn
)) {

1351 
	`´štf
 ("ERROR:„eceived websocket connection close during wait„eply..\n");

1352  
nİŞl_çl£
;

1355 
	`nİŞl_¦“p
 (10000);

1357 ià(
™”
 > 10)

1362 ià(! 
	`nİŞl_cmp
 ((*è
	`nİŞl_msg_g‘_·ylßd
 (
msg
), "Hello")) {

1363 
	`´štf
 ("ERROR:ƒxpectedo find message 'This is‡est' but something different was„eceived: '%s'..\n",

1364 (cÚ¡ *è
	`nİŞl_msg_g‘_·ylßd
 (
msg
));

1365  
nİŞl_çl£
;

1369 
	`nİŞl_msg_uÄef
 (
msg
);

1372 
	`nİŞl_cÚn_şo£
 (
cÚn
);

1375 
	`nİŞl_ùx_uÄef
 (
ùx
);

1377  
nİŞl_Œue
;

1378 
	}
}

1380 
nİŞl_boŞ
 
	$‹¡_15
 () {

1381 
noPŞlCtx
 * 
ùx
;

1382 
noPŞlCÚn
 * 
cÚn
;

1385 
ùx
 = 
	`ü—‹_ùx
 ();

1388 ià(
	`nİŞl_ùx_cÚns
 (
ùx
) != 0) {

1389 
	`´štf
 ("ERROR:ƒx³ùedØfšd 0„egi¡”ed cÚÃùiÚ buˆfound: %d\n", 
	`nİŞl_ùx_cÚns
 (
ùx
));

1390  
nİŞl_çl£
;

1393 
	`nİŞl_ùx_uÄef
 (
ùx
);

1396 
ùx
 = 
	`ü—‹_ùx
 ();

1399 
cÚn
 = 
	`nİŞl_cÚn_Ãw
 (
ùx
, "loÿlho¡", "1234", 
NULL
, NULL, NULL, NULL);

1400 ià(! 
	`nİŞl_cÚn_is_ok
 (
cÚn
)) {

1401 
	`´štf
 ("ERROR: Expectedo find…roper client connection status, but foundƒrror..\n");

1402  
nİŞl_çl£
;

1406 
nİŞl_Œue
) {

1407 ià(
	`nİŞl_cÚn_is_»ady
 (
cÚn
))

1409 
	`´štf
 ("Test 15:‚ot„eady yet..\n");

1410 
	`nİŞl_¦“p
 (10000);

1413 
	`´štf
 ("Test 15: setting‚on-blocking state..\n");

1415 ià(! 
	`nİŞl_cÚn_£t_sock_block
 (
	`nİŞl_cÚn_sock‘
 (
cÚn
), 
nİŞl_çl£
)) {

1416 
	`´štf
 ("ERROR: failedo configure‚on-blocking stateo connection..\n");

1417  
nİŞl_çl£
;

1420 
	`´štf
 ("Test 15:‡ttemptingo„ead content..\n");

1423 ià(
	`nİŞl_cÚn_g‘_msg
 (
cÚn
)) {

1424 
	`´štf
 ("ERROR (1):ƒxpectedo‚ot be‡bleo find‡ message..\n");

1425  
nİŞl_çl£
;

1427 ià(
	`nİŞl_cÚn_g‘_msg
 (
cÚn
)) {

1428 
	`´štf
 ("ERROR (2):ƒxpectedo‚ot be‡bleo find‡ message..\n");

1429  
nİŞl_çl£
;

1431 ià(
	`nİŞl_cÚn_g‘_msg
 (
cÚn
)) {

1432 
	`´štf
 ("ERROR (3):ƒxpectedo‚ot be‡bleo find‡ message..\n");

1433  
nİŞl_çl£
;

1436 
	`´štf
 ("Test 15:„eads finished..\n");

1439 ià(! 
	`nİŞl_cÚn_is_ok
 (
cÚn
)) {

1440 
	`´štf
 ("ERROR:ƒxpectedo find connection state ok, but failure found..\n");

1441  
nİŞl_çl£
;

1445 
	`nİŞl_cÚn_şo£
 (
cÚn
);

1448 
	`nİŞl_ùx_uÄef
 (
ùx
);

1450  
nİŞl_Œue
;

1451 
	}
}

1453 
nİŞl_boŞ
 
	$‹¡_16
 () {

1454 
noPŞlCtx
 * 
ùx
;

1455 
noPŞlCÚn
 * 
cÚn
;

1456 
™”©Ü
;

1459 
ùx
 = 
	`ü—‹_ùx
 ();

1462 ià(
	`nİŞl_ùx_cÚns
 (
ùx
) != 0) {

1463 
	`´štf
 ("ERROR:ƒx³ùedØfšd 0„egi¡”ed cÚÃùiÚ buˆfound: %d\n", 
	`nİŞl_ùx_cÚns
 (
ùx
));

1464  
nİŞl_çl£
;

1467 
	`nİŞl_ùx_uÄef
 (
ùx
);

1470 
ùx
 = 
	`ü—‹_ùx
 ();

1473 
cÚn
 = 
	`nİŞl_cÚn_Ãw
 (
ùx
, "loÿlho¡", "1234", 
NULL
, NULL, NULL, NULL);

1474 ià(! 
	`nİŞl_cÚn_is_ok
 (
cÚn
)) {

1475 
	`´štf
 ("ERROR: Expectedo find…roper client connection status, but foundƒrror..\n");

1476  
nİŞl_çl£
;

1480 
nİŞl_Œue
) {

1481 ià(
	`nİŞl_cÚn_is_»ady
 (
cÚn
))

1483 
	`´štf
 ("Test 16:‚ot„eady yet..\n");

1484 
	`nİŞl_¦“p
 (10000);

1487 
™”©Ü
 = 0;

1488 
™”©Ü
 < 10) {

1489 
	`´štf
 ("Te¡ 16: s’d sË• iÀh—d” cÚ‹Á (wa™šg 1000 ms, i‹¿tÜ=%d)..\n", 
™”©Ü
);

1490 ià(
	`__nİŞl_cÚn_£nd_commÚ
 (
cÚn
, "Thi i ¨‹¡", 14, 
nİŞl_Œue
, 400000, 
NOPOLL_TEXT_FRAME
) != 14) {

1491 
	`´štf
 ("ERROR: failedo send content..\n");

1492  
nİŞl_çl£
;

1495 
™”©Ü
++;

1498 
	`´štf
 ("Test 16: sends finished,‚ow checking connection ..\n");

1500 
	`nİŞl_¦“p
 (100000);

1503 ià(! 
	`nİŞl_cÚn_is_ok
 (
cÚn
)) {

1504 
	`´štf
 ("ERROR:ƒxpectedo find connection state ok, but failure found..\n");

1505  
nİŞl_çl£
;

1509 
	`nİŞl_cÚn_şo£
 (
cÚn
);

1512 
	`nİŞl_ùx_uÄef
 (
ùx
);

1514  
nİŞl_Œue
;

1515 
	}
}

1517 
nİŞl_boŞ
 
	$‹¡_17_£nd_ªd_»ûive_‹¡
 (
noPŞlCtx
 * 
ùx
, 
noPŞlCÚn
 * 
cÚn
,‚oPŞlCÚÀ* 
li¡’”
,

1518 cÚ¡ * 
mes§ge
, 
Ëngth
, 
nİŞl_boŞ
 
»ad_š_the_middË
,

1519 
nİŞl_boŞ
 
»ad_aá”_h—d”
,‚İŞl_boŞ 
»ad_aá”_mask
)

1521 
bufãr
[1024];

1522 
bufãr2
[1024];

1523 
NOPOLL_SOCKET
 
_sock‘
;

1524 
mask
[4];

1525 
de¥
;

1527 
	`mem£t
 (
bufãr
, 0, 1024);

1530 
	`nİŞl_cÚn_£t_sock_block
 (
	`nİŞl_cÚn_sock‘
 (
li¡’”
), 
nİŞl_çl£
);

1533 
	`´štf
 ("Test 17: sending‚ormal messageoest†ink..\n");

1534 ià(
	`nİŞl_cÚn_£nd_‹xt
 (
cÚn
, 
mes§ge
, 
Ëngth
) !=†ength) {

1535 
	`´štf
 ("ERROR:ƒxpectedo…roperly send‡ll bytes but it wasn't…ossible..\n");

1536  
nİŞl_çl£
;

1540 ià(
	`nİŞl_cÚn_»ad
 (
li¡’”
, 
bufãr
, 
Ëngth
, 
nİŞl_Œue
, 0) !=†ength) {

1541 
	`´štf
 ("ERROR:ƒxpected„ead 22 bytes ...buthere was‡ failure..\n");

1542  
nİŞl_çl£
;

1546 
_sock‘
 = 
	`nİŞl_cÚn_sock‘
 (
cÚn
);

1547 
bufãr
[0] = 129;

1548 
bufãr
[1] = 150;

1549 
	`£nd
 (
_sock‘
, 
bufãr
, 2, 0);

1551 ià(
»ad_aá”_h—d”
) {

1552 
	`nİŞl_¦“p
 (1000000);

1553 
	`´štf
 ("Test 17: Reading‡fter header..\n");

1554 
	`nİŞl_cÚn_»ad
 (
li¡’”
, 
bufãr2
, 
Ëngth
, 
nİŞl_çl£
, 0);

1558 
mask
[0] = 23;

1559 
mask
[1] = 24;

1560 
mask
[2] = 25;

1561 
mask
[3] = 26;

1562 
	`£nd
 (
_sock‘
, 
mask
, 4, 0);

1564 ià(
»ad_aá”_mask
) {

1565 
	`nİŞl_¦“p
 (1000000);

1566 
	`´štf
 ("Test 17: Reading‡fter mask..\n");

1567 
	`nİŞl_cÚn_»ad
 (
li¡’”
, 
bufãr2
, 
Ëngth
, 
nİŞl_çl£
, 0);

1570 
	`memıy
 (
bufãr
, 
mes§ge
, 
Ëngth
);

1571 
	`nİŞl_cÚn_mask_cÚ‹Á
 (
ùx
, 
bufãr
, 
Ëngth
, 
mask
, 0);

1573 
	`£nd
 (
_sock‘
, 
bufãr
, 10, 0);

1574 
	`´štf
 ("Test 17: sent…artial content...wait‡ bit (2 seconds)..\n");

1575 
	`nİŞl_¦“p
 (2000000);

1577 
de¥
 = 0;

1578 ià(
»ad_š_the_middË
) {

1579 
	`´štf
 ("Test 17:„eading inhe middle (10 bytes)\n");

1580 
	`mem£t
 (
bufãr2
, 0, 100);

1581 
de¥
 = 
	`nİŞl_cÚn_»ad
 (
li¡’”
, 
bufãr2
, 
Ëngth
, 
nİŞl_çl£
, 0);

1582 ià(
de¥
 != 10) {

1583 
	`´štf
 ("Te¡ 17: faedØ»ad somš™ŸÈcÚ‹Á (10), found %d by‹s..\n", 
de¥
);

1584  
nİŞl_çl£
;

1587 
	`´štf
 ("Te¡ 17:„—d %d by‹s..\n", 
de¥
);

1590 
	`´štf
 ("Test 17:‚ow sendhe„est..\n");

1591 
	`£nd
 (
_sock‘
, 
bufãr
 + 10, 
Ëngth
 - 10, 0);

1594 ià(
»ad_š_the_middË
)

1595 
	`memıy
 (
bufãr
, 
bufãr2
, 
de¥
);

1597 
	`´štf
 ("Test 17:‚ow„eadhe content„eceived..\n");

1599 ià(
	`nİŞl_cÚn_»ad
 (
li¡’”
, 
bufãr
 + 
de¥
, 
Ëngth
 - de¥, 
nİŞl_Œue
, 0) != (length - desp)) {

1600 
	`´štf
 ("ERROR:ƒxpectedo„eceive 22 bytes but found something different..\n");

1601  
nİŞl_çl£
;

1604 ià(! 
	`nİŞl_ncmp
 (
bufãr
, 
mes§ge
, 
Ëngth
)) {

1605 
	`´štf
 ("ERROR:ƒx³ùedØ»ûiv‹¡ mes§gbuˆfound: '%s'\n", 
bufãr
);

1606  
nİŞl_çl£
;

1609  
nİŞl_Œue
;

1610 
	}
}

1612 
nİŞl_boŞ
 
	$‹¡_17
 () {

1614 
noPŞlCtx
 * 
ùx
;

1615 
noPŞlCÚn
 * 
cÚn
;

1616 
noPŞlCÚn
 * 
li¡’”
, * 
ma¡”
;

1619 
ùx
 = 
	`ü—‹_ùx
 ();

1622 
ma¡”
 = 
	`nİŞl_li¡’”_Ãw
 (
ùx
, "0.0.0.0", "22351");

1623 
	`´štf
 ("Test 17: created master†istener (conn-id=%d, status=%d)\n",

1624 
	`nİŞl_cÚn_g‘_id
 (
ma¡”
), 
	`nİŞl_cÚn_is_ok
 (master));

1625 ià(! 
	`nİŞl_cÚn_is_ok
 (
ma¡”
)) {

1626 
	`´štf
 ("ERROR:ƒxpected…roper master†istener‡t 0.0.0.0:2235 creation but‡ failure was found..\n");

1627  
nİŞl_çl£
;

1631 
cÚn
 = 
	`nİŞl_cÚn_Ãw
 (
ùx
, "loÿlho¡", "22351", 
NULL
, NULL, NULL, NULL);

1632 ià(! 
	`nİŞl_cÚn_is_ok
 (
cÚn
)) {

1633 
	`´štf
 ("ERROR: Expectedo find…roper client connection status, but foundƒrror..\n");

1634  
nİŞl_çl£
;

1639 
	`´štf
 ("Test 17:‡ccepting†istener..\n");

1640 
li¡’”
 = 
	`nİŞl_cÚn_acû±
 (
ùx
, 
ma¡”
);

1642 ià(! 
	`nİŞl_cÚn_is_ok
 (
li¡’”
)) {

1643 
	`´štf
 ("ERROR:ƒxpectedo find…roper†istener status (connection‡ccepted), but found failure..\n");

1644  
nİŞl_çl£
;

1648 ià(! 
	`‹¡_17_£nd_ªd_»ûive_‹¡
 (
ùx
, 
cÚn
, 
li¡’”
, "This is‡est message", 22,

1650 
nİŞl_çl£
,

1652 
nİŞl_çl£
,

1654 
nİŞl_çl£
))

1655  
nİŞl_çl£
;

1658 ià(! 
	`‹¡_17_£nd_ªd_»ûive_‹¡
 (
ùx
, 
cÚn
, 
li¡’”
, "This is‡est message", 22,

1660 
nİŞl_Œue
,

1662 
nİŞl_çl£
,

1664 
nİŞl_çl£
))

1665  
nİŞl_çl£
;

1668 ià(! 
	`‹¡_17_£nd_ªd_»ûive_‹¡
 (
ùx
, 
cÚn
, 
li¡’”
, "This is‡est message", 22,

1670 
nİŞl_çl£
,

1672 
nİŞl_Œue
,

1674 
nİŞl_çl£
))

1675  
nİŞl_çl£
;

1678 ià(! 
	`‹¡_17_£nd_ªd_»ûive_‹¡
 (
ùx
, 
cÚn
, 
li¡’”
, "This is‡est message", 22,

1680 
nİŞl_çl£
,

1682 
nİŞl_çl£
,

1684 
nİŞl_Œue
))

1685  
nİŞl_çl£
;

1687 
	`´štf
 ("Test 17: closing connections..\n");

1688 
	`nİŞl_cÚn_şo£
 (
li¡’”
);

1689 
	`nİŞl_cÚn_şo£
 (
ma¡”
);

1690 
	`nİŞl_cÚn_şo£
 (
cÚn
);

1692 
	`´štf
 ("Test 17: finishing context..\n");

1695 
	`nİŞl_ùx_uÄef
 (
ùx
);

1698  
nİŞl_Œue
;

1699 
	}
}

1701 
nİŞl_boŞ
 
	$‹¡_18
 () {

1703 
noPŞlCtx
 * 
ùx
;

1704 
noPŞlCÚn
 * 
cÚn
;

1705 
noPŞlCÚnO±s
 * 
İts
;

1708 
ùx
 = 
	`ü—‹_ùx
 ();

1711 
İts
 = 
	`nİŞl_cÚn_İts_Ãw
 ();

1712 
	`nİŞl_cÚn_İts_s¦_³”_v”ify
 (
İts
, 
nİŞl_çl£
);

1715 
cÚn
 = 
	`nİŞl_cÚn_s_Ãw
 (
ùx
, 
İts
, "loÿlho¡", "1235", 
NULL
, NULL, NULL, NULL);

1716 ià(! 
	`nİŞl_cÚn_is_ok
 (
cÚn
)) {

1717 
	`´štf
 ("ERROR: Expectedo find…roper client connection status, but foundƒrror..\n");

1718  
nİŞl_çl£
;

1721 
	`´štf
 ("Test 18: waiting on‚opoll_loop_wait (1 seconds)...\n");

1722 
	`nİŞl_loİ_wa™
 (
ùx
, 1);

1723 
	`´štf
 ("Test 18: waiting on‚opoll_loop_wait (1 seconds)...\n");

1724 
	`nİŞl_loİ_wa™
 (
ùx
, 1);

1727 
	`nİŞl_cÚn_şo£
 (
cÚn
);

1730 
	`nİŞl_ùx_uÄef
 (
ùx
);

1733  
nİŞl_Œue
;

1734 
	}
}

1736 
nİŞl_boŞ
 
	$‹¡_19
 () {

1738 
noPŞlCtx
 * 
ùx
;

1739 
noPŞlCÚn
 * 
cÚn
;

1740 
noPŞlCÚnO±s
 * 
İts
;

1743 
ùx
 = 
	`ü—‹_ùx
 ();

1745 
	`´štf
 ("Test 19:esting SSLv23 connection...\n");

1748 
İts
 = 
	`nİŞl_cÚn_İts_Ãw
 ();

1749 
	`nİŞl_cÚn_İts_£t_s¦_´ÙocŞ
 (
İts
, 
NOPOLL_METHOD_SSLV23
);

1752 
cÚn
 = 
	`nİŞl_cÚn_s_Ãw
 (
ùx
, 
İts
, "loÿlho¡", "1236", 
NULL
, NULL, NULL, NULL);

1755 ià(! 
	`nİŞl_cÚn_is_ok
 (
cÚn
)) {

1756 
	`´štf
 ("ERROR: failedo start†istener connection..\n");

1757  
nİŞl_çl£
;

1760 ià(! 
	`‹¡_£ndšg_ªd_check_echo
 (
cÚn
, "Test 19", "This is‡est...checking SSL with different values..."))

1761  
nİŞl_çl£
;

1764 
	`nİŞl_cÚn_şo£
 (
cÚn
);

1766 
	`´štf
 ("Test 19:esting SSLv23 connection with TLSv1 server...\n");

1769 
İts
 = 
	`nİŞl_cÚn_İts_Ãw
 ();

1770 
	`nİŞl_cÚn_İts_£t_s¦_´ÙocŞ
 (
İts
, 
NOPOLL_METHOD_SSLV23
);

1773 
cÚn
 = 
	`nİŞl_cÚn_s_Ãw
 (
ùx
, 
İts
, "loÿlho¡", "1235", 
NULL
, NULL, NULL, NULL);

1776 ià(! 
	`nİŞl_cÚn_is_ok
 (
cÚn
)) {

1777 
	`´štf
 ("WARNING: failedo create connection (2)..unableo connecto TLSv1 server with NOPOLL_METHOD_SSLV23\n");

1779 ià(! 
	`‹¡_£ndšg_ªd_check_echo
 (
cÚn
, "Test 19", "This is‡est...checking SSL with different values..."))

1780  
nİŞl_çl£
;

1783 
	`nİŞl_cÚn_şo£
 (
cÚn
);

1785 
	`´štf
 ("Test 19:…erfect, got it working..\n");

1788 
İts
 = 
	`nİŞl_cÚn_İts_Ãw
 ();

1789 
	`nİŞl_cÚn_İts_£t_s¦_´ÙocŞ
 (
İts
, 
NOPOLL_METHOD_SSLV3
);

1792 
	`´štf
 ("Test 19: checking SSLv3 with TLSv1..\n");

1793 
cÚn
 = 
	`nİŞl_cÚn_s_Ãw
 (
ùx
, 
İts
, "loÿlho¡", "1234", 
NULL
, NULL, NULL, NULL);

1796 ià(
	`nİŞl_cÚn_is_ok
 (
cÚn
)) {

1797 
	`´štf
 ("ERROR:ƒxpected‡ connection failure..\n");

1798  
nİŞl_çl£
;

1800 
	`´štf
 (" ... it does‚ot work, buthis isƒxpected..\n");

1802 
	`nİŞl_cÚn_şo£
 (
cÚn
);

1805 
	`nİŞl_ùx_uÄef
 (
ùx
);

1808  
nİŞl_Œue
;

1809 
	}
}

1811 #ià
defšed
(
__NOPOLL_PTHREAD_SUPPORT__
)

1812 
nİŞl_boŞ
 
	$‹¡_20
 () {

1814 
noPŞlPŒ
 * 
mu‹x
;

1815 
™”©Ü
 = 0;

1818 
™”©Ü
 < 10) {

1820 
mu‹x
 = 
	`__nİŞl_»g‹¡_mu‹x_ü—‹
 ();

1821 ià(
mu‹x
 =ğ
NULL
)

1822  
nİŞl_çl£
;

1825 
	`__nİŞl_»g‹¡_mu‹x_lock
 (
mu‹x
);

1826 
	`__nİŞl_»g‹¡_mu‹x_uÆock
 (
mu‹x
);

1829 
	`__nİŞl_»g‹¡_mu‹x_de¡roy
 (
mu‹x
);

1832 
™”©Ü
++;

1835  
nİŞl_Œue
;

1836 
	}
}

1843 
nİŞl_boŞ
 
	$‹¡_21
 () {

1845 
noPŞlCtx
 * 
ùx
;

1846 
noPŞlCÚn
 * 
cÚn
;

1847 
noPŞlCÚnO±s
 * 
İts
;

1850 
ùx
 = 
	`ü—‹_ùx
 ();

1853 
	`´štf
 ("Test 21: check ssl connection (with‡uth certificate)..\n");

1854 
cÚn
 = 
	`nİŞl_cÚn_s_Ãw
 (
ùx
, 
NULL
, "localhost", "1239", NULL, NULL, NULL, NULL);

1855 ià(
	`nİŞl_cÚn_is_ok
 (
cÚn
)) {

1856 
	`´štf
 ("ERROR: Expectedo FAILURE client connection status, but ok..\n");

1857  
nİŞl_çl£
;

1859 
	`nİŞl_cÚn_şo£
 (
cÚn
);

1862 
	`´štf
 ("Test 21: checkingo connect‡gain with client…rovided certificates..\n");

1863 
İts
 = 
	`nİŞl_cÚn_İts_Ãw
 ();

1864 
	`nİŞl_cÚn_İts_£t_s¦_û¹s
 (
İts
,

1869 
NULL
,

1872 
cÚn
 = 
	`nİŞl_cÚn_s_Ãw
 (
ùx
, 
İts
, "loÿlho¡", "1239", 
NULL
, NULL, NULL, NULL);

1873 ià(! 
	`‹¡_£ndšg_ªd_check_echo
 (
cÚn
, "Test 21", "This is‡est")) {

1874 
	`´štf
 ("ERROR: it should WORK, client certificate isn't working..\n");

1875  
nİŞl_çl£
;

1879 
	`nİŞl_cÚn_şo£
 (
cÚn
);

1882 
	`nİŞl_ùx_uÄef
 (
ùx
);

1884  
nİŞl_Œue
;

1885 
	}
}

1888 
nİŞl_boŞ
 
	g__‹¡_22_Ú_şo£_sigÇl
 = 
nİŞl_çl£
;

1890 
	$__‹¡_22_Ú_şo£
 (
noPŞlCtx
 * 
ùx
, 
noPŞlCÚn
 * 
cÚn
, 
noPŞlPŒ
 
u£r_d©a
)

1892 
	`´štf
 ("Te¡ --: c®Ëd oÀcÚÃùiÚ clo£ fÜ cÚn-id=%d\n", 
	`nİŞl_cÚn_g‘_id
 (
cÚn
));

1893 
__‹¡_22_Ú_şo£_sigÇl
 = 
nİŞl_Œue
;

1896 
	}
}

1898 
nİŞl_boŞ
 
	$‹¡_22
 () {

1900 
noPŞlCtx
 * 
ùx
;

1901 
noPŞlCÚn
 * 
cÚn
;

1902 
NOPOLL_SOCKET
 
_sock‘
;

1903 
noPŞlMsg
 * 
msg
;

1904 
noPŞlCÚnO±s
 * 
İts
;

1906 
	`´štf
 ("Test 22:esting connection close‚otification for„egular connections (client side)..\n");

1909 
ùx
 = 
	`ü—‹_ùx
 ();

1912 
cÚn
 = 
	`nİŞl_cÚn_Ãw
 (
ùx
, "loÿlho¡", "1234", 
NULL
, NULL, NULL, NULL);

1913 ià(! 
	`nİŞl_cÚn_is_ok
 (
cÚn
)) {

1914 
	`´štf
 ("ERROR: Expectedo find…roper client connection status, but foundƒrror..\n");

1915  
nİŞl_çl£
;

1919 
	`nİŞl_cÚn_£t_Ú_şo£
 (
cÚn
, 
__‹¡_22_Ú_şo£
, 
NULL
);

1922 
_sock‘
 = 
	`nİŞl_cÚn_sock‘
 (
cÚn
);

1923 
	`nİŞl_şo£_sock‘
 (
_sock‘
);

1926 
msg
 = 
	`nİŞl_cÚn_g‘_msg
 (
cÚn
);

1927 ià(
msg
) {

1928 
	`´štf
 ("ERROR: we shouldn't get‡ msg frame, but‡ well defined…ointer was found..\n");

1929  
nİŞl_çl£
;

1932 ià(
	`nİŞl_cÚn_is_ok
 (
cÚn
)) {

1933 
	`´štf
 ("ERROR: we shouldn't get‡n ok value from‚opoll_conn_is_ok (conn)..\n");

1934  
nİŞl_çl£
;

1937 ià(! 
__‹¡_22_Ú_şo£_sigÇl
) {

1938 
	`´štf
 ("ERROR: connection close should've been called but it wasn't..\n");

1939  
nİŞl_çl£
;

1943 
	`nİŞl_cÚn_şo£
 (
cÚn
);

1945 
__‹¡_22_Ú_şo£_sigÇl
 = 
nİŞl_çl£
;

1946 
	`´štf
 ("Test 22:est close connection close‚otification for WSS:// (ssl connections), (client side)..\n");

1949 
İts
 = 
	`nİŞl_cÚn_İts_Ãw
 ();

1950 
	`nİŞl_cÚn_İts_s¦_³”_v”ify
 (
İts
, 
nİŞl_çl£
);

1953 
cÚn
 = 
	`nİŞl_cÚn_s_Ãw
 (
ùx
, 
İts
, "loÿlho¡", "1235", 
NULL
, NULL, NULL, NULL);

1954 ià(! 
	`nİŞl_cÚn_is_ok
 (
cÚn
)) {

1955 
	`´štf
 ("ERROR: Expectedo find…roper client connection status, but foundƒrror..\n");

1956  
nİŞl_çl£
;

1960 
	`nİŞl_cÚn_£t_Ú_şo£
 (
cÚn
, 
__‹¡_22_Ú_şo£
, 
NULL
);

1963 
_sock‘
 = 
	`nİŞl_cÚn_sock‘
 (
cÚn
);

1964 
	`nİŞl_şo£_sock‘
 (
_sock‘
);

1967 
msg
 = 
	`nİŞl_cÚn_g‘_msg
 (
cÚn
);

1968 ià(
msg
) {

1969 
	`´štf
 ("ERROR: we shouldn't get‡ msg frame, but‡ well defined…ointer was found..\n");

1970  
nİŞl_çl£
;

1973 ià(
	`nİŞl_cÚn_is_ok
 (
cÚn
)) {

1974 
	`´štf
 ("ERROR: we shouldn't get‡n ok value from‚opoll_conn_is_ok (conn)..\n");

1975  
nİŞl_çl£
;

1978 ià(! 
__‹¡_22_Ú_şo£_sigÇl
) {

1979 
	`´štf
 ("ERROR: connection close should've been called but it wasn't..\n");

1980  
nİŞl_çl£
;

1984 
	`nİŞl_cÚn_şo£
 (
cÚn
);

1987 
	`nİŞl_ùx_uÄef
 (
ùx
);

1988  
nİŞl_Œue
;

1989 
	}
}

1991 
	$‹¡_23_g‘_cÚÃùiÚ_şo£_couÁ
 (
noPŞlCtx
 * 
ùx
, 
noPŞlCÚn
 * 
cÚn
) {

1993 
couÁ_befÜe_şosšg
;

1994 
noPŞlMsg
 * 
msg
;

1997 
nİŞl_Œue
) {

1998 ià(
	`nİŞl_cÚn_is_»ady
 (
cÚn
))

2000 
	`nİŞl_¦“p
 (10000);

2004 ià(
	`nİŞl_cÚn_£nd_‹xt
 (
cÚn
, "get-connection-close-count", 26) != 26) {

2005 
	`´štf
 ("ERROR: Expectedo find…roper send operation..\n");

2006  
nİŞl_çl£
;

2010 
nİŞl_Œue
) {

2011 
msg
 = 
	`nİŞl_cÚn_g‘_msg
 (
cÚn
);

2012 ià(
msg
)

2015 
	`nİŞl_¦“p
 (10000);

2019 
couÁ_befÜe_şosšg
 = 
	`¡¹od
 ((cÚ¡ *è
	`nİŞl_msg_g‘_·ylßd
 (
msg
), 
NULL
);

2020 
	`´štf
 ("Te¡ 23: Mes§g»ûived: %d..\n", 
couÁ_befÜe_şosšg
);

2022 
	`nİŞl_msg_uÄef
 (
msg
);

2024  
couÁ_befÜe_şosšg
;

2025 
	}
}

2027 
nİŞl_boŞ
 
	$‹¡_23
 () {

2029 
noPŞlCtx
 * 
ùx
;

2030 
noPŞlCÚn
 * 
cÚn
;

2031 
couÁ_befÜe_şosšg
;

2032 
couÁ_befÜe_şosšg2
;

2033 
noPŞlCÚnO±s
 * 
İts
;

2035 
	`´štf
 ("Test 23:esting connection close‚otification for„egular connections (client side)..\n");

2038 
ùx
 = 
	`ü—‹_ùx
 ();

2041 
cÚn
 = 
	`nİŞl_cÚn_Ãw
 (
ùx
, "loÿlho¡", "1234", 
NULL
, NULL, NULL, NULL);

2042 ià(! 
	`nİŞl_cÚn_is_ok
 (
cÚn
)) {

2043 
	`´štf
 ("ERROR: Expectedo find…roper client connection status, but foundƒrror..\n");

2044  
nİŞl_çl£
;

2048 ià((
couÁ_befÜe_şosšg
 = 
	`‹¡_23_g‘_cÚÃùiÚ_şo£_couÁ
 (
ùx
, 
cÚn
)) == -1)

2049  
nİŞl_çl£
;

2050 
	`´štf
 ("Te¡ 23: cu¼’ˆcÚÃùiÚ clo£ is: %d\n", 
couÁ_befÜe_şosšg
);

2053 
	`nİŞl_cÚn_şo£
 (
cÚn
);

2056 
cÚn
 = 
	`nİŞl_cÚn_Ãw
 (
ùx
, "loÿlho¡", "1234", 
NULL
, NULL, NULL, NULL);

2057 ià(! 
	`nİŞl_cÚn_is_ok
 (
cÚn
)) {

2058 
	`´štf
 ("ERROR: Expectedo find…roper client connection status, but foundƒrror..\n");

2059  
nİŞl_çl£
;

2062 ià((
couÁ_befÜe_şosšg2
 = 
	`‹¡_23_g‘_cÚÃùiÚ_şo£_couÁ
 (
ùx
, 
cÚn
)) == -1)

2063  
nİŞl_çl£
;

2064 
	`´štf
 ("Te¡ 23: cu¼’ˆcÚÃùiÚ clo£ is: %d\n", 
couÁ_befÜe_şosšg2
);

2066 ià(
couÁ_befÜe_şosšg
 =ğ
couÁ_befÜe_şosšg2
) {

2067 
	`´štf
 ("ERROR:ƒxpected connection close‚otification ...but same values were found..\n");

2068  
nİŞl_çl£
;

2072 
	`nİŞl_cÚn_şo£
 (
cÚn
);

2074 
	`´štf
 ("Test 23:‚owest TLS connections connection close..\n");

2077 
İts
 = 
	`nİŞl_cÚn_İts_Ãw
 ();

2078 
	`nİŞl_cÚn_İts_s¦_³”_v”ify
 (
İts
, 
nİŞl_çl£
);

2081 
cÚn
 = 
	`nİŞl_cÚn_s_Ãw
 (
ùx
, 
İts
, "loÿlho¡", "1235", 
NULL
, NULL, NULL, NULL);

2082 ià(! 
	`nİŞl_cÚn_is_ok
 (
cÚn
)) {

2083 
	`´štf
 ("ERROR: Expectedo find…roper client connection status, but foundƒrror..\n");

2084  
nİŞl_çl£
;

2088 ià((
couÁ_befÜe_şosšg
 = 
	`‹¡_23_g‘_cÚÃùiÚ_şo£_couÁ
 (
ùx
, 
cÚn
)) == -1)

2089  
nİŞl_çl£
;

2092 
	`nİŞl_cÚn_şo£
 (
cÚn
);

2095 
İts
 = 
	`nİŞl_cÚn_İts_Ãw
 ();

2096 
	`nİŞl_cÚn_İts_s¦_³”_v”ify
 (
İts
, 
nİŞl_çl£
);

2097 
cÚn
 = 
	`nİŞl_cÚn_s_Ãw
 (
ùx
, 
İts
, "loÿlho¡", "1235", 
NULL
, NULL, NULL, NULL);

2098 ià(! 
	`nİŞl_cÚn_is_ok
 (
cÚn
)) {

2099 
	`´štf
 ("ERROR: Expectedo find…roper client connection status, but foundƒrror..\n");

2100  
nİŞl_çl£
;

2103 ià((
couÁ_befÜe_şosšg2
 = 
	`‹¡_23_g‘_cÚÃùiÚ_şo£_couÁ
 (
ùx
, 
cÚn
)) == -1)

2104  
nİŞl_çl£
;

2107 
	`nİŞl_cÚn_şo£
 (
cÚn
);

2109 ià(
couÁ_befÜe_şosšg
 =ğ
couÁ_befÜe_şosšg2
) {

2110 
	`´štf
 ("ERROR:ƒxpected connection close‚otification ...but same values were found..\n");

2111  
nİŞl_çl£
;

2114 
	`nİŞl_ùx_uÄef
 (
ùx
);

2115  
nİŞl_Œue
;

2116 
	}
}

2118 
nİŞl_boŞ
 
	$‹¡_24
 () {

2120 
noPŞlCtx
 * 
ùx
;

2121 
noPŞlCÚn
 * 
cÚn
;

2122 
noPŞlCÚnO±s
 * 
İts
;

2123 
noPŞlMsg
 * 
msg
;

2125 
	`´štf
 ("Test 24:est cookie support (set client‡nd„eceive on server..)\n");

2128 
ùx
 = 
	`ü—‹_ùx
 ();

2131 
İts
 = 
	`nİŞl_cÚn_İts_Ãw
 ();

2132 
	`nİŞl_cÚn_İts_£t_cook›
 (
İts
, "theme=light; sessionToken=abc123");

2135 
cÚn
 = 
	`nİŞl_cÚn_Ãw_İts
 (
ùx
, 
İts
, "loÿlho¡", "1234", 
NULL
, NULL, NULL, NULL);

2136 ià(! 
	`nİŞl_cÚn_is_ok
 (
cÚn
)) {

2137 
	`´štf
 ("ERROR: Expectedo find…roper client connection status, but foundƒrror..\n");

2138  
nİŞl_çl£
;

2142 ià(
	`nİŞl_cÚn_£nd_‹xt
 (
cÚn
, "get-cookie", 10) != 10) {

2143 
	`´štf
 ("ERROR: Expectedo find…roper send operation..\n");

2144  
nİŞl_çl£
;

2148 
nİŞl_Œue
) {

2149 
msg
 = 
	`nİŞl_cÚn_g‘_msg
 (
cÚn
);

2150 ià(
msg
)

2153 ià(! 
	`nİŞl_cÚn_is_ok
 (
cÚn
)) {

2154 
	`´štf
 ("ERROR: connection failure found during message wait..\n");

2155  
nİŞl_çl£
;

2158 
	`nİŞl_¦“p
 (10000);

2161 
	`´štf
 ("Te¡ 24:„eûived h—d” s‘ oÀ£rv” side: %s\n", 
	`nİŞl_msg_g‘_·ylßd
 (
msg
));

2162 ià(! 
	`nİŞl_cmp
 ((cÚ¡ *è
	`nİŞl_msg_g‘_·ylßd
 (
msg
), "theme=light; sessionToken=abc123")) {

2163 
	`´štf
 ("ERROR:ƒx³ùedØ»ûivdifã»Á h—d”,ƒ¼Ü was: %s\n", 
	`nİŞl_msg_g‘_·ylßd
 (
msg
));

2164  
nİŞl_çl£
;

2168 
	`nİŞl_msg_uÄef
 (
msg
);

2172 
	`nİŞl_cÚn_şo£
 (
cÚn
);

2175 
	`nİŞl_ùx_uÄef
 (
ùx
);

2176  
nİŞl_Œue
;

2177 
	}
}

2179 
nİŞl_boŞ
 
	$‹¡_25_check_cook›
 (
noPŞlCtx
 * 
ùx
, cÚ¡ * 
cook›
) {

2180 
noPŞlCÚn
 * 
cÚn
;

2181 
noPŞlCÚnO±s
 * 
İts
;

2184 
İts
 = 
	`nİŞl_cÚn_İts_Ãw
 ();

2187 
	`nİŞl_cÚn_İts_£t_cook›
 (
İts
, 
cook›
);

2190 
cÚn
 = 
	`nİŞl_cÚn_Ãw_İts
 (
ùx
, 
İts
, "loÿlho¡", "1234", 
NULL
, NULL, NULL, NULL);

2191 ià(! 
	`nİŞl_cÚn_is_ok
 (
cÚn
)) {

2192 
	`´štf
 ("ERROR: Expectedo find…roper client connection status, but foundƒrror..\n");

2193  
nİŞl_çl£
;

2198 
	`nİŞl_cÚn_şo£
 (
cÚn
);

2200  
nİŞl_Œue
;

2201 
	}
}

2203 
nİŞl_boŞ
 
	$‹¡_25
 () {

2205 
noPŞlCtx
 * 
ùx
;

2207 
	`´štf
 ("Test 25:est cookie support (set client‡nd„eceive on server..)\n");

2210 
ùx
 = 
	`ü—‹_ùx
 ();

2212 ià(! 
	`‹¡_25_check_cook›
 (
ùx
, "theme=light; sessionToken=abc123†kjsadfkljasdf†kjaseflkawjet klajw glkajy240u 4234lkj y3j 3q5yÃ±kl‡egar glkejry bheme=light; sessionToken=abc123†kjsadfkljasdf†kjaseflkawjet klajw glkajy240u 4234lkj y3j 3q5yÃ±kl‡egar glkejry bheme=light; sessionToken=abc123†kjsadfkljasdf†kjaseflkawjet klajw glkajy240u 4234lkj y3j 3q5yÃ±kl‡egar glkejry bheme=light; sessionToken=abc123†kjsadfkljasdf†kjaseflkawjet klajw glkajy240u 4234lkj y3j 3q5yÃ±kl‡egar glkejry bheme=light; sessionToken=abc123†kjsadfkljasdf†kjaseflkawjet klajw glkajy240u 4234lkj y3j 3q5yÃ±kl‡egar glkejry bheme=light; sessionToken=abc123†kjsadfkljasdf†kjaseflkawjet klajw glkajy240u 4234lkj y3j 3q5yÃ±kl‡egar glkejry bheme=light; sessionToken=abc123†kjsadfkljasdf†kjaseflkawjet klajw glkajy240u 4234lkj y3j 3q5yÃ±kl‡egar glkejry bheme=light; sessionToken=abc123†kjsadfkljasdf†kjaseflkawjet klajw glkajy240u 4234lkj y3j 3q5yÃ±kl‡egar glkejry bheme=light; sessionToken=abc123†kjsadfkljasdf†kjaseflkawjet klajw glkajy240u 4234lkj y3j 3q5yÃ±kl‡egar glkejry b "))

2213  
nİŞl_çl£
;

2216 ià(! 
	`‹¡_25_check_cook›
 (
ùx
, "222222222222222222222211111111111111111111111133333333333333333333333334444444444444444444444444222222222222222222222211111111111111111111111133333333333333333333333334444444444444444444444444222222222222222222222211111111111111111111111133333333333333333333333334444444444444444444444444222222222222222222222211111111111111111111111133333333333333333333333334444444444444444444444444222222222222222222222211111111111111111111111133333333333333333333333334444444444444444444444444222222222222222222222211111111111111111111111133333333333333333333333334444444444444444444444444222222222222222222222211111111111111111111111133333333333333333333333334444444444444444444444444222222222222222222222211111111111111111111111133333333333333333333333334444444444444444444444444222222222222222222222211111111111111111111111133333333333333333333333334444444444444444444444444asd35555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555affffffffff-23345"))

2217  
nİŞl_çl£
;

2219 ià(! 
	`‹¡_25_check_cook›
 (
ùx
, "222222222222222222222211111111111111111111111133333333333333333333333334444444444444444444444444222222222222222222222211111111111111111111111133333333333333333333333334444444444444444444444444222222222222222222222211111111111111111111111133333333333333333333333334444444444444444444444444222222222222222222222211111111111111111111111133333333333333333333333334444444444444444444444444222222222222222222222211111111111111111111111133333333333333333333333334444444444444444444444444222222222222222222222211111111111111111111111133333333333333333333333334444444444444444444444444222222222222222222222211111111111111111111111133333333333333333333333334444444444444444444444444222222222222222222222211111111111111111111111133333333333333333333333334444444444444444444444444222222222222222222222211111111111111111111111133333333333333333333333334444444444444444444444444asd35555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555affffffffff-233"))

2220  
nİŞl_çl£
;

2222 ià(! 
	`‹¡_25_check_cook›
 (
ùx
, "222222222222222222222211111111111111111111111133333333333333333333333334444444444444444444444444222222222222222222222211111111111111111111111133333333333333333333333334444444444444444444444444222222222222222222222211111111111111111111111133333333333333333333333334444444444444444444444444222222222222222222222211111111111111111111111133333333333333333333333334444444444444444444444444222222222222222222222211111111111111111111111133333333333333333333333334444444444444444444444444222222222222222222222211111111111111111111111133333333333333333333333334444444444444444444444444222222222222222222222211111111111111111111111133333333333333333333333334444444444444444444444444222222222222222222222211111111111111111111111133333333333333333333333334444444444444444444444444222222222222222222222211111111111111111111111133333333333333333333333334444444444444444444444444asd35555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555afffffff"))

2223  
nİŞl_çl£
;

2225 ià(! 
	`‹¡_25_check_cook›
 (
ùx
, "22222222222222211111111111111111111111133333333333333333333333334444444444444444444444444222222222222222222222211111111111111111111111133333333333333333333333334444444444444444444444444222222222222222222222211111111111111111111111133333333333333333333333334444444444444444444444444222222222222222222222211111111111111111111111133333333333333333333333334444444444444444444444444222222222222222222222211111111111111111111111133333333333333333333333334444444444444444444444444222222222222222222222211111111111111111111111133333333333333333333333334444444444444444444444444222222222222222222222211111111111111111111111133333333333333333333333334444444444444444444444444222222222222222222222211111111111111111111111133333333333333333333333334444444444444444444444444222222222222222222222211111111111111111111111133333333333333333333333334444444444444444444444444asd35555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555afffffff"))

2226  
nİŞl_çl£
;

2228 
	`nİŞl_ùx_uÄef
 (
ùx
);

2229  
nİŞl_Œue
;

2230 
	}
}

2232 
nİŞl_boŞ
 
	$‹¡_26
 () {

2234 
noPŞlCÚn
 * 
cÚn
;

2235 
noPŞlCtx
 * 
ùx
;

2238 
ùx
 = 
	`ü—‹_ùx
 ();

2241 
cÚn
 = 
	`nİŞl_cÚn_Ãw
 (
ùx
, "echo.websock‘.Üg", "80", 
NULL
, NULL, NULL, NULL);

2242 ià(! 
	`nİŞl_cÚn_is_ok
 (
cÚn
)) {

2243 
	`´štf
 ("ERROR: Expectedo find…roper client connection status, but foundƒrror..\n");

2244  
nİŞl_çl£
;

2248 ià(! 
	`‹¡_£ndšg_ªd_check_echo
 (
cÚn
, "Test 26", "This is‡est"))

2249  
nİŞl_çl£
;

2252 
	`nİŞl_cÚn_şo£
 (
cÚn
);

2255 
	`nİŞl_ùx_uÄef
 (
ùx
);

2257  
nİŞl_Œue
;

2258 
	}
}

2260 
nİŞl_boŞ
 
	$‹¡_27
 () {

2262 
noPŞlCÚn
 * 
cÚn
;

2263 
noPŞlCtx
 * 
ùx
;

2266 
ùx
 = 
	`ü—‹_ùx
 ();

2269 
cÚn
 = 
	`nİŞl_cÚn_Ãw
 (
ùx
, "loÿlho¡", "1234", 
NULL
, "/", "chat-protocol", "http://www.aspl.es");

2270 ià(! 
	`nİŞl_cÚn_is_ok
 (
cÚn
)) {

2271 
	`´štf
 ("ERROR: Expectedo find…roper client connection status, but foundƒrror..\n");

2272  
nİŞl_çl£
;

2276 ià(! 
	`‹¡_£ndšg_ªd_check_echo
 (
cÚn
, "Test 27", "This is‡est"))

2277  
nİŞl_çl£
;

2280 ià(! 
	`nİŞl_cmp
 ("ch©-´ÙocŞ", 
	`nİŞl_cÚn_g‘_acû±ed_´ÙocŞ
 (
cÚn
))) {

2281 
	`´štf
 ("ERROR:ƒxpectedo find [chat-protocol] but found something: %s\n",

2282 
	`nİŞl_cÚn_g‘_acû±ed_´ÙocŞ
 (
cÚn
));

2283  
nİŞl_çl£
;

2286 
	`´štf
 ("Te¡ 27:‡cû±ed…rÙocŞ byh£rv”: %s\n", 
	`nİŞl_cÚn_g‘_acû±ed_´ÙocŞ
 (
cÚn
));

2289 
	`nİŞl_cÚn_şo£
 (
cÚn
);

2292 
cÚn
 = 
	`nİŞl_cÚn_Ãw
 (
ùx
, "loÿlho¡", "1234", 
NULL
, "/", "hello-protocol", "http://www.aspl.es");

2293 ià(! 
	`nİŞl_cÚn_is_ok
 (
cÚn
)) {

2294 
	`´štf
 ("ERROR: Expectedo find…roper client connection status, but foundƒrror..\n");

2295  
nİŞl_çl£
;

2299 ià(! 
	`‹¡_£ndšg_ªd_check_echo
 (
cÚn
, "Test 27", "This is‡est"))

2300  
nİŞl_çl£
;

2303 ià(! 
	`nİŞl_cmp
 ("h–lo-´ÙocŞ-»¥Ú£", 
	`nİŞl_cÚn_g‘_acû±ed_´ÙocŞ
 (
cÚn
))) {

2304 
	`´štf
 ("ERROR:ƒxpectedo find [chat-protocol] but found something: %s\n",

2305 
	`nİŞl_cÚn_g‘_acû±ed_´ÙocŞ
 (
cÚn
));

2306  
nİŞl_çl£
;

2309 
	`´štf
 ("Te¡ 27:‡cû±ed…rÙocŞ byh£rv”: %s\n", 
	`nİŞl_cÚn_g‘_acû±ed_´ÙocŞ
 (
cÚn
));

2312 
	`nİŞl_cÚn_şo£
 (
cÚn
);

2316 
	`nİŞl_ùx_uÄef
 (
ùx
);

2318  
nİŞl_Œue
;

2319 
	}
}

2322 
nİŞl_boŞ
 
	$‹¡_28
 () {

2324 
noPŞlCÚn
 * 
cÚn
;

2325 
noPŞlCtx
 * 
ùx
;

2326 
noPŞlMsg
 * 
msg
;

2329 
ùx
 = 
	`ü—‹_ùx
 ();

2332 
cÚn
 = 
	`nİŞl_cÚn_Ãw
 (
ùx
, "loÿlho¡", "1234", 
NULL
, NULL, NULL, NULL);

2333 ià(! 
	`nİŞl_cÚn_is_ok
 (
cÚn
)) {

2334 
	`´štf
 ("ERROR: Expectedo find…roper client connection status, but foundƒrror..\n");

2335  
nİŞl_çl£
;

2339 
	`nİŞl_cÚn_wa™_uÁ_cÚÃùiÚ_»ady
 (
cÚn
, 5);

2342 ià(
	`nİŞl_cÚn_£nd_‹xt
 (
cÚn
, "close with message", 18) != 18) {

2343 
	`´štf
 ("ERROR: failedo send close with message..");

2344  
nİŞl_çl£
;

2348 (
msg
 = 
	`nİŞl_cÚn_g‘_msg
 (
cÚn
)è=ğ
NULL
) {

2350 ià(! 
	`nİŞl_cÚn_is_ok
 (
cÚn
)) {

2355 
	`nİŞl_¦“p
 (10000);

2358 
	`´štf
 ("Test 28: close„eason„eceived, statud=%d, message=%s\n",

2359 
	`nİŞl_cÚn_g‘_şo£_¡©us
 (
cÚn
),

2360 
	`nİŞl_cÚn_g‘_şo£_»asÚ
 (
cÚn
));

2361 ià(
	`nİŞl_cÚn_g‘_şo£_¡©us
 (
cÚn
) != 1048) {

2362 
	`´štf
 ("ERROR:ƒxpected differentƒrror code..\n");

2363  
nİŞl_çl£
;

2366 ià(! 
	`nİŞl_cmp
 (
	`nİŞl_cÚn_g‘_şo£_»asÚ
 (
cÚn
), "Hey,his is‡ very„easonableƒrror message")) {

2367 
	`´štf
 ("ERROR:ƒxpected differentƒrror message..\n");

2368  
nİŞl_çl£
;

2372 
	`nİŞl_cÚn_şo£
 (
cÚn
);

2375 
	`nİŞl_ùx_uÄef
 (
ùx
);

2377  
nİŞl_Œue
;

2378 
	}
}

2381 
	$maš
 (
¬gc
, ** 
¬gv
)

2383 
™”©Ü
;

2385 
	`´štf
 ("** NoPoll: Websocketoolkit (regressionest).\n");

2386 
	`´štf
 ("** Copyright (C) 2015 Advanced Software Production Line, S.L.\n**\n");

2387 
	`´štf
 ("** NoPoll„egressionests: version=%s\n**\n",

2388 
VERSION
);

2389 
	`´štf
 ("** To gather information‡boutime…erformance you can use:\n**\n");

2390 
	`´štf
 ("** >>ime ./nopoll-regression-client [--debug,--show-critical-only]\n**\n");

2391 
	`´štf
 ("** To gather information‡bout memory consumed (and†eaks) use:\n**\n");

2392 
	`´štf
 ("** >>†ibtool --mode=execute valgrind --leak-check=yes --error-limit=no ./nopoll-regression-client\n**\n");

2393 
	`´štf
 ("**\n");

2394 
	`´štf
 ("** Report bugso:\n**\n");

2395 
	`´štf
 ("** <info@aspl.es>‚oPoll mailing†ist\n**\n");

2397 
™”©Ü
 = 1;

2398 
™”©Ü
 < 
¬gc
) {

2400 
	`´štf
 ("Checkšg‡gum’t: %s\n", 
¬gv
[
™”©Ü
]);

2401 ià(
	`nİŞl_cmp
 (
¬gv
[
™”©Ü
], "--debug")) {

2402 
	`´štf
 ("Activating debug..\n");

2403 
debug
 = 
nİŞl_Œue
;

2405 ià(
	`nİŞl_cmp
 (
¬gv
[
™”©Ü
], "--show-critical-only")) {

2406 
	`´štf
 ("Activating„eporting of critical messages..\n");

2407 
show_ü™iÿl_Úly
 = 
nİŞl_Œue
;

2411 
™”©Ü
++;

2414 
	`´štf
 ("INFO: s¹šge¡ w™h…id: %d\n", 
	`g‘pid
 ());

2415 ià(
	`‹¡_01_¡ršgs
 ()) {

2416 
	`´štf
 ("Test 01-strings: Library strings support [ OK ]\n");

2418 
	`´štf
 ("Test 01-strings: Library strings support [ FAILED ]\n");

2422 ià(
	`‹¡_01_ba£64
 ()) {

2423 
	`´štf
 ("Test 01-base64: Library base64 support [ OK ]\n");

2425 
	`´štf
 ("Test 01-base64: Library base64 support [ FAILED ]\n");

2429 ià(
	`‹¡_01_maskšg
 ()) {

2430 
	`´štf
 ("Test 01-masking: Library websocket content masking support [ OK ]\n");

2432 
	`´štf
 ("Test 01-masking: Library websocket content masking support [ FAILED ]\n");

2436 ià(
	`‹¡_01
 ()) {

2437 
	`´štf
 ("Test 01: Simple connect‡nd disconnect [ OK ]\n");

2439 
	`´štf
 ("Test 01: Simple connect‡nd disconnect [ FAILED ]\n");

2443 ià(
	`‹¡_02
 ()) {

2444 
	`´štf
 ("Test 02: Simple„equest/reply [ OK ]\n");

2446 
	`´štf
 ("Test 02: Simple„equest/reply [ FAILED ]\n");

2451 ià(
	`‹¡_03
 ()) {

2452 
	`´štf
 ("Test 03:est streaming‡pi [ OK ]\n");

2454 
	`´štf
 ("Test 03:est streaming‡pi [ FAILED ]\n");

2458 ià(
	`‹¡_04
 (1024)) {

2459 
	`´štf
 ("Test 04:est streaming‡pi (II) [ OK ]\n");

2461 
	`´štf
 ("Test 04:est streaming‡pi (II) [ FAILED ]\n");

2465 ià(
	`‹¡_04
 (512)) {

2466 
	`´štf
 ("Test 04-a:est streaming‡pi (III) [ OK ]\n");

2468 
	`´štf
 ("Test 04-a:est streaming‡pi (III) [ FAILED ]\n");

2472 ià(
	`‹¡_04
 (137)) {

2473 
	`´štf
 ("Test 04-b:est streaming‡pi (IV) [ OK ]\n");

2475 
	`´štf
 ("Test 04-b:est streaming‡pi (IV) [ FAILED ]\n");

2479 ià(
	`‹¡_04
 (17)) {

2480 
	`´štf
 ("Test 04-c:est streaming‡pi (V) [ OK ]\n");

2482 
	`´štf
 ("Test 04-c:est streaming‡pi (V) [ FAILED ]\n");

2486 ià(
	`‹¡_04a
 ()) {

2487 
	`´štf
 ("Test 04-a: check‚on-blocking streaming‡nd message based API [ OK ]\n");

2489 
	`´štf
 ("Test 04-a: check‚on-blocking streaming‡nd message based API [ FAILED ]\n");

2493 ià(
	`‹¡_04b
 ()) {

2494 
	`´štf
 ("Test 04-b:ryo overflow write‡ccess‡nd„ecover from it [ OK ]\n");

2496 
	`´štf
 ("Test 04-b:ryo overflow write‡ccess‡nd„ecover from it [ FAILED ]\n");

2500 ià(
	`‹¡_04c
 ()) {

2501 
	`´štf
 ("Test 04-c: send‡ file‡ndryo overflow (but„etry) [ OK ]\n");

2503 
	`´štf
 ("Test 04-c: send‡ file‡ndryo overflow (but„etry) [ FAILED ]\n");

2507 ià(
	`‹¡_05
 ()) {

2508 
	`´štf
 ("Test 05: sending utf-8 content [ OK ]\n");

2510 
	`´štf
 ("Test 05: sending utf-8 content [ FAILED ]\n");

2514 ià(
	`‹¡_06
 ()) {

2515 
	`´štf
 ("Test 06:esting basic TLS connect [ OK ]\n");

2517 
	`´štf
 ("Test 06:esting basic TLS connect [ FAILED ]\n");

2521 ià(
	`‹¡_07
 ()) {

2522 
	`´štf
 ("Test 07:esting TLS„equest/reply [ OK ]\n");

2524 
	`´štf
 ("Test 07:esting TLS„equest/reply [ FAILED ]\n");

2528 ià(
	`‹¡_08
 ()) {

2529 
	`´štf
 ("Test 08:est‚ormal connecto TLS…ort [ OK ]\n");

2531 
	`´štf
 ("Test 08:est‚ormal connecto TLS…ort [ FAILED ]\n");

2535 ià(
	`‹¡_09
 ()) {

2536 
	`´štf
 ("Test 09:ƒnsure we only support Sec-WebSocket-Version: 13 [ OK ]\n");

2538 
	`´štf
 ("Test 09:ƒnsure we only support Sec-WebSocket-Version: 13 [ FAILED ]\n");

2542 ià(
	`‹¡_10
 ()) {

2543 
	`´štf
 ("Test 10:est checking origing in on open‡nd denying it [ OK ]\n");

2545 
	`´štf
 ("Test 10:est checking origing in on open‡nd denying it [ FAILED ]\n");

2549 ià(
	`‹¡_11
 ()) {

2550 
	`´štf
 ("Test 11:„elease context‡fter connection [ OK ]\n");

2552 
	`´štf
 ("Test 11:„elease context‡fter connection [ FAILED ]\n");

2556 ià(
	`‹¡_12
 ()) {

2557 
	`´štf
 ("Test 12: create huge‡mount of connections in‡ shortime [ OK ]\n");

2559 
	`´štf
 ("Test 12: create huge‡mount of connections in‡ shortime [ FAILED ]\n");

2563 ià(
	`‹¡_13
 ()) {

2564 
	`´štf
 ("Test 13:esting certificate storage [ OK ]\n");

2566 
	`´štf
 ("Test 13:esting certificate storage [ FAILED ]\n");

2570 ià(
	`‹¡_14
 ()) {

2571 
	`´štf
 ("Test 14:esting sending frame with few content‡s indicated by header [ OK ]\n");

2573 
	`´štf
 ("Test 14:esting sending frame with few content‡s indicated by header [ FAILED ]\n");

2577 ià(
	`‹¡_15
 ()) {

2578 
	`´štf
 ("Test 15: checking‚on-blocking callso get messages when‚o content is‡vailable [ OK ]\n");

2580 
	`´štf
 ("Test 15: checking‚on-blocking callso get messages when‚o content is‡vailable [ FAILED ]\n");

2584 ià(
	`‹¡_16
 ()) {

2585 
	`´štf
 ("Test 16: check sending frames with sleep in header [ OK ]\n");

2587 
	`´štf
 ("Test 16: check sending frames with sleep in header [ FAILED ]\n");

2591 ià(
	`‹¡_17
 ()) {

2592 
	`´štf
 ("Test 17: check…artial frame„eception [ OK ]\n");

2594 
	`´štf
 ("Test 17: check…artial frame„eception [ FAILED ]\n");

2598 ià(
	`‹¡_18
 ()) {

2599 
	`´štf
 ("Test 18: check‚opoll_loop_wait (second call) [ OK ]\n");

2601 
	`´štf
 ("Test 18: check‚opoll_loop_wait (second call) [ FAILED ]\n");

2605 ià(
	`‹¡_19
 ()) {

2606 
	`´štf
 ("Test 19: support different SSL methods (SSLv23, SSLv3, TLSv1 [ OK ]\n");

2608 
	`´štf
 ("Test 19: support different SSL methods (SSLv23, SSLv3, TLSv1 [ FAILED ]\n");

2612 #ià
	`defšed
(
__NOPOLL_PTHREAD_SUPPORT__
)

2613 ià(
	`‹¡_20
 ()) {

2614 
	`´štf
 ("Test 20: check mutex support [ OK ]\n");

2616 
	`´štf
 ("Test 20: check mutex support [ FAILED ]\n");

2621 ià(
	`‹¡_21
 ()) {

2622 
	`´štf
 ("Test 21: client side ssl certificates verification [ OK ]\n");

2624 
	`´štf
 ("Test 21: client side ssl certificates verification [ FAILED ]\n");

2628 ià(
	`‹¡_22
 ()) {

2629 
	`´štf
 ("Test 22:est connection closerigger (client side) [ OK ]\n");

2631 
	`´štf
 ("Test 22:est connection closerigger (client side) [ FAILED ]\n");

2635 ià(
	`‹¡_23
 ()) {

2636 
	`´štf
 ("Test 23:est connection closerigger (server side) [ OK ]\n");

2638 
	`´štf
 ("Test 23:est connection closerigger (server side) [ FAILED ]\n");

2642 ià(
	`‹¡_24
 ()) {

2643 
	`´štf
 ("Test 24: check cookie support (client‡nd server side) [ OK ]\n");

2645 
	`´štf
 ("Test 24: check cookie support (client‡nd server side) [ FAILED ]\n");

2649 ià(
	`‹¡_25
 ()) {

2650 
	`´štf
 ("Test 25: check cookie‡ttack [ OK ]\n");

2652 
	`´štf
 ("Test 25: check cookie‡ttack [ FAILED ]\n");

2656 ià(
	`‹¡_26
 ()) {

2657 
	`´štf
 ("Test 26: checkingƒcho.websocket.org [ OK ]\n");

2659 
	`´štf
 ("Test 26: chekcingƒcho.websocket.org [ FAILED ]\n");

2663 ià(
	`‹¡_27
 ()) {

2664 
	`´štf
 ("Test 27: checking setting…rotocol [ OK ]\n");

2666 
	`´štf
 ("Test 27: chekcing setting…rotocol [ FAILED ]\n");

2670 ià(
	`‹¡_28
 ()) {

2671 
	`´štf
 ("Test 28: checking setting…rotocol [ OK ]\n");

2673 
	`´štf
 ("Test 28: chekcing setting…rotocol [ FAILED ]\n");

2728 
	`nİŞl_ş—nup_lib¿ry
 ();

2729 
	`´štf
 ("Allests ok!!\n");

2733 
	}
}

	@nopoll.c

39 
	~<nİŞl.h
>

40 
	~<nİŞl_´iv©e.h
>

60 
nİŞl_boŞ
 
	$nİŞl_cmp
 (cÚ¡ * 
¡ršg1
, cÚ¡ * 
¡ršg2
)

62 
™”©Ü
;

63 ià(
¡ršg1
 =ğ
NULL
 && 
¡ršg2
 == NULL)

64  
nİŞl_Œue
;

65 ià(
¡ršg1
 =ğ
NULL
 || 
¡ršg2
 == NULL)

66  
nİŞl_çl£
;

69 
™”©Ü
 = 0;

70 
¡ršg1
[
™”©Ü
] && string1[iterator]) {

71 ià(
¡ršg1
[
™”©Ü
] !ğ
¡ršg2
[iterator])

72  
nİŞl_çl£
;

73 
™”©Ü
++;

77  
¡ršg1
[
™”©Ü
] =ğ
¡ršg2
[iterator];

78 
	}
}

91 
nİŞl_boŞ
 
	$nİŞl_ncmp
 (cÚ¡ * 
¡ršg1
, cÚ¡ * 
¡ršg2
, 
by‹s
)

93 
™”©Ü
;

94 ià(
by‹s
 <= 0)

95  
nİŞl_çl£
;

96 ià(
¡ršg1
 =ğ
NULL
 && 
¡ršg2
 == NULL)

97  
nİŞl_Œue
;

98 ià(
¡ršg1
 =ğ
NULL
 || 
¡ršg2
 == NULL)

99  
nİŞl_çl£
;

102 
™”©Ü
 = 0;

103 
¡ršg1
[
™”©Ü
] &&

104 
¡ršg2
[
™”©Ü
] &&

105 
™”©Ü
 < 
by‹s
) {

106 ià(
¡ršg1
[
™”©Ü
] !ğ
¡ršg2
[iterator])

107  
nİŞl_çl£
;

108 
™”©Ü
++;

112  
™”©Ü
 =ğ
by‹s
;

113 
	}
}

124 * 
	$nİŞl_¡rdup_´štf
 (cÚ¡ * 
chunk
, ...)

126 * 
»suÉ
 = 
NULL
;

127 
va_li¡
 
¬gs
;

129 ià(
chunk
 =ğ
NULL
)

130  
NULL
;

133 
	`va_¡¬t
 (
¬gs
, 
chunk
);

136 
»suÉ
 = 
	`nİŞl_¡rdup_´štfv
 (
chunk
, 
¬gs
);

139 
	`va_’d
 (
¬gs
);

141  
»suÉ
;

142 
	}
}

164 
	$nİŞl_v´štf_Ën
 (cÚ¡ * 
fÜm©
, 
va_li¡
 
¬gs
)

169 #ià
	`defšed
 (
NOPOLL_OS_WIN32
è&& ! defšed (
__GNUC__
)

170 #ià
HAVE_VSCPRINTF


171 ià(
fÜm©
 =ğ
NULL
)

173  
	`_vsırštf
 (
fÜm©
, 
¬gs
) + 1;

175 
bufãr
[8192];

176 ià(
fÜm©
 =ğ
NULL
)

178  
	`_v¢´štf
 (
bufãr
, 8191, 
fÜm©
, 
¬gs
) + 1;

182 ià(
fÜm©
 =ğ
NULL
)

184  
	`v¢´štf
 (
NULL
, 0, 
fÜm©
, 
¬gs
) + 1;

186 
	}
}

203 * 
	$nİŞl_¡rdup_´štfv
 (cÚ¡ * 
chunk
, 
va_li¡
 
¬gs
)

207 #ià
	`defšed
(
SHOW_DEBUG_LOG
è&& ! defšed(
NOPOLL_HAVE_VASPRINTF
)

208 
noPŞlCtx
 * 
ùx
 = 
NULL
;

211 #ià!
	`defšed
(
NOPOLL_HAVE_VASPRINTF
)

212 
size
;

214 * 
»suÉ
 = 
NULL
;

216 ià(
chunk
 =ğ
NULL
)

217  
NULL
;

219 #ifdeà
NOPOLL_HAVE_VASPRINTF


221 ià(
	`va¥rštf
 (&
»suÉ
, 
chunk
, 
¬gs
) == -1)

222  
NULL
;

225 
size
 = 
	`nİŞl_v´štf_Ën
 (
chunk
, 
¬gs
);

228 ià(
size
 == -1) {

229 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_CRITICAL
, "unableo calculatehe‡mount of memory forhe strdup_printf operation");

230  
NULL
;

234 
»suÉ
 = 
	`nİŞl_Ãw
 (, 
size
 + 2);

237 #ià
	`defšed
(
NOPOLL_OS_WIN32
è&& ! defšed (
__GNUC__
)

238 
size
 = 
	`_v¢´štf_s
 (
»suÉ
, siz+ 1, size, 
chunk
, 
¬gs
);

240 
size
 = 
	`v¢´štf
 (
»suÉ
, siz+ 1, 
chunk
, 
¬gs
);

244  
»suÉ
;

245 
	}
}

250 
nİŞl_boŞ
 
	$nİŞl_is_wh™e_¥aû
 (* 
chunk
)

253 ià(
chunk
 =ğ
NULL
)

254  
nİŞl_çl£
;

256 ià(
chunk
[0] == ' ')

257  
nİŞl_Œue
;

258 ià(
chunk
[0] == '\n')

259  
nİŞl_Œue
;

260 ià(
chunk
[0] == '\t')

261  
nİŞl_Œue
;

262 ià(
chunk
[0] == '\r')

263  
nİŞl_Œue
;

266  
nİŞl_çl£
;

267 
	}
}

278 
	$nİŞl_Œim
 (* 
chunk
, * 
Œimmed
)

280 
™”©Ü
;

281 
™”©Ü2
;

282 
’d
;

283 
tÙ®
;

286 ià(
chunk
 =ğ
NULL
)

290 ià(
	`¡¾’
 (
chunk
) == 0) {

291 ià(
Œimmed
)

292 *
Œimmed
 = 0;

298 
™”©Ü
 = 0;

299 
chunk
[
™”©Ü
] != 0) {

303 ià(! 
	`nİŞl_is_wh™e_¥aû
 (
chunk
 + 
™”©Ü
))

307 
™”©Ü
++;

311 ià(
™”©Ü
 =ğ(è
	`¡¾’
 (
chunk
)) {

313 
chunk
 [0] = 0;

314 ià(
Œimmed
)

315 *
Œimmed
 = 
™”©Ü
;

321 
tÙ®
 = 
	`¡¾’
 (
chunk
) -1;

322 
’d
 = 
tÙ®
;

323 
chunk
[
’d
] != 0) {

326 ià(! 
	`nİŞl_is_wh™e_¥aû
 (
chunk
 + 
’d
)) {

331 
’d
--;

335 
tÙ®
 -ğ
’d
;

336 
tÙ®
 +ğ
™”©Ü
;

339 
™”©Ü2
 = 0;

340 
™”©Ü2
 < (
’d
 - 
™”©Ü
 + 1)) {

342 
chunk
 [
™”©Ü2
] = chunk [
™”©Ü
 + iterator2];

345 
™”©Ü2
++;

347 
chunk
 [ 
’d
 - 
™”©Ü
 + 1] = 0;

349 ià(
Œimmed
 !ğ
NULL
)

350 *
Œimmed
 = 
tÙ®
;

354 
	}
}

362 
	$nİŞl_¦“p
 (
miüo£cÚds
)

364 #ià
	`defšed
(
NOPOLL_OS_UNIX
)

365 
	`u¦“p
 (
miüo£cÚds
);

367 #–ià
	`defšed
(
NOPOLL_OS_WIN32
)

368 
	`SË•
 (
miüo£cÚds
 / 1000);

371 
	}
}

373 
noPŞlMu‹xC»©e
 
	g__nİŞl_mu‹x_ü—‹
 = 
NULL
;

374 
noPŞlMu‹xDe¡roy
 
	g__nİŞl_mu‹x_de¡roy
 = 
NULL
;

375 
noPŞlMu‹xLock
 
	g__nİŞl_mu‹x_lock
 = 
NULL
;

376 
noPŞlMu‹xUÆock
 
	g__nİŞl_mu‹x_uÆock
 = 
NULL
;

385 
noPŞlPŒ
 
	$nİŞl_mu‹x_ü—‹
 ()

387 ià(! 
__nİŞl_mu‹x_ü—‹
)

388  
NULL
;

391  
	`__nİŞl_mu‹x_ü—‹
 ();

392 
	}
}

406 
	$nİŞl_mu‹x_lock
 (
noPŞlPŒ
 
mu‹x
)

408 ià(! 
__nİŞl_mu‹x_lock
)

412 
	`__nİŞl_mu‹x_lock
 (
mu‹x
);

414 
	}
}

426 
	$nİŞl_mu‹x_uÆock
 (
noPŞlPŒ
 
mu‹x
)

428 ià(! 
__nİŞl_mu‹x_uÆock
)

432 
	`__nİŞl_mu‹x_uÆock
 (
mu‹x
);

434 
	}
}

446 
	$nİŞl_mu‹x_de¡roy
 (
noPŞlPŒ
 
mu‹x
)

448 ià(! 
__nİŞl_mu‹x_de¡roy
)

452 
	`__nİŞl_mu‹x_de¡roy
 (
mu‹x
);

454 
	}
}

478 
	$nİŞl_th»ad_hªdËrs
 (
noPŞlMu‹xC»©e
 
mu‹x_ü—‹
,

479 
noPŞlMu‹xDe¡roy
 
mu‹x_de¡roy
,

480 
noPŞlMu‹xLock
 
mu‹x_lock
,

481 
noPŞlMu‹xUÆock
 
mu‹x_uÆock
)

484 ià(! 
mu‹x_ü—‹
 ||

485 ! 
mu‹x_de¡roy
 ||

486 ! 
mu‹x_lock
 ||

487 ! 
mu‹x_uÆock
)

491 
__nİŞl_mu‹x_ü—‹
 = 
mu‹x_ü—‹
;

492 
__nİŞl_mu‹x_de¡roy
 = 
mu‹x_de¡roy
;

493 
__nİŞl_mu‹x_lock
 = 
mu‹x_lock
;

494 
__nİŞl_mu‹x_uÆock
 = 
mu‹x_uÆock
;

497 
	}
}

516 
nİŞl_boŞ
 
	$nİŞl_ba£64_’code
 (cÚ¡ * 
cÚ‹Á
,

517 
Ëngth
,

518 * 
ouut
,

519 * 
ouut_size
)

521 
BIO
 * 
b64
;

522 
BIO
 * 
bmem
;

523 
BUF_MEM
 * 
b±r
;

525 ià(
cÚ‹Á
 =ğ
NULL
 || 
ouut
 =ğNULL || 
Ëngth
 <ğ0 || 
ouut_size
 == NULL)

526  
nİŞl_çl£
;

529 
b64
 = 
	`BIO_Ãw
 (
	`BIO_f_ba£64
());

530 
bmem
 = 
	`BIO_Ãw
 (
	`BIO_s_mem
());

533 
b64
 = 
	`BIO_push
(b64, 
bmem
);

535 ià(
	`BIO_wr™e
 (
b64
, 
cÚ‹Á
, 
Ëngth
) !=†ength) {

536 
	`BIO_ä“_®l
 (
b64
);

537  
nİŞl_çl£
;

540 ià(
	`BIO_æush
 (
b64
) != 1) {

541 
	`BIO_ä“_®l
 (
b64
);

542  
nİŞl_çl£
;

546 
	`BIO_g‘_mem_±r
 (
b64
, &
b±r
);

549 ià((*
ouut_size
è< 
b±r
->
Ëngth
) {

550 
	`BIO_ä“_®l
 (
b64
);

552 *
ouut_size
 = 
b±r
->
Ëngth
;

553  
nİŞl_çl£
;

556 
	`memıy
(
ouut
, 
b±r
->
d©a
, b±r->
Ëngth
 - 1);

557 
ouut
[
b±r
->
Ëngth
-1] = 0;

559 
	`BIO_ä“_®l
 (
b64
);

561  
nİŞl_Œue
;

562 
	}
}

581 
nİŞl_boŞ
 
	$nİŞl_ba£64_decode
 (cÚ¡ * 
cÚ‹Á
,

582 
Ëngth
,

583 * 
ouut
,

584 * 
ouut_size
)

586 
BIO
 * 
b64
;

587 
BIO
 * 
bmem
;

589 ià(
cÚ‹Á
 =ğ
NULL
 || 
ouut
 =ğNULL || 
Ëngth
 <ğ0 || 
ouut_size
 == NULL)

590  
nİŞl_çl£
;

593 
bmem
 = 
	`BIO_Ãw_mem_buf
 ((*è
cÚ‹Á
, 
Ëngth
);

594 
b64
 = 
	`BIO_Ãw
 (
	`BIO_f_ba£64
());

595 
	`BIO_£t_æags
 (
b64
, 
BIO_FLAGS_BASE64_NO_NL
);

598 
bmem
 = 
	`BIO_push
(
b64
, bmem);

600 *
ouut_size
 = 
	`BIO_»ad
 (
bmem
, 
ouut
, *output_size);

601 
ouut
[*
ouut_size
] = 0;

603 
	`BIO_ä“_®l
 (
bmem
);

605  
nİŞl_Œue
;

606 
	}
}

623 
	$nİŞl_timev®_sub¡¿ù
 (
timev®
 * 
a
,

624 
timev®
 * 
b
,

625 
timev®
 * 
»suÉ
)

629 ià(
a
->
tv_u£c
 < 
b
->tv_usec) {

630 
n£c
 = (
b
->
tv_u£c
 - 
a
->tv_usec) / 1000000 + 1;

631 
b
->
tv_u£c
 -ğ1000000 * 
n£c
;

632 
b
->
tv_£c
 +ğ
n£c
;

635 ià(
a
->
tv_u£c
 - 
b
->tv_usec > 1000000) {

636 
n£c
 = (
a
->
tv_u£c
 - 
b
->tv_usec) / 1000000;

637 
b
->
tv_u£c
 +ğ1000000 * 
n£c
;

638 
b
->
tv_£c
 -ğ
n£c
;

642 
»suÉ
->
tv_£c
 = 
a
->tv_£ø- 
b
->tv_sec;

643 
»suÉ
->
tv_u£c
 = 
a
->tv_u£ø- 
b
->tv_usec;

646  
a
->
tv_£c
 < 
b
->tv_sec;

647 
	}
}

656 * 
	$nİŞl_¡rdup
 (cÚ¡ * 
bufãr
)

658 ià(
bufãr
 =ğ
NULL
)

659  
NULL
;

661  
	`¡rdup
 (
bufãr
);

662 
	}
}

666 
nİŞl_boŞ
 
	g__nİŞl_nÚû_š™
 = 
nİŞl_çl£
;

680 
nİŞl_boŞ
 
	$nİŞl_nÚû
 (* 
bufãr
, 
nÚû_size
)

682 
¿ndom_v®ue
;

683 
™”©Ü
;

684 
timev®
 
tv
;

686 ià(
bufãr
 =ğ
NULL
 || 
nÚû_size
 <= 0)

687  
nİŞl_çl£
;

688 ià(! 
__nİŞl_nÚû_š™
) {

689 #ià
	`defšed
(
NOPOLL_OS_WIN32
)

690 
	`nİŞl_wš32_g‘timeofday
 (&
tv
, 
NULL
);

692 
	`g‘timeofday
 (&
tv
, 
NULL
);

695 
	`¤ªd
 (
	`time
(0è* 
tv
.
tv_u£c
);

696 
__nİŞl_nÚû_š™
 = 
nİŞl_Œue
;

700 
™”©Ü
 = 0;

701 
™”©Ü
 < 
nÚû_size
) {

703 #ià
	`defšed
(
NOPOLL_OS_WIN32
)

704 
¿ndom_v®ue
 = 
	`¿nd
 ();

706 
¿ndom_v®ue
 = 
	`¿ndom
 ();

710 
	`memıy
 (
bufãr
 + 
™”©Ü
, &
¿ndom_v®ue
,  (random_value));

711 
™”©Ü
 +ğ (
¿ndom_v®ue
);

714  
nİŞl_Œue
;

715 
	}
}

725 
	$nİŞl_g‘_b™
 (
by‹
, 
pos™iÚ
) {

726  ( ( 
by‹
 & (1 << 
pos™iÚ
) ) >>…osition);

727 
	}
}

737 
	$nİŞl_£t_b™
 (* 
bufãr
, 
pos™iÚ
) {

738 
bufãr
[0] |ğ(1 << 
pos™iÚ
);

740 
	}
}

742 
	$nİŞl_show_by‹
 (
noPŞlCtx
 * 
ùx
, 
by‹
, cÚ¡ * 
Ïb–
) {

744 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_DEBUG
, " byte (%s) = %d %d %d %d %d %d %d %d",

745 
Ïb–
,

746 
	`nİŞl_g‘_b™
 (
by‹
, 7),

747 
	`nİŞl_g‘_b™
 (
by‹
, 6),

748 
	`nİŞl_g‘_b™
 (
by‹
, 5),

749 
	`nİŞl_g‘_b™
 (
by‹
, 4),

750 
	`nİŞl_g‘_b™
 (
by‹
, 3),

751 
	`nİŞl_g‘_b™
 (
by‹
, 2),

752 
	`nİŞl_g‘_b™
 (
by‹
, 1),

753 
	`nİŞl_g‘_b™
 (
by‹
, 0));

755 
	}
}

757 * 
	$nİŞl_št2bš
 (
a
, *
bufãr
, 
buf_size
) {

758 
i
;

760 
bufãr
 +ğ(
buf_size
 - 1);

762 
i
 = 31; i >= 0; i--) {

763 *
bufãr
-- = (
a
 & 1) + '0';

765 
a
 >>= 1;

768  
bufãr
;

769 
	}
}

771 
	#BUF_SIZE
 33

	)

773 
	$nİŞl_št2bš_´št
 (
noPŞlCtx
 * 
ùx
, 
v®ue
) {

775 
bufãr
[
BUF_SIZE
];

776 
bufãr
[
BUF_SIZE
 - 1] = '\0';

778 
	`nİŞl_št2bš
 (
v®ue
, 
bufãr
, 
BUF_SIZE
 - 1);

780 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_DEBUG
, "%d = %s", 
v®ue
, 
bufãr
);

783 
	}
}

793 
	$nİŞl_g‘_16b™
 (cÚ¡ * 
bufãr
)

795 
high_·¹
 = 
bufãr
[0] << 8;

796 
low_·¹
 = 
bufãr
[1] & 0x000000ff;

798  (
high_·¹
 | 
low_·¹
) & 0x000000ffff;

799 
	}
}

809 
	$nİŞl_g‘_8b™
 (cÚ¡ * 
bufãr
)

811  
bufãr
[0] & 0x00000000ff;

812 
	}
}

822 
	$nİŞl_£t_16b™
 (
v®ue
, * 
bufãr
)

824 
bufãr
[0] = (
v®ue
 & 0x0000ff00) >> 8;

825 
bufãr
[1] = 
v®ue
 & 0x000000ff;

828 
	}
}

838 
	$nİŞl_£t_32b™
 (
v®ue
, * 
bufãr
)

840 
bufãr
[0] = (
v®ue
 & 0x00ff000000) >> 24;

841 
bufãr
[1] = (
v®ue
 & 0x0000ff0000) >> 16;

842 
bufãr
[2] = (
v®ue
 & 0x000000ff00) >> 8;

843 
bufãr
[3] = 
v®ue
 & 0x00000000ff;

846 
	}
}

855 
	$nİŞl_g‘_32b™
 (cÚ¡ * 
bufãr
)

857 
·¹1
 = ()(
bufãr
[0] & 0x0ff) << 24;

858 
·¹2
 = ()(
bufãr
[1] & 0x0ff) << 16;

859 
·¹3
 = ()(
bufãr
[2] & 0x0ff) << 8;

860 
·¹4
 = ()(
bufãr
[3] & 0x0ff);

862  
·¹1
 | 
·¹2
 | 
·¹3
 | 
·¹4
;

863 
	}
}

865 
nİŞl_boŞ
 
__nİŞl_s_was_š™
;

876 
	$nİŞl_ş—nup_lib¿ry
 ()

879 ià(
__nİŞl_s_was_š™
) {

880 
	`EVP_ş—nup
 ();

881 
	`CRYPTO_ş—nup_®l_ex_d©a
 ();

882 
	`ERR_ä“_¡ršgs
 ();

885 
__nİŞl_s_was_š™
 = 
nİŞl_çl£
;

889 
	}
}

	@nopoll.h

39 #iâdeà
__NOPOLL_H__


40 
	#__NOPOLL_H__


	)

42 
	~<nİŞl_deş.h
>

43 
	~<nİŞl_hªdËrs.h
>

45 
	gBEGIN_C_DECLS


47 #ià
defšed
(
NOPOLL_OS_WIN32
)

48 
	~<nİŞl_wš32.h
>

51 
	~<nİŞl_ùx.h
>

52 
	~<nİŞl_io.h
>

53 
	~<nİŞl_cÚn_İts.h
>

54 
	~<nİŞl_cÚn.h
>

55 
	~<nİŞl_msg.h
>

56 
	~<nİŞl_log.h
>

57 
	~<nİŞl_li¡’”.h
>

58 
	~<nİŞl_io.h
>

59 
	~<nİŞl_loİ.h
>

66 
nİŞl_boŞ
 
nİŞl_cmp
 (cÚ¡ * 
¡ršg1
, cÚ¡ * 
¡ršg2
);

68 
nİŞl_boŞ
 
nİŞl_ncmp
 (cÚ¡ * 
¡ršg1
, cÚ¡ * 
¡ršg2
, 
by‹s
);

70 * 
nİŞl_¡rdup_´štf
 (cÚ¡ * 
chunk
, ...);

72 * 
nİŞl_¡rdup_´štfv
 (cÚ¡ * 
chunk
, 
va_li¡
 
¬gs
);

74 
nİŞl_Œim
 (* 
chunk
, * 
Œimmed
);

76 
nİŞl_¦“p
 (
miüo£cÚds
);

78 
nİŞl_th»ad_hªdËrs
 (
noPŞlMu‹xC»©e
 
mu‹x_ü—‹
,

79 
noPŞlMu‹xDe¡roy
 
mu‹x_de¡roy
,

80 
noPŞlMu‹xLock
 
mu‹x_lock
,

81 
noPŞlMu‹xUÆock
 
mu‹x_uÆock
);

83 
noPŞlPŒ
 
nİŞl_mu‹x_ü—‹
 ();

85 
nİŞl_mu‹x_lock
 (
noPŞlPŒ
 
mu‹x
);

87 
nİŞl_mu‹x_uÆock
 (
noPŞlPŒ
 
mu‹x
);

89 
nİŞl_mu‹x_de¡roy
 (
noPŞlPŒ
 
mu‹x
);

91 
nİŞl_boŞ
 
nİŞl_ba£64_’code
 (cÚ¡ * 
cÚ‹Á
,

92 
Ëngth
,

93 * 
ouut
,

94 * 
ouut_size
);

96 
nİŞl_boŞ
 
nİŞl_ba£64_decode
 (cÚ¡ * 
cÚ‹Á
,

97 
Ëngth
,

98 * 
ouut
,

99 * 
ouut_size
);

101 
nİŞl_timev®_sub¡¿ù
 (
timev®
 * 
a
,

102 
timev®
 * 
b
,

103 
timev®
 * 
»suÉ
);

105 * 
nİŞl_¡rdup
 (cÚ¡ * 
bufãr
);

107 
nİŞl_boŞ
 
nİŞl_nÚû
 (* 
bufãr
, 
nÚû_size
);

109 
nİŞl_ş—nup_lib¿ry
 ();

111 
nİŞl_g‘_b™
 (
by‹
, 
pos™iÚ
);

113 
nİŞl_£t_b™
 (* 
bufãr
, 
pos™iÚ
);

115 
nİŞl_show_by‹
 (
noPŞlCtx
 * 
ùx
, 
by‹
, cÚ¡ * 
Ïb–
);

117 * 
nİŞl_št2bš
 (
a
, *
bufãr
, 
buf_size
);

119 
nİŞl_št2bš_´št
 (
noPŞlCtx
 * 
ùx
, 
v®ue
);

121 
nİŞl_g‘_8b™
 (cÚ¡ * 
bufãr
);

123 
nİŞl_g‘_16b™
 (cÚ¡ * 
bufãr
);

125 
nİŞl_£t_16b™
 (
v®ue
, * 
bufãr
);

127 
nİŞl_£t_32b™
 (
v®ue
, * 
bufãr
);

129 
nİŞl_g‘_32b™
 (cÚ¡ * 
bufãr
);

133 
	gEND_C_DECLS


	@nopoll_config.h

8 #iâdeà
__NOPOLL_CONFIG_H__


9 
	#__NOPOLL_CONFIG_H__


	)

27 #iâdeà
INT_TO_PTR


28 
	#INT_TO_PTR
(
š‹g”
è((
noPŞlPŒ
è(è(()š‹g”))

	)

42 #iâdeà
PTR_TO_INT


43 
	#PTR_TO_INT
(
±r
è((è(èÕŒ))

	)

51 
	#NOPOLL_OS_UNIX
 (1)

	)

58 
	#NOPOLL_HAVE_VASPRINTF
 (1)

	)

63 
	#NOPOLL_64BIT_PLATFORM
 (1)

	)

	@nopoll_config_win32.h

24 #iâdeà
__NOPOLL_CONFIG_H__


25 
	#__NOPOLL_CONFIG_H__


	)

43 #iâdeà
INT_TO_PTR


44 
	#INT_TO_PTR
(
š‹g”
è((
noPŞlPŒ
è(š‹g”))

	)

58 #iâdeà
PTR_TO_INT


59 
	#PTR_TO_INT
(
±r
è((èÕŒ))

	)

71 
	#NOPOLL_OS_WIN32
 (1)

	)

	@nopoll_config_win64.h

24 #iâdeà
__NOPOLL_CONFIG_H__


25 
	#__NOPOLL_CONFIG_H__


	)

27 
	~<ba£tsd.h
>

45 #iâdeà
INT_TO_PTR


46 
	#INT_TO_PTR
(
š‹g”
è
	`IÁToPŒ
(š‹g”)

	)

60 #iâdeà
PTR_TO_INT


61 
	#PTR_TO_INT
(
±r
è
	`PŒToIÁ
((cÚ¡ *èÕŒ))

	)

73 
	#NOPOLL_OS_WIN32
 (1)

	)

79 
	#NOPOLL_OS_WIN64
 (1)

	)

	@nopoll_conn.c

49 
	~<nİŞl_cÚn.h
>

50 
	~<nİŞl_´iv©e.h
>

52 #ià
defšed
(
NOPOLL_OS_UNIX
)

53 
	~<Ãtš‘/tı.h
>

69 
nİŞl_boŞ
 
	$nİŞl_cÚn_£t_sock_block
 (
NOPOLL_SOCKET
 
sock‘
,

70 
nİŞl_boŞ
 
’abË
)

72 #ià
	`defšed
(
NOPOLL_OS_UNIX
)

73 
æags
;

76 ià(
’abË
) {

78 #ià
	`defšed
(
NOPOLL_OS_WIN32
)

79 ià(!
	`nİŞl_wš32_blockšg_’abË
 (
sock‘
)) {

80  
nİŞl_çl£
;

83 ià((
æags
 = 
	`fú
 (
sock‘
, 
F_GETFL
, 0)) < -1) {

84  
nİŞl_çl£
;

87 
æags
 &ğ~
O_NONBLOCK
;

88 ià(
	`fú
 (
sock‘
, 
F_SETFL
, 
æags
) < -1) {

89  
nİŞl_çl£
;

94 #ià
	`defšed
(
NOPOLL_OS_WIN32
)

96 ià(!
	`nİŞl_wš32_nÚblockšg_’abË
 (
sock‘
)) {

97  
nİŞl_çl£
;

101 ià((
æags
 = 
	`fú
 (
sock‘
, 
F_GETFL
, 0)) < -1) {

102  
nİŞl_çl£
;

105 
æags
 |ğ
O_NONBLOCK
;

106 ià(
	`fú
 (
sock‘
, 
F_SETFL
, 
æags
) < -1) {

107  
nİŞl_çl£
;

112  
nİŞl_Œue
;

113 
	}
}

126 
	$nİŞl_cÚn_g‘_cÚÃù_timeout
 (
noPŞlCtx
 * 
ùx
)

129 ià(
ùx
 =ğ
NULL
) {

135  
ùx
->
cÚn_cÚÃù_¡d_timeout
;

136 
	}
}

150 
	$nİŞl_cÚn_cÚÃù_timeout
 (
noPŞlCtx
 * 
ùx
,

151 
miüo£cÚds_to_wa™
)

154 ià(
ùx
 =ğ
NULL
)

158 
ùx
->
cÚn_cÚÃù_¡d_timeout
 = 
miüo£cÚds_to_wa™
;

161 
	}
}

175 
nİŞl_boŞ
 
	$nİŞl_cÚn_£t_sock_tı_nod–ay
 (
NOPOLL_SOCKET
 
sock‘
,

176 
nİŞl_boŞ
 
’abË
)

179 
»suÉ
;

181 #ià
	`defšed
(
NOPOLL_OS_WIN32
)

182 
BOOL
 
æag
 = 
’abË
 ? 
TRUE
 : 
FALSE
;

183 
»suÉ
 = 
	`£tsockİt
(
sock‘
, 
IPPROTO_TCP
, 
TCP_NODELAY
, (*)&
æag
, (
BOOL
));

185 
æag
 = 
’abË
;

186 
»suÉ
 = 
	`£tsockİt
(
sock‘
, 
IPPROTO_TCP
, 
TCP_NODELAY
, &
æag
,  (flag));

188 ià(
»suÉ
 =ğ
NOPOLL_INVALID_SOCKET
) {

189  
nİŞl_çl£
;

193  
nİŞl_Œue
;

194 
	}
}

206 
nİŞl_boŞ
 
	$nİŞl_cÚn_£t_bšd_š‹rçû
 (
NOPOLL_SOCKET
 
sock‘
,

207 
noPŞlCÚnO±s
 * 
İtiÚs
)

210 
»suÉ
;

212 ià((
NULL
 !ğ
İtiÚs
è&& (NULL !ğİtiÚs->
š‹rçû
)) {

213 
»suÉ
 = 
	`£tsockİt
(
sock‘
, 
SOL_SOCKET
, 
SO_BINDTODEVICE
,

214 
İtiÚs
->
š‹rçû
, 
	`¡¾’
(options->interface)+1);

215 ià(
»suÉ
 =ğ
NOPOLL_SOCKET_ERROR
) {

216  
nİŞl_çl£
;

221  
nİŞl_Œue
;

222 
	}
}

239 
NOPOLL_SOCKET
 
	$nİŞl_cÚn_sock_cÚÃù_İts
 (
noPŞlCtx
 * 
ùx
,

240 cÚ¡ * 
ho¡
,

241 cÚ¡ * 
pÜt
,

242 
noPŞlCÚnO±s
 * 
İtiÚs
)

244 
ho¡’t
 * hostent;

245 
sockaddr_š
 
§ddr
;

246 
NOPOLL_SOCKET
 
£ssiÚ
;

249 
ho¡’t
 = 
	`g‘ho¡byÇme
 (
ho¡
);

250 ià(
ho¡’t
 =ğ
NULL
) {

251 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_DEBUG
, "uÇbËØ»sŞvho¡‚am%s", 
ho¡
);

256 
£ssiÚ
 = 
	`sock‘
 (
AF_INET
, 
SOCK_STREAM
, 0);

257 ià(
£ssiÚ
 =ğ
NOPOLL_INVALID_SOCKET
) {

258 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_CRITICAL
, "unableo create socket");

263 
	`nİŞl_cÚn_£t_sock_tı_nod–ay
 (
£ssiÚ
, 
nİŞl_Œue
);

266 ifĞ
nİŞl_Œue
 !ğ
	`nİŞl_cÚn_£t_bšd_š‹rçû
 (
£ssiÚ
, 
İtiÚs
) ) {

267 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_CRITICAL
, "unableo bindo specified interface");

268 
	`nİŞl_şo£_sock‘
 (
£ssiÚ
);

274 
	`mem£t
(&
§ddr
, 0, (saddr));

275 
§ddr
.
sš_addr
.
s_addr
 = ((
š_addr
 *)(
ho¡’t
->
h_addr
))->s_addr;

276 
§ddr
.
sš_çmy
 = 
AF_INET
;

277 
§ddr
.
sš_pÜt
 = 
	`htÚs
((
ušt16_t
è
	`¡¹od
 (
pÜt
, 
NULL
));

280 
	`nİŞl_cÚn_£t_sock_block
 (
£ssiÚ
, 
nİŞl_çl£
);

283 ià(
	`cÚÃù
 (
£ssiÚ
, (
sockaddr
 *)&
§ddr
, (saddr)) < 0) {

284 if(
”ºo
 !ğ
NOPOLL_EINPROGRESS
 &&ƒ¼nØ!ğ
NOPOLL_EWOULDBLOCK
 &&ƒ¼nØ!ğ
NOPOLL_ENOTCONN
) {

285 
	`shutdown
 (
£ssiÚ
, 
SHUT_RDWR
);

286 
	`nİŞl_şo£_sock‘
 (
£ssiÚ
);

288 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_WARNING
, "unableo connecto„emote host %s:%sƒrrno=%d",

289 
ho¡
, 
pÜt
, 
”ºo
);

295  
£ssiÚ
;

296 
	}
}

311 
NOPOLL_SOCKET
 
	$nİŞl_cÚn_sock_cÚÃù
 (
noPŞlCtx
 * 
ùx
,

312 cÚ¡ * 
ho¡
,

313 cÚ¡ * 
pÜt
)

315  
	`nİŞl_cÚn_sock_cÚÃù_İts
 (
ùx
, 
ho¡
, 
pÜt
, 
NULL
);

316 
	}
}

323 * 
	$__nİŞl_cÚn_g‘_ş›Á_š™
 (
noPŞlCÚn
 * 
cÚn
, 
noPŞlCÚnO±s
 * 
İts
)

326 
key
[50];

327 
key_size
 = 50;

328 
nÚû
[17];

331 ià(! 
	`nİŞl_nÚû
 (
nÚû
, 16)) {

332 
	`nİŞl_log
 (
cÚn
->
ùx
, 
NOPOLL_LEVEL_CRITICAL
, "Failedo get‚once, unableo…roduce Sec-WebSocket-Key.");

333  
NULL
;

337 ià(! 
	`nİŞl_ba£64_’code
 (
nÚû
, 16, 
key
, &
key_size
)) {

338 
	`nİŞl_log
 (
cÚn
->
ùx
, 
NOPOLL_LEVEL_CRITICAL
, "Unableo base 64ƒncode characters for Sec-WebSocket-Key");

339  
NULL
;

342 
	`nİŞl_log
 (
cÚn
->
ùx
, 
NOPOLL_LEVEL_DEBUG
, "C»©ed Sec-WebSock‘-Key‚Úû: %s", 
key
);

345 
cÚn
->
hªdshake
 = 
	`nİŞl_Ãw
 (
noPŞlHªdShake
, 1);

346 
cÚn
->
hªdshake
->
ex³ùed_acû±
 = 
	`nİŞl_¡rdup
 (
key
);

349  
	`nİŞl_¡rdup_´štf
 ("GET %s HTTP/1.1\r\nHost: %s\r\nUpgrade: websocket\r\nConnection: Upgrade\r\nSec-WebSocket-Key: %s\r\nOrigin: %s\r\n%s%s%s%s%s%s%s%sSec-WebSocket-Version: %d\r\n\r\n",

350 
cÚn
->
g‘_u¾
, cÚn->
ho¡_Çme
,

352 
key
,

354 
cÚn
->
Üigš
,

356 (
İts
 && o±s->
cook›
) ? "Cookie" : "",

357 (
İts
 && o±s->
cook›
) ? ": " : "",

358 (
İts
 && o±s->
cook›
) ? opts->cookie : "",

359 (
İts
 && o±s->
cook›
) ? "\r\n" : "",

361 
cÚn
->
´ÙocŞs
 ? "Sec-WebSocket-Protocol" : "",

362 
cÚn
->
´ÙocŞs
 ? ": " : "",

363 
cÚn
->
´ÙocŞs
 ? conn->protocols : "",

364 
cÚn
->
´ÙocŞs
 ? "\r\n" : "",

365 
cÚn
->
ùx
->
´ÙocŞ_v”siÚ
);

366 
	}
}

372 
	$nİŞl_cÚn_log_s¦
 (
noPŞlCÚn
 * 
cÚn
)

374 #ià
	`defšed
(
SHOW_DEBUG_LOG
)

375 
noPŞlCtx
 * 
ùx
 = 
cÚn
->ctx;

377 
log_bufãr
 [512];

378 
”r
;

379 
”rÜ_pos™iÚ
;

380 
aux_pos™iÚ
;

382 (
”r
 = 
	`ERR_g‘_”rÜ
()) != 0) {

383 
	`ERR_”rÜ_¡ršg_n
 (
”r
, 
log_bufãr
,  (log_buffer));

384 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_CRITICAL
, " ¡ack: % (fšd„—sÚ(codeè© o³ns¦/s¦.h)", 
log_bufãr
);

387 
”rÜ_pos™iÚ
 = 0;

388 
log_bufãr
[
”rÜ_pos™iÚ
] != ':' &&†og_buffer[error_position] != 0 &&ƒrror_position < 511)

389 
”rÜ_pos™iÚ
++;

390 
”rÜ_pos™iÚ
++;

391 
aux_pos™iÚ
 = 
”rÜ_pos™iÚ
;

392 
log_bufãr
[
aux_pos™iÚ
] != 0) {

393 ià(
log_bufãr
[
aux_pos™iÚ
] == ':') {

394 
log_bufãr
[
aux_pos™iÚ
] = 0;

397 
aux_pos™iÚ
++;

399 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_CRITICAL
, " d‘as,„un: o³ns¦ƒ¼¡¸%s", 
log_bufãr
 + 
”rÜ_pos™iÚ
);

402 
	`»cv
 (
cÚn
->
£ssiÚ
, 
log_bufãr
, 1, 
MSG_PEEK
);

403 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_CRITICAL
, "‚oPoll id=%d, socket: %d (afterestingƒrrno: %d)",

404 
cÚn
->
id
, cÚn->
£ssiÚ
, 
”ºo
);

408 
	}
}

410 
	$__nİŞl_cÚn_s_hªdË_”rÜ
 (
noPŞlCÚn
 * 
cÚn
, 
»s
, cÚ¡ * 
Ïb–
, 
nİŞl_boŞ
 * 
Ãeds_»Œy
)

412 
s¦_”r
;

414 (*
Ãeds_»Œy
èğ
nİŞl_çl£
;

417 
s¦_”r
 = 
	`SSL_g‘_”rÜ
 (
cÚn
->
s¦
, 
»s
);

418 
s¦_”r
) {

419 
SSL_ERROR_NONE
:

423  
»s
;

424 
SSL_ERROR_WANT_WRITE
:

425 
SSL_ERROR_WANT_READ
:

426 
SSL_ERROR_WANT_X509_LOOKUP
:

427 
	`nİŞl_log
 (
cÚn
->
ùx
, 
NOPOLL_LEVEL_DEBUG
, "%s, ssl_err=%d„eturnedhat isn't„eadyo„ead/write: you should„etry",

428 
Ïb–
, 
s¦_”r
);

429 (*
Ãeds_»Œy
èğ
nİŞl_Œue
;

431 
SSL_ERROR_SYSCALL
:

432 if(
»s
 < 0) {

433 if(
”ºo
 =ğ
NOPOLL_EINTR
) {

434 
	`nİŞl_log
 (
cÚn
->
ùx
, 
NOPOLL_LEVEL_DEBUG
, "% š‹¼u±ed by‡ sigÇl:„‘ryšg", 
Ïb–
);

438 
	`nİŞl_log
 (
cÚn
->
ùx
, 
NOPOLL_LEVEL_WARNING
, "SSL_read (SSL_ERROR_SYSCALL)");

441 
	`nİŞl_log
 (
cÚn
->
ùx
, 
NOPOLL_LEVEL_CRITICAL
, "SSL socket closed on %s (res=%d, ssl_err=%d,ƒrrno=%d)",

442 
Ïb–
, 
»s
, 
s¦_”r
, 
”ºo
);

443 
	`nİŞl_cÚn_log_s¦
 (
cÚn
);

445  
»s
;

446 
SSL_ERROR_ZERO_RETURN
:

447 
	`nİŞl_log
 (
cÚn
->
ùx
, 
NOPOLL_LEVEL_DEBUG
, "SSL clo£d oÀ%s", 
Ïb–
);

448  
»s
;

449 
SSL_ERROR_SSL
:

450 
	`nİŞl_log
 (
cÚn
->
ùx
, 
NOPOLL_LEVEL_WARNING
, "%s functionƒrror (received SSL_ERROR_SSL) (res=%d, ssl_err=%d,ƒrrno=%d)",

451 
Ïb–
, 
»s
, 
s¦_”r
, 
”ºo
);

452 
	`nİŞl_cÚn_log_s¦
 (
cÚn
);

458 
	`nİŞl_log
 (
cÚn
->
ùx
, 
NOPOLL_LEVEL_WARNING
, "%s/SSL_g‘_”rÜ„‘uºed %d", 
Ïb–
, 
»s
);

461 
	}
}

466 
	$nİŞl_cÚn_s_»ûive
 (
noPŞlCÚn
 * 
cÚn
, * 
bufãr
, 
bufãr_size
)

468 
»s
;

469 
nİŞl_boŞ
 
Ãeds_»Œy
;

470 
Œ›s
 = 0;

473 
Œ›s
 < 50) {

474 
»s
 = 
	`SSL_»ad
 (
cÚn
->
s¦
, 
bufãr
, 
bufãr_size
);

478 
»s
 = 
	`__nİŞl_cÚn_s_hªdË_”rÜ
 (
cÚn
,„es, "SSL_»ad", &
Ãeds_»Œy
);

480 ià(! 
Ãeds_»Œy
)

484 
Œ›s
++;

487  
»s
;

488 
	}
}

493 
	$nİŞl_cÚn_s_£nd
 (
noPŞlCÚn
 * 
cÚn
, * 
bufãr
, 
bufãr_size
)

495 
»s
;

496 
nİŞl_boŞ
 
Ãeds_»Œy
;

497 
Œ›s
 = 0;

500 
Œ›s
 < 50) {

501 
»s
 = 
	`SSL_wr™e
 (
cÚn
->
s¦
, 
bufãr
, 
bufãr_size
);

502 
	`nİŞl_log
 (
cÚn
->
ùx
, 
NOPOLL_LEVEL_DEBUG
, "SSL: s’ˆ%d by‹ Ôeque¡ed: %d)..", 
»s
, 
bufãr_size
);

505 
»s
 = 
	`__nİŞl_cÚn_s_hªdË_”rÜ
 (
cÚn
,„es, "SSL_wr™e", &
Ãeds_»Œy
);

508 ià(! 
Ãeds_»Œy
)

512 
	`nİŞl_¦“p
 (
Œ›s
 * 10000);

513 
Œ›s
++;

515  
»s
;

516 
	}
}

519 
SSL_CTX
 * 
	$__nİŞl_cÚn_g‘_s¦_cÚ‹xt
 (
noPŞlCtx
 * 
ùx
, 
noPŞlCÚn
 * 
cÚn
, 
noPŞlCÚnO±s
 * 
İts
, 
nİŞl_boŞ
 
is_ş›Á
)

522 ià(
ùx
 && ctx->
cÚ‹xt_ü—tÜ
)

523  
ùx
->
	`cÚ‹xt_ü—tÜ
 (ùx, 
cÚn
, 
İts
, 
is_ş›Á
, ctx->
cÚ‹xt_ü—tÜ_d©a
);

525 ià(
İts
 =ğ
NULL
) {

527  
	`SSL_CTX_Ãw
 (
is_ş›Á
 ? 
	`TLSv1_ş›Á_m‘hod
 (è: 
	`TLSv1_£rv”_m‘hod
 ());

530 
İts
->
s¦_´ÙocŞ
) {

531 
NOPOLL_METHOD_TLSV1
:

532  
	`SSL_CTX_Ãw
 (
is_ş›Á
 ? 
	`TLSv1_ş›Á_m‘hod
 (è: 
	`TLSv1_£rv”_m‘hod
 ());

533 #ià
	`defšed
(
TLSv1_1_ş›Á_m‘hod
)

534 
NOPOLL_METHOD_TLSV1_1
:

536  
	`SSL_CTX_Ãw
 (
is_ş›Á
 ? 
	`TLSv1_1_ş›Á_m‘hod
 (è: 
	`TLSv1_1_£rv”_m‘hod
 ());

538 
NOPOLL_METHOD_SSLV3
:

540  
	`SSL_CTX_Ãw
 (
is_ş›Á
 ? 
	`SSLv3_ş›Á_m‘hod
 (è: 
	`SSLv3_£rv”_m‘hod
 ());

541 
NOPOLL_METHOD_SSLV23
:

543  
	`SSL_CTX_Ãw
 (
is_ş›Á
 ? 
	`SSLv23_ş›Á_m‘hod
 (è: 
	`SSLv23_£rv”_m‘hod
 ());

547  
	`SSL_CTX_Ãw
 (
is_ş›Á
 ? 
	`TLSv1_ş›Á_m‘hod
 (è: 
	`TLSv1_£rv”_m‘hod
 ());

548 
	}
}

550 
noPŞlCtx
 * 
	g__nİŞl_cÚn_s¦_ùx_debug
 = 
NULL
;

552 
	$__nİŞl_cÚn_s¦_v”ify_ÿÎback
 (
ok
, 
X509_STORE_CTX
 * 
¡Üe
) {

553 
d©a
[256];

554 
X509
 * 
û¹
;

555 #ià
	`defšed
(
SHOW_DEBUG_LOG
)

556 
d•th
;

557 
”r
;

560 ià(! 
ok
) {

561 
û¹
 = 
	`X509_STORE_CTX_g‘_cu¼’t_û¹
 (
¡Üe
);

562 #ià
	`defšed
(
SHOW_DEBUG_LOG
)

563 
d•th
 = 
	`X509_STORE_CTX_g‘_”rÜ_d•th
 (
¡Üe
);

564 
”r
 = 
	`X509_STORE_CTX_g‘_”rÜ
 (
¡Üe
);

567 
	`nİŞl_log
 (
__nİŞl_cÚn_s¦_ùx_debug
, 
NOPOLL_LEVEL_CRITICAL
, "CERTIFICATE:ƒ¼Ü=%d‡ˆd•th: %d", 
”r
, 
d•th
);

569 
	`X509_NAME_Ú–še
 (
	`X509_g‘_issu”_Çme
 (
û¹
), 
d©a
, 256);

570 
	`nİŞl_log
 (
__nİŞl_cÚn_s¦_ùx_debug
, 
NOPOLL_LEVEL_CRITICAL
, "CERTIFICATE: issu”: %s", 
d©a
);

572 
	`X509_NAME_Ú–še
 (
	`X509_g‘_subjeù_Çme
 (
û¹
), 
d©a
, 256);

573 
	`nİŞl_log
 (
__nİŞl_cÚn_s¦_ùx_debug
, 
NOPOLL_LEVEL_CRITICAL
, "CERTIFICATE: subjeù: %s", 
d©a
);

575 
	`nİŞl_log
 (
__nİŞl_cÚn_s¦_ùx_debug
, 
NOPOLL_LEVEL_CRITICAL
, "CERTIFICATE:ƒ¼Ü %d:%s", 
”r
, 
	`X509_v”ify_û¹_”rÜ_¡ršg
 (err));

578  
ok
;

579 
	}
}

581 
nİŞl_boŞ
 
	$__nİŞl_cÚn_£t_s¦_ş›Á_İtiÚs
 (
noPŞlCtx
 * 
ùx
, 
noPŞlCÚn
 * 
cÚn
, 
noPŞlCÚnO±s
 * 
İtiÚs
)

583 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_DEBUG
, "CheckšgØe¡ablish SSL o±iÚ (%p)", 
İtiÚs
);

585 ià(
İtiÚs
 && o±iÚs->
ÿ_û¹ifiÿ‹
) {

586 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_DEBUG
, "S‘tšg CA c”tifiÿ‹: %s", 
İtiÚs
->
ÿ_û¹ifiÿ‹
);

587 ià(
	`SSL_CTX_lßd_v”ify_loÿtiÚs
 (
cÚn
->
s¦_ùx
, 
İtiÚs
->
ÿ_û¹ifiÿ‹
, 
NULL
) != 1) {

588 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_CRITICAL
, "FaedØcÚfigu» CA c”tifiÿ‹ (%s), SSL_CTX_lßd_v”ify_loÿtiÚ (èçed", 
İtiÚs
->
ÿ_û¹ifiÿ‹
);

589  
nİŞl_çl£
;

595 ià(
	`SSL_CTX_£t_deçuÉ_v”ify_·ths
 (
cÚn
->
s¦_ùx
) != 1) {

596 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_CRITICAL
, "Unableo configure default verification…aths, SSL_CTX_set_default_verify_paths () failed");

597  
nİŞl_çl£
;

600 ià(
İtiÚs
 && o±iÚs->
chaš_û¹ifiÿ‹
) {

601 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_DEBUG
, "S‘tšg chaš c”tifiÿ‹: %s", 
İtiÚs
->
chaš_û¹ifiÿ‹
);

602 ià(
	`SSL_CTX_u£_û¹ifiÿ‹_chaš_fe
 (
cÚn
->
s¦_ùx
, 
İtiÚs
->
chaš_û¹ifiÿ‹
) != 1) {

603 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_CRITICAL
, "FaedØcÚfigu» chaš c”tifiÿ‹ (%s), SSL_CTX_u£_û¹ifiÿ‹_chaš_f(èçed", 
İtiÚs
->
chaš_û¹ifiÿ‹
);

604  
nİŞl_çl£
;

608 ià(
İtiÚs
 && o±iÚs->
û¹ifiÿ‹
) {

609 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_DEBUG
, "S‘tšg c”tifiÿ‹: %s", 
İtiÚs
->
û¹ifiÿ‹
);

610 ià(
	`SSL_CTX_u£_û¹ifiÿ‹_chaš_fe
 (
cÚn
->
s¦_ùx
, 
İtiÚs
->
û¹ifiÿ‹
) != 1) {

611 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_CRITICAL
, "FaedØcÚfigu» cl›Á c”tifiÿ‹ (%s), SSL_CTX_u£_û¹ifiÿ‹_f(èçed", 
İtiÚs
->
û¹ifiÿ‹
);

612  
nİŞl_çl£
;

616 ià(
İtiÚs
 && o±iÚs->
´iv©e_key
) {

617 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_DEBUG
, "S‘tšg…riv©key: %s", 
İtiÚs
->
´iv©e_key
);

618 ià(
	`SSL_CTX_u£_Priv©eKey_fe
 (
cÚn
->
s¦_ùx
, 
İtiÚs
->
´iv©e_key
, 
SSL_FILETYPE_PEM
) != 1) {

619 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_CRITICAL
, "FaedØcÚfigu»…riv©key (%s), SSL_CTX_u£_Priv©eKey_f(èçed", 
İtiÚs
->
´iv©e_key
);

620  
nİŞl_çl£
;

624 ià(
İtiÚs
 && o±iÚs->
´iv©e_key
 && o±iÚs->
û¹ifiÿ‹
) {

625 ià(!
	`SSL_CTX_check_´iv©e_key
 (
cÚn
->
s¦_ùx
)) {

626 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_CRITICAL
, "Certificate‡nd…rivate key do‚ot matches, verification fails, SSL_CTX_check_private_key ()");

627  
nİŞl_çl£
;

629 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_DEBUG
, "C”tifiÿ‹ (%sèªd…riv©key (%sèm©ches", 
İtiÚs
->
û¹ifiÿ‹
, o±iÚs->
´iv©e_key
);

633 ià(
İtiÚs
 =ğ
NULL
 || ! o±iÚs->
di§bË_s¦_v”ify
) {

634 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_DEBUG
, "Enabling certificate…eer verification");

638 
__nİŞl_cÚn_s¦_ùx_debug
 = 
ùx
;

639 
	`SSL_CTX_£t_v”ify
 (
cÚn
->
s¦_ùx
, 
SSL_VERIFY_PEER
, 
__nİŞl_cÚn_s¦_v”ify_ÿÎback
);

640 
	`SSL_CTX_£t_v”ify_d•th
 (
cÚn
->
s¦_ùx
, 10);

643  
nİŞl_Œue
;

644 
	}
}

650 
noPŞlCÚn
 * 
	$__nİŞl_cÚn_Ãw_commÚ
 (
noPŞlCtx
 * 
ùx
,

651 
noPŞlCÚnO±s
 * 
İtiÚs
,

652 
nİŞl_boŞ
 
’abË_s
,

653 cÚ¡ * 
ho¡_
,

654 cÚ¡ * 
ho¡_pÜt
,

655 cÚ¡ * 
ho¡_Çme
,

656 cÚ¡ * 
g‘_u¾
,

657 cÚ¡ * 
´ÙocŞs
,

658 cÚ¡ * 
Üigš
)

660 
noPŞlCÚn
 * 
cÚn
;

661 
NOPOLL_SOCKET
 
£ssiÚ
;

662 * 
cÚ‹Á
;

663 
size
;

664 
s¦_”rÜ
;

665 
X509
 * 
£rv”_û¹
;

666 
™”©Ü
;

667 
»maššg_timeout
;

669 ià(! 
ùx
 || ! 
ho¡_
) {

671 
	`__nİŞl_cÚn_İts_»Ëa£_if_Ãeded
 (
İtiÚs
);

672  
NULL
;

676 ià(
ho¡_pÜt
 =ğ
NULL
)

677 
ho¡_pÜt
 = "80";

680 
£ssiÚ
 = 
	`nİŞl_cÚn_sock_cÚÃù_İts
 (
ùx
, 
ho¡_
, 
ho¡_pÜt
, 
İtiÚs
);

681 ià(
£ssiÚ
 =ğ
NOPOLL_INVALID_SOCKET
) {

683 
	`__nİŞl_cÚn_İts_»Ëa£_if_Ãeded
 (
İtiÚs
);

684 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_CRITICAL
, "FaedØcÚÃùØ»mÙho¡ %s:%s", 
ho¡_
, 
ho¡_pÜt
);

685  
NULL
;

689 
cÚn
 = 
	`nİŞl_Ãw
 (
noPŞlCÚn
, 1);

690 ià(
cÚn
 =ğ
NULL
) {

692 
	`__nİŞl_cÚn_İts_»Ëa£_if_Ãeded
 (
İtiÚs
);

693  
NULL
;

696 
cÚn
->
»fs
 = 1;

699 
cÚn
->
»f_mu‹x
 = 
	`nİŞl_mu‹x_ü—‹
 ();

702 ià(! 
	`nİŞl_ùx_»gi¡”_cÚn
 (
ùx
, 
cÚn
)) {

703 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_CRITICAL
, "Failedo„egister connection intohe context, unableo create connection");

704 
	`nİŞl_ä“
 (
cÚn
);

706 
	`__nİŞl_cÚn_İts_»Ëa£_if_Ãeded
 (
İtiÚs
);

708  
NULL
;

711 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_DEBUG
, "Created‚oPoll conn-id=%d (ptr: %p, context: %p, socket: %d)",

712 
cÚn
->
id
, cÚn, 
ùx
, 
£ssiÚ
);

715 
cÚn
->
ùx
 = ctx;

716 
cÚn
->
£ssiÚ
 = session;

717 
cÚn
->
rŞe
 = 
NOPOLL_ROLE_CLIENT
;

720 
cÚn
->
ho¡
 = 
	`nİŞl_¡rdup
 (
ho¡_
);

721 
cÚn
->
pÜt
 = 
	`nİŞl_¡rdup
 (
ho¡_pÜt
);

724 
cÚn
->
»ûive
 = 
nİŞl_cÚn_deçuÉ_»ûive
;

725 
cÚn
->
£nd
 = 
nİŞl_cÚn_deçuÉ_£nd
;

728 ià(
ho¡_Çme
 =ğ
NULL
)

729 
cÚn
->
ho¡_Çme
 = 
	`nİŞl_¡rdup
 (
ho¡_
);

731 
cÚn
->
ho¡_Çme
 = 
	`nİŞl_¡rdup
 (host_name);

734 ià(
Üigš
 =ğ
NULL
)

735 
cÚn
->
Üigš
 = 
	`nİŞl_¡rdup_´štf
 ("h‰p://%s", cÚn->
ho¡_Çme
);

737 
cÚn
->
Üigš
 = 
	`nİŞl_¡rdup
 (origin);

740 ià(
g‘_u¾
 =ğ
NULL
)

741 
cÚn
->
g‘_u¾
 = 
	`nİŞl_¡rdup
 ("/");

743 
cÚn
->
g‘_u¾
 = 
	`nİŞl_¡rdup
 (get_url);

746 ià(
´ÙocŞs
 !ğ
NULL
)

747 
cÚn
->
´ÙocŞs
 = 
	`nİŞl_¡rdup
 (protocols);

751 
cÚ‹Á
 = 
	`__nİŞl_cÚn_g‘_ş›Á_š™
 (
cÚn
, 
İtiÚs
);

753 ià(
cÚ‹Á
 =ğ
NULL
) {

754 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_CRITICAL
, "Failedo build client init message, unableo connect");

755 
	`nİŞl_cÚn_shutdown
 (
cÚn
);

758 
	`__nİŞl_cÚn_İts_»Ëa£_if_Ãeded
 (
İtiÚs
);

760  
NULL
;

764 ià(
’abË_s
) {

766 
cÚn
->
s¦_ùx
 = 
	`__nİŞl_cÚn_g‘_s¦_cÚ‹xt
 (
ùx
, cÚn, 
İtiÚs
, 
nİŞl_Œue
);

769 ià(! 
	`__nİŞl_cÚn_£t_s¦_ş›Á_İtiÚs
 (
ùx
, 
cÚn
, 
İtiÚs
)) {

770 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_CRITICAL
, "Unableo configure‡dditional SSL options, unableo continue",

771 
cÚn
->
s¦_ùx
, cÚn->
s¦
);

772 
ç_s¦_cÚÃùiÚ
;

776 
cÚn
->
s¦
 = 
	`SSL_Ãw
 (cÚn->
s¦_ùx
);

777 ià(
cÚn
->
s¦_ùx
 =ğ
NULL
 || cÚn->
s¦
 == NULL) {

778 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_CRITICAL
, "Unableo create SSL context internal„eferences‡re‚ull (conn->ssl_ctx=%p, conn->ssl=%p)",

779 
cÚn
->
s¦_ùx
, cÚn->
s¦
);

780 
ç_s¦_cÚÃùiÚ
:

782 
	`nİŞl_ä“
 (
cÚ‹Á
);

783 
	`nİŞl_cÚn_shutdown
 (
cÚn
);

786 
	`__nİŞl_cÚn_İts_»Ëa£_if_Ãeded
 (
İtiÚs
);

788  
cÚn
;

792 
	`SSL_£t_fd
 (
cÚn
->
s¦
, cÚn->
£ssiÚ
);

795 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_DEBUG
, "connectingo„emote TLS site");

796 
™”©Ü
 = 0;

797 
	`SSL_cÚÃù
 (
cÚn
->
s¦
) <= 0) {

800 
s¦_”rÜ
 = 
	`SSL_g‘_”rÜ
 (
cÚn
->
s¦
, -1);

802 
s¦_”rÜ
) {

803 
SSL_ERROR_WANT_READ
:

804 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_WARNING
, "still‚ot…reparedo continue because„ead wanted, conn-id=%d (%p, session: %d),ƒrrno=%d",

805 
cÚn
->
id
, cÚn, cÚn->
£ssiÚ
, 
”ºo
);

807 
SSL_ERROR_WANT_WRITE
:

808 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_WARNING
, "still‚ot…reparedo continue because write wanted, conn-id=%d (%p)",

809 
cÚn
->
id
, conn);

811 
SSL_ERROR_SYSCALL
:

812 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_CRITICAL
, "syscallƒrror while doing TLS handshake, sslƒrror (code:%d), conn-id: %d (%p),ƒrrno: %d, session: %d",

813 
s¦_”rÜ
, 
cÚn
->
id
, cÚn, 
”ºo
, cÚn->
£ssiÚ
);

814 
	`nİŞl_cÚn_log_s¦
 (
cÚn
);

815 
	`nİŞl_cÚn_shutdown
 (
cÚn
);

816 
	`nİŞl_ä“
 (
cÚ‹Á
);

819 
	`__nİŞl_cÚn_İts_»Ëa£_if_Ãeded
 (
İtiÚs
);

821  
cÚn
;

823 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_CRITICAL
, "there was‡nƒrror withhe TLS‚egotiation, sslƒrror (code:%d) : %s",

824 
s¦_”rÜ
, 
	`ERR_”rÜ_¡ršg
 (s¦_”rÜ, 
NULL
));

825 
	`nİŞl_cÚn_log_s¦
 (
cÚn
);

826 
	`nİŞl_cÚn_shutdown
 (
cÚn
);

827 
	`nİŞl_ä“
 (
cÚ‹Á
);

830 
	`__nİŞl_cÚn_İts_»Ëa£_if_Ãeded
 (
İtiÚs
);

832  
cÚn
;

836 
™”©Ü
++;

838 ià(
™”©Ü
 > 100) {

839 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_CRITICAL
, "Max„etry calls=%do SSL_connect„eached, shutting down connection id=%d,ƒrrno=%d",

840 
™”©Ü
, 
cÚn
->
id
, 
”ºo
);

841 
	`nİŞl_ä“
 (
cÚ‹Á
);

844 
	`__nİŞl_cÚn_İts_»Ëa£_if_Ãeded
 (
İtiÚs
);

846  
cÚn
;

850 
	`nİŞl_¦“p
 (10000);

854 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_DEBUG
, "Client TLS handshake finished, configuring I/O handlers");

857 
£rv”_û¹
 = 
	`SSL_g‘_³”_û¹ifiÿ‹
 (
cÚn
->
s¦
);

858 ià(
£rv”_û¹
 =ğ
NULL
) {

859 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_CRITICAL
, "server side didn't set‡ certificate forhis session,hese‡re bad‚ews");

862 
	`nİŞl_ä“
 (
cÚ‹Á
);

863 
	`__nİŞl_cÚn_İts_»Ëa£_if_Ãeded
 (
İtiÚs
);

865  
cÚn
;

867 
	`X509_ä“
 (
£rv”_û¹
);

870 ià(
cÚn
->
ùx
 && cÚn->ùx->
po¡_s¦_check
) {

871 ià(! 
cÚn
->
ùx
->
	`po¡_s¦_check
 (cÚn->ùx, cÚn, cÚn->
s¦_ùx
, cÚn->
s¦
, cÚn->ùx->
po¡_s¦_check_d©a
)) {

873 
	`nİŞl_log
 (
cÚn
->
ùx
, 
NOPOLL_LEVEL_CRITICAL
, "TLS/SSL…ost check function failed, dropping connection");

874 
	`nİŞl_cÚn_shutdown
 (
cÚn
);

875  
NULL
;

880 
cÚn
->
»ûive
 = 
nİŞl_cÚn_s_»ûive
;

881 
cÚn
->
£nd
 = 
nİŞl_cÚn_s_£nd
;

883 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_DEBUG
, "TLS I/O handlers configured");

884 
cÚn
->
s_Ú
 = 
nİŞl_Œue
;

887 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_DEBUG
, "S’dšg websock‘ cl›Á in™: %s", 
cÚ‹Á
);

888 
size
 = 
	`¡¾’
 (
cÚ‹Á
);

891 
»maššg_timeout
 = 
ùx
->
cÚn_cÚÃù_¡d_timeout
;

892 
»maššg_timeout
 > 0) {

893 ià(
size
 !ğ
cÚn
->
	`£nd
 (cÚn, 
cÚ‹Á
, size)) {

895 ià(
”ºo
 =ğ
NOPOLL_EWOULDBLOCK
 ||ƒ¼nØ=ğ
NOPOLL_EINPROGRESS
 ||ƒ¼nØ=ğ
NOPOLL_ENOTCONN
) {

897 
	`nİŞl_¦“p
 (10000);

898 
»maššg_timeout
 -= 10000;

902 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_CRITICAL
, "FaedØ£nd websock‘ in™ mes§ge,ƒ¼Ü codwas: %d (2), closšg sessiÚ", 
”ºo
);

903 
	`nİŞl_cÚn_shutdown
 (
cÚn
);

909 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_DEBUG
, "Web socket initial client handshake sent");

912 
	`nİŞl_ä“
 (
cÚ‹Á
);

915 
	`__nİŞl_cÚn_İts_»Ëa£_if_Ãeded
 (
İtiÚs
);

918  
cÚn
;

919 
	}
}

985 
noPŞlCÚn
 * 
	$nİŞl_cÚn_Ãw
 (
noPŞlCtx
 * 
ùx
,

986 cÚ¡ * 
ho¡_
,

987 cÚ¡ * 
ho¡_pÜt
,

988 cÚ¡ * 
ho¡_Çme
,

989 cÚ¡ * 
g‘_u¾
,

990 cÚ¡ * 
´ÙocŞs
,

991 cÚ¡ * 
Üigš
)

994  
	`__nİŞl_cÚn_Ãw_commÚ
 (
ùx
, 
NULL
, 
nİŞl_çl£
,

995 
ho¡_
, 
ho¡_pÜt
, 
ho¡_Çme
,

996 
g‘_u¾
, 
´ÙocŞs
, 
Üigš
);

997 
	}
}

1042 
noPŞlCÚn
 * 
	$nİŞl_cÚn_Ãw_İts
 (
noPŞlCtx
 * 
ùx
,

1043 
noPŞlCÚnO±s
 * 
İts
,

1044 cÚ¡ * 
ho¡_
,

1045 cÚ¡ * 
ho¡_pÜt
,

1046 cÚ¡ * 
ho¡_Çme
,

1047 cÚ¡ * 
g‘_u¾
,

1048 cÚ¡ * 
´ÙocŞs
,

1049 cÚ¡ * 
Üigš
)

1052  
	`__nİŞl_cÚn_Ãw_commÚ
 (
ùx
, 
İts
, 
nİŞl_çl£
,

1053 
ho¡_
, 
ho¡_pÜt
, 
ho¡_Çme
,

1054 
g‘_u¾
, 
´ÙocŞs
, 
Üigš
);

1055 
	}
}

1057 
nİŞl_boŞ
 
	g__nİŞl_s_was_š™
 = 
nİŞl_çl£
;

1102 
noPŞlCÚn
 * 
	$nİŞl_cÚn_s_Ãw
 (
noPŞlCtx
 * 
ùx
,

1103 
noPŞlCÚnO±s
 * 
İtiÚs
,

1104 cÚ¡ * 
ho¡_
,

1105 cÚ¡ * 
ho¡_pÜt
,

1106 cÚ¡ * 
ho¡_Çme
,

1107 cÚ¡ * 
g‘_u¾
,

1108 cÚ¡ * 
´ÙocŞs
,

1109 cÚ¡ * 
Üigš
)

1112 ià(! 
__nİŞl_s_was_š™
) {

1113 
__nİŞl_s_was_š™
 = 
nİŞl_Œue
;

1114 
	`SSL_lib¿ry_š™
 ();

1118  
	`__nİŞl_cÚn_Ãw_commÚ
 (
ùx
, 
İtiÚs
, 
nİŞl_Œue
,

1119 
ho¡_
, 
ho¡_pÜt
, 
ho¡_Çme
,

1120 
g‘_u¾
, 
´ÙocŞs
, 
Üigš
);

1121 
	}
}

1131 
nİŞl_boŞ
 
	$nİŞl_cÚn_»f
 (
noPŞlCÚn
 * 
cÚn
)

1133 ià(
cÚn
 =ğ
NULL
)

1134  
nİŞl_çl£
;

1137 
	`nİŞl_mu‹x_lock
 (
cÚn
->
»f_mu‹x
);

1138 ià(
cÚn
->
»fs
 <= 0) {

1140 
	`nİŞl_mu‹x_uÆock
 (
cÚn
->
»f_mu‹x
);

1141  
nİŞl_çl£
;

1144 
cÚn
->
»fs
++;

1147 
	`nİŞl_mu‹x_uÆock
 (
cÚn
->
»f_mu‹x
);

1149  
nİŞl_Œue
;

1150 
	}
}

1160 
	$nİŞl_cÚn_»f_couÁ
 (
noPŞlCÚn
 * 
cÚn
)

1162 ià(! 
cÚn
)

1164  
cÚn
->
»fs
;

1165 
	}
}

1191 
nİŞl_boŞ
 
	$nİŞl_cÚn_is_ok
 (
noPŞlCÚn
 * 
cÚn
)

1193 ià(
cÚn
 =ğ
NULL
)

1194  
nİŞl_çl£
;

1197  
cÚn
->
£ssiÚ
 !ğ
NOPOLL_INVALID_SOCKET
;

1198 
	}
}

1213 
nİŞl_boŞ
 
	$nİŞl_cÚn_is_»ady
 (
noPŞlCÚn
 * 
cÚn
)

1215 ià(
cÚn
 =ğ
NULL
)

1216  
nİŞl_çl£
;

1217 ià(
cÚn
->
£ssiÚ
 =ğ
NOPOLL_INVALID_SOCKET
)

1218  
nİŞl_çl£
;

1219 ià(! 
cÚn
->
hªdshake_ok
) {

1221 
	`nİŞl_mu‹x_lock
 (
cÚn
->
»f_mu‹x
);

1224 
	`nİŞl_cÚn_com¶‘e_hªdshake
 (
cÚn
);

1227 
	`nİŞl_mu‹x_uÆock
 (
cÚn
->
»f_mu‹x
);

1229  
cÚn
->
hªdshake_ok
;

1230 
	}
}

1239 
nİŞl_boŞ
 
	$nİŞl_cÚn_is_s_Ú
 (
noPŞlCÚn
 * 
cÚn
)

1241 ià(! 
cÚn
)

1242  
nİŞl_çl£
;

1245  
cÚn
->
s_Ú
;

1246 
	}
}

1254 
NOPOLL_SOCKET
 
	$nİŞl_cÚn_sock‘
 (
noPŞlCÚn
 * 
cÚn
)

1256 ià(
cÚn
 =ğ
NULL
)

1258  
cÚn
->
£ssiÚ
;

1259 
	}
}

1269 
	$nİŞl_cÚn_£t_sock‘
 (
noPŞlCÚn
 * 
cÚn
, 
NOPOLL_SOCKET
 
_sock‘
)

1271 ià(
cÚn
 =ğ
NULL
)

1273 
cÚn
->
£ssiÚ
 = 
_sock‘
;

1275 
	}
}

1286 
	$nİŞl_cÚn_g‘_id
 (
noPŞlCÚn
 * 
cÚn
)

1288 ià(
cÚn
 =ğ
NULL
)

1290  
cÚn
->
id
;

1291 
	}
}

1301 
noPŞlCtx
 * 
	$nİŞl_cÚn_ùx
 (
noPŞlCÚn
 * 
cÚn
)

1303 ià(
cÚn
 =ğ
NULL
)

1304  
NULL
;

1305  
cÚn
->
ùx
;

1306 
	}
}

1313 
noPŞlRŞe
 
	$nİŞl_cÚn_rŞe
 (
noPŞlCÚn
 * 
cÚn
)

1315 ià(
cÚn
 =ğ
NULL
)

1316  
NOPOLL_ROLE_UNKNOWN
;

1317  
cÚn
->
rŞe
;

1318 
	}
}

1332 cÚ¡ * 
	$nİŞl_cÚn_ho¡
 (
noPŞlCÚn
 * 
cÚn
)

1334 ià(
cÚn
 =ğ
NULL
)

1335  
NULL
;

1336  
cÚn
->
ho¡
;

1337 
	}
}

1347 cÚ¡ * 
	$nİŞl_cÚn_g‘_Üigš
 (
noPŞlCÚn
 * 
cÚn
)

1349 ià(
cÚn
 =ğ
NULL
 || cÚn->
hªdshake
 == NULL)

1350  
NULL
;

1351  
cÚn
->
Üigš
;

1352 
	}
}

1364 cÚ¡ * 
	$nİŞl_cÚn_g‘_ho¡_h—d”
 (
noPŞlCÚn
 * 
cÚn
)

1366 ià(
cÚn
 =ğ
NULL
 || cÚn->
ho¡_Çme
 == NULL)

1367  
NULL
;

1368  
cÚn
->
ho¡_Çme
;

1369 
	}
}

1380 cÚ¡ * 
	$nİŞl_cÚn_g‘_cook›
 (
noPŞlCÚn
 * 
cÚn
)

1383 ià(
cÚn
 =ğ
NULL
 || cÚn->
hªdshake
 == NULL)

1384  
NULL
;

1385  
cÚn
->
hªdshake
->
cook›
;

1386 
	}
}

1397 cÚ¡ * 
	$nİŞl_cÚn_g‘_acû±ed_´ÙocŞ
 (
noPŞlCÚn
 * 
cÚn
)

1399 ià(
cÚn
 =ğ
NULL
)

1400  
NULL
;

1401  
cÚn
->
acû±ed_´ÙocŞ
;

1402 
	}
}

1413 cÚ¡ * 
	$nİŞl_cÚn_g‘_»que¡ed_´ÙocŞ
 (
noPŞlCÚn
 * 
cÚn
)

1415 ià(
cÚn
 =ğ
NULL
)

1416  
NULL
;

1417  
cÚn
->
´ÙocŞs
;

1418 
	}
}

1436 
	$nİŞl_cÚn_£t_acû±ed_´ÙocŞ
 (
noPŞlCÚn
 * 
cÚn
, cÚ¡ * 
´ÙocŞ
)

1438 ià(
cÚn
 =ğ
NULL
 || 
´ÙocŞ
 == NULL)

1442 
cÚn
->
acû±ed_´ÙocŞ
 = 
	`nİŞl_¡rdup
 (
´ÙocŞ
);

1444 
	}
}

1454 cÚ¡ * 
	$nİŞl_cÚn_pÜt
 (
noPŞlCÚn
 * 
cÚn
)

1456 ià(
cÚn
 =ğ
NULL
)

1457  
NULL
;

1458  
cÚn
->
pÜt
;

1459 
	}
}

1471 
	$nİŞl_cÚn_g‘_şo£_¡©us
 (
noPŞlCÚn
 * 
cÚn
)

1473 ià(
cÚn
 =ğ
NULL
)

1475  
cÚn
->
³”_şo£_¡©us
;

1476 
	}
}

1488 cÚ¡ * 
	$nİŞl_cÚn_g‘_şo£_»asÚ
 (
noPŞlCÚn
 * 
cÚn
)

1490 ià(
cÚn
 =ğ
NULL
)

1491  
NULL
;

1492  
cÚn
->
³”_şo£_»asÚ
;

1493 
	}
}

1501 
	$nİŞl_cÚn_shutdown
 (
noPŞlCÚn
 * 
cÚn
)

1503 #ià
	`defšed
(
SHOW_DEBUG_LOG
)

1504 cÚ¡ * 
rŞe
 = 
NULL
;

1507 ià(
cÚn
 =ğ
NULL
)

1511 #ià
	`defšed
(
SHOW_DEBUG_LOG
)

1512 ià(
cÚn
->
rŞe
 =ğ
NOPOLL_ROLE_LISTENER
)

1513 
rŞe
 = "listener";

1514 ià(
cÚn
->
rŞe
 =ğ
NOPOLL_ROLE_MAIN_LISTENER
)

1515 
rŞe
 = "master-listener";

1516 ià(
cÚn
->
rŞe
 =ğ
NOPOLL_ROLE_UNKNOWN
)

1517 
rŞe
 = "unknown";

1518 ià(
cÚn
->
rŞe
 =ğ
NOPOLL_ROLE_CLIENT
)

1519 
rŞe
 = "client";

1521 
rŞe
 = "unknown";

1523 
	`nİŞl_log
 (
cÚn
->
ùx
, 
NOPOLL_LEVEL_DEBUG
, "shutting down connection id=%d (session: %d,„ole: %s)",

1524 
cÚn
->
id
, cÚn->
£ssiÚ
, 
rŞe
);

1528 ià(
cÚn
->
£ssiÚ
 !ğ
NOPOLL_INVALID_SOCKET
 && cÚn->
Ú_şo£
)

1529 
cÚn
->
	`Ú_şo£
 (cÚn->
ùx
, cÚn, cÚn->
Ú_şo£_d©a
);

1532 ià(
cÚn
->
£ssiÚ
 !ğ
NOPOLL_INVALID_SOCKET
) {

1533 
	`shutdown
 (
cÚn
->
£ssiÚ
, 
SHUT_RDWR
);

1534 
	`nİŞl_şo£_sock‘
 (
cÚn
->
£ssiÚ
);

1536 
cÚn
->
£ssiÚ
 = 
NOPOLL_INVALID_SOCKET
;

1539 
	}
}

1554 
	$nİŞl_cÚn_şo£_ext
 (
noPŞlCÚn
 * 
cÚn
, 
¡©us
, cÚ¡ * 
»asÚ
, 
»asÚ_size
)

1556 
»fs
;

1557 * 
cÚ‹Á
;

1558 #ià
	`defšed
(
SHOW_DEBUG_LOG
)

1559 cÚ¡ * 
rŞe
 = "unknown";

1563 ià(
cÚn
 =ğ
NULL
)

1566 #ià
	`defšed
(
SHOW_DEBUG_LOG
)

1567 ià(
cÚn
->
rŞe
 =ğ
NOPOLL_ROLE_LISTENER
)

1568 
rŞe
 = "listener";

1569 ià(
cÚn
->
rŞe
 =ğ
NOPOLL_ROLE_MAIN_LISTENER
)

1570 
rŞe
 = "master-listener";

1571 ià(
cÚn
->
rŞe
 =ğ
NOPOLL_ROLE_UNKNOWN
)

1572 
rŞe
 = "unknown";

1573 ià(
cÚn
->
rŞe
 =ğ
NOPOLL_ROLE_CLIENT
)

1574 
rŞe
 = "client";

1576 
	`nİŞl_log
 (
cÚn
->
ùx
, 
NOPOLL_LEVEL_DEBUG
, "Callingo close close id=%d (session %d,„efs: %d,„ole: %s)",

1577 
cÚn
->
id
, cÚn->
£ssiÚ
, cÚn->
»fs
, 
rŞe
);

1579 ià(
cÚn
->
£ssiÚ
 !ğ
NOPOLL_INVALID_SOCKET
) {

1580 
	`nİŞl_log
 (
cÚn
->
ùx
, 
NOPOLL_LEVEL_DEBUG
, "»que¡ed…rİ” cÚÃùiÚ clo£ id=%d (£ssiÚ %d)", cÚn->
id
, cÚn->
£ssiÚ
);

1583 
cÚ‹Á
 = 
NULL
;

1584 ià(
»asÚ
 && 
»asÚ_size
 > 0) {

1586 
cÚ‹Á
 = 
	`nİŞl_Ãw
 (, 
»asÚ_size
 + 3);

1587 ià(
cÚ‹Á
) {

1588 
	`nİŞl_£t_16b™
 (
¡©us
, 
cÚ‹Á
);

1589 
	`memıy
 (
cÚ‹Á
 + 2, 
»asÚ
, 
»asÚ_size
);

1594 
	`nİŞl_cÚn_£nd_äame
 (
cÚn
, 
nİŞl_Œue
 ,

1596 
cÚn
->
rŞe
 =ğ
NOPOLL_ROLE_CLIENT
, 
NOPOLL_CLOSE_FRAME
,

1598 
»asÚ_size
 > 0 ?„—sÚ_siz+ 2 : 0, 
cÚ‹Á
,

1603 
	`nİŞl_ä“
 (
cÚ‹Á
);

1606 
	`nİŞl_cÚn_shutdown
 (
cÚn
);

1610 
»fs
 = 
	`nİŞl_cÚn_»f_couÁ
 (
cÚn
);

1611 
	`nİŞl_ùx_uÄegi¡”_cÚn
 (
cÚn
->
ùx
, conn);

1615 ià(
»fs
 <= 1)

1619 
	`nİŞl_cÚn_uÄef
 (
cÚn
);

1622 
	}
}

1634 
	$nİŞl_cÚn_şo£
 (
noPŞlCÚn
 * 
cÚn
)

1637 
	`nİŞl_cÚn_şo£_ext
 (
cÚn
, 0, 
NULL
, 0);

1639 
	}
}

1650 
	$nİŞl_cÚn_£t_hook
 (
noPŞlCÚn
 * 
cÚn
, 
noPŞlPŒ
 
±r
)

1652 ià(
cÚn
 =ğ
NULL
)

1654 
cÚn
->
hook
 = 
±r
;

1656 
	}
}

1667 
noPŞlPŒ
 
	$nİŞl_cÚn_g‘_hook
 (
noPŞlCÚn
 * 
cÚn
)

1669 ià(
cÚn
 =ğ
NULL
)

1670  
NULL
;

1671  
cÚn
->
hook
;

1672 
	}
}

1680 
	$nİŞl_cÚn_uÄef
 (
noPŞlCÚn
 * 
cÚn
)

1682 ià(
cÚn
 =ğ
NULL
)

1686 
	`nİŞl_mu‹x_lock
 (
cÚn
->
»f_mu‹x
);

1688 
cÚn
->
»fs
--;

1689 
	`nİŞl_log
 (
cÚn
->
ùx
, 
NOPOLL_LEVEL_DEBUG
, "Releasing connection id %d„eference, current„ef count status is: %d",

1690 
cÚn
->
id
, cÚn->
»fs
);

1691 ià(
cÚn
->
»fs
 != 0) {

1693 
	`nİŞl_mu‹x_uÆock
 (
cÚn
->
»f_mu‹x
);

1697 
	`nİŞl_mu‹x_uÆock
 (
cÚn
->
»f_mu‹x
);

1700 ià(
cÚn
->
³ndšg_msg
)

1701 
	`nİŞl_msg_uÄef
 (
cÚn
->
³ndšg_msg
);

1704 ià(
cÚn
->
ùx
) {

1705 
	`nİŞl_log
 (
cÚn
->
ùx
, 
NOPOLL_LEVEL_DEBUG
, "R–—£d cÚ‹xˆ»fs,‚ow: %d", cÚn->ùx->
»fs
);

1706 
	`nİŞl_ùx_uÄef
 (
cÚn
->
ùx
);

1708 
cÚn
->
ùx
 = 
NULL
;

1711 
	`nİŞl_ä“
 (
cÚn
->
ho¡
);

1712 
	`nİŞl_ä“
 (
cÚn
->
pÜt
);

1713 
	`nİŞl_ä“
 (
cÚn
->
ho¡_Çme
);

1714 
	`nİŞl_ä“
 (
cÚn
->
Üigš
);

1715 
	`nİŞl_ä“
 (
cÚn
->
´ÙocŞs
);

1716 
	`nİŞl_ä“
 (
cÚn
->
acû±ed_´ÙocŞ
);

1717 
	`nİŞl_ä“
 (
cÚn
->
g‘_u¾
);

1720 
	`nİŞl_ä“
 (
cÚn
->
³”_şo£_»asÚ
);

1723 
	`nİŞl_ä“
 (
cÚn
->
û¹ifiÿ‹
);

1724 
	`nİŞl_ä“
 (
cÚn
->
´iv©e_key
);

1725 
	`nİŞl_ä“
 (
cÚn
->
chaš_û¹ifiÿ‹
);

1728 ià(
cÚn
->
´evious_msg
)

1729 
	`nİŞl_msg_uÄef
 (
cÚn
->
´evious_msg
);

1731 ià(
cÚn
->
s¦
)

1732 
	`SSL_ä“
 (
cÚn
->
s¦
);

1733 ià(
cÚn
->
s¦_ùx
)

1734 
	`SSL_CTX_ä“
 (
cÚn
->
s¦_ùx
);

1737 ià(
cÚn
->
hªdshake
) {

1738 
	`nİŞl_ä“
 (
cÚn
->
hªdshake
->
websock‘_key
);

1739 
	`nİŞl_ä“
 (
cÚn
->
hªdshake
->
websock‘_v”siÚ
);

1740 
	`nİŞl_ä“
 (
cÚn
->
hªdshake
->
websock‘_acû±
);

1741 
	`nİŞl_ä“
 (
cÚn
->
hªdshake
->
ex³ùed_acû±
);

1742 
	`nİŞl_ä“
 (
cÚn
->
hªdshake
->
cook›
);

1743 
	`nİŞl_ä“
 (
cÚn
->
hªdshake
);

1747 ià(
cÚn
->
İts
 && ! cÚn->İts->
»u£
)

1748 
	`nİŞl_cÚn_İts_ä“
 (
cÚn
->
İts
);

1751 
	`nİŞl_ä“
 (
cÚn
->
³ndšg_wr™e
);

1754 
	`nİŞl_mu‹x_de¡roy
 (
cÚn
->
»f_mu‹x
);

1756 
	`nİŞl_ä“
 (
cÚn
);

1759 
	}
}

1764 
	$nİŞl_cÚn_deçuÉ_»ûive
 (
noPŞlCÚn
 * 
cÚn
, * 
bufãr
, 
bufãr_size
)

1766  
	`»cv
 (
cÚn
->
£ssiÚ
, 
bufãr
, 
bufãr_size
, 0);

1767 
	}
}

1772 
	$nİŞl_cÚn_deçuÉ_£nd
 (
noPŞlCÚn
 * 
cÚn
, * 
bufãr
, 
bufãr_size
)

1774  
	`£nd
 (
cÚn
->
£ssiÚ
, 
bufãr
, 
bufãr_size
, 0);

1775 
	}
}

1795 
	$nİŞl_cÚn_»adlše
 (
noPŞlCÚn
 * 
cÚn
, * 
bufãr
, 
maxËn
)

1797 
n
, 
rc
;

1798 
de¥
;

1799 
c
, *
±r
;

1800 #ià
	`defšed
(
SHOW_DEBUG_LOG
)

1801 #ià!
	`defšed
(
SHOW_FORMAT_BUGS
)

1802 
noPŞlCtx
 * 
ùx
 = 
cÚn
->ctx;

1810 
de¥
 = 0;

1811 ià(
cÚn
->
³ndšg_lše
) {

1813 
de¥
 = 
	`¡¾’
 (
cÚn
->
³ndšg_lše
);

1814 ià(
de¥
 >ğ
maxËn
) {

1815 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_CRITICAL
,

1817 
de¥
, 
maxËn
);

1818 
	`nİŞl_cÚn_shutdown
 (
cÚn
);

1823 
	`memıy
 (
bufãr
, 
cÚn
->
³ndšg_lše
, 
de¥
);

1826 
	`nİŞl_ä“
 (
cÚn
->
³ndšg_lše
);

1827 
cÚn
->
³ndšg_lše
 = 
NULL
;

1831 
±r
 = (
bufãr
 + 
de¥
);

1832 
n
 = 1;‚ < (
maxËn
 - 
de¥
);‚++) {

1833 
nİŞl_»adlše_agaš
:

1834 ià(Ğ
rc
 = 
cÚn
->
	`»ûive
 (cÚn, &
c
, 1)) == 1) {

1835 *
±r
++ = 
c
;

1836 ià(
c
 == '\x0A')

1838 }ià(
rc
 == 0) {

1839 ià(
n
 == 1)

1844 ià(
”ºo
 =ğ
NOPOLL_EINTR
)

1845 
nİŞl_»adlše_agaš
;

1846 ià((
”ºo
 =ğ
NOPOLL_EWOULDBLOCK
è|| (”ºØ=ğ
NOPOLL_EAGAIN
è|| (
rc
 == -2)) {

1847 ià(
n
 > 0) {

1849 ià((
n
 + 
de¥
 - 1) > 0) {

1850 
bufãr
[
n
+
de¥
 - 1] = 0;

1851 
cÚn
->
³ndšg_lše
 = 
	`nİŞl_¡rdup
 (
bufãr
);

1857 ià(
	`nİŞl_cÚn_is_ok
 (
cÚn
è&& 
”ºo
 =ğ0 && 
rc
 == 0) {

1858 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_WARNING
, "unableo„ead†ine, butƒrrno is 0,‡nd connection is ok,„eturno keep onrying..");

1864 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_CRITICAL
, "unableo„ead†ine,ƒrror codeƒrrno: %d,„c: %d (%s)",

1865 
”ºo
, 
rc
, 
	`¡»¼Ü
 (errno));

1869 *
±r
 = 0;

1870  (
n
 + 
de¥
);

1872 
	}
}

1886 
noPŞlCÚn
 * 
	$nİŞl_cÚn_g‘_li¡’”
 (
noPŞlCÚn
 * 
cÚn
)

1890 ià(
cÚn
 =ğ
NULL
 || cÚn->
rŞe
 !ğ
NOPOLL_ROLE_LISTENER
)

1891  
NULL
;

1893  
cÚn
->
li¡’”
;

1894 
	}
}

1896 
	$__nİŞl_·ck_cÚ‹Á
 (* 
bufãr
, 
¡¬t
, 
by‹s
)

1898 
™”©Ü
 = 0;

1899 
™”©Ü
 < 
by‹s
) {

1901 
bufãr
[
™”©Ü
] = bufãr[
¡¬t
 + iterator];

1904 
™”©Ü
++;

1908 
	}
}

1916 
	$__nİŞl_cÚn_»ûive
 (
noPŞlCÚn
 * 
cÚn
, * 
bufãr
, 
maxËn
)

1918 
Ä—d
;

1920 ià(
cÚn
->
³ndšg_buf_by‹s
 > 0) {

1921 
	`nİŞl_log
 (
cÚn
->
ùx
, 
NOPOLL_LEVEL_DEBUG
, "Calling with bytes we can„euse (%d),„equested: %d",

1922 
cÚn
->
³ndšg_buf_by‹s
, 
maxËn
);

1924 ià(
cÚn
->
³ndšg_buf_by‹s
 >ğ
maxËn
) {

1929 
	`memıy
 (
bufãr
, 
cÚn
->
³ndšg_buf
, 
maxËn
);

1930 
	`__nİŞl_·ck_cÚ‹Á
 (
cÚn
->
³ndšg_buf
, 
maxËn
, cÚn->
³ndšg_buf_by‹s
 - maxlen);

1931 
cÚn
->
³ndšg_buf_by‹s
 -ğ
maxËn
;

1932  
maxËn
;

1937 
	`memıy
 (
bufãr
, 
cÚn
->
³ndšg_buf
, cÚn->
³ndšg_buf_by‹s
);

1940 
Ä—d
 = 
cÚn
->
³ndšg_buf_by‹s
;

1941 
cÚn
->
³ndšg_buf_by‹s
 = 0;

1945  
	`__nİŞl_cÚn_»ûive
 (
cÚn
, 
bufãr
 + 
Ä—d
, 
maxËn
 -‚read) +‚read;

1949 
k“p_»adšg
:

1952 #ià
	`defšed
(
NOPOLL_OS_UNIX
)

1953 
”ºo
 = 0;

1955 ià((
Ä—d
 = 
cÚn
->
	`»ûive
 (cÚn, 
bufãr
, 
maxËn
)è=ğ
NOPOLL_SOCKET_ERROR
) {

1957 ià(
”ºo
 =ğ
NOPOLL_EAGAIN
)

1959 ià(
”ºo
 =ğ
NOPOLL_EWOULDBLOCK
)

1961 ià(
”ºo
 =ğ
NOPOLL_EINTR
)

1962 
k“p_»adšg
;

1964 
	`nİŞl_log
 (
cÚn
->
ùx
, 
NOPOLL_LEVEL_CRITICAL
, "uÇbËØ»adn=%d,ƒ¼Ü codwas: %d (%sè(shu‰šg dowÀcÚÃùiÚ)", 
maxËn
, 
”ºo
, 
	`¡»¼Ü
 (errno));

1965 
	`nİŞl_cÚn_shutdown
 (
cÚn
);

1970 ià(
Ä—d
 == 0) {

1972 ià(
”ºo
 =ğ
NOPOLL_EAGAIN
 ||ƒ¼nØ=ğ
NOPOLL_EWOULDBLOCK
) {

1973 
	`nİŞl_log
 (
cÚn
->
ùx
, 
NOPOLL_LEVEL_WARNING
, "unableo„ead from conn-id=%d (%s:%s), connection is‚ot„eady (errno: %d : %s)",

1974 
cÚn
->
id
, cÚn->
ho¡
, cÚn->
pÜt
, 
”ºo
, 
	`¡»¼Ü
 (errno));

1978 
	`nİŞl_log
 (
cÚn
->
ùx
, 
NOPOLL_LEVEL_CRITICAL
, "received connection close while„eading from conn id %d (errno=%d : %s) (%d, %d, %d), shutting down connection..",

1979 
cÚn
->
id
, 
”ºo
, 
	`¡»¼Ü
 (errno),

1980 
NOPOLL_EAGAIN
, 
NOPOLL_EWOULDBLOCK
, 
NOPOLL_EINTR
);

1981 
	`nİŞl_cÚn_shutdown
 (
cÚn
);

1985 ià(
Ä—d
 < 0)

1986 
Ä—d
 = 0;

1988 
bufãr
[
Ä—d
] = 0;

1989  
Ä—d
;

1990 
	}
}

1992 
nİŞl_boŞ
 
	$nİŞl_cÚn_g‘_h‰p_u¾
 (
noPŞlCÚn
 * 
cÚn
, cÚ¡ * 
bufãr
, 
bufãr_size
, cÚ¡ * 
m‘hod
, ** 
u¾
)

1994 
™”©Ü
;

1995 
™”©Ü2
;

1996 #ià
	`defšed
(
SHOW_DEBUG_LOG
)

1997 #ià! 
	`defšed
(
SHOW_FORMAT_BUGS
)

1998 
noPŞlCtx
 * 
ùx
 = 
cÚn
->ctx;

2003 ià(
cÚn
->
g‘_u¾
) {

2004 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_CRITICAL
, "Received GET method declartion when it was‡lready„eceived during handshake..closing session");

2005 
	`nİŞl_cÚn_shutdown
 (
cÚn
);

2006  
nİŞl_çl£
;

2010 ià(
bufãr_size
 < 15) {

2011 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_CRITICAL
, "Received uncomplete GET method during handshake, closing session");

2012 
	`nİŞl_cÚn_shutdown
 (
cÚn
);

2013  
nİŞl_çl£
;

2017 
™”©Ü
 = 4;

2018 
™”©Ü
 < 
bufãr_size
 && 
bufãr
[iterator] == ' ')

2019 
™”©Ü
++;

2020 ià(
bufãr_size
 =ğ
™”©Ü
) {

2021 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_CRITICAL
, "Reûived‡ % m‘hod w™houˆª s¹šg„eque¡ u¾, closšg sessiÚ", 
m‘hod
);

2022 
	`nİŞl_cÚn_shutdown
 (
cÚn
);

2023  
nİŞl_çl£
;

2027 ià(
bufãr
[
™”©Ü
] != '/') {

2028 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_CRITICAL
, "Reûived‡ % m‘hod w™h‡„eque¡ u¾h© dØnÙ s¹ w™h /, closšg sessiÚ", 
m‘hod
);

2029 
	`nİŞl_cÚn_shutdown
 (
cÚn
);

2030  
nİŞl_çl£
;

2034 
™”©Ü2
 = (
™”©Ü
 + 1);

2035 
™”©Ü2
 < 
bufãr_size
 && 
bufãr
[iterator2] != ' ')

2036 
™”©Ü2
++;

2037 ià(
bufãr_size
 =ğ
™”©Ü2
) {

2038 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_CRITICAL
, "Reûived‡ % m‘hod w™h‡Àuncom¶©»que¡ u¾, closšg sessiÚ", 
m‘hod
);

2039 
	`nİŞl_cÚn_shutdown
 (
cÚn
);

2040  
nİŞl_çl£
;

2043 (*
u¾
èğ
	`nİŞl_Ãw
 (, 
™”©Ü2
 - 
™”©Ü
 + 1);

2044 
	`memıy
 (*
u¾
, 
bufãr
 + 
™”©Ü
, 
™”©Ü2
 - iterator);

2045 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_DEBUG
, "Found u¾ m‘hod: '%s'", *
u¾
);

2048 
™”©Ü
 = 
™”©Ü2
 + 1;

2049 
™”©Ü
 < 
bufãr_size
 && 
bufãr
[iterator] == ' ')

2050 
™”©Ü
++;

2051 ià(
bufãr_size
 =ğ
™”©Ü
) {

2052 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_CRITICAL
, "Reûived‡ % m‘hod w™h‡Àuncom¶©»que¡ u¾, closšg sessiÚ", 
m‘hod
);

2053 
	`nİŞl_cÚn_shutdown
 (
cÚn
);

2054  
nİŞl_çl£
;

2058  
	`nİŞl_cmp
 (
bufãr
 + 
™”©Ü
, "HTTP/1.1\r\n") ||‚opoll_cmp (buffer + iterator, "HTTP/1.1\n");

2059 
	}
}

2065 
nİŞl_boŞ
 
	$nİŞl_cÚn_g‘_mime_h—d”
 (
noPŞlCtx
 * 
ùx
, 
noPŞlCÚn
 * 
cÚn
, cÚ¡ * 
bufãr
, 
bufãr_size
, ** 
h—d”
, ** 
v®ue
)

2067 
™”©Ü
 = 0;

2068 
™”©Ü2
 = 0;

2073 
™”©Ü
 < 
bufãr_size
 && 
bufãr
[iterator] && buffer[iterator] != ':')

2074 
™”©Ü
++;

2075 ià(
bufãr
[
™”©Ü
] != ':') {

2076 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_CRITICAL
, "Expectedo find mime header separator : but it wasn't found (buffer_size=%d, iterator=%d, content: [%s]..",

2077 
bufãr_size
, 
™”©Ü
, 
bufãr
);

2078  
nİŞl_çl£
;

2082 (*
h—d”
èğ
	`nİŞl_Ãw
 (, 
™”©Ü
 + 1);

2083 
	`memıy
 (*
h—d”
, 
bufãr
, 
™”©Ü
);

2086 
™”©Ü2
 = 
™”©Ü
 + 1;

2087 
™”©Ü2
 < 
bufãr_size
 && 
bufãr
[iterator2] && buffer[iterator2] != '\n')

2088 
™”©Ü2
++;

2089 ià(
bufãr
[
™”©Ü2
] != '\n') {

2090 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_CRITICAL
,

2092 
™”©Ü
, 
™”©Ü2
, (*
h—d”
), ()
bufãr
[iterator2], buffer);

2093 
	`nİŞl_ä“
 (*
h—d”
);

2094 (*
h—d”
èğ
NULL
;

2095 (*
v®ue
èğ
NULL
;

2096  
nİŞl_çl£
;

2100 (*
v®ue
èğ
	`nİŞl_Ãw
 (, (
™”©Ü2
 - 
™”©Ü
) + 1);

2101 
	`memıy
 (*
v®ue
, 
bufãr
 + 
™”©Ü
 + 1, 
™”©Ü2
 - iterator);

2104 
	`nİŞl_Œim
 (*
v®ue
, 
NULL
);

2105 
	`nİŞl_Œim
 (*
h—d”
, 
NULL
);

2107 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_DEBUG
, "Found MIME h—d”: '%s' -> '%s'", *
h—d”
, *
v®ue
);

2108  
nİŞl_Œue
;

2109 
	}
}

2114 
nİŞl_boŞ
 
	$nİŞl_cÚn_check_mime_h—d”_»³©ed
 (
noPŞlCÚn
 * 
cÚn
,

2115 * 
h—d”
,

2116 * 
v®ue
,

2117 cÚ¡ * 
»f_h—d”
,

2118 
noPŞlPŒ
 
check
)

2120 ià(
	`¡rÿ£cmp
 (
»f_h—d”
, 
h—d”
) == 0) {

2121 ià(
check
) {

2122 
	`nİŞl_log
 (
cÚn
->
ùx
, 
NOPOLL_LEVEL_CRITICAL
, "Provided h—d” % twiû, closšg cÚÃùiÚ", 
h—d”
);

2123 
	`nİŞl_ä“
 (
h—d”
);

2124 
	`nİŞl_ä“
 (
v®ue
);

2125 
	`nİŞl_cÚn_shutdown
 (
cÚn
);

2126  
nİŞl_Œue
;

2129  
nİŞl_çl£
;

2130 
	}
}

2132 * 
	$nİŞl_cÚn_´oduû_acû±_key
 (
noPŞlCtx
 * 
ùx
, cÚ¡ * 
websock‘_key
)

2134 cÚ¡ * 
¡©ic_guid
 = "258EAFA5-E914-47DA-95CA-C5AB0DC85B11";

2135 * 
acû±_key
;

2136 
acû±_key_size
;

2137 
key_Ëngth
;

2139 ià(
websock‘_key
 =ğ
NULL
)

2140  
NULL
;

2142 
key_Ëngth
 = 
	`¡¾’
 (
websock‘_key
);

2144 
bufãr
[
EVP_MAX_MD_SIZE
];

2145 
EVP_MD_CTX
 
mdùx
;

2146 cÚ¡ 
EVP_MD
 * 
md
 = 
NULL
;

2147 
md_Ën
 = 
EVP_MAX_MD_SIZE
;

2149 
acû±_key_size
 = 
key_Ëngth
 + 36 + 1;

2150 
acû±_key
 = 
	`nİŞl_Ãw
 (, 
acû±_key_size
);

2152 
	`memıy
 (
acû±_key
, 
websock‘_key
, 
key_Ëngth
);

2153 
	`memıy
 (
acû±_key
 + 
key_Ëngth
, 
¡©ic_guid
, 36);

2155 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_DEBUG
, "ba£ key v®ue: %s", 
acû±_key
);

2158 
md
 = 
	`EVP_sha1
 ();

2159 
	`EVP_Dige¡In™
 (&
mdùx
, 
md
);

2160 
	`EVP_Dige¡Upd©e
 (&
mdùx
, 
acû±_key
, 
	`¡¾’
 (accept_key));

2161 
	`EVP_Dige¡Fš®
 (&
mdùx
, 
bufãr
, &
md_Ën
);

2163 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_DEBUG
, "Sha-1†’gth is: %u", 
md_Ën
);

2165 ià(! 
	`nİŞl_ba£64_’code
 ((cÚ¡ *è
bufãr
, 
md_Ën
, (*è
acû±_key
, &
acû±_key_size
)) {

2166 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_CRITICAL
, "Failedo base64 sec-websocket-key value..");

2167  
NULL
;

2170 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_DEBUG
, "R‘uºšg Sec-Websock‘-Acû±: %s", 
acû±_key
);

2172  
acû±_key
;

2174 
	}
}

2176 
nİŞl_boŞ
 
	$nİŞl_cÚn_com¶‘e_hªdshake_check_li¡’”
 (
noPŞlCtx
 * 
ùx
, 
noPŞlCÚn
 * 
cÚn
)

2178 * 
»¶y
;

2179 
»¶y_size
;

2180 * 
acû±_key
;

2181 
noPŞlAùiÚHªdËr
 
Ú_»ady
;

2182 
noPŞlPŒ
 
Ú_»ady_d©a
;

2183 cÚ¡ * 
´ÙocŞ
;

2184 
nİŞl_boŞ
 
Üigš_check
;

2187 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_DEBUG
, "Checking client handshake data..");

2193 
Üigš_check
 = 
cÚn
->
Üigš
 !ğ
NULL
;

2197 iàĞ
cÚn
->
li¡’”
 && cÚn->li¡’”->
İts
 && cÚn->li¡’”->İts->
sk_Üigš_h—d”_check
 && cÚn->
Üigš
 =ğ
NULL
)

2198 
Üigš_check
 = 
nİŞl_Œue
;

2202 ià(! 
cÚn
->
hªdshake
->
upg¿de_websock‘
 ||

2203 ! 
cÚn
->
hªdshake
->
cÚÃùiÚ_upg¿de
 ||

2204 ! 
cÚn
->
hªdshake
->
websock‘_key
 ||

2205 ! 
Üigš_check
 ||

2206 ! 
cÚn
->
hªdshake
->
websock‘_v”siÚ
) {

2207 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_CRITICAL
, "Client from %s:%s didn't…rovide‡ll websocket handshake values„equired, closing session (Upgraded: websocket %d, Connection: upgrade%d, Sec-WebSocket-Key: %p, Origin: %p, Sec-WebSocket-Version: %p)",

2208 
cÚn
->
ho¡
, cÚn->
pÜt
,

2209 
cÚn
->
hªdshake
->
upg¿de_websock‘
,

2210 
cÚn
->
hªdshake
->
cÚÃùiÚ_upg¿de
,

2211 
cÚn
->
hªdshake
->
websock‘_key
,

2212 
cÚn
->
Üigš
,

2213 
cÚn
->
hªdshake
->
websock‘_v”siÚ
);

2214  
nİŞl_çl£
;

2218 ià(
	`¡¹od
 (
cÚn
->
hªdshake
->
websock‘_v”siÚ
, 
NULL
è!ğ
ùx
->
´ÙocŞ_v”siÚ
) {

2219 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_CRITICAL
, "Received„equest for‡n unsupported…rotocol version: %s,ƒxpected: %d",

2220 
cÚn
->
hªdshake
->
websock‘_v”siÚ
, 
ùx
->
´ÙocŞ_v”siÚ
);

2221  
nİŞl_çl£
;

2226 ià(
ùx
->
Ú_İ’
) {

2227 ià(! 
ùx
->
	`Ú_İ’
 (ùx, 
cÚn
, ctx->
Ú_İ’_d©a
)) {

2228 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_CRITICAL
, "Client from %s:%s was denied by‡pplication†evel (on open handler %p), clossing session",

2229 
cÚn
->
ho¡
, cÚn->
pÜt
, 
ùx
->
Ú_İ’
);

2230 
	`nİŞl_cÚn_shutdown
 (
cÚn
);

2231  
nİŞl_çl£
;

2235 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_DEBUG
, "Client from %s:%s was‡ccepted,„eplying‡ccept",

2236 
cÚn
->
ho¡
, cÚn->
pÜt
);

2239 
acû±_key
 = 
	`nİŞl_cÚn_´oduû_acû±_key
 (
ùx
, 
cÚn
->
hªdshake
->
websock‘_key
);

2242 ià(
cÚn
->
´ÙocŞs
 || cÚn->
acû±ed_´ÙocŞ
) {

2245 
´ÙocŞ
 = 
cÚn
->
acû±ed_´ÙocŞ
;

2246 ià(! 
´ÙocŞ
)

2247 
´ÙocŞ
 = 
cÚn
->
´ÙocŞs
;

2250 
»¶y
 = 
	`nİŞl_¡rdup_´štf
 ("HTTP/1.1 101 Switching Protocols\r\nUpgrade: websocket\r\nConnection: Upgrade\r\nSec-WebSocket-Accept: %s\r\nSec-WebSocket-Protocol: %s\r\n\r\n",

2251 
acû±_key
, 
´ÙocŞ
);

2254 
»¶y
 = 
	`nİŞl_¡rdup_´štf
 ("HTTP/1.1 101 Switching Protocols\r\nUpgrade: websocket\r\nConnection: Upgrade\r\nSec-WebSocket-Accept: %s\r\n\r\n",

2255 
acû±_key
);

2258 
	`nİŞl_ä“
 (
acû±_key
);

2259 ià(
»¶y
 =ğ
NULL
) {

2260 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_CRITICAL
, "Unableo build„eply, closing session");

2261  
nİŞl_çl£
;

2264 
»¶y_size
 = 
	`¡¾’
 (
»¶y
);

2265 ià(
»¶y_size
 !ğ
cÚn
->
	`£nd
 (cÚn, 
»¶y
,„eply_size)) {

2266 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_CRITICAL
, "UÇbËØ£nd„•ly,h”wa ¨çu»,ƒ¼Ü codwas: %d", 
”ºo
);

2267 
	`nİŞl_ä“
 (
»¶y
);

2268  
nİŞl_çl£
;

2272 
	`nİŞl_ä“
 (
»¶y
);

2276 ià(
ùx
->
Ú_»ady
 || 
cÚn
->on_ready) {

2278 
Ú_»ady
 = 
cÚn
->on_ready;

2279 
Ú_»ady_d©a
 = 
cÚn
->on_ready_data;

2280 ià(! 
Ú_»ady
) {

2281 
Ú_»ady
 = 
ùx
->on_ready;

2282 
Ú_»ady_d©a
 = 
ùx
->on_ready_data;

2285 ià(
Ú_»ady
 && ! 
	`Ú_»ady
 (
ùx
, 
cÚn
, 
Ú_»ady_d©a
)) {

2286 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_CRITICAL
, "Client from %s:%s was denied by‡pplication†evel (on„eady handler: %p), clossing session",

2287 
cÚn
->
ho¡
, cÚn->
pÜt
, 
Ú_»ady
);

2288 
	`nİŞl_cÚn_shutdown
 (
cÚn
);

2289  
nİŞl_çl£
;

2293  
nİŞl_Œue
;

2294 
	}
}

2296 
nİŞl_boŞ
 
	$nİŞl_cÚn_com¶‘e_hªdshake_check_ş›Á
 (
noPŞlCtx
 * 
ùx
, 
noPŞlCÚn
 * 
cÚn
)

2298 * 
acû±
;

2299 
nİŞl_boŞ
 
»suÉ
;

2302 ià(! 
cÚn
->
hªdshake
->
websock‘_acû±
 ||

2303 ! 
cÚn
->
hªdshake
->
upg¿de_websock‘
 ||

2304 ! 
cÚn
->
hªdshake
->
cÚÃùiÚ_upg¿de
) {

2305 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_CRITICAL
, "Received uncomplete†istener handshake„eply (%p %d %d)",

2306 
cÚn
->
hªdshake
->
websock‘_acû±
, cÚn->hªdshake->
upg¿de_websock‘
, cÚn->hªdshake->
cÚÃùiÚ_upg¿de
);

2307  
nİŞl_çl£
;

2311 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_DEBUG
, "Checking‡ccept key from†istener..");

2312 
acû±
 = 
	`nİŞl_cÚn_´oduû_acû±_key
 (
ùx
, 
cÚn
->
hªdshake
->
websock‘_key
);

2314 
»suÉ
 = 
	`nİŞl_cmp
 (
acû±
, 
cÚn
->
hªdshake
->
websock‘_key
);

2315 ià(! 
»suÉ
) {

2316 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_CRITICAL
, "Unableo‡ccept connection Sec-Websocket-Accept %s is‚otƒxpected %s, closing session",

2317 
acû±
, 
cÚn
->
hªdshake
->
websock‘_key
);

2318 
	`nİŞl_cÚn_shutdown
 (
cÚn
);

2320 
	`nİŞl_ä“
 (
acû±
);

2322 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_DEBUG
, "Sec-Websocket-Accept matchesƒxpected value..nopoll_conn_complete_handshake_check_client (%p, %p)=%d",

2323 
ùx
, 
cÚn
, 
»suÉ
);

2325  
»suÉ
;

2326 
	}
}

2333 
	$nİŞl_cÚn_com¶‘e_hªdshake_check
 (
noPŞlCÚn
 * 
cÚn
)

2335 
noPŞlCtx
 * 
ùx
 = 
cÚn
->ctx;

2336 
nİŞl_boŞ
 
»suÉ
 = 
nİŞl_çl£
;

2338 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_DEBUG
, "callingo check handshake„eceived on connection id %d„ole %d..",

2339 
cÚn
->
id
, cÚn->
rŞe
);

2341 ià(
cÚn
->
rŞe
 =ğ
NOPOLL_ROLE_LISTENER
) {

2342 
»suÉ
 = 
	`nİŞl_cÚn_com¶‘e_hªdshake_check_li¡’”
 (
ùx
, 
cÚn
);

2343 } ià(
cÚn
->
rŞe
 =ğ
NOPOLL_ROLE_CLIENT
) {

2344 
»suÉ
 = 
	`nİŞl_cÚn_com¶‘e_hªdshake_check_ş›Á
 (
ùx
, 
cÚn
);

2348 ià(
»suÉ
) {

2349 
cÚn
->
hªdshake_ok
 = 
nİŞl_Œue
;

2351 
	`nİŞl_cÚn_shutdown
 (
cÚn
);

2355 
	}
}

2365 
	$nİŞl_cÚn_com¶‘e_hªdshake_li¡’”
 (
noPŞlCtx
 * 
ùx
, 
noPŞlCÚn
 * 
cÚn
, * 
bufãr
, 
bufãr_size
)

2367 * 
h—d”
;

2368 * 
v®ue
;

2371 ià(
	`nİŞl_ncmp
 (
bufãr
, "GET ", 4)) {

2373 
	`nİŞl_cÚn_g‘_h‰p_u¾
 (
cÚn
, 
bufãr
, 
bufãr_size
, "GET", &cÚn->
g‘_u¾
);

2378 ià(! 
	`nİŞl_cÚn_g‘_mime_h—d”
 (
ùx
, 
cÚn
, 
bufãr
, 
bufãr_size
, &
h—d”
, &
v®ue
)) {

2379 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_CRITICAL
, "Failedo‡cquire mime header from„emote…eer during handshake, closing connection");

2380 
	`nİŞl_cÚn_shutdown
 (
cÚn
);

2385 ià(
	`nİŞl_cÚn_check_mime_h—d”_»³©ed
 (
cÚn
, 
h—d”
, 
v®ue
, "Ho¡", cÚn->
ho¡_Çme
))

2387 ià(
	`nİŞl_cÚn_check_mime_h—d”_»³©ed
 (
cÚn
, 
h—d”
, 
v®ue
, "Upg¿de", 
	`INT_TO_PTR
 (cÚn->
hªdshake
->
upg¿de_websock‘
)))

2389 ià(
	`nİŞl_cÚn_check_mime_h—d”_»³©ed
 (
cÚn
, 
h—d”
, 
v®ue
, "CÚÃùiÚ", 
	`INT_TO_PTR
 (cÚn->
hªdshake
->
cÚÃùiÚ_upg¿de
)))

2391 ià(
	`nİŞl_cÚn_check_mime_h—d”_»³©ed
 (
cÚn
, 
h—d”
, 
v®ue
, "Sec-WebSock‘-Key", cÚn->
hªdshake
->
websock‘_key
))

2393 ià(
	`nİŞl_cÚn_check_mime_h—d”_»³©ed
 (
cÚn
, 
h—d”
, 
v®ue
, "Origš", cÚn->
Üigš
))

2395 ià(
	`nİŞl_cÚn_check_mime_h—d”_»³©ed
 (
cÚn
, 
h—d”
, 
v®ue
, "Sec-WebSock‘-PrÙocŞ", cÚn->
´ÙocŞs
))

2397 ià(
	`nİŞl_cÚn_check_mime_h—d”_»³©ed
 (
cÚn
, 
h—d”
, 
v®ue
, "Sec-WebSock‘-V”siÚ", cÚn->
hªdshake
->
websock‘_v”siÚ
))

2399 ià(
	`nİŞl_cÚn_check_mime_h—d”_»³©ed
 (
cÚn
, 
h—d”
, 
v®ue
, "Cook›", cÚn->
hªdshake
->
cook›
))

2403 ià(
	`¡rÿ£cmp
 (
h—d”
, "Host") == 0)

2404 
cÚn
->
ho¡_Çme
 = 
v®ue
;

2405 ià(
	`¡rÿ£cmp
 (
h—d”
, "Sec-Websocket-Key") == 0)

2406 
cÚn
->
hªdshake
->
websock‘_key
 = 
v®ue
;

2407 ià(
	`¡rÿ£cmp
 (
h—d”
, "Origin") == 0)

2408 
cÚn
->
Üigš
 = 
v®ue
;

2409 ià(
	`¡rÿ£cmp
 (
h—d”
, "Sec-Websocket-Protocol") == 0)

2410 
cÚn
->
´ÙocŞs
 = 
v®ue
;

2411 ià(
	`¡rÿ£cmp
 (
h—d”
, "Sec-Websocket-Version") == 0)

2412 
cÚn
->
hªdshake
->
websock‘_v”siÚ
 = 
v®ue
;

2413 ià(
	`¡rÿ£cmp
 (
h—d”
, "Upgrade") == 0) {

2414 
cÚn
->
hªdshake
->
upg¿de_websock‘
 = 1;

2415 
	`nİŞl_ä“
 (
v®ue
);

2416 } ià(
	`¡rÿ£cmp
 (
h—d”
, "Connection") == 0) {

2417 
cÚn
->
hªdshake
->
cÚÃùiÚ_upg¿de
 = 1;

2418 
	`nİŞl_ä“
 (
v®ue
);

2419 } ià(
	`¡rÿ£cmp
 (
h—d”
, "Cookie") == 0) {

2421 
cÚn
->
hªdshake
->
cook›
 = 
v®ue
;

2424 
	`nİŞl_ä“
 (
v®ue
);

2428 
	`nİŞl_ä“
 (
h—d”
);

2431 
	}
}

2441 
	$nİŞl_cÚn_com¶‘e_hªdshake_ş›Á
 (
noPŞlCtx
 * 
ùx
, 
noPŞlCÚn
 * 
cÚn
, * 
bufãr
, 
bufãr_size
)

2443 * 
h—d”
;

2444 * 
v®ue
;

2445 
™”©Ü
;

2448 ià(! 
cÚn
->
hªdshake
->
»ûived_101
 && 
	`nİŞl_ncmp
 (
bufãr
, "HTTP/1.1 ", 9)) {

2449 
™”©Ü
 = 9;

2450 
™”©Ü
 < 
bufãr_size
 && 
bufãr
[iterator] && buffer[iterator] == ' ')

2451 
™”©Ü
++;

2452 ià(! 
	`nİŞl_ncmp
 (
bufãr
 + 
™”©Ü
, "101", 3)) {

2453 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_CRITICAL
, "websock‘ s”v” d’›d cÚÃùiÚ w™h: %s", 
bufãr
 + 
™”©Ü
);

2458 
cÚn
->
hªdshake
->
»ûived_101
 = 
nİŞl_Œue
;

2464 ià(! 
	`nİŞl_cÚn_g‘_mime_h—d”
 (
ùx
, 
cÚn
, 
bufãr
, 
bufãr_size
, &
h—d”
, &
v®ue
)) {

2465 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_CRITICAL
, "Failedo‡cquire mime header from„emote…eer during handshake, closing connection");

2466 
	`nİŞl_cÚn_shutdown
 (
cÚn
);

2471 ià(
	`nİŞl_cÚn_check_mime_h—d”_»³©ed
 (
cÚn
, 
h—d”
, 
v®ue
, "Upg¿de", 
	`INT_TO_PTR
 (cÚn->
hªdshake
->
upg¿de_websock‘
)))

2473 ià(
	`nİŞl_cÚn_check_mime_h—d”_»³©ed
 (
cÚn
, 
h—d”
, 
v®ue
, "CÚÃùiÚ", 
	`INT_TO_PTR
 (cÚn->
hªdshake
->
cÚÃùiÚ_upg¿de
)))

2475 ià(
	`nİŞl_cÚn_check_mime_h—d”_»³©ed
 (
cÚn
, 
h—d”
, 
v®ue
, "Sec-WebSock‘-Acû±", cÚn->
hªdshake
->
websock‘_acû±
))

2477 ià(
	`nİŞl_cÚn_check_mime_h—d”_»³©ed
 (
cÚn
, 
h—d”
, 
v®ue
, "Sec-WebSock‘-PrÙocŞ", cÚn->
acû±ed_´ÙocŞ
))

2481 ià(
	`¡rÿ£cmp
 (
h—d”
, "Sec-Websocket-Accept") == 0)

2482 
cÚn
->
hªdshake
->
websock‘_acû±
 = 
v®ue
;

2483 ià(
	`¡rÿ£cmp
 (
h—d”
, "Sec-Websocket-Protocol") == 0)

2484 
cÚn
->
acû±ed_´ÙocŞ
 = 
v®ue
;

2485 ià(
	`¡rÿ£cmp
 (
h—d”
, "Upgrade") == 0) {

2486 
cÚn
->
hªdshake
->
upg¿de_websock‘
 = 1;

2487 
	`nİŞl_ä“
 (
v®ue
);

2488 } ià(
	`¡rÿ£cmp
 (
h—d”
, "Connection") == 0) {

2489 
cÚn
->
hªdshake
->
cÚÃùiÚ_upg¿de
 = 1;

2490 
	`nİŞl_ä“
 (
v®ue
);

2493 
	`nİŞl_ä“
 (
v®ue
);

2497 
	`nİŞl_ä“
 (
h—d”
);

2500 
	}
}

2507 
	$nİŞl_cÚn_com¶‘e_hªdshake
 (
noPŞlCÚn
 * 
cÚn
)

2509 
bufãr
[1024];

2510 
bufãr_size
;

2511 
noPŞlCtx
 * 
ùx
 = 
cÚn
->ctx;

2514 ià(
cÚn
->
hªdshake_ok
)

2517 
	`nİŞl_log
 (
cÚn
->
ùx
, 
NOPOLL_LEVEL_DEBUG
, "CheckšgØcom¶‘cÚn-id=%d WebSock‘ hªdshake,„Ş%d", cÚn->
id
, cÚn->
rŞe
);

2520 ià(
cÚn
->
hªdshake
 =ğ
NULL
)

2521 
cÚn
->
hªdshake
 = 
	`nİŞl_Ãw
 (
noPŞlHªdShake
, 1);

2524 
nİŞl_Œue
) {

2526 
bufãr
[0] = 0;

2528 
bufãr_size
 = 
	`nİŞl_cÚn_»adlše
 (
cÚn
, 
bufãr
, 1024);

2529 ià(
bufãr_size
 == 0 || buffer_size == -1) {

2530 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_CRITICAL
, "Unexpected connection close during handshake..closing connection");

2531 
	`nİŞl_cÚn_shutdown
 (
cÚn
);

2536 ià(
bufãr_size
 == -2) {

2537 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_DEBUG
, "NØmÜd©¨avaabË oÀcÚÃùiÚ id %d", 
cÚn
->
id
);

2542 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_DEBUG
, "By‹ »ad %d from cÚÃùiÚ id %d: %s", 
bufãr_size
, 
cÚn
->
id
, 
bufãr
);

2546 ià(
bufãr_size
 =ğ2 && 
	`nİŞl_ncmp
 (
bufãr
, "\r\n", 2)) {

2547 
	`nİŞl_cÚn_com¶‘e_hªdshake_check
 (
cÚn
);

2551 ià(
cÚn
->
rŞe
 =ğ
NOPOLL_ROLE_LISTENER
) {

2553 ià(
	`nİŞl_cÚn_com¶‘e_hªdshake_li¡’”
 (
ùx
, 
cÚn
, 
bufãr
, 
bufãr_size
) == 1)

2555 } ià(
cÚn
->
rŞe
 =ğ
NOPOLL_ROLE_CLIENT
) {

2557 ià(
	`nİŞl_cÚn_com¶‘e_hªdshake_ş›Á
 (
ùx
, 
cÚn
, 
bufãr
, 
bufãr_size
) == 1)

2560 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_DEBUG
, "Calledo handle connection handshake on‡ connection with‡n unexpected„ole: %d, closing session",

2561 
cÚn
->
rŞe
);

2562 
	`nİŞl_cÚn_shutdown
 (
cÚn
);

2568 
	}
}

2570 
	$nİŞl_cÚn_mask_cÚ‹Á
 (
noPŞlCtx
 * 
ùx
, * 
·ylßd
, 
·ylßd_size
, * 
mask
, 
de¥
)

2572 
™”
 = 0;

2573 
mask_šdex
 = 0;

2575 
™”
 < 
·ylßd_size
) {

2577 
mask_šdex
 = (
™”
 + 
de¥
) % 4;

2578 
·ylßd
[
™”
] ^ğ
mask
[
mask_šdex
];

2579 
™”
++;

2583 
	}
}

2600 
noPŞlMsg
 * 
	$nİŞl_cÚn_g‘_msg
 (
noPŞlCÚn
 * 
cÚn
)

2602 
bufãr
[20];

2603 
by‹s
;

2604 
noPŞlMsg
 * 
msg
;

2605 
s¦_”rÜ
;

2606 
h—d”_size
;

2607 #ià
	`defšed
(
SHOW_DEBUG_LOG
)

2608 
»suÉ
;

2610 #ià
	`defšed
(
NOPOLL_64BIT_PLATFORM
)

2611 *
Ën
;

2614 ià(
cÚn
 =ğ
NULL
)

2615  
NULL
;

2617 
	`nİŞl_log
 (
cÚn
->
ùx
, 
NOPOLL_LEVEL_DEBUG
,

2619 
cÚn
->
id
, 
”ºo
, cÚn->
£ssiÚ
, cÚn->
hªdshake_ok
, cÚn->
³ndšg_s¦_acû±
);

2622 ià(
cÚn
->
³ndšg_s¦_acû±
) {

2623 
	`nİŞl_log
 (
cÚn
->
ùx
, 
NOPOLL_LEVEL_DEBUG
, "Received connect over‡ connection (id %d) with TLS handshake…endingo be finished,…rocessing..",

2624 
cÚn
->
id
);

2627 
s¦_”rÜ
 = 
	`SSL_acû±
 (
cÚn
->
s¦
);

2628 ià(
s¦_”rÜ
 == -1) {

2630 
s¦_”rÜ
 = 
	`SSL_g‘_”rÜ
 (
cÚn
->
s¦
, -1);

2632 
	`nİŞl_log
 (
cÚn
->
ùx
, 
NOPOLL_LEVEL_WARNING
, "acû± funùiÚ havçed (fÜ†i¡’” sideès¦_”rÜ=%d : dumpšgƒ¼Ü sck..", 
s¦_”rÜ
);

2634 
s¦_”rÜ
) {

2635 
SSL_ERROR_WANT_READ
:

2636 
	`nİŞl_log
 (
cÚn
->
ùx
, 
NOPOLL_LEVEL_WARNING
, "still‚ot…reparedo continue because„ead wanted conn-id=%d (%p, session %d)",

2637 
cÚn
->
id
, cÚn, cÚn->
£ssiÚ
);

2638  
NULL
;

2639 
SSL_ERROR_WANT_WRITE
:

2640 
	`nİŞl_log
 (
cÚn
->
ùx
, 
NOPOLL_LEVEL_WARNING
, "still‚ot…reparedo continue because write wanted conn-id=%d (%p)",

2641 
cÚn
->
id
, conn);

2642  
NULL
;

2648 
	`nİŞl_log
 (
cÚn
->
ùx
, 
NOPOLL_LEVEL_CRITICAL
, "there was‡nƒrror while‡ccepting TLS connection");

2649 
	`nİŞl_cÚn_log_s¦
 (
cÚn
);

2650 
	`nİŞl_cÚn_shutdown
 (
cÚn
);

2651  
NULL
;

2655 
cÚn
->
³ndšg_s¦_acû±
 = 
nİŞl_çl£
;

2656 
	`nİŞl_cÚn_£t_sock_block
 (
cÚn
->
£ssiÚ
, 
nİŞl_çl£
);

2658 #ià
	`defšed
(
SHOW_DEBUG_LOG
)

2659 
»suÉ
 = 
	`SSL_g‘_v”ify_»suÉ
 (
cÚn
->
s¦
);

2660 
	`nİŞl_log
 (
cÚn
->
ùx
, 
NOPOLL_LEVEL_DEBUG
, "Completed TLS operation from %s:%s (conn id %d, ssl veriry„esult: %d)",

2661 
cÚn
->
ho¡
, cÚn->
pÜt
, cÚn->
id
, (è
»suÉ
);

2665 
cÚn
->
»ûive
 = 
nİŞl_cÚn_s_»ûive
;

2666 
cÚn
->
£nd
 = 
nİŞl_cÚn_s_£nd
;

2669 ià(
cÚn
->
ùx
 && cÚn->ùx->
po¡_s¦_check
) {

2670 ià(! 
cÚn
->
ùx
->
	`po¡_s¦_check
 (cÚn->ùx, cÚn, cÚn->
s¦_ùx
, cÚn->
s¦
, cÚn->ùx->
po¡_s¦_check_d©a
)) {

2672 
	`nİŞl_log
 (
cÚn
->
ùx
, 
NOPOLL_LEVEL_CRITICAL
, "TLS/SSL…ost check function failed, dropping connection");

2673 
	`nİŞl_cÚn_shutdown
 (
cÚn
);

2674  
NULL
;

2679 
cÚn
->
s_Ú
 = 
nİŞl_Œue
;

2681 #ià
	`defšed
(
NOPOLL_OS_UNIX
)

2683 
”ºo
 = 
NOPOLL_EWOULDBLOCK
;

2687  
NULL
;

2692 ià(! 
cÚn
->
hªdshake_ok
) {

2693 
	`nİŞl_log
 (
cÚn
->
ùx
, 
NOPOLL_LEVEL_DEBUG
, "CÚÃùiÚ id %d hªdshaki nÙ com¶‘e,„uÂšg..", cÚn->
id
);

2695 
	`nİŞl_mu‹x_lock
 (
cÚn
->
»f_mu‹x
);

2698 
	`nİŞl_cÚn_com¶‘e_hªdshake
 (
cÚn
);

2701 
	`nİŞl_mu‹x_uÆock
 (
cÚn
->
»f_mu‹x
);

2703 ià(! 
cÚn
->
hªdshake_ok
)

2704  
NULL
;

2707 ià(
cÚn
->
´evious_msg
) {

2708 
	`nİŞl_log
 (
cÚn
->
ùx
, 
NOPOLL_LEVEL_WARNING
, "Reading bytes (previously„ead %d) from‡…revious unfinished frame (pending: %d) over conn-id=%d",

2709 
cÚn
->
´evious_msg
->
·ylßd_size
, cÚn->´evious_msg->
»maš_by‹s
, cÚn->
id
);

2712 ià(
cÚn
->
´evious_msg
->
·ylßd_size
 > 0) {

2713 
msg
 = 
	`nİŞl_msg_Ãw
 ();

2714 ià(
msg
 =ğ
NULL
) {

2715 
	`nİŞl_log
 (
cÚn
->
ùx
, 
NOPOLL_LEVEL_CRITICAL
, "Failedo‡llocate memory for„eceived message, closing session id: %d",

2716 
cÚn
->
id
);

2717 
	`nİŞl_cÚn_shutdown
 (
cÚn
);

2718  
NULL
;

2722 
msg
->
is_äagm’t
 = 
nİŞl_Œue
;

2725 
msg
->
has_fš
 = 1;

2726 
msg
->
İ_code
 = 0;

2729 
msg
->
is_masked
 = 
cÚn
->
´evious_msg
->is_masked;

2730 
msg
->
·ylßd_size
 = 
cÚn
->
´evious_msg
->
»maš_by‹s
;

2731 
msg
->
unmask_de¥
 = 
cÚn
->
´evious_msg
->unmask_desp;

2734 
	`memıy
 (
msg
->
mask
, 
cÚn
->
´evious_msg
->mask, 4);

2736 ià(
msg
->
is_masked
) {

2737 
	`nİŞl_log
 (
cÚn
->
ùx
, 
NOPOLL_LEVEL_DEBUG
, "Reusšg mask v®uğ%d from…»viou äam(%d)", 
	`nİŞl_g‘_32b™
 (
msg
->
mask
));

2738 
	`nİŞl_show_by‹
 (
cÚn
->
ùx
, 
msg
->
mask
[0], "mask[0]");

2739 
	`nİŞl_show_by‹
 (
cÚn
->
ùx
, 
msg
->
mask
[1], "mask[1]");

2740 
	`nİŞl_show_by‹
 (
cÚn
->
ùx
, 
msg
->
mask
[2], "mask[2]");

2741 
	`nİŞl_show_by‹
 (
cÚn
->
ùx
, 
msg
->
mask
[3], "mask[3]");

2745 
	`nİŞl_msg_uÄef
 (
cÚn
->
´evious_msg
);

2748 
msg
 = 
cÚn
->
´evious_msg
;

2751 
msg
->
·ylßd_size
 = msg->
»maš_by‹s
;

2752 
	`nİŞl_ä“
 (
msg
->
·ylßd
);

2753 
	`nİŞl_log
 (
cÚn
->
ùx
, 
NOPOLL_LEVEL_DEBUG
, "»usšg‚oPŞlMsg„eã»nû (%pèsšû†a¡…aylßd„—d wa 0,„emaššg: %d", 
msg
,

2754 
msg
->
·ylßd_size
);

2758 
cÚn
->
´evious_msg
 = 
NULL
;

2760 
»ad_·ylßd
;

2787 
by‹s
 = 
	`__nİŞl_cÚn_»ûive
 (
cÚn
, 
bufãr
, 2);

2788 ià(
by‹s
 == 0) {

2790 
	`nİŞl_log
 (
cÚn
->
ùx
, 
NOPOLL_LEVEL_WARNING
, "Connection id=%d without data,ƒrrno=%d : %s,„eturning‚o message",

2791 
cÚn
->
id
, 
”ºo
, 
	`¡»¼Ü
 (errno));

2792  
NULL
;

2795 ià(
by‹s
 <= 0) {

2796 
	`nİŞl_log
 (
cÚn
->
ùx
, 
NOPOLL_LEVEL_CRITICAL
, "Received connection close, finishing connection session");

2797 
	`nİŞl_cÚn_shutdown
 (
cÚn
);

2798  
NULL
;

2801 ià(
by‹s
 != 2) {

2803 
	`memıy
 (
cÚn
->
³ndšg_buf
 + cÚn->
³ndšg_buf_by‹s
, 
bufãr
, 
by‹s
);

2804 
cÚn
->
³ndšg_buf_by‹s
 +ğ
by‹s
;

2806 
	`nİŞl_log
 (
cÚn
->
ùx
, 
NOPOLL_LEVEL_WARNING
,

2808 
by‹s
, 
cÚn
->
id
);

2809  
NULL
;

2813 
h—d”_size
 = 2;

2815 
	`nİŞl_log
 (
cÚn
->
ùx
, 
NOPOLL_LEVEL_DEBUG
, "Reûived %d by‹ fÜ websock‘ h—d”", 
by‹s
);

2816 
	`nİŞl_show_by‹
 (
cÚn
->
ùx
, 
bufãr
[0], "header[0]");

2817 
	`nİŞl_show_by‹
 (
cÚn
->
ùx
, 
bufãr
[1], "header[1]");

2820 
msg
 = 
	`nİŞl_msg_Ãw
 ();

2821 ià(
msg
 =ğ
NULL
) {

2822 
	`nİŞl_log
 (
cÚn
->
ùx
, 
NOPOLL_LEVEL_CRITICAL
, "Failedo‡llocate memory for„eceived message, closing session id: %d",

2823 
cÚn
->
id
);

2824 
	`nİŞl_cÚn_shutdown
 (
cÚn
);

2825  
NULL
;

2829 
msg
->
has_fš
 = 
	`nİŞl_g‘_b™
 (
bufãr
[0], 7);

2830 
msg
->
İ_code
 = 
bufãr
[0] & 0x0F;

2831 
msg
->
is_masked
 = 
	`nİŞl_g‘_b™
 (
bufãr
[1], 7);

2832 
msg
->
·ylßd_size
 = 
bufãr
[1] & 0x7F;

2835 ià(
cÚn
->
rŞe
 =ğ
NOPOLL_ROLE_LISTENER
 && ! 
msg
->
is_masked
) {

2836 
	`nİŞl_log
 (
cÚn
->
ùx
, 
NOPOLL_LEVEL_CRITICAL
, "Received websocket frame with mask bit seto zero, closing session id: %d",

2837 
cÚn
->
id
);

2838 
	`nİŞl_msg_uÄef
 (
msg
);

2839 
	`nİŞl_cÚn_shutdown
 (
cÚn
);

2840  
NULL
;

2844 ià(
msg
->
·ylßd_size
 < 0) {

2845 
	`nİŞl_log
 (
cÚn
->
ùx
, 
NOPOLL_LEVEL_CRITICAL
, "Received wrong…ayload size‡t first 7 bits, closing session id: %d",

2846 
cÚn
->
id
);

2847 
	`nİŞl_msg_uÄef
 (
msg
);

2848 
	`nİŞl_cÚn_shutdown
 (
cÚn
);

2849  
NULL
;

2852 
	`nİŞl_log
 (
cÚn
->
ùx
, 
NOPOLL_LEVEL_DEBUG
, "š‹rim…aylßd siz»ûived: %d", (è
msg
->
·ylßd_size
);

2855 ià(
msg
->
·ylßd_size
 < 126) {

2858 } ià(
msg
->
·ylßd_size
 == 126) {

2861 
by‹s
 = 
	`__nİŞl_cÚn_»ûive
 (
cÚn
, 
bufãr
 + 2, 2);

2862 ià(
by‹s
 != 2) {

2863 
	`nİŞl_log
 (
cÚn
->
ùx
, 
NOPOLL_LEVEL_WARNING
, "FaedØg‘‚exˆ2 by‹ tØ»ad h—d” fromhwœe, faedØ»ûived cÚ‹Á, shu‰šg dowÀid=%dhcÚÃùiÚ", cÚn->
id
);

2864 
	`nİŞl_msg_uÄef
 (
msg
);

2865 
	`nİŞl_cÚn_shutdown
 (
cÚn
);

2866  
NULL
;

2870 
h—d”_size
 +ğ
by‹s
;

2872 
msg
->
·ylßd_size
 = 
	`nİŞl_g‘_16b™
 (
bufãr
 + 2);

2874 } ià(
msg
->
·ylßd_size
 == 127) {

2875 #ià
	`defšed
(
NOPOLL_64BIT_PLATFORM
)

2877 ià((
by‹s
 = 
	`__nİŞl_cÚn_»ûive
 (
cÚn
, 
bufãr
, 8)) != 8) {

2878 
	`nİŞl_log
 (
cÚn
->
ùx
, 
NOPOLL_LEVEL_CRITICAL
,

2880 
by‹s
, 
cÚn
->
id
);

2881 
	`nİŞl_cÚn_shutdown
 (
cÚn
);

2882  
NULL
;

2885 
Ën
 = (*)
bufãr
;

2886 
msg
->
·ylßd_size
 = 0;

2887 
msg
->
·ylßd_size
 |ğ(()(
Ën
[0]) << 56);

2888 
msg
->
·ylßd_size
 |ğ(()(
Ën
[1]) << 48);

2889 
msg
->
·ylßd_size
 |ğ(()(
Ën
[2]) << 40);

2890 
msg
->
·ylßd_size
 |ğ(()(
Ën
[3]) << 32);

2891 
msg
->
·ylßd_size
 |ğ(()(
Ën
[4]) << 24);

2892 
msg
->
·ylßd_size
 |ğ(()(
Ën
[5]) << 16);

2893 
msg
->
·ylßd_size
 |ğ(()(
Ën
[6]) << 8);

2894 
msg
->
·ylßd_size
 |ğ
Ën
[7];

2896 
	`nİŞl_log
 (
cÚn
->
ùx
, 
NOPOLL_LEVEL_CRITICAL
, "noPoll doesn't support messages biggerhan 65k onhis…lataform (support for 64bit‚ot found)");

2897 
	`nİŞl_msg_uÄef
 (
msg
);

2898 
	`nİŞl_cÚn_shutdown
 (
cÚn
);

2899  
NULL
;

2903 ià(
msg
->
İ_code
 =ğ
NOPOLL_PONG_FRAME
) {

2904 
	`nİŞl_log
 (
cÚn
->
ùx
, 
NOPOLL_LEVEL_DEBUG
, "PONG„eûived ov” cÚÃùiÚ id=%d", cÚn->
id
);

2905 
	`nİŞl_msg_uÄef
 (
msg
);

2906  
NULL
;

2909 ià(
msg
->
İ_code
 =ğ
NOPOLL_CLOSE_FRAME
) {

2910 ià(
msg
->
·ylßd_size
 == 0) {

2914 
	`nİŞl_log
 (
cÚn
->
ùx
, 
NOPOLL_LEVEL_DEBUG
, "Prİ” cÚÃùiÚ clo£ f¿m»ûived id=%d, shu‰šg down", cÚn->
id
);

2915 
	`nİŞl_msg_uÄef
 (
msg
);

2916 
	`nİŞl_cÚn_shutdown
 (
cÚn
);

2917  
NULL
;

2921 
	`nİŞl_log
 (
cÚn
->
ùx
, 
NOPOLL_LEVEL_DEBUG
, "Proper connection close frame„eceived id=%d with content bytes=%d,„eading„eason..",

2922 
cÚn
->
id
, 
msg
->
·ylßd_size
);

2925 ià(
msg
->
İ_code
 =ğ
NOPOLL_PING_FRAME
) {

2926 
	`nİŞl_log
 (
cÚn
->
ùx
, 
NOPOLL_LEVEL_DEBUG
, "PING„eûived ov” cÚÃùiÚ id=%d,„•lyšg PONG", cÚn->
id
);

2927 
	`nİŞl_msg_uÄef
 (
msg
);

2930 
	`nİŞl_cÚn_£nd_pÚg
 (
cÚn
);

2932  
NULL
;

2936 ià(
msg
->
is_masked
) {

2937 
by‹s
 = 
	`__nİŞl_cÚn_»ûive
 (
cÚn
, (*è
msg
->
mask
, 4);

2938 ià(
by‹s
 != 4) {

2940 
	`memıy
 (
cÚn
->
³ndšg_buf
, 
bufãr
, 
h—d”_size
);

2941 
cÚn
->
³ndšg_buf_by‹s
 = 
h—d”_size
;

2943 ià(
by‹s
 > 0) {

2944 
	`memıy
 (
cÚn
->
³ndšg_buf
 + 
h—d”_size
, 
msg
->
mask
, 
by‹s
);

2945 
cÚn
->
³ndšg_buf_by‹s
 +ğ
by‹s
;

2949 
	`nİŞl_msg_uÄef
 (
msg
);

2950 ià(
by‹s
 >ğ0 && 
	`nİŞl_cÚn_is_ok
 (
cÚn
)) {

2951 
	`nİŞl_log
 (
cÚn
->
ùx
, 
NOPOLL_LEVEL_WARNING
,

2953 
by‹s
, 
cÚn
->
id
, cÚn->
³ndšg_buf_by‹s
);

2954  
NULL
;

2957 
	`nİŞl_log
 (
cÚn
->
ùx
, 
NOPOLL_LEVEL_CRITICAL
, "Expectedo„eceive incoming mask‡fter header (4 bytes) but found %d bytes, shutting down id=%dhe connection",

2958 
by‹s
, 
cÚn
->
id
);

2959 
	`nİŞl_cÚn_shutdown
 (
cÚn
);

2960  
NULL
;

2963 
	`nİŞl_log
 (
cÚn
->
ùx
, 
NOPOLL_LEVEL_DEBUG
, "Reûived mask v®uğ%d", 
	`nİŞl_g‘_32b™
 (
msg
->
mask
));

2964 
	`nİŞl_show_by‹
 (
cÚn
->
ùx
, 
msg
->
mask
[0], "mask[0]");

2965 
	`nİŞl_show_by‹
 (
cÚn
->
ùx
, 
msg
->
mask
[1], "mask[1]");

2966 
	`nİŞl_show_by‹
 (
cÚn
->
ùx
, 
msg
->
mask
[2], "mask[2]");

2967 
	`nİŞl_show_by‹
 (
cÚn
->
ùx
, 
msg
->
mask
[3], "mask[3]");

2971 ià(
msg
->
·ylßd_size
 == 0) {

2972 
	`nİŞl_log
 (
cÚn
->
ùx
, 
NOPOLL_LEVEL_WARNING
, "Found incomšg f¿mw™h…aylßd siz0, shu‰šg dowÀid=%dhcÚÃùiÚ", cÚn->
id
);

2973 
	`nİŞl_msg_uÄef
 (
msg
);

2974 
	`nİŞl_cÚn_shutdown
 (
cÚn
);

2975  
NULL
;

2978 
	`nİŞl_log
 (
cÚn
->
ùx
, 
NOPOLL_LEVEL_DEBUG
, "Detected incoming websocket frame: fin(%d), op_code(%d), is_masked(%d),…ayload size(%ld), mask=%d",

2979 
msg
->
has_fš
, msg->
İ_code
, msg->
is_masked
, msg->
·ylßd_size
, 
	`nİŞl_g‘_32b™
 (msg->
mask
));

2984 
»ad_·ylßd
:

2987 
msg
->
·ylßd
 = 
	`nİŞl_Ãw
 (, msg->
·ylßd_size
 + 1);

2988 ià(
msg
->
·ylßd
 =ğ
NULL
) {

2989 
	`nİŞl_log
 (
cÚn
->
ùx
, 
NOPOLL_LEVEL_CRITICAL
, "UÇbËØacquœmemÜyØ»adhšcomšg f¿me, drİpšg cÚÃùiÚ id=%d", cÚn->
id
);

2990 
	`nİŞl_msg_uÄef
 (
msg
);

2991 
	`nİŞl_cÚn_shutdown
 (
cÚn
);

2992  
NULL
;

2995 
by‹s
 = 
	`__nİŞl_cÚn_»ûive
 (
cÚn
, (*è
msg
->
·ylßd
, msg->
·ylßd_size
);

2996 ià(
by‹s
 < 0) {

2997 
	`nİŞl_log
 (
cÚn
->
ùx
, 
NOPOLL_LEVEL_CRITICAL
, "Connection†ost during message„eception, dropping connection id=%d, bytes=%d,ƒrrno=%d : %s",

2998 
cÚn
->
id
, 
by‹s
, 
”ºo
, 
	`¡»¼Ü
 (errno));

2999 
	`nİŞl_msg_uÄef
 (
msg
);

3000 
	`nİŞl_cÚn_shutdown
 (
cÚn
);

3001  
NULL
;

3004 ià(
by‹s
 !ğ
msg
->
·ylßd_size
) {

3006 
msg
->
»maš_by‹s
 = msg->
·ylßd_size
 - 
by‹s
;

3009 
	`nİŞl_log
 (
cÚn
->
ùx
, 
NOPOLL_LEVEL_WARNING
, "Received fewer byteshanƒxpected (bytes: %d <…ayload size: %d)",

3010 
by‹s
, (è
msg
->
·ylßd_size
);

3011 
msg
->
·ylßd_size
 = 
by‹s
;

3016 ià(
by‹s
 > 0)

3017 
	`nİŞl_msg_»f
 (
msg
);

3018 
cÚn
->
´evious_msg
 = 
msg
;

3021 
msg
->
is_äagm’t
 = 
nİŞl_Œue
;

3025 
msg
->
has_fš
 = 0;

3029 
msg
->
is_äagm’t
 = msg->is_äagm’ˆ|| 
cÚn
->
´evious_was_äagm’t
 || msg->
has_fš
 == 0;

3032 
cÚn
->
´evious_was_äagm’t
 = 
msg
->
is_äagm’t
 && msg->
has_fš
 == 0;

3035 ià(
by‹s
 =ğ0 && 
msg
 =ğ
cÚn
->
´evious_msg
) {

3036 
	`nİŞl_log
 (
cÚn
->
ùx
, 
NOPOLL_LEVEL_DEBUG
, "bytes == %d, msg (%p) == conn->previous_msg (%p)",

3037 
by‹s
, 
msg
, 
cÚn
->
´evious_msg
);

3038  
NULL
;

3042 ià(
msg
->
is_masked
) {

3043 
	`nİŞl_log
 (
cÚn
->
ùx
, 
NOPOLL_LEVEL_DEBUG
, "Unmasking (payload size %d, mask: %d, msg: %p, desp: %d)",

3044 
msg
->
·ylßd_size
, 
	`nİŞl_g‘_32b™
 (msg->
mask
), msg, msg->
unmask_de¥
);

3045 
	`nİŞl_cÚn_mask_cÚ‹Á
 (
cÚn
->
ùx
, (*è
msg
->
·ylßd
, msg->
·ylßd_size
, (*èmsg->
mask
, msg->
unmask_de¥
);

3048 
msg
->
unmask_de¥
 +ğmsg->
·ylßd_size
;

3052 ià(
msg
->
İ_code
 =ğ
NOPOLL_CLOSE_FRAME
) {

3054 ià(
msg
->
·ylßd_size
 >= 2) {

3055 
	`nİŞl_log
 (
cÚn
->
ùx
, 
NOPOLL_LEVEL_DEBUG
, "Close frame„eceived id=%d with content bytes=%d,…eer status=%d,…eer„eason=%s,„eading„eason..",

3056 
cÚn
->
id
, 
msg
->
·ylßd_size
, 
	`nİŞl_g‘_16b™
 (msg->
·ylßd
), msg->payload + 2);

3059 
cÚn
->
³”_şo£_¡©us
 = 
	`nİŞl_g‘_16b™
 (
msg
->
·ylßd
);

3060 
cÚn
->
³”_şo£_»asÚ
 = 
	`nİŞl_¡rdup
 (
msg
->
·ylßd
 + 2);

3066 
	`nİŞl_msg_uÄef
 (
msg
);

3067 
	`nİŞl_cÚn_shutdown
 (
cÚn
);

3068  
NULL
;

3071  
msg
;

3072 
	}
}

3091 
	$__nİŞl_cÚn_£nd_commÚ
 (
noPŞlCÚn
 * 
cÚn
, cÚ¡ * 
cÚ‹Á
, 
Ëngth
, 
nİŞl_boŞ
 
has_fš
, 
¦“p_š_h—d”
, 
noPŞlOpCode
 
äame_ty³
)

3093 ià(
cÚn
 =ğ
NULL
 || 
cÚ‹Á
 =ğNULL || 
Ëngth
 == 0 ||†ength < -1)

3096 ià(
cÚn
->
rŞe
 =ğ
NOPOLL_ROLE_MAIN_LISTENER
) {

3097 
	`nİŞl_log
 (
cÚn
->
ùx
, 
NOPOLL_LEVEL_CRITICAL
, "Tryingo send content over‡ master†istener connection");

3101 ià(
Ëngth
 == -1) {

3102 ià(
NOPOLL_BINARY_FRAME
 =ğ
äame_ty³
) {

3103 
	`nİŞl_log
 (
cÚn
->
ùx
, 
NOPOLL_LEVEL_CRITICAL
, "Received†ength == -1 for binary frame. Unableo guess†ength");

3107 
Ëngth
 = 
	`¡¾’
 (
cÚ‹Á
);

3109 
	`nİŞl_log
 (
cÚn
->
ùx
, 
NOPOLL_LEVEL_DEBUG
, "nİŞl_cÚn_£nd_‹xt: A‰em±šgØ£nd %d by‹s", (è
Ëngth
);

3112 ià(
cÚn
->
rŞe
 =ğ
NOPOLL_ROLE_CLIENT
) {

3113  
	`nİŞl_cÚn_£nd_äame
 (
cÚn
, 
has_fš
, 
nİŞl_Œue
,

3114 
äame_ty³
, 
Ëngth
, (
noPŞlPŒ
è
cÚ‹Á
, 
¦“p_š_h—d”
);

3118  
	`nİŞl_cÚn_£nd_äame
 (
cÚn
, 
has_fš
, 
nİŞl_çl£
,

3119 
äame_ty³
, 
Ëngth
, (
noPŞlPŒ
è
cÚ‹Á
, 
¦“p_š_h—d”
);

3120 
	}
}

3142 
	$nİŞl_cÚn_£nd_‹xt
 (
noPŞlCÚn
 * 
cÚn
, cÚ¡ * 
cÚ‹Á
, 
Ëngth
)

3145  
	`__nİŞl_cÚn_£nd_commÚ
 (
cÚn
, 
cÚ‹Á
, 
Ëngth
, 
nİŞl_Œue
, 0, 
NOPOLL_TEXT_FRAME
);

3146 
	}
}

3170 
	$nİŞl_cÚn_£nd_‹xt_äagm’t
 (
noPŞlCÚn
 * 
cÚn
, cÚ¡ * 
cÚ‹Á
, 
Ëngth
)

3173  
	`__nİŞl_cÚn_£nd_commÚ
 (
cÚn
, 
cÚ‹Á
, 
Ëngth
, 
nİŞl_çl£
, 0, 
NOPOLL_TEXT_FRAME
);

3174 
	}
}

3195 
	$nİŞl_cÚn_£nd_bš¬y
 (
noPŞlCÚn
 * 
cÚn
, cÚ¡ * 
cÚ‹Á
, 
Ëngth
)

3197  
	`__nİŞl_cÚn_£nd_commÚ
 (
cÚn
, 
cÚ‹Á
, 
Ëngth
, 
nİŞl_Œue
, 0, 
NOPOLL_BINARY_FRAME
);

3198 
	}
}

3223 
	$nİŞl_cÚn_£nd_bš¬y_äagm’t
 (
noPŞlCÚn
 * 
cÚn
, cÚ¡ * 
cÚ‹Á
, 
Ëngth
)

3225  
	`__nİŞl_cÚn_£nd_commÚ
 (
cÚn
, 
cÚ‹Á
, 
Ëngth
, 
nİŞl_Œue
, 0, 
NOPOLL_BINARY_FRAME
);

3226 
	}
}

3268 
	$nİŞl_cÚn_»ad
 (
noPŞlCÚn
 * 
cÚn
, * 
bufãr
, 
by‹s
, 
nİŞl_boŞ
 
block
, 
timeout
)

3270 
wa™_¦iû
 = 0;

3271 
noPŞlMsg
 * 
msg
 = 
NULL
;

3272 
timev®
 
¡¬t
;

3273 
timev®
 
¡İ
;

3274 
timev®
 
diff
;

3275 
–Ïp£d
 = 0;

3276 
de¥
 = 0;

3277 
amouÁ
;

3278 
tÙ®_»ad
 = 0;

3279 
tÙ®_³ndšg
 = 0;

3282 ià(
cÚn
 =ğ
NULL
 || 
bufãr
 =ğNULL || 
by‹s
 <= 0)

3285 ià(
timeout
 > 1000)

3286 
wa™_¦iû
 = 100;

3287 ià(
timeout
 > 100)

3288 
wa™_¦iû
 = 50;

3289 ià(
timeout
 > 10)

3290 
wa™_¦iû
 = 10;

3292 ià(
timeout
 > 0)

3293 #ià
	`defšed
(
NOPOLL_OS_WIN32
)

3294 
	`nİŞl_wš32_g‘timeofday
 (&
¡¬t
, 
NULL
);

3296 
	`g‘timeofday
 (&
¡¬t
, 
NULL
);

3300 
	`mem£t
 (
bufãr
, 0, 
by‹s
);

3303 ià(
cÚn
->
³ndšg_msg
) {

3306 
amouÁ
 = 
cÚn
->
³ndšg_diff
;

3307 
msg
 = 
cÚn
->
³ndšg_msg
;

3308 ià(
amouÁ
 > 
by‹s
) {

3311 ià(
by‹s
 < 
cÚn
->
³ndšg_diff
) {

3312 
cÚn
->
³ndšg_diff
 -ğ
by‹s
;

3315 
by‹s
 = 
cÚn
->
³ndšg_diff
;

3316 
cÚn
->
³ndšg_diff
 = 0;

3319 
amouÁ
 = 
by‹s
;

3321 
cÚn
->
³ndšg_diff
 = 0;

3325 
	`memıy
 (
bufãr
, ((*è
	`nİŞl_msg_g‘_·ylßd
 (
msg
)è+ 
cÚn
->
³ndšg_de¥
, 
amouÁ
);

3326 
tÙ®_»ad
 +ğ
amouÁ
;

3327 
de¥
 = 
amouÁ
;

3331 
cÚn
->
³ndšg_de¥
 +ğ
amouÁ
;

3334 ià(
cÚn
->
³ndšg_diff
 == 0) {

3335 
	`nİŞl_msg_uÄef
 (
cÚn
->
³ndšg_msg
);

3336 
cÚn
->
³ndšg_msg
 = 
NULL
;

3340 ià(
tÙ®_»ad
 =ğ
by‹s
 || ! 
block
) {

3341 ià(
tÙ®_»ad
 =ğ0 && ! 
block
)

3344  
tÙ®_»ad
;

3352 
nİŞl_Œue
) {

3354 
msg
 = 
	`nİŞl_cÚn_g‘_msg
 (
cÚn
);

3355 ià(
msg
 =ğ
NULL
) {

3356 ià(! 
	`nİŞl_cÚn_is_ok
 (
cÚn
)) {

3357 
	`nİŞl_log
 (
cÚn
->
ùx
, 
NOPOLL_LEVEL_CRITICAL
, "Received websocket conn-id=%d close during wait„eply..",

3358 
cÚn
->
id
);

3359 ià(
tÙ®_»ad
 =ğ0 && ! 
block
)

3361  
tÙ®_»ad
;

3364 ià(! 
block
) {

3365 ià(
tÙ®_»ad
 =ğ0 && ! 
block
)

3367  
tÙ®_»ad
;

3373 ià(
msg
) {

3375 
amouÁ
 = 
	`nİŞl_msg_g‘_·ylßd_size
 (
msg
);

3376 
tÙ®_³ndšg
 = 
by‹s
 - 
tÙ®_»ad
;

3377 
	`nİŞl_log
 (
cÚn
->
ùx
, 
NOPOLL_LEVEL_DEBUG
, "(New F¿meè»ûived %d by‹ Õ’dšg„eque¡ed %d by‹s, de¥: %d)", 
amouÁ
, 
tÙ®_³ndšg
, 
de¥
);

3378 ià(
amouÁ
 > 
tÙ®_³ndšg
) {

3381 
cÚn
->
³ndšg_de¥
 = 
tÙ®_³ndšg
;

3382 
cÚn
->
³ndšg_diff
 = 
amouÁ
 - 
tÙ®_³ndšg
;

3383 
cÚn
->
³ndšg_msg
 = 
msg
;

3384 
amouÁ
 = 
tÙ®_³ndšg
;

3387 
	`nİŞl_msg_»f
 (
msg
);

3390 
	`memıy
 (
bufãr
 + 
de¥
, 
	`nİŞl_msg_g‘_·ylßd
 (
msg
), 
amouÁ
);

3391 
tÙ®_»ad
 +ğ
amouÁ
;

3392 
de¥
 +ğ
amouÁ
;

3397 
	`nİŞl_msg_uÄef
 (
msg
);

3400 ià(
tÙ®_»ad
 =ğ
by‹s
 || ! 
block
) {

3401 
	`nİŞl_log
 (
cÚn
->
ùx
, 
NOPOLL_LEVEL_DEBUG
, "Finishing‚opoll_conn_read because block=%d orotal bytes„equested=%d satisfied=%d ",

3402 
block
, 
by‹s
, 
tÙ®_»ad
);

3404 ià(
tÙ®_»ad
 =ğ0 && ! 
block
)

3406  
tÙ®_»ad
;

3411 ià(
timeout
 > 0) {

3412 #ià
	`defšed
(
NOPOLL_OS_WIN32
)

3413 
	`nİŞl_wš32_g‘timeofday
 (&
¡İ
, 
NULL
);

3415 
	`g‘timeofday
 (&
¡İ
, 
NULL
);

3417 
	`nİŞl_timev®_sub¡¿ù
 (&
¡İ
, &
¡¬t
, &
diff
);

3419 
–Ïp£d
 = (
diff
.
tv_£c
 * 1000è+ (diff.
tv_u£c
 / 1000);

3420 ià(
–Ïp£d
 > (
timeout
))

3424 
	`nİŞl_¦“p
 (
wa™_¦iû
);

3428 
	`nİŞl_log
 (
cÚn
->
ùx
, 
NOPOLL_LEVEL_DEBUG
, "Finishing‚opoll_conn_readimeout„eached=%ld ms ,„eturningotal bytes„equested=%d satisfied=%d ",

3429 
timeout
, 
by‹s
, 
tÙ®_»ad
);

3431 ià(
tÙ®_»ad
 =ğ0 && ! 
block
)

3433  
tÙ®_»ad
;

3434 
	}
}

3445 
nİŞl_boŞ
 
	$nİŞl_cÚn_£nd_pšg
 (
noPŞlCÚn
 * 
cÚn
)

3447  
	`nİŞl_cÚn_£nd_äame
 (
cÚn
, 
nİŞl_Œue
, 
nİŞl_çl£
, 
NOPOLL_PING_FRAME
, 0, 
NULL
, 0) > 0;

3448 
	}
}

3461 
	$nİŞl_cÚn_£t_Ú_msg
 (
noPŞlCÚn
 * 
cÚn
,

3462 
noPŞlOnMes§geHªdËr
 
Ú_msg
,

3463 
noPŞlPŒ
 
u£r_d©a
)

3465 ià(
cÚn
 =ğ
NULL
)

3469 
cÚn
->
Ú_msg
 = on_msg;

3470 
cÚn
->
Ú_msg_d©a
 = 
u£r_d©a
;

3473 
	}
}

3498 
	$nİŞl_cÚn_£t_Ú_»ady
 (
noPŞlCÚn
 * 
cÚn
,

3499 
noPŞlAùiÚHªdËr
 
Ú_»ady
,

3500 
noPŞlPŒ
 
u£r_d©a
)

3502 ià(
cÚn
 =ğ
NULL
)

3506 
cÚn
->
Ú_»ady
 = on_ready;

3507 ià(
cÚn
->
Ú_»ady
 =ğ
NULL
)

3508 
cÚn
->
Ú_»ady_d©a
 = 
NULL
;

3510 
cÚn
->
Ú_»ady_d©a
 = 
u£r_d©a
;

3512 
	}
}

3524 
	$nİŞl_cÚn_£t_Ú_şo£
 (
noPŞlCÚn
 * 
cÚn
,

3525 
noPŞlOnClo£HªdËr
 
Ú_şo£
,

3526 
noPŞlPŒ
 
u£r_d©a
)

3528 ià(
cÚn
 =ğ
NULL
)

3532 
cÚn
->
Ú_şo£
 = on_close;

3533 
cÚn
->
Ú_şo£_d©a
 = 
u£r_d©a
;

3536 
	}
}

3548 
nİŞl_boŞ
 
	$nİŞl_cÚn_£nd_pÚg
 (
noPŞlCÚn
 * 
cÚn
)

3550 ià(
cÚn
 =ğ
NULL
)

3551  
nİŞl_çl£
;

3553  
	`nİŞl_cÚn_£nd_äame
 (
cÚn
, 
nİŞl_Œue
, cÚn->
rŞe
 =ğ
NOPOLL_ROLE_CLIENT
, 
NOPOLL_PONG_FRAME
, 0, 
NULL
, 0);

3554 
	}
}

3572 
	$nİŞl_cÚn_com¶‘e_³ndšg_wr™e
 (
noPŞlCÚn
 * 
cÚn
)

3574 
by‹s_wr™‹n
 = 0;

3575 * 
»ã»nû
;

3576 
³ndšg_by‹s
;

3578 ià(
cÚn
 =ğ
NULL
 || cÚn->
³ndšg_wr™e
 == NULL)

3582 
by‹s_wr™‹n
 = 
cÚn
->
	`£nd
 (cÚn, cÚn->
³ndšg_wr™e
, cÚn->
³ndšg_wr™e_by‹s
);

3583 ià(
by‹s_wr™‹n
 =ğ
cÚn
->
³ndšg_wr™e_by‹s
) {

3584 
	`nİŞl_log
 (
cÚn
->
ùx
, 
NOPOLL_LEVEL_DEBUG
, "Com¶‘ed…’dšg wr™İ”©iÚ w™h by‹s=%d", 
by‹s_wr™‹n
);

3585 
	`nİŞl_ä“
 (
cÚn
->
³ndšg_wr™e
);

3586 
cÚn
->
³ndšg_wr™e
 = 
NULL
;

3587  
by‹s_wr™‹n
;

3590 ià(
by‹s_wr™‹n
 > 0) {

3592 
³ndšg_by‹s
 = 
cÚn
->
³ndšg_wr™e_by‹s
 - 
by‹s_wr™‹n
;

3593 
»ã»nû
 = 
	`nİŞl_Ãw
 (, 
³ndšg_by‹s
);

3594 
	`memıy
 (
»ã»nû
, 
cÚn
->
³ndšg_wr™e
 + 
by‹s_wr™‹n
, 
³ndšg_by‹s
);

3595 
	`nİŞl_ä“
 (
cÚn
->
³ndšg_wr™e
);

3596 
cÚn
->
³ndšg_wr™e
 = 
»ã»nû
;

3597  
by‹s_wr™‹n
;

3600 
	`nİŞl_log
 (
cÚn
->
ùx
, 
NOPOLL_LEVEL_WARNING
, "Found complete write operation didn't finish well,„esult=%d,ƒrrno=%d, conn-id=%d",

3601 
by‹s_wr™‹n
, 
”ºo
, 
cÚn
->
id
);

3602  
by‹s_wr™‹n
;

3603 
	}
}

3615 
	$nİŞl_cÚn_³ndšg_wr™e_by‹s
 (
noPŞlCÚn
 * 
cÚn
)

3617 ià(
cÚn
 =ğ
NULL
 || cÚn->
³ndšg_wr™e
 == NULL)

3620  
cÚn
->
³ndšg_wr™e_by‹s
;

3621 
	}
}

3649 
	$nİŞl_cÚn_æush_wr™es
 (
noPŞlCÚn
 * 
cÚn
, 
timeout
, 
´evious_»suÉ
)

3651 
™”©Ü
 = 0;

3652 
by‹s_wr™‹n
;

3653 
tÙ®
 = 0;

3654 
muÉl›r
 = 1;

3655 
wa™_im¶em’‹d
 = 0;

3658 ià(
”ºo
 !ğ
NOPOLL_EWOULDBLOCK
 || 
	`nİŞl_cÚn_³ndšg_wr™e_by‹s
 (
cÚn
) == 0) {

3659 
	`nİŞl_log
 (
cÚn
->
ùx
, 
NOPOLL_LEVEL_DEBUG
, "called flush but‚othing is…ending=%d orƒrrno=%d isn't %d",

3660 
	`nİŞl_cÚn_³ndšg_wr™e_by‹s
 (
cÚn
), 
”ºo
, 
NOPOLL_EWOULDBLOCK
);

3661  
´evious_»suÉ
 > 0 ?…revious_result : 0;

3664 
™”©Ü
 < 100 && 
	`nİŞl_cÚn_³ndšg_wr™e_by‹s
 (
cÚn
) > 0) {

3667 ià(
wa™_im¶em’‹d
 >ğ
timeout
)

3670 
	`nİŞl_¦“p
 (100000 * 
muÉl›r
);

3671 
wa™_im¶em’‹d
 +ğ(100000 * 
muÉl›r
);

3674 
by‹s_wr™‹n
 = 
	`nİŞl_cÚn_com¶‘e_³ndšg_wr™e
 (
cÚn
);

3676 ià(
by‹s_wr™‹n
 > 0)

3677 
tÙ®
 +ğ
by‹s_wr™‹n
;

3680 
™”©Ü
++;

3681 
muÉl›r
++;

3684 
	`nİŞl_log
 (
cÚn
->
ùx
, 
NOPOLL_LEVEL_DEBUG
, "finishing flush operation,otal written=%d,‡ddedo…revious„esult=%d",

3685 
tÙ®
, 
´evious_»suÉ
);

3688 ià(
´evious_»suÉ
 > 0)

3689  
tÙ®
 + 
´evious_»suÉ
;

3692  
tÙ®
;

3693 
	}
}

3712 
	$nİŞl_cÚn_£nd_äame
 (
noPŞlCÚn
 * 
cÚn
, 
nİŞl_boŞ
 
fš
,‚İŞl_boŞ 
masked
,

3713 
noPŞlOpCode
 
İ_code
, 
Ëngth
, 
noPŞlPŒ
 
cÚ‹Á
, 
¦“p_š_h—d”
)

3716 
h—d”
[14];

3717 
h—d”_size
;

3718 * 
£nd_bufãr
;

3719 
by‹s_wr™‹n
 = 0;

3720 
mask
[4];

3721 
mask_v®ue
 = 0;

3722 
de¥
 = 0;

3723 
Œ›s
;

3724 #ià
	`defšed
(
SHOW_DEBUG_LOG
)

3725 
noPŞlDebugLev–
 
Ëv–
;

3729 ià(
	`nİŞl_cÚn_com¶‘e_³ndšg_wr™e
 (
cÚn
) != 0)

3733 
	`mem£t
 (
h—d”
, 0, 14);

3736 ià(
fš
)

3737 
	`nİŞl_£t_b™
 (
h—d”
, 7);

3739 ià(
masked
) {

3740 
	`nİŞl_£t_b™
 (
h—d”
 + 1, 7);

3743 #ià
	`defšed
(
NOPOLL_OS_WIN32
)

3744 
mask_v®ue
 = (è
	`¿nd
 ();

3746 
mask_v®ue
 = (è
	`¿ndom
 ();

3748 
	`mem£t
 (
mask
, 0, 4);

3749 
	`nİŞl_£t_32b™
 (
mask_v®ue
, 
mask
);

3752 ià(
İ_code
) {

3754 
h—d”
[0] |ğ
İ_code
 & 0x0f;

3758 
h—d”_size
 = 2;

3761 ià(
Ëngth
 < 126) {

3762 
h—d”
[1] |ğ
Ëngth
;

3763 } ià(
Ëngth
 < 65535) {

3765 
h—d”
[1] |= 126;

3766 
h—d”_size
 += 2;

3768 
	`nİŞl_£t_16b™
 (
Ëngth
, 
h—d”
 + 2);

3769 #ià
	`defšed
(
NOPOLL_64BIT_PLATFORM
)

3770 } ià(
Ëngth
 < 9223372036854775807) {

3775 
	`nİŞl_log
 (
cÚn
->
ùx
, 
NOPOLL_LEVEL_CRITICAL
, "Unableo sendhe„equested message,his„equested is biggerhanhe valuehat can be supported byhis…latform (it should be < 65k)");

3781 ià(
masked
) {

3782 
	`nİŞl_£t_32b™
 (
mask_v®ue
, 
h—d”
 + 
h—d”_size
);

3783 
h—d”_size
 += 4;

3787 
£nd_bufãr
 = 
	`nİŞl_Ãw
 (, 
Ëngth
 + 
h—d”_size
 + 2);

3788 ià(
£nd_bufãr
 =ğ
NULL
) {

3789 
	`nİŞl_log
 (
cÚn
->
ùx
, 
NOPOLL_LEVEL_CRITICAL
, "Unableo‡llocate memoryo implement send operation");

3794 
	`nİŞl_log
 (
cÚn
->
ùx
, 
NOPOLL_LEVEL_DEBUG
, "Copying intohe buffer %d bytes of header (total memory‡llocated: %d)",

3795 
h—d”_size
, (è
Ëngth
 + header_size + 1);

3796 
	`memıy
 (
£nd_bufãr
, 
h—d”
, 
h—d”_size
);

3797 ià(
Ëngth
 > 0) {

3798 
	`memıy
 (
£nd_bufãr
 + 
h—d”_size
, 
cÚ‹Á
, 
Ëngth
);

3801 ià(
masked
) {

3802 
	`nİŞl_cÚn_mask_cÚ‹Á
 (
cÚn
->
ùx
, 
£nd_bufãr
 + 
h—d”_size
, 
Ëngth
, 
mask
, 0);

3808 
	`nİŞl_log
 (
cÚn
->
ùx
, 
NOPOLL_LEVEL_DEBUG
, "Mask used forhis delivery: %d (abouto send %d bytes)",

3809 
	`nİŞl_g‘_32b™
 (
£nd_bufãr
 + 
h—d”_size
 - 2), (è
Ëngth
 + header_size);

3811 
de¥
 = 0;

3812 
Œ›s
 = 0;

3813 
nİŞl_Œue
) {

3815 ià(
¦“p_š_h—d”
 == 0) {

3816 
by‹s_wr™‹n
 = 
cÚn
->
	`£nd
 (cÚn, 
£nd_bufãr
 + 
de¥
, 
Ëngth
 + 
h—d”_size
 - desp);

3818 
	`nİŞl_log
 (
cÚn
->
ùx
, 
NOPOLL_LEVEL_DEBUG
, "Found sË• iÀh—d” indiÿtiÚ, s’dšg h—d”: %d by‹ (wa™šg %ld)", 
h—d”_size
, 
¦“p_š_h—d”
);

3819 
by‹s_wr™‹n
 = 
cÚn
->
	`£nd
 (cÚn, 
£nd_bufãr
, 
h—d”_size
);

3820 ià(
by‹s_wr™‹n
 =ğ
h—d”_size
) {

3822 
	`nİŞl_¦“p
 (
¦“p_š_h—d”
);

3825 
by‹s_wr™‹n
 = 
cÚn
->
	`£nd
 (cÚn, 
£nd_bufãr
 + 
h—d”_size
, 
Ëngth
);

3826 
	`nİŞl_log
 (
cÚn
->
ùx
, 
NOPOLL_LEVEL_DEBUG
, "Rest of content written %d (header size: %d,†ength: %d)",

3827 
by‹s_wr™‹n
, 
h—d”_size
, 
Ëngth
);

3828 
by‹s_wr™‹n
 = 
Ëngth
 + 
h—d”_size
;

3829 
	`nİŞl_log
 (
cÚn
->
ùx
, 
NOPOLL_LEVEL_DEBUG
, "fš® by‹s_wr™‹À%d", 
by‹s_wr™‹n
);

3831 
	`nİŞl_log
 (
cÚn
->
ùx
, 
NOPOLL_LEVEL_WARNING
, "Requestedo write %d bytes forhe header but %d were written",

3832 
h—d”_size
, 
by‹s_wr™‹n
);

3837 ià((
by‹s_wr™‹n
 + 
de¥
è!ğ(
Ëngth
 + 
h—d”_size
)) {

3838 
	`nİŞl_log
 (
cÚn
->
ùx
, 
NOPOLL_LEVEL_WARNING
,

3840 (è
Ëngth
 + 
h—d”_size
 - 
de¥
, 
by‹s_wr™‹n
, 
masked
, 
mask_v®ue
, h—d”_size, (èËngth, 
”ºo
, 
	`¡»¼Ü
 (errno));

3843 ià(
by‹s_wr™‹n
 > 0)

3844 
de¥
 +ğ
by‹s_wr™‹n
;

3846 
	`nİŞl_log
 (
cÚn
->
ùx
, 
NOPOLL_LEVEL_DEBUG
, "Bytes writtenohe wire %d (masked? %d, mask: %u, header size: %d,†ength: %d)",

3847 
by‹s_wr™‹n
, 
masked
, 
mask_v®ue
, 
h—d”_size
, (è
Ëngth
);

3852 ià(
by‹s_wr™‹n
 > 0)

3853 
de¥
 +ğ
by‹s_wr™‹n
;

3856 
Œ›s
++;

3858 ià((
”ºo
 !ğ0è|| 
Œ›s
 > 50) {

3859 
	`nİŞl_log
 (
cÚn
->
ùx
, 
NOPOLL_LEVEL_WARNING
, "Foundƒrrno=%d (%s) value whileryingo bytesohe WebSocket conn-id=%d or maxries„eached=%d",

3860 
”ºo
, 
	`¡»¼Ü
 (”ºo), 
cÚn
->
id
, 
Œ›s
);

3865 
	`nİŞl_¦“p
 (100000);

3870 
cÚn
->
³ndšg_wr™e_by‹s
 = 
Ëngth
 + 
h—d”_size
 - 
de¥
;

3872 #ià
	`defšed
(
SHOW_DEBUG_LOG
)

3873 
Ëv–
 = 
NOPOLL_LEVEL_DEBUG
;

3874 ià(
de¥
 !ğ(
Ëngth
 + 
h—d”_size
))

3875 
Ëv–
 = 
NOPOLL_LEVEL_CRITICAL
;

3876 ià(
”ºo
 =ğ
NOPOLL_EWOULDBLOCK
 && 
cÚn
->
³ndšg_wr™e_by‹s
 > 0)

3877 
Ëv–
 = 
NOPOLL_LEVEL_WARNING
;

3879 
	`nİŞl_log
 (
cÚn
->
ùx
, 
Ëv–
,

3882 
by‹s_wr™‹n
 <ğ0 ? by‹s_wr™‹À: 
de¥
 - 
h—d”_size
,

3884 
de¥
 - 
h—d”_size
,

3885 
Ëngth
, 
cÚn
->
³ndšg_wr™e_by‹s
, cÚn->
id
);

3889 ià(
cÚn
->
³ndšg_wr™e_by‹s
 > 0) {

3890 
cÚn
->
³ndšg_wr™e
 = 
	`nİŞl_Ãw
 (, cÚn->
³ndšg_wr™e_by‹s
);

3891 
	`memıy
 (
cÚn
->
³ndšg_wr™e
, 
£nd_bufãr
 + 
Ëngth
 + 
h—d”_size
 - cÚn->
³ndšg_wr™e_by‹s
, conn->pending_write_bytes);

3893 
	`nİŞl_log
 (
cÚn
->
ùx
, 
NOPOLL_LEVEL_DEBUG
, "Stored %d bytes starting from %d out of %d bytes (header size: %d)",

3894 
cÚn
->
³ndšg_wr™e_by‹s
, 
Ëngth
 + 
h—d”_size
 - conn->pending_write_bytes,†ength + header_size, header_size);

3899 
	`nİŞl_ä“
 (
£nd_bufãr
);

3902 ià(
de¥
 - 
h—d”_size
 > 0)

3903  
de¥
 - 
h—d”_size
;

3906  
by‹s_wr™‹n
;

3907 
	}
}

3920 
noPŞlCÚn
 * 
	$nİŞl_cÚn_acû±
 (
noPŞlCtx
 * 
ùx
, 
noPŞlCÚn
 * 
li¡’”
)

3922 
NOPOLL_SOCKET
 
£ssiÚ
;

3924 
	`nİŞl_»tuº_v®_if_ç
 (
ùx
, ctx && 
li¡’”
, 
NULL
);

3926 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_DEBUG
, "Callingo‡ccept web socket connection over master id=%d, socket=%d",

3927 
li¡’”
->
id
,†i¡’”->
£ssiÚ
);

3932 
£ssiÚ
 = 
	`nİŞl_li¡’”_acû±
 (
li¡’”
->session);

3933 ià(
£ssiÚ
 =ğ
NOPOLL_INVALID_SOCKET
) {

3934 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_CRITICAL
, "Received invalid socket value from‡ccept(2): %d,ƒrror codeƒrrno=: %d",

3935 
£ssiÚ
, 
”ºo
);

3936  
NULL
;

3939  
	`nİŞl_cÚn_acû±_sock‘
 (
ùx
, 
li¡’”
, 
£ssiÚ
);

3940 
	}
}

3957 
noPŞlCÚn
 * 
	$nİŞl_cÚn_acû±_sock‘
 (
noPŞlCtx
 * 
ùx
, 
noPŞlCÚn
 * 
li¡’”
, 
NOPOLL_SOCKET
 
£ssiÚ
)

3959 
noPŞlCÚn
 * 
cÚn
;

3961 
	`nİŞl_»tuº_v®_if_ç
 (
ùx
, ctx && 
li¡’”
, 
NULL
);

3964 
cÚn
 = 
	`nİŞl_li¡’”_äom_sock‘
 (
ùx
, 
£ssiÚ
);

3965 ià(
cÚn
 =ğ
NULL
) {

3966 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_CRITICAL
, "Received NULL…ointer‡fter callingo create†istener from session..");

3967  
NULL
;

3970 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_DEBUG
, "Accepted‚ew WebSocket conn-id=%d, socket=%d, over master id=%d, socket=%d",

3971 
cÚn
->
id
, cÚn->
£ssiÚ
, 
li¡’”
->id,†istener->session);

3975 
cÚn
->
li¡’”
 =†istener;

3977 ià(! 
	`nİŞl_cÚn_acû±_com¶‘e
 (
ùx
, 
li¡’”
, 
cÚn
, 
£ssiÚ
,†i¡’”->
s_Ú
))

3978  
NULL
;

3981  
cÚn
;

3982 
	}
}

3987 
nİŞl_boŞ
 
	$__nİŞl_cÚn_acû±_com¶‘e_commÚ
 (
noPŞlCtx
 * 
ùx
, 
noPŞlCÚnO±s
 * 
İtiÚs
, 
noPŞlCÚn
 * 
li¡’”
,‚oPŞlCÚÀ* 
cÚn
, 
NOPOLL_SOCKET
 
£ssiÚ
, 
nİŞl_boŞ
 
s_Ú
) {

3989 cÚ¡ * 
û¹ifiÿ‹Fe
 = 
NULL
;

3990 cÚ¡ * 
´iv©eKey
 = 
NULL
;

3991 cÚ¡ * 
chašC”tifiÿ‹
 = 
NULL
;

3992 cÚ¡ * 
£rv”Name
 = 
NULL
;

3995 ià(! (
ùx
 && 
li¡’”
 && 
cÚn
 && 
£ssiÚ
 !ğ
NOPOLL_INVALID_SOCKET
)) {

3996 
	`nİŞl_cÚn_shutdown
 (
cÚn
);

3997 
	`nİŞl_ùx_uÄegi¡”_cÚn
 (
ùx
, 
cÚn
);

4000 
	`__nİŞl_cÚn_İts_»Ëa£_if_Ãeded
 (
İtiÚs
);

4002  
nİŞl_çl£
;

4006 
	`nİŞl_cÚn_£t_sock_block
 (
£ssiÚ
, 
nİŞl_Œue
);

4009 ià(
ùx
->
Ú_acû±
) {

4011 ià(! 
ùx
->
	`Ú_acû±
 (ùx, 
cÚn
, ctx->
Ú_acû±_d©a
)) {

4012 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_WARNING
, "Application†evel denied‡ccepting connection from %s:%s, closing",

4013 
cÚn
->
ho¡
, cÚn->
pÜt
);

4014 
	`nİŞl_cÚn_shutdown
 (
cÚn
);

4015 
	`nİŞl_ùx_uÄegi¡”_cÚn
 (
ùx
, 
cÚn
);

4018 
	`__nİŞl_cÚn_İts_»Ëa£_if_Ãeded
 (
İtiÚs
);

4020  
nİŞl_çl£
;

4024 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_DEBUG
, "Connection„eceived‡nd‡ccepted from %s:%s (conn„efs: %d, ctx„efs: %d)",

4025 
li¡’”
->
ho¡
,†i¡’”->
pÜt
,†i¡’”->
»fs
, 
ùx
->refs);

4027 ià(
li¡’”
->
s_Ú
 ||ls_on) {

4030 
cÚn
->
s_Ú
 = 
nİŞl_Œue
;

4036 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_DEBUG
, "S¹šg TLS…roûss, o±iÚs=%p,†i¡’”=%p", 
İtiÚs
, 
li¡’”
);

4038 ià(
İtiÚs
) {

4039 
û¹ifiÿ‹Fe
 = 
İtiÚs
->
û¹ifiÿ‹
;

4040 
´iv©eKey
 = 
İtiÚs
->
´iv©e_key
;

4042 ià(
û¹ifiÿ‹Fe
 =ğ
NULL
 || 
´iv©eKey
 == NULL) {

4045 
û¹ifiÿ‹Fe
 = 
li¡’”
->
û¹ifiÿ‹
;

4046 
´iv©eKey
 = 
li¡’”
->
´iv©e_key
;

4047 ià(
û¹ifiÿ‹Fe
 =ğ
NULL
 || 
´iv©eKey
 == NULL) {

4050 
	`nİŞl_ùx_fšd_û¹ifiÿ‹
 (
ùx
, 
£rv”Name
, &
û¹ifiÿ‹Fe
, &
´iv©eKey
, &
chašC”tifiÿ‹
);

4055 ià(
û¹ifiÿ‹Fe
 =ğ
NULL
 || 
´iv©eKey
 == NULL) {

4056 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_CRITICAL
, "Unableo‡ccept secure web socket connection, certificate file %s‡nd/or key file %s isn't defined",

4057 
û¹ifiÿ‹Fe
 ? certificateFile : "<not defined>",

4058 
´iv©eKey
 ?…rivateKey : "<not defined>");

4059 
	`nİŞl_cÚn_shutdown
 (
cÚn
);

4060 
	`nİŞl_ùx_uÄegi¡”_cÚn
 (
ùx
, 
cÚn
);

4063 
	`__nİŞl_cÚn_İts_»Ëa£_if_Ãeded
 (
İtiÚs
);

4065  
nİŞl_çl£
;

4069 ià(! 
__nİŞl_s_was_š™
) {

4070 
__nİŞl_s_was_š™
 = 
nİŞl_Œue
;

4071 
	`SSL_lib¿ry_š™
 ();

4075 ià(
li¡’”
->
chaš_û¹ifiÿ‹
)

4076 
chašC”tifiÿ‹
 = 
li¡’”
->
chaš_û¹ifiÿ‹
;

4077 ià(
İtiÚs
 && o±iÚs->
chaš_û¹ifiÿ‹
)

4078 
chašC”tifiÿ‹
 = 
İtiÚs
->
chaš_û¹ifiÿ‹
;

4081 
cÚn
->
s¦_ùx
 = 
	`__nİŞl_cÚn_g‘_s¦_cÚ‹xt
 (
ùx
, cÚn, 
li¡’”
->
İts
, 
nİŞl_çl£
);

4084 ià(
İtiÚs
 && o±iÚs->
ÿ_û¹ifiÿ‹
) {

4085 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_DEBUG
, "S‘tšg u°CA c”tifiÿ‹: %s", 
İtiÚs
->
ÿ_û¹ifiÿ‹
);

4086 ià(
	`SSL_CTX_lßd_v”ify_loÿtiÚs
 (
cÚn
->
s¦_ùx
, 
İtiÚs
->
ÿ_û¹ifiÿ‹
, 
NULL
) != 1) {

4087 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_CRITICAL
, "FaedØcÚfigu» CA c”tifiÿ‹ (%s), SSL_CTX_lßd_v”ify_loÿtiÚ (èçed", 
İtiÚs
->
ÿ_û¹ifiÿ‹
);

4088  
nİŞl_çl£
;

4094 ià(
	`SSL_CTX_£t_deçuÉ_v”ify_·ths
 (
cÚn
->
s¦_ùx
) != 1) {

4095 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_CRITICAL
, "Unableo configure default verification…aths, SSL_CTX_set_default_verify_paths () failed");

4096  
nİŞl_çl£
;

4100 ià(
chašC”tifiÿ‹
) {

4101 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_DEBUG
, "S‘tšg u°chaš c”tifiÿ‹: %s", 
chašC”tifiÿ‹
);

4102 ià(
	`SSL_CTX_u£_û¹ifiÿ‹_chaš_fe
 (
cÚn
->
s¦_ùx
, 
chašC”tifiÿ‹
) != 1) {

4103 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_CRITICAL
, "FaedØcÚfigu» chaš c”tifiÿ‹ (%s), SSL_CTX_u£_û¹ifiÿ‹_chaš_f(èçed", 
chašC”tifiÿ‹
);

4104  
nİŞl_çl£
;

4108 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_DEBUG
, "Usšg c”tifiÿ‹ fe: % (w™h s¦ cÚ‹xˆ»f: %p)", 
û¹ifiÿ‹Fe
, 
cÚn
->
s¦_ùx
);

4109 ià(
cÚn
->
s¦_ùx
 =ğ
NULL
 || 
	`SSL_CTX_u£_û¹ifiÿ‹_chaš_fe
 (cÚn->s¦_ùx, 
û¹ifiÿ‹Fe
) != 1) {

4111 ià(
cÚn
->
s¦_ùx
 =ğ
NULL
)

4112 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_CRITICAL
, "Unableo‡ccept incoming connection, failedo create SSL context. Context creator„eturned NULL…ointer");

4114 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_CRITICAL
, "there was‡nƒrror while setting certificate file intohe SSl context, unableo start TLS…rofile. Failure found‡t SSL_CTX_use_certificate_file function. Tried certificate file: %s",

4115 
û¹ifiÿ‹Fe
);

4118 
	`nİŞl_cÚn_shutdown
 (
cÚn
);

4119 
	`nİŞl_ùx_uÄegi¡”_cÚn
 (
ùx
, 
cÚn
);

4122 
	`__nİŞl_cÚn_İts_»Ëa£_if_Ãeded
 (
İtiÚs
);

4124  
nİŞl_çl£
;

4127 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_DEBUG
, "Usšg c”tifiÿ‹ key: %s", 
´iv©eKey
);

4128 ià(
	`SSL_CTX_u£_Priv©eKey_fe
 (
cÚn
->
s¦_ùx
, 
´iv©eKey
, 
SSL_FILETYPE_PEM
) != 1) {

4129 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_CRITICAL
,

4131 
´iv©eKey
);

4133 
	`nİŞl_cÚn_shutdown
 (
cÚn
);

4134 
	`nİŞl_ùx_uÄegi¡”_cÚn
 (
ùx
, 
cÚn
);

4137 
	`__nİŞl_cÚn_İts_»Ëa£_if_Ãeded
 (
İtiÚs
);

4139  
nİŞl_çl£
;

4143 ià(! 
	`SSL_CTX_check_´iv©e_key
 (
cÚn
->
s¦_ùx
)) {

4144 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_CRITICAL
,

4146 
û¹ifiÿ‹Fe
, 
´iv©eKey
);

4148 
	`nİŞl_cÚn_shutdown
 (
cÚn
);

4151 
	`__nİŞl_cÚn_İts_»Ëa£_if_Ãeded
 (
İtiÚs
);

4153  
nİŞl_çl£
;

4156 ià(
İtiÚs
 !ğ
NULL
 && ! o±iÚs->
di§bË_s¦_v”ify
) {

4157 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_DEBUG
, "Enabling certificate client…eer verification from server");

4161 
__nİŞl_cÚn_s¦_ùx_debug
 = 
ùx
;

4162 
	`SSL_CTX_£t_v”ify
 (
cÚn
->
s¦_ùx
, 
SSL_VERIFY_PEER
 | 
SSL_VERIFY_FAIL_IF_NO_PEER_CERT
, 
__nİŞl_cÚn_s¦_v”ify_ÿÎback
);

4163 
	`SSL_CTX_£t_v”ify_d•th
 (
cÚn
->
s¦_ùx
, 5);

4168 
cÚn
->
s¦
 = 
	`SSL_Ãw
 (cÚn->
s¦_ùx
);

4169 ià(
cÚn
->
s¦
 =ğ
NULL
) {

4170 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_CRITICAL
, "”rÜ whü—tšg TLS¿n¥Üt, SSL_Ãw (%pè»tuºed NULL", 
cÚn
->
s¦_ùx
);

4171 
	`nİŞl_cÚn_shutdown
 (
cÚn
);

4172 
	`nİŞl_ùx_uÄegi¡”_cÚn
 (
ùx
, 
cÚn
);

4175 
	`__nİŞl_cÚn_İts_»Ëa£_if_Ãeded
 (
İtiÚs
);

4177  
nİŞl_çl£
;

4181 
	`SSL_£t_fd
 (
cÚn
->
s¦
, cÚn->
£ssiÚ
);

4185 
cÚn
->
³ndšg_s¦_acû±
 = 
nİŞl_Œue
;

4186 
	`nİŞl_cÚn_£t_sock_block
 (
cÚn
->
£ssiÚ
, 
nİŞl_çl£
);

4188 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_DEBUG
, "P»·»d TLS sessiÚØbaùiv©ed oÀÃxˆ»ad (cÚÀid %d)", 
cÚn
->
id
);

4193 
	`__nİŞl_cÚn_İts_»Ëa£_if_Ãeded
 (
İtiÚs
);

4195  
nİŞl_Œue
;

4196 
	}
}

4215 
nİŞl_boŞ
 
	$nİŞl_cÚn_acû±_com¶‘e
 (
noPŞlCtx
 * 
ùx
, 
noPŞlCÚn
 * 
li¡’”
,‚oPŞlCÚÀ* 
cÚn
, 
NOPOLL_SOCKET
 
£ssiÚ
, 
nİŞl_boŞ
 
s_Ú
) {

4217 ià(
li¡’”
->
İts
) {

4218 ià(! 
	`nİŞl_cÚn_İts_»f
 (
li¡’”
->
İts
)) {

4219 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_CRITICAL
, "Unableo‡cquire‡„eferenceohe connection option‡t‚opoll_conn_accept_complete() function‚opoll_conn_opts_ref () failed..");

4220  
nİŞl_çl£
;

4224  
	`__nİŞl_cÚn_acû±_com¶‘e_commÚ
 (
ùx
, 
li¡’”
->
İts
,†i¡’”, 
cÚn
, 
£ssiÚ
, 
s_Ú
);

4225 
	}
}

4240 
nİŞl_boŞ
 
	$nİŞl_cÚn_wa™_uÁ_cÚÃùiÚ_»ady
 (
noPŞlCÚn
 * 
cÚn
,

4241 
timeout
)

4243 
tÙ®_timeout
 = 
timeout
 * 1000000;

4247 ! 
	`nİŞl_cÚn_is_»ady
 (
cÚn
è&& 
tÙ®_timeout
 > 0) {

4250 ià(! 
	`nİŞl_cÚn_is_ok
 (
cÚn
))

4251  
nİŞl_çl£
;

4254 
	`nİŞl_¦“p
 (500);

4257 
tÙ®_timeout
 =otal_timeout - 500;

4261  
	`nİŞl_cÚn_is_ok
 (
cÚn
è&& 
	`nİŞl_cÚn_is_»ady
 (conn);

4262 
	}
}

	@nopoll_conn.h

39 #iâdeà
__NOPOLL_CONN_H__


40 
	#__NOPOLL_CONN_H__


	)

42 
	~<nİŞl.h
>

44 
BEGIN_C_DECLS


46 
noPŞlCÚn
 * 
nİŞl_cÚn_Ãw
 (
noPŞlCtx
 * 
ùx
,

47 cÚ¡ * 
ho¡_
,

48 cÚ¡ * 
ho¡_pÜt
,

49 cÚ¡ * 
ho¡_Çme
,

50 cÚ¡ * 
g‘_u¾
,

51 cÚ¡ * 
´ÙocŞs
,

52 cÚ¡ * 
Üigš
);

54 
noPŞlCÚn
 * 
nİŞl_cÚn_Ãw_İts
 (
noPŞlCtx
 * 
ùx
,

55 
noPŞlCÚnO±s
 * 
İts
,

56 cÚ¡ * 
ho¡_
,

57 cÚ¡ * 
ho¡_pÜt
,

58 cÚ¡ * 
ho¡_Çme
,

59 cÚ¡ * 
g‘_u¾
,

60 cÚ¡ * 
´ÙocŞs
,

61 cÚ¡ * 
Üigš
);

63 
noPŞlCÚn
 * 
nİŞl_cÚn_s_Ãw
 (
noPŞlCtx
 * 
ùx
,

64 
noPŞlCÚnO±s
 * 
İtiÚs
,

65 cÚ¡ * 
ho¡_
,

66 cÚ¡ * 
ho¡_pÜt
,

67 cÚ¡ * 
ho¡_Çme
,

68 cÚ¡ * 
g‘_u¾
,

69 cÚ¡ * 
´ÙocŞs
,

70 cÚ¡ * 
Üigš
);

72 
noPŞlCÚn
 * 
nİŞl_cÚn_acû±
 (
noPŞlCtx
 * 
ùx
,‚oPŞlCÚÀ* 
li¡’”
);

74 
noPŞlCÚn
 * 
nİŞl_cÚn_acû±_sock‘
 (
noPŞlCtx
 * 
ùx
,‚oPŞlCÚÀ* 
li¡’”
, 
NOPOLL_SOCKET
 
£ssiÚ
);

76 
nİŞl_boŞ
 
nİŞl_cÚn_acû±_com¶‘e
 (
noPŞlCtx
 * 
ùx
,

77 
noPŞlCÚn
 * 
li¡’”
,

78 
noPŞlCÚn
 * 
cÚn
,

79 
NOPOLL_SOCKET
 
£ssiÚ
,

80 
nİŞl_boŞ
 
s_Ú
);

82 
nİŞl_boŞ
 
nİŞl_cÚn_»f
 (
noPŞlCÚn
 * 
cÚn
);

84 
nİŞl_cÚn_»f_couÁ
 (
noPŞlCÚn
 * 
cÚn
);

86 
nİŞl_cÚn_uÄef
 (
noPŞlCÚn
 * 
cÚn
);

88 
nİŞl_boŞ
 
nİŞl_cÚn_is_ok
 (
noPŞlCÚn
 * 
cÚn
);

90 
nİŞl_boŞ
 
nİŞl_cÚn_is_»ady
 (
noPŞlCÚn
 * 
cÚn
);

92 
nİŞl_boŞ
 
nİŞl_cÚn_is_s_Ú
 (
noPŞlCÚn
 * 
cÚn
);

94 
NOPOLL_SOCKET
 
nİŞl_cÚn_sock‘
 (
noPŞlCÚn
 * 
cÚn
);

96 
nİŞl_cÚn_£t_sock‘
 (
noPŞlCÚn
 * 
cÚn
, 
NOPOLL_SOCKET
 
_sock‘
);

98 
nİŞl_cÚn_g‘_id
 (
noPŞlCÚn
 * 
cÚn
);

100 
noPŞlCtx
 * 
nİŞl_cÚn_ùx
 (
noPŞlCÚn
 * 
cÚn
);

102 
noPŞlRŞe
 
nİŞl_cÚn_rŞe
 (
noPŞlCÚn
 * 
cÚn
);

104 cÚ¡ * 
nİŞl_cÚn_ho¡
 (
noPŞlCÚn
 * 
cÚn
);

106 cÚ¡ * 
nİŞl_cÚn_pÜt
 (
noPŞlCÚn
 * 
cÚn
);

108 cÚ¡ * 
nİŞl_cÚn_g‘_Üigš
 (
noPŞlCÚn
 * 
cÚn
);

110 cÚ¡ * 
nİŞl_cÚn_g‘_ho¡_h—d”
 (
noPŞlCÚn
 * 
cÚn
);

112 cÚ¡ * 
nİŞl_cÚn_g‘_cook›
 (
noPŞlCÚn
 * 
cÚn
);

114 cÚ¡ * 
nİŞl_cÚn_g‘_acû±ed_´ÙocŞ
 (
noPŞlCÚn
 * 
cÚn
);

116 cÚ¡ * 
nİŞl_cÚn_g‘_»que¡ed_´ÙocŞ
 (
noPŞlCÚn
 * 
cÚn
);

118 
nİŞl_cÚn_£t_acû±ed_´ÙocŞ
 (
noPŞlCÚn
 * 
cÚn
, cÚ¡ * 
´ÙocŞ
);

120 
nİŞl_cÚn_g‘_şo£_¡©us
 (
noPŞlCÚn
 * 
cÚn
);

122 cÚ¡ * 
nİŞl_cÚn_g‘_şo£_»asÚ
 (
noPŞlCÚn
 * 
cÚn
);

124 
nİŞl_cÚn_shutdown
 (
noPŞlCÚn
 * 
cÚn
);

126 
nİŞl_cÚn_şo£
 (
noPŞlCÚn
 * 
cÚn
);

128 
nİŞl_cÚn_şo£_ext
 (
noPŞlCÚn
 * 
cÚn
, 
¡©us
, cÚ¡ * 
»asÚ
, 
»asÚ_size
);

130 
nİŞl_cÚn_£t_hook
 (
noPŞlCÚn
 * 
cÚn
, 
noPŞlPŒ
 
±r
);

132 
noPŞlPŒ
 
nİŞl_cÚn_g‘_hook
 (
noPŞlCÚn
 * 
cÚn
);

134 
nİŞl_boŞ
 
nİŞl_cÚn_£t_sock_block
 (
NOPOLL_SOCKET
 
sock‘
,

135 
nİŞl_boŞ
 
’abË
);

137 
noPŞlMsg
 * 
nİŞl_cÚn_g‘_msg
 (
noPŞlCÚn
 * 
cÚn
);

139 
nİŞl_cÚn_£nd_‹xt
 (
noPŞlCÚn
 * 
cÚn
, cÚ¡ * 
cÚ‹Á
, 
Ëngth
);

141 
nİŞl_cÚn_£nd_‹xt_äagm’t
 (
noPŞlCÚn
 * 
cÚn
, cÚ¡ * 
cÚ‹Á
, 
Ëngth
);

143 
nİŞl_cÚn_£nd_bš¬y
 (
noPŞlCÚn
 * 
cÚn
, cÚ¡ * 
cÚ‹Á
, 
Ëngth
);

145 
nİŞl_cÚn_£nd_bš¬y_äagm’t
 (
noPŞlCÚn
 * 
cÚn
, cÚ¡ * 
cÚ‹Á
, 
Ëngth
);

147 
nİŞl_cÚn_com¶‘e_³ndšg_wr™e
 (
noPŞlCÚn
 * 
cÚn
);

149 
nİŞl_cÚn_³ndšg_wr™e_by‹s
 (
noPŞlCÚn
 * 
cÚn
);

151 
nİŞl_cÚn_æush_wr™es
 (
noPŞlCÚn
 * 
cÚn
, 
timeout
, 
´evious_»suÉ
);

153 
nİŞl_cÚn_»ad
 (
noPŞlCÚn
 * 
cÚn
, * 
bufãr
, 
by‹s
, 
nİŞl_boŞ
 
block
, 
timeout
);

155 
noPŞlCÚn
 * 
nİŞl_cÚn_g‘_li¡’”
 (noPŞlCÚÀ* 
cÚn
);

157 
nİŞl_boŞ
 
nİŞl_cÚn_£nd_pšg
 (
noPŞlCÚn
 * 
cÚn
);

159 
nİŞl_boŞ
 
nİŞl_cÚn_£nd_pÚg
 (
noPŞlCÚn
 * 
cÚn
);

161 
nİŞl_cÚn_£t_Ú_msg
 (
noPŞlCÚn
 * 
cÚn
,

162 
noPŞlOnMes§geHªdËr
 
Ú_msg
,

163 
noPŞlPŒ
 
u£r_d©a
);

165 
nİŞl_cÚn_£t_Ú_»ady
 (
noPŞlCÚn
 * 
cÚn
,

166 
noPŞlAùiÚHªdËr
 
Ú_»ady
,

167 
noPŞlPŒ
 
u£r_d©a
);

169 
nİŞl_cÚn_£t_Ú_şo£
 (
noPŞlCÚn
 * 
cÚn
,

170 
noPŞlOnClo£HªdËr
 
Ú_şo£
,

171 
noPŞlPŒ
 
u£r_d©a
);

173 
nİŞl_cÚn_£nd_äame
 (
noPŞlCÚn
 * 
cÚn
, 
nİŞl_boŞ
 
fš
,‚İŞl_boŞ 
masked
,

174 
noPŞlOpCode
 
İ_code
, 
Ëngth
, 
noPŞlPŒ
 
cÚ‹Á
,

175 
¦“p_š_h—d”
);

177 
__nİŞl_cÚn_£nd_commÚ
 (
noPŞlCÚn
 * 
cÚn
,

178 cÚ¡ * 
cÚ‹Á
,

179 
Ëngth
,

180 
nİŞl_boŞ
 
has_fš
,

181 
¦“p_š_h—d”
,

182 
noPŞlOpCode
 
äame_ty³
);

184 
nİŞl_boŞ
 
nİŞl_cÚn_wa™_uÁ_cÚÃùiÚ_»ady
 (
noPŞlCÚn
 * 
cÚn
,

185 
timeout
);

187 
nİŞl_cÚn_cÚÃù_timeout
 (
noPŞlCtx
 * 
ùx
,

188 
miüo£cÚds_to_wa™
);

190 
nİŞl_cÚn_g‘_cÚÃù_timeout
 (
noPŞlCtx
 * 
ùx
);

193 
nİŞl_cÚn_com¶‘e_hªdshake
 (
noPŞlCÚn
 * 
cÚn
);

195 
nİŞl_cÚn_deçuÉ_»ûive
 (
noPŞlCÚn
 * 
cÚn
, * 
bufãr
, 
bufãr_size
);

197 
nİŞl_cÚn_deçuÉ_£nd
 (
noPŞlCÚn
 * 
cÚn
, * 
bufãr
, 
bufãr_size
);

199 
nİŞl_cÚn_mask_cÚ‹Á
 (
noPŞlCtx
 * 
ùx
, * 
·ylßd
, 
·ylßd_size
, * 
mask
, 
de¥
);

201 
	gEND_C_DECLS


	@nopoll_conn_opts.c

39 
	~<nİŞl_cÚn_İts.h
>

40 
	~<nİŞl_´iv©e.h
>

56 
noPŞlCÚnO±s
 * 
	$nİŞl_cÚn_İts_Ãw
 ()

58 
noPŞlCÚnO±s
 * 
»suÉ
;

61 
»suÉ
 = 
	`nİŞl_Ãw
 (
noPŞlCÚnO±s
, 1);

62 ià(! 
»suÉ
)

63  
NULL
;

65 
»suÉ
->
»u£
 = 
nİŞl_çl£
;

66 
»suÉ
->
s¦_´ÙocŞ
 = 
NOPOLL_METHOD_TLSV1
;

68 
»suÉ
->
mu‹x
 = 
	`nİŞl_mu‹x_ü—‹
 ();

69 
»suÉ
->
»fs
 = 1;

72 
»suÉ
->
di§bË_s¦_v”ify
 = 
nİŞl_Œue
;

74  
»suÉ
;

75 
	}
}

85 
	$nİŞl_cÚn_İts_£t_s¦_´ÙocŞ
 (
noPŞlCÚnO±s
 * 
İts
, 
noPŞlS¦PrÙocŞ
 
s¦_´ÙocŞ
)

87 ià(
İts
 =ğ
NULL
)

89 
İts
->
s¦_´ÙocŞ
 = ssl_protocol;

91 
	}
}

114 
nİŞl_boŞ
 
	$nİŞl_cÚn_İts_£t_s¦_û¹s
 (
noPŞlCÚnO±s
 * 
İts
,

115 cÚ¡ * 
û¹ifiÿ‹
,

116 cÚ¡ * 
´iv©e_key
,

117 cÚ¡ * 
chaš_û¹ifiÿ‹
,

118 cÚ¡ * 
ÿ_û¹ifiÿ‹
)

120 ià(
İts
 =ğ
NULL
)

121  
nİŞl_çl£
;

124 
İts
->
û¹ifiÿ‹
 = 
	`nİŞl_¡rdup
 (certificate);

125 ià(
İts
->
û¹ifiÿ‹
)

126 ià(
	`acûss
 (
İts
->
û¹ifiÿ‹
, 
R_OK
) != 0)

127  
nİŞl_çl£
;

128 
İts
->
´iv©e_key
 = 
	`nİŞl_¡rdup
 (private_key);

129 ià(
İts
->
´iv©e_key
)

130 ià(
	`acûss
 (
İts
->
´iv©e_key
, 
R_OK
) != 0)

131  
nİŞl_çl£
;

132 
İts
->
chaš_û¹ifiÿ‹
 = 
	`nİŞl_¡rdup
 (chain_certificate);

133 ià(
İts
->
chaš_û¹ifiÿ‹
)

134 ià(
	`acûss
 (
İts
->
chaš_û¹ifiÿ‹
, 
R_OK
) != 0)

135  
nİŞl_çl£
;

136 
İts
->
ÿ_û¹ifiÿ‹
 = 
	`nİŞl_¡rdup
 (ca_certificate);

137 ià(
İts
->
ÿ_û¹ifiÿ‹
)

138 ià(
	`acûss
 (
İts
->
ÿ_û¹ifiÿ‹
, 
R_OK
) != 0)

139  
nİŞl_çl£
;

141  
nİŞl_Œue
;

142 
	}
}

164 
	$nİŞl_cÚn_İts_s¦_³”_v”ify
 (
noPŞlCÚnO±s
 * 
İts
, 
nİŞl_boŞ
 
v”ify
)

166 ià(
İts
 =ğ
NULL
)

168 
İts
->
di§bË_s¦_v”ify
 = ! 
v”ify
;

170 
	}
}

182 
	$nİŞl_cÚn_İts_£t_cook›
 (
noPŞlCÚnO±s
 * 
İts
, cÚ¡ * 
cook›_cÚ‹Á
)

184 ià(
İts
 =ğ
NULL
)

187 ià(
cook›_cÚ‹Á
) {

189 
İts
->
cook›
 = 
	`nİŞl_¡rdup
 (
cook›_cÚ‹Á
);

191 
	`nİŞl_ä“
 (
İts
->
cook›
);

192 
İts
->
cook›
 = 
NULL
;

196 
	}
}

214 
	$nİŞl_cÚn_İts_sk_Üigš_check
 (
noPŞlCÚnO±s
 * 
İts
, 
nİŞl_boŞ
 
sk_check
)

217 ià(
İts
)

218 
İts
->
sk_Üigš_h—d”_check
 = 
sk_check
;

221 
	}
}

234 
nİŞl_boŞ
 
	$nİŞl_cÚn_İts_»f
 (
noPŞlCÚnO±s
 * 
İts
)

236 ià(
İts
 =ğ
NULL
)

237  
nİŞl_çl£
;

240 
	`nİŞl_mu‹x_lock
 (
İts
->
mu‹x
);

241 ià(
İts
->
»fs
 <= 0) {

243 
	`nİŞl_mu‹x_uÆock
 (
İts
->
mu‹x
);

244  
nİŞl_çl£
;

247 
İts
->
»fs
++;

250 
	`nİŞl_mu‹x_uÆock
 (
İts
->
mu‹x
);

252  
nİŞl_Œue
;

253 
	}
}

260 
	$nİŞl_cÚn_İts_uÄef
 (
noPŞlCÚnO±s
 * 
İts
)

263 
	`nİŞl_cÚn_İts_ä“
 (
İts
);

265 
	}
}

282 
	$nİŞl_cÚn_İts_£t_»u£
 (
noPŞlCÚnO±s
 * 
İts
, 
nİŞl_boŞ
 
»u£
)

284 ià(
İts
 =ğ
NULL
)

286 
İts
->
»u£
 =„euse;

288 
	}
}

299 
	$nİŞl_cÚn_İts_£t_š‹rçû
 (
noPŞlCÚnO±s
 * 
İts
, cÚ¡ * 
š‹rçû
)

301 ià(
İts
 =ğ
NULL
)

304 ià(
š‹rçû
) {

306 
İts
->
š‹rçû
 = 
	`nİŞl_¡rdup
 (interface);

308 
	`nİŞl_ä“
 (
İts
->
š‹rçû
);

309 
İts
->
š‹rçû
 = 
NULL
;

313 
	}
}

315 
	$__nİŞl_cÚn_İts_ä“_commÚ
 (
noPŞlCÚnO±s
 * 
İts
)

317 ià(
İts
 =ğ
NULL
)

321 
	`nİŞl_mu‹x_lock
 (
İts
->
mu‹x
);

323 
İts
->
»fs
--;

324 ià(
İts
->
»fs
 != 0) {

326 
	`nİŞl_mu‹x_uÆock
 (
İts
->
mu‹x
);

330 
	`nİŞl_mu‹x_uÆock
 (
İts
->
mu‹x
);

332 
	`nİŞl_ä“
 (
İts
->
û¹ifiÿ‹
);

333 
	`nİŞl_ä“
 (
İts
->
´iv©e_key
);

334 
	`nİŞl_ä“
 (
İts
->
chaš_û¹ifiÿ‹
);

335 
	`nİŞl_ä“
 (
İts
->
ÿ_û¹ifiÿ‹
);

338 
	`nİŞl_ä“
 (
İts
->
cook›
);

341 
	`nİŞl_ä“
 (
İts
->
š‹rçû
);

344 
	`nİŞl_mu‹x_de¡roy
 (
İts
->
mu‹x
);

345 
	`nİŞl_ä“
 (
İts
);

347 
	}
}

358 
	$nİŞl_cÚn_İts_ä“
 (
noPŞlCÚnO±s
 * 
İts
)

360 
	`__nİŞl_cÚn_İts_ä“_commÚ
 (
İts
);

362 
	}
}

368 
	$__nİŞl_cÚn_İts_»Ëa£_if_Ãeded
 (
noPŞlCÚnO±s
 * 
İtiÚs
)

370 ià(! 
İtiÚs
)

372 ià(
İtiÚs
 && o±iÚs->
»u£
)

374 
	`__nİŞl_cÚn_İts_ä“_commÚ
 (
İtiÚs
);

376 
	}
}

	@nopoll_conn_opts.h

39 #iâdeà
__NOPOLL_CONN_OPTS_H__


40 
	#__NOPOLL_CONN_OPTS_H__


	)

42 
	~<nİŞl.h
>

44 
BEGIN_C_DECLS


46 
noPŞlCÚnO±s
 * 
nİŞl_cÚn_İts_Ãw
 ();

48 
nİŞl_cÚn_İts_£t_s¦_´ÙocŞ
 (
noPŞlCÚnO±s
 * 
İts
, 
noPŞlS¦PrÙocŞ
 
s¦_´ÙocŞ
);

50 
nİŞl_boŞ
 
nİŞl_cÚn_İts_£t_s¦_û¹s
 (
noPŞlCÚnO±s
 * 
İts
,

51 cÚ¡ * 
ş›Á_û¹ifiÿ‹
,

52 cÚ¡ * 
´iv©e_key
,

53 cÚ¡ * 
chaš_û¹ifiÿ‹
,

54 cÚ¡ * 
ÿ_û¹ifiÿ‹
);

56 
nİŞl_cÚn_İts_s¦_³”_v”ify
 (
noPŞlCÚnO±s
 * 
İts
, 
nİŞl_boŞ
 
v”ify
);

58 
nİŞl_cÚn_İts_£t_cook›
 (
noPŞlCÚnO±s
 * 
İts
, cÚ¡ * 
cook›_cÚ‹Á
);

60 
nİŞl_cÚn_İts_sk_Üigš_check
 (
noPŞlCÚnO±s
 * 
İts
, 
nİŞl_boŞ
 
sk_check
);

62 
nİŞl_boŞ
 
nİŞl_cÚn_İts_»f
 (
noPŞlCÚnO±s
 * 
İts
);

64 
nİŞl_cÚn_İts_uÄef
 (
noPŞlCÚnO±s
 * 
İts
);

66 
nİŞl_cÚn_İts_£t_»u£
 (
noPŞlCÚnO±s
 * 
İts
, 
nİŞl_boŞ
 
»u£
);

68 
nİŞl_cÚn_İts_£t_š‹rçû
 (
noPŞlCÚnO±s
 * 
İts
, cÚ¡ * 
š‹rçû
);

70 
nİŞl_cÚn_İts_ä“
 (
noPŞlCÚnO±s
 * 
İts
);

73 
__nİŞl_cÚn_İts_»Ëa£_if_Ãeded
 (
noPŞlCÚnO±s
 * 
İtiÚs
);

75 
	gEND_C_DECLS


	@nopoll_ctx.c

39 
	~<nİŞl_ùx.h
>

40 
	~<nİŞl_´iv©e.h
>

41 
	~<sigÇl.h
>

51 
	$__nİŞl_ùx_sigpe_do_nÙhšg
 (
_sigÇl
)

53 #ià!
	`defšed
(
NOPOLL_OS_WIN32
)

60 
	`sigÇl
 (
SIGPIPE
, 
__nİŞl_ùx_sigpe_do_nÙhšg
);

63 
	}
}

69 
noPŞlCtx
 * 
	$nİŞl_ùx_Ãw
 () {

70 
noPŞlCtx
 * 
»suÉ
 = 
	`nİŞl_Ãw
 (noPollCtx, 1);

71 ià(
»suÉ
 =ğ
NULL
)

72  
NULL
;

74 #ià
	`defšed
(
NOPOLL_OS_WIN32
)

75 ià(! 
	`nİŞl_wš32_š™
 (
»suÉ
))

76  
NULL
;

80 
»suÉ
->
cÚn_id
 = 1;

81 
»suÉ
->
»fs
 = 1;

82 
»suÉ
->
cÚn_id
 = 1;

85 
»suÉ
->
cÚn_cÚÃù_¡d_timeout
 = 20000000;

88 
»suÉ
->
nÙ_execu‹d
 = 
nİŞl_Œue
;

89 
»suÉ
->
debug_’abËd
 = 
nİŞl_çl£
;

92 
»suÉ
->
nÙ_execu‹d_cŞÜ
 = 
nİŞl_Œue
;

93 
»suÉ
->
debug_cŞÜ_’abËd
 = 
nİŞl_çl£
;

96 
»suÉ
->
backlog
 = 5;

99 
»suÉ
->
cÚn_Ëngth
 = 0;

101 #ià!
	`defšed
(
NOPOLL_OS_WIN32
)

103 
	`sigÇl
 (
SIGPIPE
, 
__nİŞl_ùx_sigpe_do_nÙhšg
);

107 
»suÉ
->
´ÙocŞ_v”siÚ
 = 13;

110 
»suÉ
->
»f_mu‹x
 = 
	`nİŞl_mu‹x_ü—‹
 ();

112  
»suÉ
;

113 
	}
}

124 
nİŞl_boŞ
 
	$nİŞl_ùx_»f
 (
noPŞlCtx
 * 
ùx
)

127 
	`nİŞl_»tuº_v®_if_ç
 (
ùx
, ctx, 
nİŞl_çl£
);

130 
	`nİŞl_mu‹x_lock
 (
ùx
->
»f_mu‹x
);

132 
ùx
->
»fs
++;

135 
	`nİŞl_mu‹x_uÆock
 (
ùx
->
»f_mu‹x
);

137  
nİŞl_Œue
;

138 
	}
}

147 
	$nİŞl_ùx_uÄef
 (
noPŞlCtx
 * 
ùx
)

149 
noPŞlC”tifiÿ‹
 * 
û¹
;

150 
™”©Ü
;

152 
	`nİŞl_»tuº_if_ç
 (
ùx
, ctx);

155 
	`nİŞl_mu‹x_lock
 (
ùx
->
»f_mu‹x
);

157 
ùx
->
»fs
--;

158 ià(
ùx
->
»fs
 != 0) {

160 
	`nİŞl_mu‹x_uÆock
 (
ùx
->
»f_mu‹x
);

164 
	`nİŞl_mu‹x_uÆock
 (
ùx
->
»f_mu‹x
);

166 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_DEBUG
, "R–—sšg‚ØpŞÈcÚ‹xˆ%°(%d, cÚns: %d)", ctx, ctx->
»fs
, ctx->
cÚn_Ëngth
);

168 
™”©Ü
 = 0;

169 
™”©Ü
 < 
ùx
->
û¹ifiÿ‹s_Ëngth
) {

171 
û¹
 = &(
ùx
->
û¹ifiÿ‹s
[
™”©Ü
]);

174 
	`nİŞl_ä“
 (
û¹
->
£rv”Name
);

175 
	`nİŞl_ä“
 (
û¹
->
û¹ifiÿ‹Fe
);

176 
	`nİŞl_ä“
 (
û¹
->
´iv©eKey
);

177 
	`nİŞl_ä“
 (
û¹
->
İtiÚ®ChašFe
);

180 
™”©Ü
++;

184 
	`nİŞl_mu‹x_de¡roy
 (
ùx
->
»f_mu‹x
);

187 
	`nİŞl_ä“
 (
ùx
->
û¹ifiÿ‹s
);

190 
	`nİŞl_ä“
 (
ùx
->
cÚn_li¡
);

191 
ùx
->
cÚn_Ëngth
 = 0;

192 
	`nİŞl_ä“
 (
ùx
);

194 
	}
}

204 
	$nİŞl_ùx_»f_couÁ
 (
noPŞlCtx
 * 
ùx
)

206 
»suÉ
;

207 ià(! 
ùx
)

211 
	`nİŞl_mu‹x_lock
 (
ùx
->
»f_mu‹x
);

213 
»suÉ
 = 
ùx
->
»fs
;

216 
	`nİŞl_mu‹x_uÆock
 (
ùx
->
»f_mu‹x
);

218  
»suÉ
;

219 
	}
}

232 
nİŞl_boŞ
 
	$nİŞl_ùx_»gi¡”_cÚn
 (
noPŞlCtx
 * 
ùx
,

233 
noPŞlCÚn
 * 
cÚn
)

235 
™”©Ü
;

237 
	`nİŞl_»tuº_v®_if_ç
 (
ùx
, ctx && 
cÚn
, 
nİŞl_çl£
);

240 
	`nİŞl_mu‹x_lock
 (
ùx
->
»f_mu‹x
);

243 
cÚn
->
id
 = 
ùx
->
cÚn_id
;

244 
ùx
->
cÚn_id
 ++;

247 
™”©Ü
 = 0;

248 
™”©Ü
 < 
ùx
->
cÚn_Ëngth
) {

251 ià(
ùx
->
cÚn_li¡
[
™”©Ü
] == 0) {

252 
ùx
->
cÚn_li¡
[
™”©Ü
] = 
cÚn
;

255 
ùx
->
cÚn_num
++;

257 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_DEBUG
, "»gi¡”ed cÚÃùiÚ id %d,„Şe: %d", 
cÚn
->
id
, cÚn->
rŞe
);

260 
	`nİŞl_mu‹x_uÆock
 (
ùx
->
»f_mu‹x
);

263 
	`nİŞl_ùx_»f
 (
ùx
);

266 
	`nİŞl_cÚn_»f
 (
cÚn
);

269  
nİŞl_Œue
;

272 
™”©Ü
++;

277 
ùx
->
cÚn_Ëngth
 += 10;

278 
ùx
->
cÚn_li¡
 = (
noPŞlCÚn
**è
	`nİŞl_»®loc
 (ùx->cÚn_li¡,  (noPŞlCÚÀ*è* (ùx->
cÚn_Ëngth
));

279 ià(
ùx
->
cÚn_li¡
 =ğ
NULL
) {

281 
	`nİŞl_mu‹x_uÆock
 (
ùx
->
»f_mu‹x
);

283 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_CRITICAL
, "General connection„egistrationƒrror, memory‡cquisition failed..");

284  
nİŞl_çl£
;

288 
™”©Ü
 = (
ùx
->
cÚn_Ëngth
 - 10);

289 
™”©Ü
 < 
ùx
->
cÚn_Ëngth
) {

290 
ùx
->
cÚn_li¡
[
™”©Ü
] = 0;

292 
™”©Ü
++;

296 
	`nİŞl_mu‹x_uÆock
 (
ùx
->
»f_mu‹x
);

299  
	`nİŞl_ùx_»gi¡”_cÚn
 (
ùx
, 
cÚn
);

300 
	}
}

310 
	$nİŞl_ùx_uÄegi¡”_cÚn
 (
noPŞlCtx
 * 
ùx
,

311 
noPŞlCÚn
 * 
cÚn
)

313 
™”©Ü
;

315 
	`nİŞl_»tuº_if_ç
 (
ùx
, ctx && 
cÚn
);

318 
	`nİŞl_mu‹x_lock
 (
ùx
->
»f_mu‹x
);

321 
™”©Ü
 = 0;

322 
™”©Ü
 < 
ùx
->
cÚn_Ëngth
) {

325 ià(
ùx
->
cÚn_li¡
 && ctx->cÚn_li¡[
™”©Ü
] && ctx->cÚn_li¡[™”©Ü]->
id
 =ğ
cÚn
->id) {

327 
ùx
->
cÚn_li¡
[
™”©Ü
] = 
NULL
;

330 
ùx
->
cÚn_num
--;

333 
	`nİŞl_mu‹x_uÆock
 (
ùx
->
»f_mu‹x
);

336 
	`nİŞl_cÚn_uÄef
 (
cÚn
);

341 
™”©Ü
++;

345 
	`nİŞl_mu‹x_uÆock
 (
ùx
->
»f_mu‹x
);

348 
	}
}

357 
	$nİŞl_ùx_cÚns
 (
noPŞlCtx
 * 
ùx
)

359 
	`nİŞl_»tuº_v®_if_ç
 (
ùx
, ctx, -1);

360  
ùx
->
cÚn_num
;

361 
	}
}

384 
nİŞl_boŞ
 
	$nİŞl_ùx_fšd_û¹ifiÿ‹
 (
noPŞlCtx
 * 
ùx
,

385 cÚ¡ * 
£rv”Name
,

386 cÚ¡ ** 
û¹ifiÿ‹Fe
,

387 cÚ¡ ** 
´iv©eKey
,

388 cÚ¡ ** 
İtiÚ®ChašFe
)

390 
noPŞlC”tifiÿ‹
 * 
û¹
;

392 
™”©Ü
 = 0;

393 
	`nİŞl_»tuº_v®_if_ç
 (
ùx
, ctx, 
nİŞl_çl£
);

395 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_DEBUG
, "Fšdšg‡ c”tifiÿ‹ fÜ s”v”Name=%s", 
£rv”Name
 ? serverName : "<not defined>");

397 
™”©Ü
 < 
ùx
->
û¹ifiÿ‹s_Ëngth
) {

399 
û¹
 = &(
ùx
->
û¹ifiÿ‹s
[
™”©Ü
]);

400 ià(
û¹
) {

402 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_DEBUG
, " c”tifiÿ‹ stÜed‡ssocŸ‹dØ£rv”Name=%s", 
û¹
->
£rv”Name
 ? cert->serverName : "<not defined>");

403 ià((
£rv”Name
 =ğ
NULL
 && 
û¹
->serverName == NULL) ||

404 (
	`nİŞl_cmp
 (
£rv”Name
, 
û¹
->serverName))) {

405 ià(
û¹ifiÿ‹Fe
)

406 (*
û¹ifiÿ‹Fe
èğ
û¹
->certificateFile;

407 ià(
´iv©eKey
)

408 (*
´iv©eKey
èğ
û¹
->privateKey;

409 ià(
İtiÚ®ChašFe
)

410 (*
İtiÚ®ChašFe
èğ
û¹
->optionalChainFile;

411  
nİŞl_Œue
;

416 
™”©Ü
++;

420 ià(
£rv”Name
 =ğ
NULL
) {

422 
™”©Ü
 = 0;

423 
™”©Ü
 < 
ùx
->
û¹ifiÿ‹s_Ëngth
) {

425 
û¹
 = &(
ùx
->
û¹ifiÿ‹s
[
™”©Ü
]);

426 ià(
û¹
) {

428 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_DEBUG
, " serverName‚ot defined, selecting first certificate fromhe†ist");

429 ià(
û¹ifiÿ‹Fe
)

430 (*
û¹ifiÿ‹Fe
èğ
û¹
->certificateFile;

431 ià(
´iv©eKey
)

432 (*
´iv©eKey
èğ
û¹
->privateKey;

433 ià(
İtiÚ®ChašFe
)

434 (*
İtiÚ®ChašFe
èğ
û¹
->optionalChainFile;

435  
nİŞl_Œue
;

440 
™”©Ü
++;

443  
nİŞl_çl£
;

444 
	}
}

468 
nİŞl_boŞ
 
	$nİŞl_ùx_£t_û¹ifiÿ‹
 (
noPŞlCtx
 * 
ùx
,

469 cÚ¡ * 
£rv”Name
,

470 cÚ¡ * 
û¹ifiÿ‹Fe
,

471 cÚ¡ * 
´iv©eKey
,

472 cÚ¡ * 
İtiÚ®ChašFe
)

474 
Ëngth
;

475 
noPŞlC”tifiÿ‹
 * 
û¹
;

478 
	`nİŞl_»tuº_v®_if_ç
 (
ùx
, ctx && 
û¹ifiÿ‹Fe
 && 
´iv©eKey
, 
nİŞl_çl£
);

481 ià(
	`nİŞl_ùx_fšd_û¹ifiÿ‹
 (
ùx
, 
£rv”Name
, 
NULL
, NULL, NULL))

482  
nİŞl_Œue
;

485 
ùx
->
û¹ifiÿ‹s_Ëngth
++;

486 
Ëngth
 = 
ùx
->
û¹ifiÿ‹s_Ëngth
;

487 ià(
Ëngth
 == 1)

488 
ùx
->
û¹ifiÿ‹s
 = 
	`nİŞl_Ãw
 (
noPŞlC”tifiÿ‹
, 1);

490 
ùx
->
û¹ifiÿ‹s
 = (
noPŞlC”tifiÿ‹
 *è
	`nİŞl_»®loc
 (ùx->û¹ifiÿ‹s,  (noPŞlC”tifiÿ‹è* (
Ëngth
));

493 
û¹
 = &(
ùx
->
û¹ifiÿ‹s
[
Ëngth
 - 1]);

495 
û¹
->
£rv”Name
 = 
NULL
;

496 ià(
£rv”Name
)

497 
û¹
->
£rv”Name
 = 
	`nİŞl_¡rdup
 (serverName);

499 
û¹
->
û¹ifiÿ‹Fe
 = 
NULL
;

500 ià(
û¹ifiÿ‹Fe
)

501 
û¹
->
û¹ifiÿ‹Fe
 = 
	`nİŞl_¡rdup
 (certificateFile);

503 
û¹
->
´iv©eKey
 = 
NULL
;

504 ià(
´iv©eKey
)

505 
û¹
->
´iv©eKey
 = 
	`nİŞl_¡rdup
 (privateKey);

507 
û¹
->
İtiÚ®ChašFe
 = 
NULL
;

508 ià(
İtiÚ®ChašFe
)

509 
û¹
->
İtiÚ®ChašFe
 = 
	`nİŞl_¡rdup
 (optionalChainFile);

511  
nİŞl_Œue
;

512 
	}
}

542 
	$nİŞl_ùx_£t_Ú_İ’
 (
noPŞlCtx
 * 
ùx
,

543 
noPŞlAùiÚHªdËr
 
Ú_İ’
,

544 
noPŞlPŒ
 
u£r_d©a
)

546 
	`nİŞl_»tuº_if_ç
 (
ùx
, ctx && 
Ú_İ’
);

549 
ùx
->
Ú_İ’
 = on_open;

550 ià(
ùx
->
Ú_İ’
 =ğ
NULL
)

551 
ùx
->
Ú_İ’_d©a
 = 
NULL
;

553 
ùx
->
Ú_İ’_d©a
 = 
u£r_d©a
;

555 
	}
}

580 
	$nİŞl_ùx_£t_Ú_»ady
 (
noPŞlCtx
 * 
ùx
,

581 
noPŞlAùiÚHªdËr
 
Ú_»ady
,

582 
noPŞlPŒ
 
u£r_d©a
)

584 
	`nİŞl_»tuº_if_ç
 (
ùx
, ctx && 
Ú_»ady
);

587 
ùx
->
Ú_»ady
 = on_ready;

588 ià(
ùx
->
Ú_»ady
 =ğ
NULL
)

589 
ùx
->
Ú_»ady_d©a
 = 
NULL
;

591 
ùx
->
Ú_»ady_d©a
 = 
u£r_d©a
;

593 
	}
}

609 
	$nİŞl_ùx_£t_Ú_acû±
 (
noPŞlCtx
 * 
ùx
,

610 
noPŞlAùiÚHªdËr
 
Ú_acû±
,

611 
noPŞlPŒ
 
u£r_d©a
)

613 
	`nİŞl_»tuº_if_ç
 (
ùx
, ctx && 
Ú_acû±
);

616 
ùx
->
Ú_acû±
 = on_accept;

617 ià(
ùx
->
Ú_acû±
 =ğ
NULL
)

618 
ùx
->
Ú_acû±_d©a
 = 
NULL
;

620 
ùx
->
Ú_acû±_d©a
 = 
u£r_d©a
;

622 
	}
}

640 
	$nİŞl_ùx_£t_Ú_msg
 (
noPŞlCtx
 * 
ùx
,

641 
noPŞlOnMes§geHªdËr
 
Ú_msg
,

642 
noPŞlPŒ
 
u£r_d©a
)

644 
	`nİŞl_»tuº_if_ç
 (
ùx
, ctx);

647 
ùx
->
Ú_msg
 = on_msg;

648 
ùx
->
Ú_msg_d©a
 = 
u£r_d©a
;

651 
	}
}

668 
	$nİŞl_ùx_£t_s¦_cÚ‹xt_ü—tÜ
 (
noPŞlCtx
 * 
ùx
,

669 
noPŞlS¦CÚ‹xtC»©Ü
 
cÚ‹xt_ü—tÜ
,

670 
noPŞlPŒ
 
u£r_d©a
)

672 ià(
ùx
 =ğ
NULL
)

676 
ùx
->
cÚ‹xt_ü—tÜ
 = context_creator;

677 
ùx
->
cÚ‹xt_ü—tÜ_d©a
 = 
u£r_d©a
;

679 
	}
}

696 
	$nİŞl_ùx_£t_po¡_s¦_check
 (
noPŞlCtx
 * 
ùx
,

697 
noPŞlS¦Po¡Check
 
po¡_s¦_check
,

698 
noPŞlPŒ
 
u£r_d©a
)

700 ià(
ùx
 =ğ
NULL
)

704 
ùx
->
po¡_s¦_check
 =…ost_ssl_check;

705 
ùx
->
po¡_s¦_check_d©a
 = 
u£r_d©a
;

707 
	}
}

731 
noPŞlCÚn
 * 
	$nİŞl_ùx_fÜ—ch_cÚn
 (
noPŞlCtx
 * 
ùx
,

732 
noPŞlFÜ—chCÚn
 
fÜ—ch
,

733 
noPŞlPŒ
 
u£r_d©a
)

735 
noPŞlCÚn
 * 
»suÉ
;

736 
™”©Ü
;

737 
	`nİŞl_»tuº_v®_if_ç
 (
ùx
, ctx && 
fÜ—ch
, 
NULL
);

740 
	`nİŞl_mu‹x_lock
 (
ùx
->
»f_mu‹x
);

745 
™”©Ü
 = 0;

746 
™”©Ü
 < 
ùx
->
cÚn_Ëngth
) {

749 ià(
ùx
->
cÚn_li¡
[
™”©Ü
]) {

751 ià(
	`fÜ—ch
 (
ùx
, ctx->
cÚn_li¡
[
™”©Ü
], 
u£r_d©a
)) {

754 
»suÉ
 = 
ùx
->
cÚn_li¡
[
™”©Ü
];

757 
	`nİŞl_mu‹x_uÆock
 (
ùx
->
»f_mu‹x
);

760  
»suÉ
;

764 
™”©Ü
++;

768 
	`nİŞl_mu‹x_uÆock
 (
ùx
->
»f_mu‹x
);

770  
NULL
;

771 
	}
}

791 
	$nİŞl_ùx_£t_´ÙocŞ_v”siÚ
 (
noPŞlCtx
 * 
ùx
, 
v”siÚ
)

794 
	`nİŞl_»tuº_if_ç
 (
ùx
, ctx || 
v”siÚ
);

797 
ùx
->
´ÙocŞ_v”siÚ
 = 
v”siÚ
;

800 
	}
}

	@nopoll_ctx.h

39 #iâdeà
__NOPOLL_CTX_H__


40 
	#__NOPOLL_CTX_H__


	)

42 
	~<nİŞl.h
>

44 
BEGIN_C_DECLS


46 
noPŞlCtx
 * 
nİŞl_ùx_Ãw
 ();

48 
nİŞl_boŞ
 
nİŞl_ùx_»f
 (
noPŞlCtx
 * 
ùx
);

50 
nİŞl_ùx_uÄef
 (
noPŞlCtx
 * 
ùx
);

52 
nİŞl_ùx_»f_couÁ
 (
noPŞlCtx
 * 
ùx
);

54 
nİŞl_boŞ
 
nİŞl_ùx_»gi¡”_cÚn
 (
noPŞlCtx
 * 
ùx
,

55 
noPŞlCÚn
 * 
cÚn
);

57 
nİŞl_ùx_uÄegi¡”_cÚn
 (
noPŞlCtx
 * 
ùx
,

58 
noPŞlCÚn
 * 
cÚn
);

60 
nİŞl_ùx_cÚns
 (
noPŞlCtx
 * 
ùx
);

62 
nİŞl_boŞ
 
nİŞl_ùx_£t_û¹ifiÿ‹
 (
noPŞlCtx
 * 
ùx
,

63 cÚ¡ * 
£rv”Name
,

64 cÚ¡ * 
û¹ifiÿ‹Fe
,

65 cÚ¡ * 
´iv©eKey
,

66 cÚ¡ * 
İtiÚ®ChašFe
);

68 
nİŞl_boŞ
 
nİŞl_ùx_fšd_û¹ifiÿ‹
 (
noPŞlCtx
 * 
ùx
,

69 cÚ¡ * 
£rv”Name
,

70 cÚ¡ ** 
û¹ifiÿ‹Fe
,

71 cÚ¡ ** 
´iv©eKey
,

72 cÚ¡ ** 
İtiÚ®ChašFe
);

74 
nİŞl_ùx_£t_Ú_acû±
 (
noPŞlCtx
 * 
ùx
,

75 
noPŞlAùiÚHªdËr
 
Ú_acû±
,

76 
noPŞlPŒ
 
u£r_d©a
);

78 
nİŞl_ùx_£t_Ú_İ’
 (
noPŞlCtx
 * 
ùx
,

79 
noPŞlAùiÚHªdËr
 
Ú_İ’
,

80 
noPŞlPŒ
 
u£r_d©a
);

82 
nİŞl_ùx_£t_Ú_»ady
 (
noPŞlCtx
 * 
ùx
,

83 
noPŞlAùiÚHªdËr
 
Ú_»ady
,

84 
noPŞlPŒ
 
u£r_d©a
);

86 
nİŞl_ùx_£t_Ú_msg
 (
noPŞlCtx
 * 
ùx
,

87 
noPŞlOnMes§geHªdËr
 
Ú_msg
,

88 
noPŞlPŒ
 
u£r_d©a
);

90 
nİŞl_ùx_£t_s¦_cÚ‹xt_ü—tÜ
 (
noPŞlCtx
 * 
ùx
,

91 
noPŞlS¦CÚ‹xtC»©Ü
 
cÚ‹xt_ü—tÜ
,

92 
noPŞlPŒ
 
u£r_d©a
);

94 
nİŞl_ùx_£t_po¡_s¦_check
 (
noPŞlCtx
 * 
ùx
,

95 
noPŞlS¦Po¡Check
 
po¡_s¦_check
,

96 
noPŞlPŒ
 
u£r_d©a
);

98 
noPŞlCÚn
 * 
nİŞl_ùx_fÜ—ch_cÚn
 (
noPŞlCtx
 * 
ùx
, 
noPŞlFÜ—chCÚn
 
fÜ—ch
, 
noPŞlPŒ
 
u£r_d©a
);

100 
nİŞl_ùx_£t_´ÙocŞ_v”siÚ
 (
noPŞlCtx
 * 
ùx
, 
v”siÚ
);

102 
nİŞl_ùx_ä“
 (
noPŞlCtx
 * 
ùx
);

104 
	gEND_C_DECLS


	@nopoll_decl.c

39 
	~<nİŞl_deş.h
>

55 
noPŞlPŒ
 
	$nİŞl_ÿÎoc
(
size_t
 
couÁ
, size_ˆ
size
)

57  
	`ÿÎoc
 (
couÁ
, 
size
);

58 
	}
}

69 
noPŞlPŒ
 
	$nİŞl_»®loc
(
noPŞlPŒ
 
»f
, 
size_t
 
size
)

71  
	`»®loc
 (
»f
, 
size
);

72 
	}
}

80 
	$nİŞl_ä“
 (
noPŞlPŒ
 
»f
)

82 
	`ä“
 (
»f
);

84 
	}
}

	@nopoll_decl.h

39 #iâdeà
__NOPOLL_DECL_H__


40 
	#__NOPOLL_DECL_H__


	)

52 
	~<nİŞl_cÚfig.h
>

55 #ià
defšed
(
__GNUC__
)

56 #iâdeà
_GNU_SOURCE


57 
	#_GNU_SOURCE


	)

59 
	#__NOPOLL_PRETTY_FUNCTION__
 
__PRETTY_FUNCTION__


	)

60 
	#__NOPOLL_LINE__
 
__LINE__


	)

61 
	#__NOPOLL_FILE__
 
__FILE__


	)

62 #–ià
defšed
(
_MSC_VER
)

63 
	#__NOPOLL_PRETTY_FUNCTION__
 
__FUNCDNAME__


	)

64 
	#__NOPOLL_LINE__
 
__LINE__


	)

65 
	#__NOPOLL_FILE__
 
__FILE__


	)

68 
	#__NOPOLL_PRETTY_FUNCTION__
 ""

	)

69 
	#__NOPOLL_LINE__
 0

	)

70 
	#__NOPOLL_FILE__
 ""

	)

73 
	~<¡dio.h
>

74 
	~<¡dlib.h
>

75 
	~<¡d¬g.h
>

76 
	~<¡ršg.h
>

80 #ià
defšed
(
__GNUC__
è|| defšed(
NOPOLL_OS_UNIX
)

81 
	~<uni¡d.h
>

84 
	~<sys/ty³s.h
>

85 
	~<sys/¡©.h
>

86 
	~<fú.h
>

87 
	~<ùy³.h
>

90 #ià
defšed
(
NOPOLL_OS_UNIX
)

93 
	#NOPOLL_EINTR
 
EINTR


	)

97 
	#NOPOLL_EWOULDBLOCK
 
EWOULDBLOCK


	)

98 
	#NOPOLL_EINPROGRESS
 
EINPROGRESS


	)

99 
	#NOPOLL_ENOTCONN
 
ENOTCONN


	)

100 
	#NOPOLL_EAGAIN
 
EAGAIN


	)

101 
	#NOPOLL_SOCKET
 

	)

102 
	#NOPOLL_INVALID_SOCKET
 -1

	)

103 
	#NOPOLL_SOCKET_ERROR
 -1

	)

104 
	#nİŞl_şo£_sock‘
(
s
èdØ{iàĞ >ğ0è{
	`şo£
 (s);}} 0)

	)

105 
	#nİŞl_is_discÚÃùed
 (
”ºo
 =ğ
EPIPE
)

	)

109 #ià
defšed
(
NOPOLL_OS_WIN32
)

116 #iâdeà
_WIN32_WINNT


117 
	#_WIN32_WINNT
 0x400

	)

119 
	~<wšsock2.h
>

120 
	~<wšdows.h
>

121 
	~<fú.h
>

122 
	~<io.h
>

123 
	~<´oûss.h
>

124 
	~<time.h
>

126 #ifdeà
_MSC_FULL_VER


127 
	#¡rÿ£cmp
(
¡ršg1
, 
¡ršg2
è
	`_¡ricmp
(¡ršg1, sŒšg2)

	)

130 
	#NOPOLL_EINTR
 
WSAEINTR


	)

131 
	#NOPOLL_EWOULDBLOCK
 
WSAEWOULDBLOCK


	)

132 
	#NOPOLL_EINPROGRESS
 
WSAEINPROGRESS


	)

133 
	#NOPOLL_ENOTCONN
 
WSAENOTCONN


	)

134 
	#NOPOLL_EAGAIN
 
WSAEWOULDBLOCK


	)

135 
	#SHUT_RDWR
 
SD_BOTH


	)

136 
	#SHUT_WR
 
SD_SEND


	)

137 
	#NOPOLL_SOCKET
 
SOCKET


	)

138 
	#NOPOLL_INVALID_SOCKET
 
INVALID_SOCKET


	)

139 
	#NOPOLL_SOCKET_ERROR
 
SOCKET_ERROR


	)

140 
	#nİŞl_şo£_sock‘
(
s
èdØ{iàĞ >ğ0è{
	`şo£sock‘
 (s);}} 0)

	)

141 
	#ušt16_t
 
u_shÜt


	)

142 
	#nİŞl_is_discÚÃùed
 ((
”ºo
 =ğ
WSAESHUTDOWN
è|| (”ºØ=ğ
WSAECONNABORTED
è|| (”ºØ=ğ
WSAECONNRESET
))

	)

145 
	#¡¾’
 (è
¡¾’


	)

148 
	#S_ISLNK
(
m
è(0)

	)

152 #ià
defšed
(
NOPOLL_OS_UNIX
)

153 
	~<sys/ty³s.h
>

154 
	~<fú.h
>

155 
	~<Ãtdb.h
>

156 
	~<sys/sock‘.h
>

157 
	~<Ãtš‘/š.h
>

158 
	~<¬·/š‘.h
>

159 
	~<sys/£Ëù.h
>

160 
	~<sys/time.h
>

161 
	~<sys/»sourû.h
>

162 
	~<time.h
>

163 
	~<uni¡d.h
>

167 #ià
defšed
(
NOPOLL_HAVE_POLL
)

168 
	~<sys/pŞl.h
>

172 #ià
defšed
(
NOPOLL_HAVE_EPOLL
)

173 
	~<sys/•Şl.h
>

176 
	~<”ºo.h
>

178 #ià
defšed
(
NOPOLL_OS_WIN32
)

181 #ifdeà 
”ºo


182 #undeà
”ºo


184 
	#”ºo
 (
	`WSAG‘La¡E¼Ü
())

	)

190 
	#nİŞl_çl£
 (()0)

	)

194 
	#nİŞl_Œue
 (()1)

	)

202 
	tnİŞl_boŞ
;

210 * 
	tnoPŞlPŒ
;

216 
_noPŞlCtx
 
	tnoPŞlCtx
;

223 
_noPŞlCÚn
 
	tnoPŞlCÚn
;

228 
_noPŞlCÚnO±s
 
	tnoPŞlCÚnO±s
;

233 
_noPŞlIoEngše
 
	tnoPŞlIoEngše
;

239 
_noPŞlMsg
 
	tnoPŞlMsg
;

245 
_noPŞlHªdshake
 
	tnoPŞlHªdShake
;

258 
	mNOPOLL_LEVEL_DEBUG
,

264 
	mNOPOLL_LEVEL_WARNING
,

272 
	mNOPOLL_LEVEL_CRITICAL
}

273 
	tnoPŞlDebugLev–
;

282 
	mNOPOLL_ROLE_UNKNOWN
,

287 
	mNOPOLL_ROLE_CLIENT
,

292 
	mNOPOLL_ROLE_LISTENER
,

297 
	mNOPOLL_ROLE_MAIN_LISTENER


298 } 
	tnoPŞlRŞe
;

308 
	mNOPOLL_IO_ENGINE_DEFAULT
,

312 
	mNOPOLL_IO_ENGINE_SELECT
,

316 
	mNOPOLL_IO_ENGINE_POLL
,

320 
	mNOPOLL_IO_ENGINE_EPOLL


321 } 
	tnoPŞlIoEngšeTy³
;

332 
	#nİŞl_Ãw
(
ty³
, 
couÁ
èÑy³ *è
	`nİŞl_ÿÎoc
 (couÁ,  (ty³))

	)

340 
	#nİŞl_»tuº_if_ç
(
ùx
, 
ex´
) \

341 ià(!(
ex´
)è{
	`__nİŞl_log
 (
ùx
, 
__funùiÚ_Çme__
, 
__fe__
, 
__lše__
, 
NOPOLL_LEVEL_CRITICAL
, "Ex´esiÚ '%s' havçed‡ˆ% (%s:%d)", #ex´, 
__NOPOLL_PRETTY_FUNCTION__
, 
__NOPOLL_FILE__
, 
__NOPOLL_LINE__
); ;}

	)

353 
	#nİŞl_»tuº_v®_if_ç
(
ùx
, 
ex´
, 
v®
) \

354 ià(!(
ex´
)è{ 
	`__nİŞl_log
 (
ùx
, 
__funùiÚ_Çme__
, 
__fe__
, 
__lše__
, 
NOPOLL_LEVEL_CRITICAL
, "Ex´esiÚ '%s' havçed,„‘uºšg: % © % (%s:%d)", #ex´, #v®, 
__NOPOLL_PRETTY_FUNCTION__
, 
__NOPOLL_FILE__
, 
__NOPOLL_LINE__
);  
v®
;}

	)

367 #undeà
BEGIN_C_DECLS


368 #undeà
END_C_DECLS


369 #ifdeà
__ılu¥lus


370 
	#BEGIN_C_DECLS
 "C" {

	)

371 
	#END_C_DECLS
 }

	)

373 
	#BEGIN_C_DECLS


	)

374 
	#END_C_DECLS


	)

385 
NOPOLL_UNKNOWN_OP_CODE
 = -1,

389 
NOPOLL_CONTINUATION_FRAME
 = 0,

394 
NOPOLL_TEXT_FRAME
 = 1,

399 
NOPOLL_BINARY_FRAME
 = 2,

403 
NOPOLL_CLOSE_FRAME
 = 8,

408 
NOPOLL_PING_FRAME
 = 9,

412 
NOPOLL_PONG_FRAME
 = 10

413 } 
	tnoPŞlOpCode
;

426 
	mNOPOLL_METHOD_SSLV23
 = 2,

433 
	mNOPOLL_METHOD_SSLV3
 = 3,

440 
	mNOPOLL_METHOD_TLSV1
 = 4,

441 #ià
defšed
(
TLSv1_1_ş›Á_m‘hod
)

448 
	mNOPOLL_METHOD_TLSV1_1
 = 5

450 } 
	tnoPŞlS¦PrÙocŞ
 ;

452 
BEGIN_C_DECLS


454 
noPŞlPŒ
 
nİŞl_ÿÎoc
 (
size_t
 
couÁ
, size_ˆ
size
);

456 
noPŞlPŒ
 
nİŞl_»®loc
 (noPŞlPŒ 
»f
, 
size_t
 
size
);

458 
nİŞl_ä“
 (
noPŞlPŒ
 
»f
);

460 
	gEND_C_DECLS


	@nopoll_handlers.h

39 #iâdeà
__NOPOLL_HANDLERS_H__


40 
	#__NOPOLL_HANDLERS_H__


	)

69 
	$nİŞl_boŞ
 (*
	tnoPŞlAùiÚHªdËr
è(
	tnoPŞlCtx
 * 
	tùx
, 
	tnoPŞlCÚn
 * 
	tcÚn
, 
	tnoPŞlPŒ
 
	tu£r_d©a
);

76 
	$noPŞlPŒ
 (*
	tnoPŞlIoMechC»©e
è(
	tnoPŞlCtx
 * 
	tùx
);

87 (*
	tnoPŞlIoMechDe¡roy
è(
	tnoPŞlCtx
 * 
	tùx
, 
	tnoPŞlPŒ
 
	tio_objeù
);

98 (*
	tnoPŞlIoMechCË¬
è(
	tnoPŞlCtx
 * 
	tùx
, 
	tnoPŞlPŒ
 
	tio_objeù
);

110 (*
	tnoPŞlIoMechWa™
è(
	tnoPŞlCtx
 * 
	tùx
, 
	tnoPŞlPŒ
 
	tio_objeù
);

124 
	$nİŞl_boŞ
 (*
	tnoPŞlIoMechAddTo
è(
	tfds
,

125 
	tnoPŞlCtx
 * 
	tùx
,

126 
	tnoPŞlCÚn
 * 
	tcÚn
,

127 
	tnoPŞlPŒ
 
	tio_objeù
);

141 
	$nİŞl_boŞ
 (*
	tnoPŞlIoMechIsS‘
è(
	tnoPŞlCtx
 * 
	tùx
,

142 
	tfds
,

143 
	tnoPŞlPŒ
 
	tio_objeù
);

160 
	$nİŞl_boŞ
 (*
	tnoPŞlFÜ—chCÚn
è(
	tnoPŞlCtx
 * 
	tùx
,

161 
	tnoPŞlCÚn
 * 
	tcÚn
,

162 
	tnoPŞlPŒ
 
	tu£r_d©a
);

173 (*
	tnoPŞlR—d
è(
	tnoPŞlCÚn
 * 
	tcÚn
,

174 * 
	tbufãr
,

175 
	tbufãr_size
);

195 (*
	tnoPŞlOnMes§geHªdËr
è(
	tnoPŞlCtx
 * 
	tùx
,

196 
	tnoPŞlCÚn
 * 
	tcÚn
,

197 
	tnoPŞlMsg
 * 
	tmsg
,

198 
	tnoPŞlPŒ
 
	tu£r_d©a
);

214 (*
	tnoPŞlOnClo£HªdËr
è(
	tnoPŞlCtx
 * 
	tùx
,

215 
	tnoPŞlCÚn
 * 
	tcÚn
,

216 
	tnoPŞlPŒ
 
	tu£r_d©a
);

223 
	$noPŞlPŒ
 (*
	tnoPŞlMu‹xC»©e
) ();

230 (*
	tnoPŞlMu‹xDe¡roy
è(
	tnoPŞlPŒ
 
	tmu‹x
);

237 (*
	tnoPŞlMu‹xLock
è(
	tnoPŞlPŒ
 
	tmu‹x
);

244 (*
	tnoPŞlMu‹xUÆock
è(
	tnoPŞlPŒ
 
	tmu‹x
);

258 (*
	tnoPŞlLogHªdËr
è(
	tnoPŞlCtx
 * 
	tùx
, 
	tnoPŞlDebugLev–
 
	tËv–
, cÚ¡ * 
	tlog_msg
, 
	tnoPŞlPŒ
 
	tu£r_d©a
);

291 
	$noPŞlPŒ
 (*
	tnoPŞlS¦CÚ‹xtC»©Ü
è(
	tnoPŞlCtx
 * 
	tùx
,

292 
	tnoPŞlCÚn
 * 
	tcÚn
,

293 
	tnoPŞlCÚnO±s
 * 
	tİts
,

294 
	tnİŞl_boŞ
 
	tis_ş›Á
,

295 
	tnoPŞlPŒ
 
	tu£r_d©a
);

320 
	$nİŞl_boŞ
 (*
	tnoPŞlS¦Po¡Check
è(
	tnoPŞlCtx
 * 
	tùx
,

321 
	tnoPŞlCÚn
 * 
	tcÚn
,

322 
	tnoPŞlPŒ
 
	tSSL_CTX
,

323 
	tnoPŞlPŒ
 
	tSSL
,

324 
	tnoPŞlPŒ
 
	tu£r_d©a
);

	@nopoll_io.c

39 
	~<nİŞl_io.h
>

40 
	~<nİŞl_´iv©e.h
>

42 
	s_noPŞlS–eù
 {

43 
noPŞlCtx
 * 
	mùx
;

44 
fd_£t
 
	m£t
;

45 
	mËngth
;

46 
	mmax_fds
;

47 } 
	tnoPŞlS–eù
;

55 
noPŞlPŒ
 
	$nİŞl_io_wa™_£Ëù_ü—‹
 (
noPŞlCtx
 * 
ùx
)

57 
noPŞlS–eù
 * 
£Ëù
 = 
	`nİŞl_Ãw
 (noPollSelect, 1);

60 
£Ëù
->
ùx
 = ctx;

63 
	`FD_ZERO
 (&(
£Ëù
->
£t
));

65  
£Ëù
;

66 
	}
}

74 
	$nİŞl_io_wa™_£Ëù_de¡roy
 (
noPŞlCtx
 * 
ùx
, 
noPŞlPŒ
 
fd_group
)

76 
fd_£t
 * 
__fd_£t
 = (fd_£ˆ*è
fd_group
;

79 
	`nİŞl_ä“
 (
__fd_£t
);

83 
	}
}

91 
	$nİŞl_io_wa™_£Ëù_ş—r
 (
noPŞlCtx
 * 
ùx
, 
noPŞlPŒ
 
__fd_group
)

93 
noPŞlS–eù
 * 
£Ëù
 = (noPŞlS–eù *è
__fd_group
;

96 
£Ëù
->
Ëngth
 = 0;

97 
	`FD_ZERO
 (&(
£Ëù
->
£t
));

101 
	}
}

113 
	$nİŞl_io_wa™_£Ëù_wa™
 (
noPŞlCtx
 * 
ùx
, 
noPŞlPŒ
 
__fd_group
)

115 
»suÉ
 = -1;

116 
timev®
 
tv
;

117 
noPŞlS–eù
 * 
_£Ëù
 = (noPŞlS–eù *è
__fd_group
;

120 
tv
.
tv_£c
 = 0;

121 
tv
.
tv_u£c
 = 500000;

122 
»suÉ
 = 
	`£Ëù
 (
_£Ëù
->
max_fds
 + 1, &(_£Ëù->
£t
), 
NULL
, NULL, &
tv
);

125 ià((
»suÉ
 =ğ
NOPOLL_SOCKET_ERROR
è&& (
”ºo
 =ğ
NOPOLL_EINTR
))

128  
»suÉ
;

129 
	}
}

139 
nİŞl_boŞ
 
	$nİŞl_io_wa™_£Ëù_add_to
 (
fds
,

140 
noPŞlCtx
 * 
ùx
,

141 
noPŞlCÚn
 * 
cÚn
,

142 
noPŞlPŒ
 
__fd_£t
)

144 
noPŞlS–eù
 * 
£Ëù
 = (noPŞlS–eù *è
__fd_£t
;

146 ià(
fds
 < 0) {

147 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_CRITICAL
,

148 "»ûived‡‚Ú v®id sock‘ (%d), uÇbËØaddØth£t", 
fds
);

149  
nİŞl_çl£
;

153 
	`FD_SET
 (
fds
, &(
£Ëù
->
£t
));

156 
£Ëù
->
Ëngth
++;

159 ià(
fds
 > 
£Ëù
->
max_fds
)

160 
£Ëù
->
max_fds
 = 
fds
;

162  
nİŞl_Œue
;

163 
	}
}

176 
nİŞl_boŞ
 
	$nİŞl_io_wa™_£Ëù_is_£t
 (
noPŞlCtx
 * 
ùx
,

177 
fds
,

178 
noPŞlPŒ
 
__fd_£t
)

180 
noPŞlS–eù
 * 
£Ëù
 = (noPŞlS–eù *è
__fd_£t
;

182  
	`FD_ISSET
 (
fds
, &(
£Ëù
->
£t
));

183 
	}
}

197 
noPŞlIoEngše
 * 
	$nİŞl_io_g‘_’gše
 (
noPŞlCtx
 * 
ùx
, 
noPŞlIoEngšeTy³
 
’gše_ty³
)

199 
noPŞlIoEngše
 * 
’gše
 = 
	`nİŞl_Ãw
 (noPollIoEngine, 1);

200 ià(
’gše
 =ğ
NULL
)

201  
NULL
;

204 
’gše
->
ü—‹
 = 
nİŞl_io_wa™_£Ëù_ü—‹
;

205 
’gše
->
de¡roy
 = 
nİŞl_io_wa™_£Ëù_de¡roy
;

206 
’gše
->
ş—r
 = 
nİŞl_io_wa™_£Ëù_ş—r
;

207 
’gše
->
wa™
 = 
nİŞl_io_wa™_£Ëù_wa™
;

208 
’gše
->
addto
 = 
nİŞl_io_wa™_£Ëù_add_to
;

209 
’gše
->
is£t
 = 
nİŞl_io_wa™_£Ëù_is_£t
;

212 
’gše
->
ùx
 = ctx;

213 
’gše
->
io_objeù
 =ƒngše->
	`ü—‹
 (
ùx
);

216  
’gše
;

217 
	}
}

224 
	$nİŞl_io_»Ëa£_’gše
 (
noPŞlIoEngše
 * 
’gše
)

226 ià(
’gše
 =ğ
NULL
)

228 
’gše
->
	`de¡roy
 (’gše->
ùx
,ƒngše->
io_objeù
);

229 
	`nİŞl_ä“
 (
’gše
);

231 
	}
}

	@nopoll_io.h

39 #iâdeà
__NOPOLL_IO_H__


40 
	#__NOPOLL_IO_H__


	)

42 
	~<nİŞl.h
>

44 
BEGIN_C_DECLS


46 
noPŞlIoEngše
 * 
nİŞl_io_g‘_’gše
 (
noPŞlCtx
 * 
ùx
, 
noPŞlIoEngšeTy³
 
’gše_ty³
);

48 
nİŞl_io_»Ëa£_’gše
 (
noPŞlIoEngše
 * 
’gše
);

50 
	gEND_C_DECLS


	@nopoll_listener.c

39 
	~<nİŞl_li¡’”.h
>

40 
	~<nİŞl_´iv©e.h
>

54 
NOPOLL_SOCKET
 
	$nİŞl_li¡’”_sock_li¡’
 (
noPŞlCtx
 * 
ùx
,

55 cÚ¡ * 
ho¡
,

56 cÚ¡ * 
pÜt
)

58 
ho¡’t
 * 
he
;

59 
š_addr
 * 
haddr
;

60 
sockaddr_š
 
§ddr
;

61 
sockaddr_š
 
sš
;

62 
NOPOLL_SOCKET
 
fd
;

63 
Œ›s
;

65 #ià
	`defšed
(
NOPOLL_OS_WIN32
)

66 
sš_size
 =  (
sš
);

68 
un™
 = 1;

69 
sockËn_t
 
sš_size
 =  (
sš
);

71 
ušt16_t
 
št_pÜt
;

72 
bšd_»s
;

74 
	`nİŞl_»tuº_v®_if_ç
 (
ùx
, ctx, -2);

75 
	`nİŞl_»tuº_v®_if_ç
 (
ùx
, 
ho¡
, -2);

76 
	`nİŞl_»tuº_v®_if_ç
 (
ùx
, 
pÜt
 || 
	`¡¾’
 (port) == 0, -2);

79 
he
 = 
	`g‘ho¡byÇme
 (
ho¡
);

80 ià(
he
 =ğ
NULL
) {

81 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_CRITICAL
, "unableo get hostname by calling gethostbyname");

85 
haddr
 = ((
š_addr
 *è(
he
->
h_addr_li¡
)[0]);

86 ià((
fd
 = 
	`sock‘
(
AF_INET
, 
SOCK_STREAM
, 0)) <= 2) {

89 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_DEBUG
, "çedØü—‹†i¡’” sock‘: %d (”ºo=%d)", 
fd
, 
”ºo
);

93 #ià
	`defšed
(
NOPOLL_OS_WIN32
)

101 
	`£tsockİt
(
fd
, 
SOL_SOCKET
, 
SO_REUSEADDR
, &
un™
,  (unit));

105 
št_pÜt
 = (
ušt16_t
è
	`©oi
 (
pÜt
);

107 
	`mem£t
(&
§ddr
, 0, (
sockaddr_š
));

108 
§ddr
.
sš_çmy
 = 
AF_INET
;

109 
§ddr
.
sš_pÜt
 = 
	`htÚs
(
št_pÜt
);

110 
	`memıy
(&
§ddr
.
sš_addr
, 
haddr
, (
š_addr
));

113 
Œ›s
 = 0;

115 
bšd_»s
 = 
	`bšd
(
fd
, (
sockaddr
 *)&
§ddr
,  (
sockaddr_š
));

116 ià(
bšd_»s
 =ğ
NOPOLL_SOCKET_ERROR
) {

118 
Œ›s
++;

119 ià(
Œ›s
 < 25) {

120 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_WARNING
,

122 
št_pÜt
, 
”ºo
, 
	`¡»¼Ü
 (”ºo), 
Œ›s
, 
fd
);

123 
	`nİŞl_¦“p
 (100000);

127 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_CRITICAL
,

129 
št_pÜt
, 
”ºo
, 
	`¡»¼Ü
 (”ºo), 
fd
);

130 
	`nİŞl_şo£_sock‘
 (
fd
);

138 ià(
	`li¡’
(
fd
, 
ùx
->
backlog
è=ğ
NOPOLL_SOCKET_ERROR
) {

139 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_CRITICAL
, "anƒrror have occur whileƒxecuting†isten");

144 ià(
	`g‘sockÇme
 (
fd
, (
sockaddr
 *è&
sš
, &
sš_size
) < -1) {

149 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_DEBUG
, "ruÂšg†i¡’”‡ˆ%s:%d (sock‘: %d)", 
	`š‘_Áß
(
sš
.
sš_addr
), 
	`Áohs
 (sš.
sš_pÜt
), 
fd
);

150  
fd
;

151 
	}
}

166 
noPŞlCÚn
 * 
	$nİŞl_li¡’”_Ãw
 (
noPŞlCtx
 * 
ùx
,

167 cÚ¡ * 
ho¡
,

168 cÚ¡ * 
pÜt
)

170  
	`nİŞl_li¡’”_Ãw_İts
 (
ùx
, 
NULL
, 
ho¡
, 
pÜt
);

171 
	}
}

188 
noPŞlCÚn
 * 
	$nİŞl_li¡’”_Ãw_İts
 (
noPŞlCtx
 * 
ùx
,

189 
noPŞlCÚnO±s
 * 
İts
,

190 cÚ¡ * 
ho¡
,

191 cÚ¡ * 
pÜt
)

193 
NOPOLL_SOCKET
 
£ssiÚ
;

194 
noPŞlCÚn
 * 
li¡’”
;

196 
	`nİŞl_»tuº_v®_if_ç
 (
ùx
, ctx && 
ho¡
, 
NULL
);

199 
£ssiÚ
 = 
	`nİŞl_li¡’”_sock_li¡’
 (
ùx
, 
ho¡
, 
pÜt
);

200 ià(
£ssiÚ
 =ğ
NOPOLL_INVALID_SOCKET
) {

201 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_CRITICAL
, "FaedØ¡¬ˆli¡’”ƒ¼Ü was: %d", 
”ºo
);

202  
NULL
;

206 
li¡’”
 = 
	`nİŞl_Ãw
 (
noPŞlCÚn
, 1);

207 
li¡’”
->
»fs
 = 1;

208 
li¡’”
->
£ssiÚ
 = session;

209 
li¡’”
->
ùx
 = ctx;

210 
li¡’”
->
rŞe
 = 
NOPOLL_ROLE_MAIN_LISTENER
;

213 
li¡’”
->
ho¡
 = 
	`nİŞl_¡rdup
 (host);

214 
li¡’”
->
pÜt
 = 
	`nİŞl_¡rdup
 (port);

217 
	`nİŞl_ùx_»gi¡”_cÚn
 (
ùx
, 
li¡’”
);

220 
li¡’”
->
»ûive
 = 
nİŞl_cÚn_deçuÉ_»ûive
;

221 
li¡’”
->
£nd
 = 
nİŞl_cÚn_deçuÉ_£nd
;

224 
li¡’”
->
İts
 = opts;

226 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_DEBUG
, "Li¡’” c»©ed, s¹ed: %s:% (sock‘: %d)", 
li¡’”
->
ho¡
,†i¡’”->
pÜt
,†i¡’”->
£ssiÚ
);

228  
li¡’”
;

229 
	}
}

245 
noPŞlCÚn
 * 
	$nİŞl_li¡’”_s_Ãw
 (
noPŞlCtx
 * 
ùx
,

246 cÚ¡ * 
ho¡
,

247 cÚ¡ * 
pÜt
)

249  
	`nİŞl_li¡’”_s_Ãw_İts
 (
ùx
, 
NULL
, 
ho¡
, 
pÜt
);

250 
	}
}

270 
noPŞlCÚn
 * 
	$nİŞl_li¡’”_s_Ãw_İts
 (
noPŞlCtx
 * 
ùx
,

271 
noPŞlCÚnO±s
 * 
İts
,

272 cÚ¡ * 
ho¡
,

273 cÚ¡ * 
pÜt
)

275 
noPŞlCÚn
 * 
li¡’”
;

278 
li¡’”
 = 
	`nİŞl_li¡’”_Ãw
 (
ùx
, 
ho¡
, 
pÜt
);

279 ià(! 
li¡’”
)

280  
li¡’”
;

283 
li¡’”
->
s_Ú
 = 
nİŞl_Œue
;

284 
li¡’”
->
İts
 = opts;

286  
li¡’”
;

287 
	}
}

308 
nİŞl_boŞ
 
	$nİŞl_li¡’”_£t_û¹ifiÿ‹
 (
noPŞlCÚn
 * 
li¡’”
,

309 cÚ¡ * 
û¹ifiÿ‹
,

310 cÚ¡ * 
´iv©e_key
,

311 cÚ¡ * 
chaš_fe
)

313 
FILE
 * 
hªdË
;

315 ià(! 
li¡’”
 || ! 
û¹ifiÿ‹
 || ! 
´iv©e_key
)

316  
nİŞl_çl£
;

319 
hªdË
 = 
	`fİ’
 (
û¹ifiÿ‹
, "r");

320 ià(! 
hªdË
) {

321 
	`nİŞl_log
 (
li¡’”
->
ùx
, 
NOPOLL_LEVEL_CRITICAL
, "FaedØİ’ c”tifiÿ‹ fäom %s", 
û¹ifiÿ‹
);

322  
nİŞl_çl£
;

324 
	`fşo£
 (
hªdË
);

327 
hªdË
 = 
	`fİ’
 (
´iv©e_key
, "r");

328 ià(! 
hªdË
) {

329 
	`nİŞl_log
 (
li¡’”
->
ùx
, 
NOPOLL_LEVEL_CRITICAL
, "FaedØİ’…riv©key fäom %s", 
´iv©e_key
);

330  
nİŞl_çl£
;

332 
	`fşo£
 (
hªdË
);

334 ià(
chaš_fe
) {

336 
hªdË
 = 
	`fİ’
 (
chaš_fe
, "r");

337 ià(! 
hªdË
) {

338 
	`nİŞl_log
 (
li¡’”
->
ùx
, 
NOPOLL_LEVEL_CRITICAL
, "FaedØİ’ chaš c”tifiÿ‹ fäom %s", 
´iv©e_key
);

339  
nİŞl_çl£
;

341 
	`fşo£
 (
hªdË
);

345 
li¡’”
->
û¹ifiÿ‹
 = 
	`nİŞl_¡rdup
 (certificate);

346 
li¡’”
->
´iv©e_key
 = 
	`nİŞl_¡rdup
 (private_key);

347 ià(
chaš_fe
)

348 
li¡’”
->
chaš_û¹ifiÿ‹
 = 
	`nİŞl_¡rdup
 (
chaš_fe
);

350 
	`nİŞl_log
 (
li¡’”
->
ùx
, 
NOPOLL_LEVEL_DEBUG
, "Configured certificate: %s, key: %s, for conn id: %d",

351 
li¡’”
->
û¹ifiÿ‹
,†i¡’”->
´iv©e_key
,†i¡’”->
id
);

354  
nİŞl_Œue
;

355 
	}
}

367 
noPŞlCÚn
 * 
	$nİŞl_li¡’”_äom_sock‘
 (
noPŞlCtx
 * 
ùx
,

368 
NOPOLL_SOCKET
 
£ssiÚ
)

370 
noPŞlCÚn
 * 
li¡’”
;

371 
sockaddr_š
 
sš
;

372 #ià
	`defšed
(
NOPOLL_OS_WIN32
)

374 
sš_size
 =  (
sš
);

377 
sockËn_t
 
sš_size
 =  (
sš
);

380 
	`nİŞl_»tuº_v®_if_ç
 (
ùx
, ctx && 
£ssiÚ
 > 0, 
NULL
);

383 
li¡’”
 = 
	`nİŞl_Ãw
 (
noPŞlCÚn
, 1);

384 
li¡’”
->
»fs
 = 1;

385 
li¡’”
->
£ssiÚ
 = session;

386 
li¡’”
->
ùx
 = ctx;

387 
li¡’”
->
rŞe
 = 
NOPOLL_ROLE_LISTENER
;

390 
	`mem£t
 (&
sš
, 0,  (
sockaddr_š
));

391 ià(
	`g‘³”Çme
 (
£ssiÚ
, (
sockaddr
 *è&
sš
, &
sš_size
) < -1) {

392 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_CRITICAL
, "unableo get„emote hostname‡nd…ort");

393  
NULL
;

398 
li¡’”
->
ho¡
 = 
	`nİŞl_¡rdup
 (
	`š‘_Áß
 (
sš
.
sš_addr
));

400 
li¡’”
->
pÜt
 = 
	`nİŞl_¡rdup_´štf
 ("%d", 
	`Áohs
 (
sš
.
sš_pÜt
));

403 
li¡’”
->
»ûive
 = 
nİŞl_cÚn_deçuÉ_»ûive
;

404 
li¡’”
->
£nd
 = 
nİŞl_cÚn_deçuÉ_£nd
;

407 ià(! 
	`nİŞl_ùx_»gi¡”_cÚn
 (
ùx
, 
li¡’”
)) {

408 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_CRITICAL
, "Failedo„egister connection intohe context, unableo create connection");

409 
	`nİŞl_cÚn_»f
 (
li¡’”
);

410  
NULL
;

413 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_DEBUG
, "Li¡’” c»©ed, s¹ed: %s:% (sock‘: %d)", 
li¡’”
->
ho¡
,†i¡’”->
pÜt
,†i¡’”->
£ssiÚ
);

417 
	`nİŞl_cÚn_uÄef
 (
li¡’”
);

419  
li¡’”
;

420 
	}
}

430 
NOPOLL_SOCKET
 
	$nİŞl_li¡’”_acû±
 (
NOPOLL_SOCKET
 
£rv”_sock‘
)

432 
sockaddr_š
 
š‘_addr
;

433 #ià
	`defšed
(
NOPOLL_OS_WIN32
)

434 
add¾’
;

436 
sockËn_t
 
add¾’
;

438 
add¾’
 = (
sockaddr_š
);

441  
	`acû±
 (
£rv”_sock‘
, (
sockaddr
 *)&
š‘_addr
, &
add¾’
);

442 
	}
}

	@nopoll_listener.h

39 #iâdeà
__NOPOLL_LISTENER_H__


40 
	#__NOPOLL_LISTENER_H__


	)

42 
	~<nİŞl.h
>

44 
BEGIN_C_DECLS


46 
NOPOLL_SOCKET
 
nİŞl_li¡’”_sock_li¡’
 (
noPŞlCtx
 * 
ùx
,

47 cÚ¡ * 
ho¡
,

48 cÚ¡ * 
pÜt
);

50 
noPŞlCÚn
 * 
nİŞl_li¡’”_Ãw
 (
noPŞlCtx
 * 
ùx
,

51 cÚ¡ * 
ho¡
,

52 cÚ¡ * 
pÜt
);

54 
noPŞlCÚn
 * 
nİŞl_li¡’”_Ãw_İts
 (
noPŞlCtx
 * 
ùx
,

55 
noPŞlCÚnO±s
 * 
İts
,

56 cÚ¡ * 
ho¡
,

57 cÚ¡ * 
pÜt
);

59 
noPŞlCÚn
 * 
nİŞl_li¡’”_s_Ãw
 (
noPŞlCtx
 * 
ùx
,

60 cÚ¡ * 
ho¡
,

61 cÚ¡ * 
pÜt
);

63 
noPŞlCÚn
 * 
nİŞl_li¡’”_s_Ãw_İts
 (
noPŞlCtx
 * 
ùx
,

64 
noPŞlCÚnO±s
 * 
İts
,

65 cÚ¡ * 
ho¡
,

66 cÚ¡ * 
pÜt
);

68 
nİŞl_boŞ
 
nİŞl_li¡’”_£t_û¹ifiÿ‹
 (
noPŞlCÚn
 * 
li¡’”
,

69 cÚ¡ * 
û¹ifiÿ‹
,

70 cÚ¡ * 
´iv©e_key
,

71 cÚ¡ * 
chaš_fe
);

73 
noPŞlCÚn
 * 
nİŞl_li¡’”_äom_sock‘
 (
noPŞlCtx
 * 
ùx
,

74 
NOPOLL_SOCKET
 
£ssiÚ
);

76 
NOPOLL_SOCKET
 
nİŞl_li¡’”_acû±
 (NOPOLL_SOCKET 
£rv”_sock‘
);

78 
	gEND_C_DECLS


	@nopoll_log.c

39 
	~<nİŞl.h
>

40 
	~<nİŞl_´iv©e.h
>

57 
nİŞl_boŞ
 
	$nİŞl_log_is_’abËd
 (
noPŞlCtx
 * 
ùx
)

59 ià(
ùx
 =ğ
NULL
)

60  
nİŞl_çl£
;

63  
ùx
->
debug_’abËd
;

64 
	}
}

72 
nİŞl_boŞ
 
	$nİŞl_log_cŞÜ_is_’abËd
 (
noPŞlCtx
 * 
ùx
)

75 ià(
ùx
 =ğ
NULL
)

76  
nİŞl_çl£
;

79  
ùx
->
debug_cŞÜ_’abËd
;

80 
	}
}

91 
	$nİŞl_log_’abË
 (
noPŞlCtx
 * 
ùx
, 
nİŞl_boŞ
 
v®ue
)

93 ià(
ùx
 =ğ
NULL
)

97 
ùx
->
debug_’abËd
 = 
v®ue
;

99 
	}
}

110 
	$nİŞl_log_cŞÜ_’abË
 (
noPŞlCtx
 * 
ùx
, 
nİŞl_boŞ
 
v®ue
)

112 ià(
ùx
 =ğ
NULL
)

116 
ùx
->
debug_cŞÜ_’abËd
 = 
v®ue
;

118 
	}
}

133 
	$nİŞl_log_£t_hªdËr
 (
noPŞlCtx
 * 
ùx
, 
noPŞlLogHªdËr
 
hªdËr
, 
noPŞlPŒ
 
u£r_d©a
)

135 
	`nİŞl_»tuº_if_ç
 (
ùx
, ctx);

137 
ùx
->
log_hªdËr
 = 
hªdËr
;

138 
ùx
->
log_u£r_d©a
 = 
u£r_d©a
;

141 
	}
}

167 
	$__nİŞl_log
 (
noPŞlCtx
 * 
ùx
, cÚ¡ * 
funùiÚ_Çme
, cÚ¡ * 
fe
, 
lše
, 
noPŞlDebugLev–
 
Ëv–
, cÚ¡ * 
mes§ge
, ...)

170 #ifdeà
SHOW_DEBUG_LOG


171 
va_li¡
 
¬gs
;

172 * 
log_msg
;

173 * 
log_msg2
;

175 ià(
ùx
 && ctx->
log_hªdËr
) {

177 
	`va_¡¬t
 (
¬gs
, 
mes§ge
);

178 
log_msg
 = 
	`nİŞl_¡rdup_´štfv
 (
mes§ge
, 
¬gs
);

179 
	`va_’d
 (
¬gs
);

181 
log_msg2
 = 
log_msg
;

182 
log_msg
 = 
	`nİŞl_¡rdup_´štf
 ("%s:%d % ", 
fe
, 
lše
,†og_msg);

183 
	`nİŞl_ä“
 (
log_msg2
);

185 
ùx
->
	`log_hªdËr
 (ùx, 
Ëv–
, 
log_msg
, ctx->
log_u£r_d©a
);

186 
	`nİŞl_ä“
 (
log_msg
);

191 ià(! 
	`nİŞl_log_is_’abËd
 (
ùx
))

195 ià(
	`nİŞl_log_cŞÜ_is_’abËd
 (
ùx
))

196 
	`´štf
 ("\e[1;36mÕroø%d)\e[0m: ", 
	`g‘pid
 ());

198 
	`´štf
 ("Õroø%d): ", 
	`g‘pid
 ());

201 ià(
	`nİŞl_log_cŞÜ_is_’abËd
 (
ùx
)) {

202 
Ëv–
) {

203 
NOPOLL_LEVEL_DEBUG
:

204 
	`´štf
 ("(\e[1;32mdebug\e[0m) ");

206 
NOPOLL_LEVEL_WARNING
:

207 
	`´štf
 ("(\e[1;33mwarning\e[0m) ");

209 
NOPOLL_LEVEL_CRITICAL
:

210 
	`´štf
 ("(\e[1;31mcritical\e[0m) ");

214 
Ëv–
) {

215 
NOPOLL_LEVEL_DEBUG
:

216 
	`´štf
 ("(debug)");

218 
NOPOLL_LEVEL_WARNING
:

219 
	`´štf
 ("(warning)");

221 
NOPOLL_LEVEL_CRITICAL
:

222 
	`´štf
 ("(critical) ");

228 
	`´štf
 ("%s:%d ", 
fe
, 
lše
);

231 
	`va_¡¬t
 (
¬gs
, 
mes§ge
);

232 
	`v´štf
 (
mes§ge
, 
¬gs
);

233 
	`va_’d
 (
¬gs
);

235 
	`´štf
 ("\n");

238 
	`fæush
 (
¡dout
);

243 
	}
}

	@nopoll_log.h

39 #iâdeà
__NOPOLL_LOG_H__


40 
	#__NOPOLL_LOG_H__


	)

42 
	~<nİŞl_deş.h
>

43 
	~<nİŞl_hªdËrs.h
>

45 
BEGIN_C_DECLS


52 
nİŞl_boŞ
 
nİŞl_log_is_’abËd
 (
noPŞlCtx
 * 
ùx
);

54 
nİŞl_boŞ
 
nİŞl_log_cŞÜ_is_’abËd
 (
noPŞlCtx
 * 
ùx
);

56 
nİŞl_log_’abË
 (
noPŞlCtx
 * 
ùx
, 
nİŞl_boŞ
 
v®ue
);

58 
nİŞl_log_cŞÜ_’abË
 (
noPŞlCtx
 * 
ùx
, 
nİŞl_boŞ
 
v®ue
);

60 
nİŞl_log_£t_hªdËr
 (
noPŞlCtx
 * 
ùx
, 
noPŞlLogHªdËr
 
hªdËr
, 
noPŞlPŒ
 
u£r_d©a
);

63 #ià
defšed
(
__GNUC__
)

64 #iâdeà
_GNU_SOURCE


65 
	#_GNU_SOURCE


	)

67 
	#__funùiÚ_Çme__
 
__PRETTY_FUNCTION__


	)

68 
	#__lše__
 
__LINE__


	)

69 
	#__fe__
 
__FILE__


	)

70 #–ià
defšed
(
_MSC_VER
)

71 
	#__funùiÚ_Çme__
 
__FUNCDNAME__


	)

72 
	#__lše__
 
__LINE__


	)

73 
	#__fe__
 
__FILE__


	)

76 
	#__funùiÚ_Çme__
 ""

	)

77 
	#__lše__
 0

	)

78 
	#__fe__
 ""

	)

82 #ià
defšed
(
SHOW_DEBUG_LOG
)

83 
	#nİŞl_log
(
ùx
,
Ëv–
,
mes§ge
, ...èdo{
	`__nİŞl_log
(ùx, 
__funùiÚ_Çme__
, 
__fe__
, 
__lše__
,†ev–, mes§ge, ##
__VA_ARGS__
);}0)

	)

85 #ià
defšed
(
NOPOLL_OS_WIN32
è&& !Ğdefšed (
__GNUC__
è|| 
_MSC_VER
 >= 1400)

88 
	#nİŞl_log
 
__nİŞl_log


	)

90 
	#nİŞl_log
(
ùx
, 
Ëv–
, 
mes§ge
, ...è

	)

101 #ià
defšed
(
SHOW_FORMAT_BUGS
)

102 #undeà
nİŞl_log


103 
	#nİŞl_log
(
ùx
,
Ëv–
,
mes§ge
, ...èdo{
	`´štf
 (mes§ge, ##
__VA_ARGS__
);}0)

	)

106 
__nİŞl_log
 (
noPŞlCtx
 * 
ùx
, cÚ¡ * 
funùiÚ_Çme
, cÚ¡ * 
fe
, 
lše
, 
noPŞlDebugLev–
 
Ëv–
, cÚ¡ * 
mes§ge
, ...);

110 
	gEND_C_DECLS


	@nopoll_loop.c

39 
	~<nİŞl_loİ.h
>

40 
	~<nİŞl_´iv©e.h
>

55 
nİŞl_boŞ
 
	$nİŞl_loİ_»gi¡”
 (
noPŞlCtx
 * 
ùx
, 
noPŞlCÚn
 * 
cÚn
, 
noPŞlPŒ
 
u£r_d©a
)

58 ià(! 
	`nİŞl_cÚn_is_ok
 (
cÚn
)) {

60 
	`nİŞl_ùx_uÄegi¡”_cÚn
 (
ùx
, 
cÚn
);

61  
nİŞl_çl£
;

66 ià(! 
ùx
->
io_’gše
->
	`addto
 (
cÚn
->
£ssiÚ
, ctx, cÚn, ctx->io_’gše->
io_objeù
)) {

68 
	`nİŞl_ùx_uÄegi¡”_cÚn
 (
ùx
, 
cÚn
);

69 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_WARNING
, "FaedØadd sock‘ %dØthw©chšg s‘", 
cÚn
->
£ssiÚ
);

72  
nİŞl_çl£
;

73 
	}
}

79 
	$nİŞl_loİ_´oûss_d©a
 (
noPŞlCtx
 * 
ùx
, 
noPŞlCÚn
 * 
cÚn
)

81 
noPŞlMsg
 * 
msg
;

84 
msg
 = 
	`nİŞl_cÚn_g‘_msg
 (
cÚn
);

85 ià(
msg
 =ğ
NULL
)

89 ià(
cÚn
->
Ú_msg
)

90 
cÚn
->
	`Ú_msg
 (
ùx
, cÚn, 
msg
, cÚn->
Ú_msg_d©a
);

91 ià(
ùx
->
Ú_msg
)

92 
ùx
->
	`Ú_msg
 (ùx, 
cÚn
, 
msg
, ctx->
Ú_msg_d©a
);

95 
	`nİŞl_msg_uÄef
 (
msg
);

97 
	}
}

104 
nİŞl_boŞ
 
	$nİŞl_loİ_´oûss
 (
noPŞlCtx
 * 
ùx
, 
noPŞlCÚn
 * 
cÚn
, 
noPŞlPŒ
 
u£r_d©a
)

106 * 
cÚn_chªged
 = (*è
u£r_d©a
;

109 ià(
ùx
->
io_’gše
->
	`is£t
 (ùx, 
cÚn
->
£ssiÚ
, ctx->io_’gše->
io_objeù
)) {

112 
cÚn
->
rŞe
) {

113 
NOPOLL_ROLE_CLIENT
:

114 
NOPOLL_ROLE_LISTENER
:

116 
	`nİŞl_loİ_´oûss_d©a
 (
ùx
, 
cÚn
);

118 
NOPOLL_ROLE_MAIN_LISTENER
:

120 
	`nİŞl_cÚn_acû±
 (
ùx
, 
cÚn
);

123 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_CRITICAL
, "Found connection with unknown„ole, closing‡nd dropping");

124 
	`nİŞl_cÚn_shutdown
 (
cÚn
);

129 (*
cÚn_chªged
)--;

132  (*
cÚn_chªged
) == 0;

133 
	}
}

140 
	$nİŞl_loİ_š™
 (
noPŞlCtx
 * 
ùx
)

142 ià(
ùx
 =ğ
NULL
)

146 ià(
ùx
->
io_’gše
 =ğ
NULL
) {

147 
ùx
->
io_’gše
 = 
	`nİŞl_io_g‘_’gše
 (ùx, 
NOPOLL_IO_ENGINE_DEFAULT
);

148 ià(
ùx
->
io_’gše
 =ğ
NULL
) {

149 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_CRITICAL
, "Failedo create IO waitƒngine, unableo implement wait call");

156 
	}
}

165 
	$nİŞl_loİ_¡İ
 (
noPŞlCtx
 * 
ùx
)

167 ià(! 
ùx
)

169 
ùx
->
k“p_loİšg
 = 
nİŞl_çl£
;

171 
	}
}

189 
	$nİŞl_loİ_wa™
 (
noPŞlCtx
 * 
ùx
, 
timeout
)

191 
timev®
 
¡¬t
;

192 
timev®
 
¡İ
;

193 
timev®
 
diff
;

194 
–Ïp£d
;

195 
wa™_¡©us
;

197 
	`nİŞl_»tuº_v®_if_ç
 (
ùx
, ctx, -2);

198 
	`nİŞl_»tuº_v®_if_ç
 (
ùx
, 
timeout
 >= 0, -2);

201 
	`nİŞl_loİ_š™
 (
ùx
);

204 ià(
timeout
 > 0)

205 #ià
	`defšed
(
NOPOLL_OS_WIN32
)

206 
	`nİŞl_wš32_g‘timeofday
 (&
¡¬t
, 
NULL
);

208 
	`g‘timeofday
 (&
¡¬t
, 
NULL
);

212 
ùx
->
k“p_loİšg
 = 
nİŞl_Œue
;

214 
ùx
->
k“p_loİšg
) {

216 
ùx
->
io_’gše
->
	`ş—r
 (ùx, ctx->io_’gše->
io_objeù
);

220 
	`nİŞl_ùx_fÜ—ch_cÚn
 (
ùx
, 
nİŞl_loİ_»gi¡”
, 
NULL
);

232 
wa™_¡©us
 = 
ùx
->
io_’gše
->
	`wa™
 (ùx, ctx->io_’gše->
io_objeù
);

234 ià(
wa™_¡©us
 == -1) {

235 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_CRITICAL
, "Reûivedƒ¼Ü from wa™ o³¿tiÚ,ƒ¼Ü codwas: %d", 
”ºo
);

240 ià(
wa™_¡©us
 > 0) {

243 
	`nİŞl_ùx_fÜ—ch_cÚn
 (
ùx
, 
nİŞl_loİ_´oûss
, &
wa™_¡©us
);

247 ià(
timeout
 > 0) {

248 #ià
	`defšed
(
NOPOLL_OS_WIN32
)

249 
	`nİŞl_wš32_g‘timeofday
 (&
¡İ
, 
NULL
);

251 
	`g‘timeofday
 (&
¡İ
, 
NULL
);

253 
	`nİŞl_timev®_sub¡¿ù
 (&
¡İ
, &
¡¬t
, &
diff
);

254 
–Ïp£d
 = (
diff
.
tv_£c
 * 1000000è+ diff.
tv_u£c
;

255 ià(
–Ïp£d
 > 
timeout
)

261 
	`nİŞl_io_»Ëa£_’gše
 (
ùx
->
io_’gše
);

262 
ùx
->
io_’gše
 = 
NULL
;

265 
	}
}

	@nopoll_loop.h

39 #iâdeà
__NOPOLL_LOOP_H__


40 
	#__NOPOLL_LOOP_H__


	)

42 
	~<nİŞl.h
>

44 
BEGIN_C_DECLS


46 
nİŞl_loİ_wa™
 (
noPŞlCtx
 * 
ùx
, 
timeout
);

48 
nİŞl_loİ_¡İ
 (
noPŞlCtx
 * 
ùx
);

50 
	gEND_C_DECLS


	@nopoll_msg.c

39 
	~<nİŞl_msg.h
>

40 
	~<nİŞl_´iv©e.h
>

55 
noPŞlMsg
 * 
	$nİŞl_msg_Ãw
 ()

57 
noPŞlMsg
 * 
msg
 = 
	`nİŞl_Ãw
 (noPollMsg, 1);

58 ià(
msg
 =ğ
NULL
)

59  
NULL
;

61 
msg
->
»fs
 = 1;

62 
msg
->
»f_mu‹x
 = 
	`nİŞl_mu‹x_ü—‹
 ();

64  
msg
;

65 
	}
}

76 cÚ¡ * 
	$nİŞl_msg_g‘_·ylßd
 (
noPŞlMsg
 * 
msg
)

78 ià(
msg
 =ğ
NULL
)

79  
NULL
;

80  
msg
->
·ylßd
;

81 
	}
}

91 
	$nİŞl_msg_g‘_·ylßd_size
 (
noPŞlMsg
 * 
msg
)

93 ià(
msg
 =ğ
NULL
)

95  
msg
->
·ylßd_size
;

96 
	}
}

107 
nİŞl_boŞ
 
	$nİŞl_msg_»f
 (
noPŞlMsg
 * 
msg
)

110 ià(
msg
 =ğ
NULL
)

111  
nİŞl_çl£
;

114 
	`nİŞl_mu‹x_lock
 (
msg
->
»f_mu‹x
);

116 
msg
->
»fs
++;

119 
	`nİŞl_mu‹x_uÆock
 (
msg
->
»f_mu‹x
);

121  
nİŞl_Œue
;

122 
	}
}

134 
	$nİŞl_msg_»f_couÁ
 (
noPŞlMsg
 * 
msg
)

136 
»suÉ
;

139 ià(
msg
 =ğ
NULL
)

143 
	`nİŞl_mu‹x_lock
 (
msg
->
»f_mu‹x
);

145 
»suÉ
 = 
msg
->
»fs
;

148 
	`nİŞl_mu‹x_uÆock
 (
msg
->
»f_mu‹x
);

150  
»suÉ
;

151 
	}
}

178 
nİŞl_boŞ
 
	$nİŞl_msg_is_fš®
 (
noPŞlMsg
 * 
msg
)

180 ià(
msg
 =ğ
NULL
)

181  
nİŞl_çl£
;

183  
msg
->
has_fš
;

184 
	}
}

202 
nİŞl_boŞ
 
	$nİŞl_msg_is_äagm’t
 (
noPŞlMsg
 * 
msg
)

204 ià(
msg
 =ğ
NULL
)

205  
nİŞl_çl£
;

206  
msg
->
is_äagm’t
 || msg->
has_fš
 == 0;

207 
	}
}

217 
noPŞlOpCode
 
	$nİŞl_msg_İcode
 (
noPŞlMsg
 * 
msg
)

219 ià(
msg
 =ğ
NULL
)

220  
NOPOLL_UNKNOWN_OP_CODE
;

221  (
noPŞlOpCode
è
msg
->
İ_code
;

222 
	}
}

249 
noPŞlMsg
 * 
	$nİŞl_msg_još
 (
noPŞlMsg
 * 
msg
,‚oPŞlMsg * 
msg2
)

251 
noPŞlMsg
 * 
»suÉ
;

254 ià(
msg
 =ğ
NULL
 && 
msg2
 == NULL)

255  
NULL
;

256 ià(
msg
 =ğ
NULL
 && 
msg2
) {

257 
	`nİŞl_msg_»f
 (
msg2
);

258  
msg2
;

260 ià(
msg
 && 
msg2
 =ğ
NULL
) {

261 
	`nİŞl_msg_»f
 (
msg
);

262  
msg
;

266 
»suÉ
 = 
	`nİŞl_msg_Ãw
 ();

267 
»suÉ
->
has_fš
 = 
msg
->has_fin;

268 
»suÉ
->
İ_code
 = 
msg
->op_code;

269 
»suÉ
->
is_masked
 = 
msg
->is_masked;

270 ià(
»suÉ
->
is_masked
)

271 
	`memıy
 (
»suÉ
->
mask
, 
msg
->mask, 4);

274 
»suÉ
->
·ylßd_size
 = 
msg
->·ylßd_siz+ 
msg2
->payload_size;

275 
»suÉ
->
·ylßd
 = 
	`nİŞl_Ãw
 (,„esuÉ->
·ylßd_size
 + 1);

278 
	`memıy
 (
»suÉ
->
·ylßd
, 
msg
->·ylßd, msg->
·ylßd_size
);

281 
	`memıy
 (((*è
»suÉ
->
·ylßd
è+ 
msg
->
·ylßd_size
 , 
msg2
->payload, msg2->payload_size);

284  
»suÉ
;

285 
	}
}

293 
	$nİŞl_msg_uÄef
 (
noPŞlMsg
 * 
msg
)

295 ià(
msg
 =ğ
NULL
)

299 
	`nİŞl_mu‹x_lock
 (
msg
->
»f_mu‹x
);

301 
msg
->
»fs
--;

302 ià(
msg
->
»fs
 != 0) {

304 
	`nİŞl_mu‹x_uÆock
 (
msg
->
»f_mu‹x
);

308 
	`nİŞl_mu‹x_uÆock
 (
msg
->
»f_mu‹x
);

309 
	`nİŞl_mu‹x_de¡roy
 (
msg
->
»f_mu‹x
);

312 
	`nİŞl_ä“
 (
msg
->
·ylßd
);

313 
	`nİŞl_ä“
 (
msg
);

317 
	}
}

	@nopoll_msg.h

39 #iâdeà
__NOPOLL_MSG_H__


40 
	#__NOPOLL_MSG_H__


	)

42 
	~<nİŞl.h
>

44 
BEGIN_C_DECLS


46 cÚ¡ * 
nİŞl_msg_g‘_·ylßd
 (
noPŞlMsg
 * 
msg
);

48 
nİŞl_msg_g‘_·ylßd_size
 (
noPŞlMsg
 * 
msg
);

50 
noPŞlMsg
 * 
nİŞl_msg_Ãw
 ();

52 
nİŞl_boŞ
 
nİŞl_msg_»f
 (
noPŞlMsg
 * 
msg
);

54 
nİŞl_msg_»f_couÁ
 (
noPŞlMsg
 * 
msg
);

56 
nİŞl_boŞ
 
nİŞl_msg_is_fš®
 (
noPŞlMsg
 * 
msg
);

58 
nİŞl_boŞ
 
nİŞl_msg_is_äagm’t
 (
noPŞlMsg
 * 
msg
);

60 
noPŞlOpCode
 
nİŞl_msg_İcode
 (
noPŞlMsg
 * 
msg
);

62 
noPŞlMsg
 * 
nİŞl_msg_još
 (noPŞlMsg * 
msg
,‚oPŞlMsg * 
msg2
);

64 
nİŞl_msg_uÄef
 (
noPŞlMsg
 * 
msg
);

66 
	gEND_C_DECLS


	@nopoll_private.h

39 #iâdeà
__NOPOLL_PRIVATE_H__


40 
	#__NOPOLL_PRIVATE_H__


	)

42 
	~<İ’s¦/bio.h
>

43 
	~<İ’s¦/evp.h
>

44 
	~<İ’s¦/objeùs.h
>

45 
	~<İ’s¦/x509v3.h
>

46 
	~<İ’s¦/s¦.h
>

47 
	~<İ’s¦/”r.h
>

49 
	~<nİŞl_hªdËrs.h
>

51 
	s_noPŞlC”tifiÿ‹
 {

53 * 
	m£rv”Name
;

54 * 
	mû¹ifiÿ‹Fe
;

55 * 
	m´iv©eKey
;

56 * 
	mİtiÚ®ChašFe
;

58 } 
	tnoPŞlC”tifiÿ‹
;

60 
	s_noPŞlCtx
 {

65 
	m»fs
;

68 
nİŞl_boŞ
 
	mnÙ_execu‹d
;

69 
nİŞl_boŞ
 
	mdebug_’abËd
;

72 
nİŞl_boŞ
 
	mnÙ_execu‹d_cŞÜ
;

73 
nİŞl_boŞ
 
	mdebug_cŞÜ_’abËd
;

75 
nİŞl_boŞ
 
	mk“p_loİšg
;

80 
	mcÚn_cÚÃù_¡d_timeout
;

85 
	mbacklog
;

90 
noPŞlIoEngše
 * 
	mio_’gše
;

95 
	mcÚn_id
;

96 
noPŞlCÚn
 ** 
	mcÚn_li¡
;

97 
	mcÚn_Ëngth
;

101 
	mcÚn_num
;

106 
noPŞlAùiÚHªdËr
 
	mÚ_acû±
;

107 
noPŞlPŒ
 
	mÚ_acû±_d©a
;

112 
noPŞlAùiÚHªdËr
 
	mÚ_»ady
;

113 
noPŞlPŒ
 
	mÚ_»ady_d©a
;

118 
noPŞlAùiÚHªdËr
 
	mÚ_İ’
;

119 
noPŞlPŒ
 
	mÚ_İ’_d©a
;

124 
noPŞlOnMes§geHªdËr
 
	mÚ_msg
;

125 
noPŞlPŒ
 
	mÚ_msg_d©a
;

131 
	m´ÙocŞ_v”siÚ
;

136 
noPŞlC”tifiÿ‹
 * 
	mû¹ifiÿ‹s
;

137 
	mû¹ifiÿ‹s_Ëngth
;

140 
noPŞlPŒ
 
	m»f_mu‹x
;

143 
noPŞlLogHªdËr
 
	mlog_hªdËr
;

144 
noPŞlPŒ
 
	mlog_u£r_d©a
;

147 
noPŞlS¦CÚ‹xtC»©Ü
 
	mcÚ‹xt_ü—tÜ
;

148 
noPŞlPŒ
 
	mcÚ‹xt_ü—tÜ_d©a
;

151 
noPŞlS¦Po¡Check
 
	mpo¡_s¦_check
;

152 
noPŞlPŒ
 
	mpo¡_s¦_check_d©a
;

155 
	s_noPŞlCÚn
 {

159 
	mid
;

164 
noPŞlCtx
 * 
	mùx
;

170 
NOPOLL_SOCKET
 
	m£ssiÚ
;

175 
nİŞl_boŞ
 
	mhªdshake_ok
;

180 
noPŞlR—d
 
	m»ûive
;

185 
noPŞlR—d
 
	m£nd
;

190 
noPŞlRŞe
 
	mrŞe
;

195 * 
	mho¡
;

201 * 
	mpÜt
;

206 * 
	mho¡_Çme
;

211 * 
	mÜigš
;

216 * 
	mg‘_u¾
;

222 * 
	m´ÙocŞs
;

224 * 
	macû±ed_´ÙocŞ
;

227 
	m³”_şo£_¡©us
;

228 * 
	m³”_şo£_»asÚ
;

233 
noPŞlOnMes§geHªdËr
 
	mÚ_msg
;

234 
noPŞlPŒ
 
	mÚ_msg_d©a
;

239 
noPŞlAùiÚHªdËr
 
	mÚ_»ady
;

240 
noPŞlPŒ
 
	mÚ_»ady_d©a
;

245 
noPŞlOnClo£HªdËr
 
	mÚ_şo£
;

246 
noPŞlPŒ
 
	mÚ_şo£_d©a
;

249 
noPŞlHªdShake
 * 
	mhªdshake
;

252 * 
	m³ndšg_lše
;

257 
	m»fs
;

262 
noPŞlMsg
 * 
	m³ndšg_msg
;

263 
	m³ndšg_diff
;

264 
	m³ndšg_de¥
;

270 
nİŞl_boŞ
 
	ms_Ú
;

275 
nİŞl_boŞ
 
	m³ndšg_s¦_acû±
;

278 
SSL_CTX
 * 
	ms¦_ùx
;

279 
SSL
 * 
	ms¦
;

282 * 
	mû¹ifiÿ‹
;

283 * 
	m´iv©e_key
;

284 * 
	mchaš_û¹ifiÿ‹
;

287 
	m³ndšg_buf
[100];

288 
	m³ndšg_buf_by‹s
;

293 
noPŞlPŒ
 
	mhook
;

298 
noPŞlPŒ
 
	m»f_mu‹x
;

304 
noPŞlMsg
 * 
	m´evious_msg
;

307 
nİŞl_boŞ
 
	m´evious_was_äagm’t
;

309 * 
	m³ndšg_wr™e
;

310 
	m³ndšg_wr™e_by‹s
;

315 
noPŞlCÚnO±s
 * 
	mİts
;

321 
noPŞlCÚn
 * 
	mli¡’”
;

324 
	s_noPŞlIoEngše
 {

325 
noPŞlPŒ
 
	mio_objeù
;

326 
noPŞlCtx
 * 
	mùx
;

327 
noPŞlIoMechC»©e
 
	mü—‹
;

328 
noPŞlIoMechDe¡roy
 
	mde¡roy
;

329 
noPŞlIoMechCË¬
 
	mş—r
;

330 
noPŞlIoMechWa™
 
	mwa™
;

331 
noPŞlIoMechAddTo
 
	maddto
;

332 
noPŞlIoMechIsS‘
 
	mis£t
;

335 
	s_noPŞlMsg
 {

336 
nİŞl_boŞ
 
	mhas_fš
;

337 
	mİ_code
;

338 
nİŞl_boŞ
 
	mis_masked
;

340 
noPŞlPŒ
 
	m·ylßd
;

341 
	m·ylßd_size
;

343 
	m»fs
;

344 
noPŞlPŒ
 
	m»f_mu‹x
;

346 
	mmask
[4];

347 
	m»maš_by‹s
;

349 
nİŞl_boŞ
 
	mis_äagm’t
;

350 
	munmask_de¥
;

353 
	s_noPŞlHªdshake
 {

358 
nİŞl_boŞ
 
	mupg¿de_websock‘
;

359 
nİŞl_boŞ
 
	mcÚÃùiÚ_upg¿de
;

360 
nİŞl_boŞ
 
	m»ûived_101
;

361 * 
	mwebsock‘_key
;

362 * 
	mwebsock‘_v”siÚ
;

363 * 
	mwebsock‘_acû±
;

364 * 
	mex³ùed_acû±
;

367 * 
	mcook›
;

370 
	s_noPŞlCÚnO±s
 {

372 
nİŞl_boŞ
 
	m»u£
;

375 
noPŞlPŒ
 
	mmu‹x
;

376 
	m»fs
;

379 
noPŞlS¦PrÙocŞ
 
	ms¦_´ÙocŞ
;

382 * 
	mû¹ifiÿ‹
;

383 * 
	m´iv©e_key
;

384 * 
	mchaš_û¹ifiÿ‹
;

385 * 
	mÿ_û¹ifiÿ‹
;

387 
nİŞl_boŞ
 
	mdi§bË_s¦_v”ify
;

390 * 
	mcook›
;

393 
nİŞl_boŞ
 
	msk_Üigš_h—d”_check
;

396 * 
	mš‹rçû
;

	@nopoll_win32.c

40 
	~<nİŞl.h
>

42 
	#LOG_DOMAIN
 "nİŞl-wš32"

	)

44 #ià
defšed
(
NOPOLL_OS_WIN32
)

46 
nİŞl_boŞ
 
	g__nİŞl_wš32_was_š™
 = 
nİŞl_çl£
;

48 
	$nİŞl_wš32_š™
 (
noPŞlCtx
 * 
ùx
)

50 
WORD
 
wV”siÚReque¡ed
;

51 
WSADATA
 
w§D©a
;

52 
”rÜ
;

54 ià(
__nİŞl_wš32_was_š™
)

55  
nİŞl_Œue
;

57 
wV”siÚReque¡ed
 = 
	`MAKEWORD
( 2, 2 );

59 
”rÜ
 = 
	`WSAS¹up
Ğ
wV”siÚReque¡ed
, &
w§D©a
 );

60 ià(
”rÜ
 !ğ
NO_ERROR
) {

61 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_CRITICAL
, "unableo init winsock‡pi,ƒxiting..");

62  
nİŞl_çl£
;

64 
	`nİŞl_log
 (
ùx
, 
NOPOLL_LEVEL_DEBUG
, "winsock initialization ok");

66 
__nİŞl_wš32_was_š™
 = 
nİŞl_Œue
;

67  
nİŞl_Œue
;

68 
	}
}

70 
BOOL
 
APIENTRY
 
	$DÎMaš
 (
HINSTANCE
 
hIn¡
,

71 
DWORD
 
»asÚ
,

72 
LPVOID
 
»£rved
)

77  
nİŞl_Œue
;

78 
	}
}

80 
	$__nİŞl_wš32_blockšg_sock‘_£t
 (
NOPOLL_SOCKET
 
sock‘
,

81 
¡©us
)

83 
’abË
 = 
¡©us
;

85  (
	`ioùlsock‘
 (
sock‘
, 
FIONBIO
, &
’abË
) == 0);

86 
	}
}

88 
	$nİŞl_wš32_nÚblockšg_’abË
 (
NOPOLL_SOCKET
 
sock‘
)

90  
	`__nİŞl_wš32_blockšg_sock‘_£t
 (
sock‘
, 1);

91 
	}
}

93 
	$nİŞl_wš32_blockšg_’abË
 (
NOPOLL_SOCKET
 
sock‘
)

95  
	`__nİŞl_wš32_blockšg_sock‘_£t
 (
sock‘
, 0);

96 
	}
}

98 #ià! 
defšed
(
HAVE_GETTIMEOFDAY
)

122 
	$nİŞl_wš32_g‘timeofday
(
timev®
 *
tv
, 
noPŞlPŒ
 
nÙU£d
)

125 
ns100
;

126 
FILETIME
 
feTime
;

127 } 
now
;

129 
	`G‘Sy¡emTimeAsFeTime
 (&
now
.
feTime
);

130 
tv
->
tv_u£c
 = (è((
now
.
ns100
 / 10LL) % 1000000LL);

131 
tv
->
tv_£c
 = (è((
now
.
ns100
 - 116444736000000000LL) / 10000000LL);

133 
	}
}

	@nopoll_win32.h

40 #iâdeà
__NOPOLL_WIN32_H__


41 
	#__NOPOLL_WIN32_H__


	)

43 
	~<nİŞl_ùx.h
>

45 
BEGIN_C_DECLS


47 
nİŞl_wš32_š™
 (
noPŞlCtx
 * 
ùx
);

49 
nİŞl_wš32_nÚblockšg_’abË
 (
NOPOLL_SOCKET
 
sock‘
);

51 
nİŞl_wš32_blockšg_’abË
 (
NOPOLL_SOCKET
 
sock‘
);

54 
nİŞl_wš32_g‘timeofday
 (
timev®
 *
tv
, 
noPŞlPŒ
 
nÙU£d
);

56 
BOOL
 
APIENTRY
 
DÎMaš
 (
HINSTANCE
 
hIn¡
,

57 
DWORD
 
»asÚ
,

58 
LPVOID
 
»£rved
);

60 #ià!
defšed
(
EINPROGRESS
)

61 
	#EINPROGRESS
 (
WSAEINPROGRESS
)

	)

64 
	gEND_C_DECLS


	@
1
.
0
30
450
SConstruct
config.h
nopoll-regression-client.c
nopoll.c
nopoll.h
nopoll_config.h
nopoll_config_win32.h
nopoll_config_win64.h
nopoll_conn.c
nopoll_conn.h
nopoll_conn_opts.c
nopoll_conn_opts.h
nopoll_ctx.c
nopoll_ctx.h
nopoll_decl.c
nopoll_decl.h
nopoll_handlers.h
nopoll_io.c
nopoll_io.h
nopoll_listener.c
nopoll_listener.h
nopoll_log.c
nopoll_log.h
nopoll_loop.c
nopoll_loop.h
nopoll_msg.c
nopoll_msg.h
nopoll_private.h
nopoll_win32.c
nopoll_win32.h
